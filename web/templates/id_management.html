<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacOS VM 虚拟机管理平台 - Apple ID管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 15px rgba(102, 126, 234, 0.3);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            width: 280px;
            color: white;
        }
        
 /* 侧边栏标题样式 */
    .sidebar-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        
        .brand-text {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        

        .accordion-button:not(.collapsed) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            box-shadow: none;
        }
        
        .accordion-button {
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            font-weight: 600;
        }
        
        .accordion-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .accordion-button:focus {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button::after {
            filter: invert(1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .accordion-item {
            background: transparent;
            border: none;
        }
        
        .accordion-body {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 0 8px;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 20px;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 600;
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }
        
        .table {
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .table thead th {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #000000;
            border: none;
            padding: 15px;
            font-weight: 600;
        }
        
        .table tbody tr:hover {
            background-color: rgba(102, 126, 234, 0.1);
        }
        
        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .status-active {
            background-color: #d4edda;
            color: #155724;
        }
        
        .status-inactive {
            background-color: #f8d7da;
            color: #721c24;
        }
        
        .main-content {
            margin-left: 280px;
            padding: 20px;
        }
        
        .page-header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }
        
        .stats-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .stats-number {
            font-size: 2.5em;
            font-weight: bold;
            color: #667eea;
        }
        
        .stats-label {
            color: #6c757d;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        /* Apple ID管理页面样式 */
        .appleid-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            flex: 1;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #0d6efd;
        }
        
        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }
        
        .stat-card {
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .appleid-table {
            font-size: 0.9em;
            table-layout: fixed;
            width: 100%;
        }
        
        /* 确保表格容器正确处理溢出 */
        .table-responsive {
            overflow-x: auto;
            overflow-y: hidden;
        }
        
        /* 表格容器最小宽度，确保状态列和操作列不被挤压 */
        .table-responsive .table {
            min-width: 800px;
        }
        
        /* 表格容器样式优化 */
        .appleid-data-container {
            overflow-x: auto;
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
        }
        
        /* 确保表格头部固定 */
        .appleid-table thead th {
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 2;
        }
        
        .appleid-table th {
            background-color: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        /* 表格列宽分配 */
        .appleid-table th:nth-child(1), .appleid-table td:nth-child(1) {
            width: 6%; /* 序号 */
            text-align: center;
            min-width: 50px;
        }
        
        .appleid-table th:nth-child(2), .appleid-table td:nth-child(2) {
            width: 18%; /* 账户名 */
            min-width: 140px;
        }
        
        .appleid-table th:nth-child(3), .appleid-table td:nth-child(3) {
            width: 12%; /* 密码 */
            min-width: 100px;
        }
        
        .appleid-table th:nth-child(4), .appleid-table td:nth-child(4) {
            width: 15%; /* 手机号码 - 新增 */
            min-width: 120px;
            text-align: center;
        }
        
        .appleid-table th:nth-child(5), .appleid-table td:nth-child(5) {
            width: 32%; /* 接码地址 */
            min-width: 180px;
        }
        
        .appleid-table th:nth-child(6), .appleid-table td:nth-child(6) {
            width: 9%; /* 状态 */
            text-align: center;
            min-width: 70px;
            max-width: 70px;
            white-space: nowrap;
            overflow: hidden;
        }
        
        .appleid-table th:nth-child(7), .appleid-table td:nth-child(7) {
            width: 8%; /* 删除 */
            text-align: center;
            min-width: 70px;
            max-width: 70px;
            white-space: nowrap;
            overflow: hidden;
        }
        
        /* 删除列按钮样式优化 */
        .appleid-table td:nth-child(7) .btn {
            padding: 0.2rem 0.4rem;
            font-size: 0.7rem;
            white-space: nowrap;
            min-width: 32px;
            height: 28px;
        }
        
        .appleid-table td:nth-child(7) .btn i {
            font-size: 0.65rem;
        }
        
        /* 表格内容样式优化 */
        .appleid-table td {
            vertical-align: middle;
            font-size: 0.9em;
        }
        
        /* 长文本处理 */
        .appleid-table td:nth-child(2),
        .appleid-table td:nth-child(3),
        .appleid-table td:nth-child(4),
        .appleid-table td:nth-child(5) {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* 接码地址列特殊处理 */
        .appleid-table td:nth-child(5) {
            max-width: 0;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            word-break: break-all;
            position: relative;
        }
        
        /* 鼠标悬停显示完整内容 */
        .appleid-table td:nth-child(2):hover,
        .appleid-table td:nth-child(3):hover,
        .appleid-table td:nth-child(4):hover {
            white-space: normal;
            word-break: break-all;
            position: relative;
            z-index: 10;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        /* 接码地址列悬停效果 */
        .appleid-table td:nth-child(5):hover {
            white-space: normal;
            word-break: break-all;
            position: relative;
            z-index: 10;
            background-color: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            min-width: 300px;
            max-width: 500px;
        }
        
        /* 截断链接样式 */
        .truncated-link {
            display: inline-block;
            max-width: calc(100% - 30px); /* 为图标留出空间 */
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            vertical-align: middle;
        }
        
        /* 链接图标悬停效果 */
        .appleid-table td:nth-child(5) i.fas.fa-link {
            transition: all 0.3s ease;
        }
        
        .appleid-table td:nth-child(5) i.fas.fa-link:hover {
            color: #007bff !important;
            transform: scale(1.1);
        }
        
        /* 状态徽章样式 */
        .appleid-table .badge {
            font-size: 0.7em;
            padding: 0.2rem 0.4rem;
            white-space: nowrap;
            display: inline-block;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 配置文件下拉框样式 */
        .config-dropdown-btn {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: 2px solid #17a2b8;
            color: white;
            font-weight: 600;
            box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
            transition: all 0.3s ease;
            min-width: 200px;
            white-space: nowrap;
        }
        
        .config-dropdown-btn:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            border-color: #138496;
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.4);
        }
        
        .config-dropdown-btn:focus {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            border-color: #138496;
            color: white;
            box-shadow: 0 0 0 0.2rem rgba(23, 162, 184, 0.25);
        }
        
        /* 下拉菜单样式 */
        .config-dropdown-menu {
            border: 2px solid #17a2b8;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 8px 0;
            min-width: 220px;
            max-width: 280px;
            overflow: hidden;
        }
        
        .config-dropdown-menu .dropdown-item {
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.2s ease;
            border-radius: 4px;
            margin: 2px 8px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* 错误信息样式 */
        .error-message {
            background-color: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            display: none;
        }
        
        /* 加载状态样式 */
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        /* 表格容器样式 */
        .table-container {
            display: none;
        }
        
        /* Apple ID管理专用样式 */
        .id-card-icon {
            color: #007AFF;
            font-size: 1.2em;
        }
        
        .navbar-brand .fas.fa-id-card {
            color: #000000;
            font-size: 1.3em;
        }
        
        .card-header .fas.fa-id-card {
            color: #000000;
            font-size: 1.2em;
        }
        
        .nav-link.active .fas.fa-id-card {
            color: #000000;
        }
        
        .nav-link .fas.fa-id-card {
            color: rgba(0, 0, 0, 0.8);
        }
        
        /* Apple ID页面展示区域logo样式 */
        .card-header .fab.fa-apple {
            color: white;
            font-size: 1.3em;
            margin-right: 8px;
        }
        
        /* 表格头部图标样式 */
        .appleid-table th i {
            font-size: 0.9em;
            margin-right: 4px;
        }
        
        /* 表格数据行图标样式 */
        .appleid-table td i {
            font-size: 0.85em;
            margin-right: 4px;
        }
        
        /* Apple ID文件下拉菜单样式 */
        .appleid-data-container {
            margin-top: 20px;
        }
        
        .appleid-data-container .form-group {
            margin-bottom: 20px;
        }
        
        .appleid-data-container .form-label {
            font-weight: 600;
            color: #333;
        }
        
        /* 下拉菜单样式 */
        #appleIdFileDropdown {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            border: none;
            border-radius: 8px;
            padding: 10px 20px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        #appleIdFileDropdown:hover {
            background: linear-gradient(135deg, #138496 0%, #117a8b 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
        }
        
        #appleIdFileDropdownMenu {
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: none;
            padding: 8px 0;
        }
        
        #appleIdFileDropdownMenu .dropdown-item {
            padding: 10px 20px;
            font-size: 14px;
            transition: all 0.2s ease;
        }
        
        #appleIdFileDropdownMenu .dropdown-item:hover {
            background: linear-gradient(135deg, #17a2b8 0%, #138496 100%);
            color: white;
            transform: translateX(3px);
        }
        
        #appleIdFileDropdownMenu .dropdown-item.disabled {
            color: #6c757d !important;
            font-style: italic;
            cursor: not-allowed;
        }
        
        /* 操作按钮样式 */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
            border-radius: 0.2rem;
        }
        
        .btn-success {
            background-color: #28a745;
            border-color: #28a745;
        }
        
        .btn-success:hover {
            background-color: #218838;
            border-color: #1e7e34;
        }
        
        .btn-danger {
            background-color: #dc3545;
            border-color: #dc3545;
        }
        
        .btn-danger:hover {
            background-color: #c82333;
            border-color: #bd2130;
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }
        
        /* 状态徽章样式 */
        .badge {
            font-size: 0.75em;
            padding: 0.35em 0.65em;
        }
        
        .bg-success {
            background-color: #28a745 !important;
        }
        
        .bg-danger {
            background-color: #dc3545 !important;
        }
        
        /* 分页样式 */
        .pagination-sm .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .pagination-sm .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        /* 文件信息显示样式 */
        .appleid-data-container .alert {
            border-radius: 8px;
            border: none;
            padding: 15px;
        }
        
        /* 品牌文字样式 */
        .brand-text {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-header h4 {
            margin-bottom: 5px !important;
        }
        
        .sidebar-header small {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        html, body { width: 100vw; overflow-x: hidden !important; }
        .col-md-9.col-lg-10 { width: calc(100vw - 280px); min-width: 0; margin: 0; height: calc(100vh - 80px); overflow-y: auto; overflow-x: hidden; }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" style="position: fixed; top: 0; left: 280px; right: 0; z-index: 1000;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                Apple ID管理
            </span>
            <div class="d-flex">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-home me-2"></i>主页
                </a>
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        语言
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="langDropdown">
                        <li><a class="dropdown-item" href="?lang=zh">中文</a></li>
                        <li><a class="dropdown-item" href="?lang=en">English</a></li>
                    </ul>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">登出</a>
            </div>
        </div>
    </div>
    
    <div class="container-fluid" style="margin-left: 280px; margin-top: 80px;">
        <div class="row">
            <!-- 左侧菜单 -->
            <nav class="col-md-3 col-lg-2 sidebar p-3">
        <div class="sidebar-header text-center mb-4">
            <h4 class="mb-0">
                <span class="brand-text">MacOS VM 虚拟机管理平台</span>
            </h4>
        </div>
        <div class="accordion" id="accordionMenu">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingVM">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVM" aria-expanded="false" aria-controls="collapseVM">
                        虚拟机管理
                    </button>
                </h2>
                <div id="collapseVM" class="accordion-collapse collapse" aria-labelledby="headingVM" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('clone_vm_page') }}">虚拟机批量克隆</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('vm_management_page') }}">虚拟机信息管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('vm_script_page') }}">虚拟机脚本管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
              <div class="accordion-item">
                <h2 class="accordion-header" id="headingClient">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClient" aria-expanded="false" aria-controls="collapseClient">
                        客户端管理
                    </button>
                </h2>
                <div id="collapseClient" class="accordion-collapse collapse" aria-labelledby="headingClient" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('client_management_page') }}">ScptRunner客户端管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('json_parser_page') }}"><i class="fas fa-code me-2"></i>JSON解析功能</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
                  <!-- 发信管理主菜单 -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingMessaging">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMessaging" aria-expanded="false" aria-controls="collapseMessaging">
                        发信管理
                    </button>
                </h2>
                <div id="collapseMessaging" class="accordion-collapse collapse " aria-labelledby="headingMessaging" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="{{ url_for('phone_management_page') }}"><i class="fas fa-phone me-2"></i>手机号管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('mass_messaging.mass_messaging_page') }}"><i class="fas fa-broadcast-tower me-2"></i>群发管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingBoot">
                                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBoot" aria-expanded="false" aria-controls="collapseBoot">
                            杂项管理
                        </button>
                </h2>
                <div id="collapseBoot" class="accordion-collapse collapse show" aria-labelledby="headingBoot" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('wuma_page') }}">虚拟机五码管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('mupan_page') }}">虚拟机母盘管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link active" href="{{ url_for('id_management_page') }}">Apple ID管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
       
            <!-- 其他菜单项 -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingEncrypt">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncrypt" aria-expanded="false" aria-controls="collapseEncrypt">
                        数据加密功能
                    </button>
                </h2>
                <div id="collapseEncrypt" class="accordion-collapse collapse" aria-labelledby="headingEncrypt" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_code_page') }}">代码加密</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_wuma_page') }}">五码加密</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_id_page') }}">id加密</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingProxy">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProxy" aria-expanded="false" aria-controls="collapseProxy">
                        代理ip配置
                    </button>
                </h2>
                <div id="collapseProxy" class="accordion-collapse collapse" aria-labelledby="headingProxy" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('proxy_assign_page') }}">代理ip分配</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSoft">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSoft" aria-expanded="false" aria-controls="collapseSoft">
                        虚拟机软件管理
                    </button>
                </h2>
                <div id="collapseSoft" class="accordion-collapse collapse" aria-labelledby="headingSoft" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('soft_version_page') }}">版本查看</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('soft_env_page') }}">环境变量</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSystem">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSystem" aria-expanded="false" aria-controls="collapseSystem">
                        系统管理
                    </button>
                </h2>
                <div id="collapseSystem" class="accordion-collapse collapse" aria-labelledby="headingSystem" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="#">系统版本</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">系统插件管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">用户管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">授权管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </nav>
    
    <!-- 右侧内容区域 -->
    <div class="col-md-9 col-lg-10">
        <div class="card">
            <div class="card-header">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fab fa-apple me-2"></i>Apple ID管理
                    </h4>
                    <div class="btn-group">
                        <div class="dropdown me-2">
                            <button class="btn btn-info dropdown-toggle" type="button" id="appleIdFileDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-file-text me-2"></i>选择Apple ID文件
                            </button>
                            <ul class="dropdown-menu" id="appleIdFileDropdownMenu" aria-labelledby="appleIdFileDropdown">
                                <!-- Apple ID文件选项将在这里动态加载 -->
                            </ul>
                        </div>
                        <div class="form-check me-3" style="display: inline-flex; align-items: center;">
                            <input class="form-check-input" type="checkbox" id="defaultAppleIdFileCheck" onchange="toggleDefaultAppleIdFile()">
                            <label class="form-check-label ms-1" for="defaultAppleIdFileCheck" style="margin-bottom: 0; font-size: 14px; color: #495057;">
                                设为默认
                            </label>
                        </div>
                        <button class="btn btn-success me-2" onclick="openUploadAppleIdModal()">
                            <i class="fas fa-upload me-2"></i>上传Apple ID文本
                        </button>
                        <button class="btn btn-primary" onclick="loadAppleIdFiles()">
                            <i class="fas fa-sync-alt me-2"></i>刷新文件列表
                        </button>
                    </div>
                </div>
            </div>
            <div class="card-body">
                <!-- Apple ID统计信息 -->
                <div class="appleid-stats" id="appleIdStats">
                    <div class="stat-card">
                        <div class="stat-number" id="totalAppleIds">-</div>
                        <div class="stat-label">总Apple ID数</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="validAppleIds">-</div>
                        <div class="stat-label">有效Apple ID</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="invalidAppleIds">-</div>
                        <div class="stat-label">无效Apple ID</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="usedAppleIds">-</div>
                        <div class="stat-label">已使用</div>
                    </div>
                </div>
                
                <!-- 错误信息显示 -->
                <div class="error-message" id="errorMessage"></div>
                
                <!-- 加载状态 -->
                <div class="loading" id="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-2">正在获取Apple ID信息...</p>
                </div>
                
                <!-- Apple ID数据展示区域 -->
                <div class="appleid-data-container" id="appleIdDataContainer" style="display: none;">
                    <!-- 表格容器 -->
                    <div class="table-responsive" id="table-container">
                        <table class="table table-hover appleid-table">
                            <thead>
                                <tr>
                                    <th><i class="fas fa-hashtag me-1"></i>序号</th>
                                    <th><i class="fas fa-user me-1"></i>账户名</th>
                                    <th><i class="fas fa-key me-1"></i>密码</th>
                                    <th><i class="fas fa-phone me-1"></i>手机号码</th>
                                    <th><i class="fas fa-link me-1"></i>接码地址</th>
                                    <th><i class="fas fa-info-circle me-1"></i>状态</th>
                                    <th><i class="fas fa-trash me-1"></i>删除</th>
                                </tr>
                            </thead>
                            <tbody id="previewTableBody">
                                <!-- 数据将通过JavaScript动态加载 -->
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- 分页控件 -->
                    <div class="d-flex justify-content-between align-items-center mt-3" id="paginationContainer" style="display: none;">
                        <div class="d-flex align-items-center">
                            <div class="text-muted me-3">
                                <i class="fas fa-info-circle me-1"></i>
                                显示 <span id="startRecord" class="fw-bold">0</span> - <span id="endRecord" class="fw-bold">0</span> 条，共 <span id="totalRecords" class="fw-bold">0</span> 条记录
                            </div>
                            <div class="d-flex align-items-center">
                                <label class="form-label mb-0 me-2">每页显示:</label>
                                <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;" onchange="changePageSize()">
                                    <option value="5" selected>5</option>
                                    <option value="10">10</option>
                                    <option value="20">20</option>
                                    <option value="50">50</option>
                                </select>
                            </div>
                        </div>
                        <nav aria-label="Apple ID列表分页">
                            <ul class="pagination pagination-sm mb-0" id="pagination">
                                <!-- 分页将通过JavaScript动态生成 -->
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 上传Apple ID文件模态框 -->
    <div class="modal fade" id="uploadAppleIdModal" tabindex="-1" aria-labelledby="uploadAppleIdModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="uploadAppleIdModalLabel">
                        <i class="fas fa-upload me-2"></i>上传Apple ID文本文件
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="appleIdFile" class="form-label">选择Apple ID文本文件</label>
                        <input type="file" class="form-control" id="appleIdFile" accept=".txt,.csv" onchange="validateAppleIdFile()">
                        <div class="form-text">支持 .txt 和 .csv 格式的文件</div>
                        <div id="appleIdFileValidationMessage" class="mt-2"></div>
                    </div>
                    <div class="mb-3" id="appleIdFilenameSection" style="display: none;">
                        <label for="customAppleIdFilename" class="form-label">重新修改文件名（可选）</label>
                        <input type="text" class="form-control" id="customAppleIdFilename" placeholder="输入自定义文件名，不包含.txt扩展名">
                        <div class="form-text">留空将使用原文件名</div>
                    </div>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>文件格式说明：</strong> 
                        <br>每行一个Apple ID信息，必须符合以下格式：
                        <br>格式：邮箱----密码----电话----接码地址
                        <br>示例：maddoxmarley47290@gmail.com----24LqO2MAo2Pl----12296580599----http://a.62-us.com/api/get_sms?key=ef9fba2d7ae4bc3aaaba8989dbf038d7
                        <br><strong>注意：</strong>每行必须以四个----为分隔符，包含四个字段（邮箱、密码、电话、接码地址）
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="uploadAppleIdBtn" onclick="submitAppleIdUpload()" disabled>上传</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 删除确认模态框 -->
    <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteConfirmModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteConfirmModalLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>确认删除
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>确定要删除这条Apple ID数据吗？</p>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>注意：</strong>删除的Apple ID数据将会移动到ID_delete目录下的备份文件中<br>
                    </div>
                    <input type="hidden" id="deleteAppleIdIndex" value="">
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-danger" id="confirmDeleteBtn" onclick="confirmDelete()">
                        <i class="fas fa-trash me-2"></i>确认删除
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 分页相关变量
        let currentPage = 1;
        let pageSize = 5; // 默认每页显示5条
        let allAppleIdData = [];
        let currentFileName = '';
        let currentAppleIdFile = ''; // 当前选择的Apple ID文件

        // 初始化页面
        document.addEventListener('DOMContentLoaded', function() {
            console.log('页面加载完成，初始化Apple ID管理功能');
            
            // 初始化分页设置
            pageSize = 5;
            currentPage = 1;
            document.getElementById('pageSizeSelect').value = pageSize;
            
            // 先加载默认文件设置
            const defaultFile = localStorage.getItem('defaultAppleIdFile');
            if (defaultFile) {
                currentAppleIdFile = defaultFile;
                console.log('初始化时设置当前文件为默认文件:', currentAppleIdFile);
            }
            
            // 先加载文件列表，然后加载默认文件
            loadAppleIdFiles();
            
            // 延迟加载默认文件，确保文件列表已加载完成
            setTimeout(() => {
                loadDefaultAppleIdFile();
            }, 1000);
            
            // 监听下拉框打开事件
            const appleIdFileDropdown = document.getElementById('appleIdFileDropdown');
            if (appleIdFileDropdown) {
                appleIdFileDropdown.addEventListener('shown.bs.dropdown', function() {
                    // 下拉时动态刷新文件列表
                    loadAppleIdFiles();
                });
            }
        });



        // 加载Apple ID文件列表
        function loadAppleIdFiles() {
            console.log('开始加载Apple ID文件列表...');
            
            // 重置统计信息
            document.getElementById('totalAppleIds').textContent = '-';
            document.getElementById('validAppleIds').textContent = '-';
            document.getElementById('invalidAppleIds').textContent = '-';
            document.getElementById('usedAppleIds').textContent = '-';
            
            fetch('/api/appleid_files')
                .then(response => response.json())
                .then(data => {
                    console.log('Apple ID文件列表响应:', data);
                    if (data.success) {
                        updateAppleIdFileSelect(data.files);
                        
                        // 如果当前有选中的文件，重新加载其内容以更新统计信息
                        if (currentAppleIdFile) {
                            console.log('重新加载当前文件内容以更新统计信息:', currentAppleIdFile);
                            
                            // 检查当前文件是否在文件列表中
                            const fileExists = data.files.some(file => file.name === currentAppleIdFile);
                            if (fileExists) {
                                selectAppleIdFile(currentAppleIdFile);
                            } else {
                                console.log('当前选中的文件不在文件列表中，清空统计信息');
                                document.getElementById('totalAppleIds').textContent = '0';
                                document.getElementById('validAppleIds').textContent = '0';
                                document.getElementById('invalidAppleIds').textContent = '0';
                                document.getElementById('usedAppleIds').textContent = '0';
                                
                                // 清空当前文件选择
                                currentAppleIdFile = '';
                                updateDropdownButtonText();
                            }
                        } else {
                            // 如果没有选中的文件，清空统计信息
                            console.log('没有选中的文件，清空统计信息');
                            document.getElementById('totalAppleIds').textContent = '0';
                            document.getElementById('validAppleIds').textContent = '0';
                            document.getElementById('invalidAppleIds').textContent = '0';
                            document.getElementById('usedAppleIds').textContent = '0';
                        }
                        
                        // 如果有文件，自动选择第一个文件并更新统计
                        if (data.files && data.files.length > 0 && !currentAppleIdFile) {
                            console.log('自动选择第一个文件:', data.files[0].name);
                            selectAppleIdFile(data.files[0].name);
                        } else if (data.files && data.files.length > 0 && currentAppleIdFile) {
                            // 如果已经有选中的文件，确保统计信息是最新的
                            console.log('刷新文件列表后更新统计信息');
                            updateAppleIdStats();
                        }
                    } else {
                        console.error('获取Apple ID文件列表失败:', data.message);
                    }
                })
                .catch(error => {
                    console.error('网络错误:', error.message);
                });
        }

        // 更新Apple ID文件下拉菜单
        function updateAppleIdFileSelect(files) {
            console.log('更新Apple ID文件下拉菜单，文件列表:', files);
            const dropdownMenu = document.getElementById('appleIdFileDropdownMenu');
            if (!dropdownMenu) {
                console.error('找不到appleIdFileDropdownMenu元素');
                return;
            }
            
            dropdownMenu.innerHTML = '';
            
            if (files && files.length > 0) {
                files.forEach(file => {
                    const li = document.createElement('li');
                    const isActive = file.name === currentAppleIdFile;
                    li.innerHTML = `<a class="dropdown-item ${isActive ? 'active' : ''}" href="#" onclick="selectAppleIdFile('${file.name}')">${file.display_name || file.name}</a>`;
                    dropdownMenu.appendChild(li);
                });
                console.log(`成功加载 ${files.length} 个Apple ID文件`);
                
                // 更新下拉菜单样式
                updateAppleIdFileDropdownStyles();
                
                // 确保复选框状态正确
                const defaultFile = localStorage.getItem('defaultAppleIdFile');
                if (defaultFile && currentAppleIdFile === defaultFile) {
                    const checkbox = document.getElementById('defaultAppleIdFileCheck');
                    if (checkbox) {
                        checkbox.checked = true;
                        console.log('文件列表加载完成，自动勾选默认文件复选框');
                    }
                }
            } else {
                console.log('没有找到Apple ID文件');
                // 添加一个提示选项
                const li = document.createElement('li');
                li.innerHTML = `<a class="dropdown-item disabled" href="#" style="color: #6c757d !important; font-style: italic;">暂无Apple ID文件</a>`;
                dropdownMenu.appendChild(li);
            }
        }

        // 更新Apple ID文件下拉菜单样式
        function updateAppleIdFileDropdownStyles() {
            document.querySelectorAll('#appleIdFileDropdownMenu .dropdown-item').forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (!onclick) return; // 跳过没有onclick的元素（如提示信息）
                
                const match = onclick.match(/'([^']+)'/);
                if (!match) return; // 跳过无法匹配的元素
                
                const itemFileName = match[1];
                const isActive = itemFileName === currentAppleIdFile;
                
                // 更新class
                item.classList.remove('active');
                if (isActive) {
                    item.classList.add('active');
                }
                
                // 强制应用样式，使用!important
                if (isActive) {
                    // 激活状态：蓝色样式
                    item.setAttribute('style', `
                        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
                        color: white !important;
                        border: 1px solid #0056b3 !important;
                        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3) !important;
                        transform: translateX(3px) !important;
                        font-weight: 600 !important;
                        font-size: 14px !important;
                    `);
                } else {
                    // 未激活状态：白色样式
                    item.setAttribute('style', `
                        color: #333 !important;
                        background-color: white !important;
                        font-weight: normal !important;
                        border: none !important;
                        box-shadow: none !important;
                        transform: none !important;
                        font-size: 14px !important;
                    `);
                }
            });
            
            // 更新默认配置复选框状态
            updateDefaultAppleIdFileCheckbox();
        }

        // 选择Apple ID文件
        function selectAppleIdFile(filename) {
            console.log('选择的Apple ID文件:', filename);
            
            if (!filename) {
                document.getElementById('appleIdDataContainer').style.display = 'none';
                return;
            }

            // 保存当前文件名
            currentFileName = filename;
            currentAppleIdFile = filename; // 更新当前选择的Apple ID文件
            
            console.log('更新当前文件为:', currentAppleIdFile);

            // 更新下拉框显示
            const dropdownButton = document.getElementById('appleIdFileDropdown');
            const files = Array.from(document.querySelectorAll('#appleIdFileDropdownMenu .dropdown-item')).map(item => {
                const onclick = item.getAttribute('onclick');
                if (onclick) {
                    const match = onclick.match(/'([^']+)'/);
                    if (match) {
                        return {
                            name: match[1],
                            display_name: item.textContent
                        };
                    }
                }
                return null;
            }).filter(file => file !== null);
            
            const selectedFile = files.find(f => f.name === filename);
            if (selectedFile) {
                dropdownButton.innerHTML = `<i class="fas fa-file me-2"></i>已选择：${selectedFile.display_name}`;
            }
            
            // 立即更新所有下拉框选项的样式
            document.querySelectorAll('#appleIdFileDropdownMenu .dropdown-item').forEach(item => {
                const onclick = item.getAttribute('onclick');
                if (!onclick) return; // 跳过没有onclick的元素（如提示信息）
                
                const match = onclick.match(/'([^']+)'/);
                if (!match) return;
                
                const itemFileName = match[1];
                const isActive = itemFileName === filename;
                
                // 更新class
                item.classList.remove('active');
                if (isActive) {
                    item.classList.add('active');
                }
                
                // 强制应用样式，使用!important
                if (isActive) {
                    // 激活状态：蓝色样式
                    item.setAttribute('style', `
                        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%) !important;
                        color: white !important;
                        border: 1px solid #0056b3 !important;
                        box-shadow: 0 2px 4px rgba(0, 123, 255, 0.3) !important;
                        transform: translateX(3px) !important;
                        font-weight: 600 !important;
                        font-size: 14px !important;
                    `);
                } else {
                    // 未激活状态：白色样式
                    item.setAttribute('style', `
                        color: #333 !important;
                        background-color: white !important;
                        font-weight: normal !important;
                        border: none !important;
                        box-shadow: none !important;
                        transform: none !important;
                        font-size: 14px !important;
                    `);
                }
            });
            
            // 更新下拉按钮文本
            updateDropdownButtonText();
            
            // 立即更新默认配置复选框状态
            console.log('调用updateDefaultAppleIdFileCheckbox前 - 当前文件:', currentAppleIdFile);
            updateDefaultAppleIdFileCheckbox();
            console.log('调用updateDefaultAppleIdFileCheckbox后 - 复选框状态:', document.getElementById('defaultAppleIdFileCheck').checked);
            
            // 检查当前文件是否为默认文件
            const defaultFile = localStorage.getItem('defaultAppleIdFile');
            console.log('调试信息 - 默认文件:', defaultFile, '当前文件:', currentAppleIdFile, '是否匹配:', defaultFile === currentAppleIdFile);
            
            if (defaultFile === currentAppleIdFile) {
                // 如果当前文件是默认文件，确保复选框勾选
                const checkbox = document.getElementById('defaultAppleIdFileCheck');
                if (checkbox && !checkbox.checked) {
                    checkbox.checked = true;
                    console.log('当前选择的文件是默认文件，自动勾选复选框');
                }
            } else {
                // 如果当前文件不是默认文件，自动将其设置为默认文件并勾选复选框
                localStorage.setItem('defaultAppleIdFile', currentAppleIdFile);
                console.log('当前选择的文件不是默认文件，自动设置为默认文件:', currentAppleIdFile);
                
                const checkbox = document.getElementById('defaultAppleIdFileCheck');
                if (checkbox) {
                    checkbox.checked = true;
                    console.log('自动勾选复选框');
                }
                
                // 显示友好的提示信息
                const files = Array.from(document.querySelectorAll('#appleIdFileDropdownMenu .dropdown-item')).map(item => {
                    const onclick = item.getAttribute('onclick');
                    if (onclick) {
                        const match = onclick.match(/'([^']+)'/);
                        if (match) {
                            return {
                                name: match[1],
                                display_name: item.textContent
                            };
                        }
                    }
                    return null;
                }).filter(file => file !== null);
                
                const selectedFile = files.find(f => f.name === currentAppleIdFile);
                if (selectedFile) {
                    showToast(`已自动将 ${selectedFile.display_name} 设为默认文件`, 'success');
                }
            }

            // 显示加载状态
            document.getElementById('appleIdDataContainer').style.display = 'block';
            const tbody = document.getElementById('previewTableBody');
                        tbody.innerHTML = '<tr><td colspan="7" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>正在加载文件内容...</td></tr>';

            // 加载文件内容
            loadAppleIdFileContent(filename);
        }



        // 显示文件内容
        function displayFileContent(content) {
            console.log('显示文件内容，行数:', content.length);
            const tbody = document.getElementById('previewTableBody');
            if (!tbody) {
                console.error('找不到previewTableBody元素');
                return;
            }
            
            // 保存所有数据用于分页
            allAppleIdData = [];
            if (content && content.length > 0) {
                content.forEach((line, index) => {
                    const parts = line.split('----');
                    if (parts.length >= 4) {
                        allAppleIdData.push({
                            account: parts[0],
                            password: parts[1],
                            phone: parts[2], // 手机号码字段
                            smsAddress: parts[3],
                            status: 'valid', // 默认状态为有效
                            originalLine: line,
                            lineIndex: index
                        });
                    } else {
                        console.warn(`第${index + 1}行格式错误:`, line);
                    }
                });
            } else {
                // 当文件为空时，显示友好提示
                console.log('文件内容为空，显示空状态提示');
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted">
                    <i class="fas fa-inbox me-2"></i>当前文件为空，暂无可用ID
                </td></tr>`;
                return;
            }
            
            // 重置分页
            currentPage = 1;
            // 确保分页选择器值与当前设置一致
            document.getElementById('pageSizeSelect').value = pageSize;
            displayCurrentPage();
            updateAppleIdStats(); // 更新统计信息
        }



        // 更新Apple ID统计信息
        function updateAppleIdStats() {
            // 获取当前选择的文件名
            const selectedFilename = currentAppleIdFile || 'test.txt';
            
            console.log('更新统计信息，当前选择的文件:', selectedFilename);
            
            // 从服务器获取统计信息，传递文件名参数
            fetch(`/api/appleid_stats?filename=${encodeURIComponent(selectedFilename)}`)
                .then(response => {
                    console.log('统计API响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('统计API响应数据:', data);
                    if (data.success) {
                        console.log('统计信息更新成功:', data.stats);
                        document.getElementById('totalAppleIds').textContent = data.stats.total;
                        document.getElementById('validAppleIds').textContent = data.stats.valid;
                        document.getElementById('invalidAppleIds').textContent = data.stats.invalid;
                        document.getElementById('usedAppleIds').textContent = data.stats.used;
                    } else {
                        console.error('获取统计信息失败:', data.message);
                        // 如果获取失败，使用本地数据
                        const totalCount = allAppleIdData.length;
                        const validCount = allAppleIdData.filter(item => item.status === 'valid').length;
                        const invalidCount = allAppleIdData.filter(item => item.status === 'invalid').length;
                        const usedCount = 0;
                        
                        console.log('使用本地数据作为统计信息:', {totalCount, validCount, invalidCount, usedCount});
                        document.getElementById('totalAppleIds').textContent = totalCount;
                        document.getElementById('validAppleIds').textContent = validCount;
                        document.getElementById('invalidAppleIds').textContent = invalidCount;
                        document.getElementById('usedAppleIds').textContent = usedCount;
                    }
                })
                .catch(error => {
                    console.error('获取统计信息网络错误:', error);
                    // 如果网络错误，使用本地数据
                    const totalCount = allAppleIdData.length;
                    const validCount = allAppleIdData.filter(item => item.status === 'valid').length;
                    const invalidCount = allAppleIdData.filter(item => item.status === 'invalid').length;
                    const usedCount = 0;
                    
                    console.log('网络错误，使用本地数据作为统计信息:', {totalCount, validCount, invalidCount, usedCount});
                    document.getElementById('totalAppleIds').textContent = totalCount;
                    document.getElementById('validAppleIds').textContent = validCount;
                    document.getElementById('invalidAppleIds').textContent = invalidCount;
                    document.getElementById('usedAppleIds').textContent = usedCount;
                });
        }

        // 加载Apple ID文件内容
        function loadAppleIdFileContent(filename) {
            console.log('开始加载Apple ID文件内容:', filename);
            
            fetch(`/api/appleid_file_content?file=${encodeURIComponent(filename)}`)
                .then(response => response.json())
                .then(data => {
                    console.log('文件内容响应:', data);
                    if (data.success) {
                        // 显示文件内容
                        displayFileContent(data.content);
                    } else {
                        console.error('获取文件内容失败:', data.message);
                        const tbody = document.getElementById('previewTableBody');
                        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>加载失败：${data.message}
                        </td></tr>`;
                    }
                })
                .catch(error => {
                    console.error('网络错误:', error);
                    const tbody = document.getElementById('previewTableBody');
                    tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>网络错误：${error.message}
                    </td></tr>`;
                });
        }

        // 显示当前页数据
        function displayCurrentPage() {
            const tbody = document.getElementById('previewTableBody');
            tbody.innerHTML = '';
            
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, allAppleIdData.length);
            const currentPageData = allAppleIdData.slice(startIndex, endIndex);
            
            console.log('显示当前页数据:', {
                currentPage: currentPage,
                pageSize: pageSize,
                startIndex: startIndex,
                endIndex: endIndex,
                totalData: allAppleIdData.length,
                currentPageDataLength: currentPageData.length
            });
            
            if (currentPageData.length > 0) {
                currentPageData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${startIndex + index + 1}</td>
                        <td>
                            <i class="fas fa-user me-1" style="color: #000000;"></i><span class="truncated-text" title="${item.account}">${truncateText(item.account, 20)}</span>
                        </td>
                        <td>
                            <i class="fas fa-key me-1" style="color: #000000;"></i><span class="truncated-text" title="${item.password}">${truncateText(item.password, 15)}</span>
                        </td>
                        <td>
                            <i class="fas fa-phone me-1" style="color: #000000;"></i><span class="truncated-text" title="${item.phone || ''}">${truncateText(item.phone || '', 15)}</span>
                        </td>
                        <td>
                            <i class="fas fa-link me-1" style="color: #000000; cursor: pointer;" onclick="copyToClipboard(\`${item.smsAddress}\`, this)" title="点击复制完整链接"></i>
                            <span class="truncated-link" title="${item.smsAddress.replace(/"/g, '&quot;')}">${truncateUrl(item.smsAddress)}</span>
                        </td>
                        <td style="text-align: center;">
                            <span class="badge bg-${getStatusBadgeClass(item.status)}">${getStatusDisplayName(item.status)}</span>
                        </td>
                        <td style="text-align: center;">
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteAppleId(${startIndex + index})" title="删除">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                
                // 显示分页控件
                document.getElementById('paginationContainer').style.display = 'flex';
                updatePagination();
            } else {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">没有有效的Apple ID数据</td></tr>';
                document.getElementById('paginationContainer').style.display = 'none';
            }
            
            document.getElementById('appleIdDataContainer').style.display = 'block';
        }

        // 获取状态显示名称
        function getStatusDisplayName(status) {
            const statusMap = {
                'valid': '有效',
                'invalid': '无效'
            };
            return statusMap[status] || status;
        }

        // 获取状态徽章样式
        function getStatusBadgeClass(status) {
            const badgeMap = {
                'valid': 'success',
                'invalid': 'danger'
            };
            return badgeMap[status] || 'secondary';
        }
        
        // 截断URL显示
        function truncateUrl(url) {
            if (!url) return '';
            
            // 如果URL长度超过50个字符，则截断显示
            if (url.length > 50) {
                const start = url.substring(0, 25);
                const end = url.substring(url.length - 20);
                return `${start}...${end}`;
            }
            return url;
        }
        
        // 截断文本显示
        function truncateText(text, maxLength) {
            if (!text) return '';
            
            // 如果文本长度超过指定长度，则截断显示
            if (text.length > maxLength) {
                return text.substring(0, maxLength) + '...';
            }
            return text;
        }
        
        // 复制文本到剪贴板
        function copyToClipboard(text, element) {
            // 创建临时输入框
            const tempInput = document.createElement('textarea');
            tempInput.value = text;
            document.body.appendChild(tempInput);
            
            // 选择文本并复制
            tempInput.select();
            tempInput.setSelectionRange(0, 99999); // 兼容移动设备
            
            try {
                document.execCommand('copy');
                
                // 显示复制成功提示
                showToast('链接已复制到剪贴板', 'success');
                
                // 添加临时的高亮效果
                if (element) {
                    element.style.color = '#28a745';
                    element.style.transform = 'scale(1.2)';
                    element.style.transition = 'all 0.3s ease';
                    
                    setTimeout(() => {
                        element.style.color = '#000000';
                        element.style.transform = 'scale(1)';
                    }, 500);
                }
            } catch (err) {
                console.error('复制失败:', err);
                showToast('复制失败，请手动复制', 'danger');
            }
            
            // 移除临时输入框
            document.body.removeChild(tempInput);
        }

        // 更新分页信息
        function updatePagination() {
            const totalPages = Math.ceil(allAppleIdData.length / pageSize);
            const startRecord = (currentPage - 1) * pageSize + 1;
            const endRecord = Math.min(currentPage * pageSize, allAppleIdData.length);
            
            document.getElementById('startRecord').textContent = startRecord;
            document.getElementById('endRecord').textContent = endRecord;
            document.getElementById('totalRecords').textContent = allAppleIdData.length;
            
            // 更新分页控件
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // 上一页按钮
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>`;
            pagination.appendChild(prevLi);
            
            // 页码按钮
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
                pagination.appendChild(pageLi);
            }
            
            // 下一页按钮
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>`;
            pagination.appendChild(nextLi);
        }

        // 切换页面
        function changePage(page) {
            if (page < 1 || page > Math.ceil(allAppleIdData.length / pageSize)) return;
            currentPage = page;
            displayCurrentPage();
        }

        // 改变每页显示数量
        function changePageSize() {
            pageSize = parseInt(document.getElementById('pageSizeSelect').value);
            currentPage = 1;
            console.log('分页大小已更改为:', pageSize);
            displayCurrentPage();
        }



        // 删除Apple ID数据
        function deleteAppleId(index) {
            console.log('🔵 deleteAppleId函数被调用，行索引:', index);
            console.log('当前文件:', currentAppleIdFile);
            
            try {
                // 检查模态框元素是否存在
                const modalElement = document.getElementById('deleteConfirmModal');
                if (!modalElement) {
                    console.error('❌ 删除确认模态框不存在');
                    alert('删除确认对话框不存在，请刷新页面重试');
                    return;
                }
                
                // 检查隐藏输入字段是否存在
                const hiddenInput = document.getElementById('deleteAppleIdIndex');
                if (!hiddenInput) {
                    console.error('❌ 删除索引隐藏字段不存在');
                    alert('删除索引字段不存在，请刷新页面重试');
                    return;
                }
                
                // 设置删除索引
                hiddenInput.value = index;
                console.log('设置删除索引:', index);
                
                // 显示删除确认对话框
                const deleteModal = new bootstrap.Modal(modalElement);
                console.log('显示删除确认对话框...');
                deleteModal.show();
                
                console.log('✅ 删除确认对话框已显示');
                
                // 添加模态框事件监听
                modalElement.addEventListener('shown.bs.modal', function() {
                    console.log('✅ 模态框已完全显示');
                });
                
                modalElement.addEventListener('hidden.bs.modal', function() {
                    console.log('✅ 模态框已隐藏');
                });
                
            } catch (error) {
                console.error('删除功能出错:', error);
                alert('删除功能出错: ' + error.message);
            }
        }
        
        // 确认删除
        function confirmDelete() {
            console.log('🔴 confirmDelete函数被调用');
            
            try {
                const index = document.getElementById('deleteAppleIdIndex').value;
                const deleteModal = bootstrap.Modal.getInstance(document.getElementById('deleteConfirmModal'));
                
                console.log('确认删除，行索引:', index);
                console.log('当前文件:', currentAppleIdFile);
                
                // 显示加载状态
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                const originalText = confirmBtn.innerHTML;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>删除中...';
                confirmBtn.disabled = true;
                
                // 获取要删除的数据
                const itemToDelete = allAppleIdData[parseInt(index)];
                if (!itemToDelete) {
                    console.error('找不到要删除的数据');
                    showToast('删除失败：找不到要删除的数据', 'danger');
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    return;
                }
                
                const requestData = {
                    account: itemToDelete.account,
                    password: itemToDelete.password,
                    phone: itemToDelete.phone,
                    smsAddress: itemToDelete.smsAddress,
                    original_line: itemToDelete.originalLine,
                    line_index: itemToDelete.lineIndex,
                    file_name: currentAppleIdFile
                };
                
                console.log('发送删除请求:', requestData);
                
                // 发送删除请求
                fetch('/api/appleid_delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    credentials: 'same-origin',
                    body: JSON.stringify(requestData)
                })
                .then(response => {
                    console.log('删除响应状态:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('删除响应数据:', data);
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    
                    if (data.success) {
                        console.log('✅ 删除成功！');
                        showToast('删除成功！数据已移动到ID_delete目录', 'success');
                        
                        // 确保模态框正确关闭
                        if (deleteModal) {
                            deleteModal.hide();
                        }
                        
                        // 重新加载数据
                        setTimeout(() => {
                            loadAppleIdFiles();
                        }, 500);
                    } else {
                        console.log('❌ 删除失败:', data.message);
                        showToast('删除失败：' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('删除请求错误:', error);
                    console.error('错误详情:', error.message);
                    confirmBtn.innerHTML = originalText;
                    confirmBtn.disabled = false;
                    showToast('删除失败：网络错误', 'danger');
                });
            } catch (error) {
                console.error('确认删除功能出错:', error);
                console.error('错误堆栈:', error.stack);
                showToast('删除功能出错: ' + error.message, 'danger');
                
                // 重置按钮状态
                const confirmBtn = document.getElementById('confirmDeleteBtn');
                if (confirmBtn) {
                    confirmBtn.innerHTML = '<i class="fas fa-trash me-2"></i>确认删除';
                    confirmBtn.disabled = false;
                }
            }
        }

        // 打开上传Apple ID文件模态框
        function openUploadAppleIdModal() {
            // 重置表单
            document.getElementById('appleIdFile').value = '';
            document.getElementById('customAppleIdFilename').value = '';
            document.getElementById('appleIdFileValidationMessage').innerHTML = '';
            document.getElementById('uploadAppleIdBtn').disabled = true;
            document.getElementById('appleIdFilenameSection').style.display = 'none';
            
            // 显示模态框
            const modal = new bootstrap.Modal(document.getElementById('uploadAppleIdModal'));
            modal.show();
        }

        // 验证Apple ID文件格式
        function validateAppleIdFile() {
            const fileInput = document.getElementById('appleIdFile');
            const file = fileInput.files[0];
            const validationMessage = document.getElementById('appleIdFileValidationMessage');
            const uploadBtn = document.getElementById('uploadAppleIdBtn');
            const filenameSection = document.getElementById('appleIdFilenameSection');
            
            if (!file) {
                validationMessage.innerHTML = '<div class="alert alert-warning">请选择文件</div>';
                uploadBtn.disabled = true;
                filenameSection.style.display = 'none';
                return;
            }
            
            // 检查文件扩展名
            const fileName = file.name.toLowerCase();
            if (!fileName.endsWith('.txt') && !fileName.endsWith('.csv')) {
                validationMessage.innerHTML = '<div class="alert alert-danger">只支持 .txt 和 .csv 格式的文件</div>';
                uploadBtn.disabled = true;
                filenameSection.style.display = 'none';
                return;
            }
            
            // 读取文件内容进行验证
            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                const lines = content.split('\n');
                let validLines = 0;
                let invalidLines = 0;
                let errorMessages = [];
                
                for (let i = 0; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line === '') continue;
                    
                    const parts = line.split('----');
                    if (parts.length === 4) {
                        // 检查每个字段是否不为空
                        if (parts[0].trim() && parts[1].trim() && parts[2].trim() && parts[3].trim()) {
                            validLines++;
                        } else {
                            invalidLines++;
                            errorMessages.push(`第${i + 1}行：字段不能为空`);
                        }
                    } else {
                        invalidLines++;
                        errorMessages.push(`第${i + 1}行：格式错误，需要4个字段用----分隔`);
                    }
                }
                
                if (validLines > 0) {
                    validationMessage.innerHTML = `
                        <div class="alert alert-success">
                            <i class="fas fa-check-circle me-2"></i>
                            文件验证通过！<br>
                            有效行数：${validLines} 行<br>
                            ${invalidLines > 0 ? `无效行数：${invalidLines} 行` : ''}
                        </div>
                    `;
                    uploadBtn.disabled = false;
                    filenameSection.style.display = 'block';
                    
                    // 设置默认文件名
                    const customFilename = document.getElementById('customAppleIdFilename');
                    if (!customFilename.value) {
                        const baseName = file.name.replace(/\.(txt|csv)$/i, '');
                        customFilename.value = baseName;
                    }
                } else {
                    validationMessage.innerHTML = `
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            文件格式错误！<br>
                            无效行数：${invalidLines} 行<br>
                            错误详情：${errorMessages.slice(0, 3).join('<br>')}
                            ${errorMessages.length > 3 ? '<br>...' : ''}
                        </div>
                    `;
                    uploadBtn.disabled = true;
                    filenameSection.style.display = 'none';
                }
            };
            
            reader.readAsText(file);
        }

        // 提交Apple ID文件上传
        function submitAppleIdUpload() {
            const fileInput = document.getElementById('appleIdFile');
            const customFilename = document.getElementById('customAppleIdFilename');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('请选择文件');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', file);
            
            // 如果用户输入了自定义文件名
            if (customFilename.value.trim()) {
                formData.append('custom_filename', customFilename.value.trim());
            }
            
            // 显示上传进度
            const uploadBtn = document.getElementById('uploadAppleIdBtn');
            const originalText = uploadBtn.innerHTML;
            uploadBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>上传中...';
            uploadBtn.disabled = true;
            
            fetch('/api/appleid_upload', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Apple ID文件上传成功！');
                    // 关闭模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('uploadAppleIdModal'));
                    modal.hide();
                    // 刷新文件列表
                    loadAppleIdFiles();
                } else {
                    alert('上传失败: ' + data.message);
                }
            })
            .catch(error => {
                alert('上传失败: ' + error.message);
            })
            .finally(() => {
                uploadBtn.innerHTML = originalText;
                uploadBtn.disabled = false;
            });
        }











        // 显示加载状态
        function showLoading() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('appleIdDataContainer').style.display = 'none';
        }

        // 隐藏加载状态
        function hideLoading() {
            document.getElementById('loading').style.display = 'none';
        }

        // 显示错误信息
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
        }

        // 隐藏错误信息
        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // 显示表格容器
        function showTableContainer() {
            document.getElementById('appleIdDataContainer').style.display = 'block';
        }

        // 加载默认Apple ID文件
        function loadDefaultAppleIdFile() {
            const defaultFile = localStorage.getItem('defaultAppleIdFile');
            if (defaultFile) {
                console.log('加载默认Apple ID文件:', defaultFile);
                // 直接选择默认文件，因为文件列表应该已经加载完成
                selectAppleIdFile(defaultFile);
            } else {
                // 如果没有默认文件，更新按钮文本为初始状态
                updateDropdownButtonText();
            }
        }

        // 切换默认Apple ID文件
        function toggleDefaultAppleIdFile() {
            const checkbox = document.getElementById('defaultAppleIdFileCheck');
            const isChecked = checkbox.checked;
            
            if (isChecked) {
                // 设置为默认文件
                localStorage.setItem('defaultAppleIdFile', currentAppleIdFile);
                console.log('设置默认Apple ID文件:', currentAppleIdFile);
                
                // 更新下拉按钮文本，显示当前文件已被设为默认
                updateDropdownButtonText();
            } else {
                // 取消默认文件
                localStorage.removeItem('defaultAppleIdFile');
                console.log('取消默认Apple ID文件');
                
                // 更新下拉按钮文本，移除默认标识
                updateDropdownButtonText();
            }
        }

        // 更新默认Apple ID文件复选框状态
        function updateDefaultAppleIdFileCheckbox() {
            const checkbox = document.getElementById('defaultAppleIdFileCheck');
            const defaultFile = localStorage.getItem('defaultAppleIdFile');
            
            console.log('调试信息 - 当前文件:', currentAppleIdFile);
            console.log('调试信息 - 默认文件:', defaultFile);
            console.log('调试信息 - 是否匹配:', defaultFile === currentAppleIdFile);
            console.log('调试信息 - 复选框元素:', checkbox);
            
            if (!checkbox) {
                console.error('找不到复选框元素');
                return;
            }
            
            if (defaultFile === currentAppleIdFile) {
                checkbox.checked = true;
                console.log('复选框状态：已勾选（当前文件为默认）');
            } else {
                checkbox.checked = false;
                console.log('复选框状态：未勾选（当前文件不是默认）');
            }
        }

        // 显示提示信息
        function showToast(message, type = 'info') {
            // 创建提示元素
            const toast = document.createElement('div');
            toast.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            toast.style.cssText = `
                top: 20px;
                right: 20px;
                z-index: 9999;
                min-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            toast.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            
            // 添加到页面
            document.body.appendChild(toast);
            
            // 3秒后自动移除
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }

        // 更新下拉按钮文本
        function updateDropdownButtonText() {
            const dropdownButton = document.getElementById('appleIdFileDropdown');
            const files = Array.from(document.querySelectorAll('#appleIdFileDropdownMenu .dropdown-item')).map(item => {
                const onclick = item.getAttribute('onclick');
                if (!onclick) return null;
                
                const match = onclick.match(/'([^']+)'/);
                if (!match) return null;
                
                return {
                    name: match[1],
                    display_name: item.textContent
                };
            }).filter(file => file !== null);
            
            if (files.length === 0) {
                dropdownButton.innerHTML = `<i class="fas fa-file-text me-2"></i>暂无Apple ID文件`;
                return;
            }
            
            // 查找当前选中的文件
            const selectedFile = files.find(f => f.name === currentAppleIdFile);
            if (selectedFile) {
                dropdownButton.innerHTML = `<i class="fas fa-file-text me-2"></i>已选择：${selectedFile.display_name}`;
            } else {
                // 如果没有找到当前文件，选择第一个
                currentAppleIdFile = files[0].name;
                dropdownButton.innerHTML = `<i class="fas fa-file-text me-2"></i>已选择：${files[0].display_name}`;
            }
        }

    </script>
</body>
</html>