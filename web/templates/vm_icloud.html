{% extends "base.html" %}

{% block title %}VM 虚拟机管理平台 - iCloud管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="card-title mb-0">iCloud进程管理</h4>
                </div>
                <div class="col-auto">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="addNewProcess()">
                            <i class="fas fa-plus"></i> 添加进程
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <style>
                    /* 表格列固定宽度和超长隐藏样式 */
                    #processTable th {
                        white-space: nowrap;        /* 列名单行显示 */
                        overflow: hidden;           /* 内容超长隐藏 */
                        text-overflow: ellipsis;    /* 超长显示省略号 */
                        text-align: center;         /* 列名居中 */
                    }
                    #processTable td {
                        white-space: nowrap;        /* 数据单行显示 */
                        overflow: hidden;           /* 内容超长隐藏 */
                        text-overflow: ellipsis;    /* 超长显示省略号 */
                        max-width: 150px;           /* 设置最大宽度 */
                    }
                    /* 为不同列设置固定宽度 */
                    #processTable th:nth-child(1), #processTable td:nth-child(1) { width: 200px; text-align: left; }
                    #processTable th:nth-child(2), #processTable td:nth-child(2) { width: 150px; text-align: left; }
                    #processTable th:nth-child(3), #processTable td:nth-child(3) { width: 80px; text-align: center; }
                    #processTable th:nth-child(4), #processTable td:nth-child(4) { width: 160px; text-align: left; }
                    #processTable th:nth-child(5), #processTable td:nth-child(5) { width: 300px; text-align: center; }
                    /* 操作按钮列保持内容完整显示 */
                    #processTable td:nth-child(5) {
                        overflow: visible;
                        white-space: normal;
                        max-width: none;
                        text-align: center;
                    }
                    /* 优化按钮组布局 */
                    .btn-group-sm .btn {
                        font-size: 0.75rem;
                        padding: 0.25rem 0.5rem;
                        margin: 0 1px;
                    }
                    /* 表格单元格内容居中 */
                    #processTable td {
                        vertical-align: middle;
                    }
                </style>
                <table class="table table-striped table-hover" id="processTable">
                    <thead>
                        <tr>
                            <th>进程名称</th>
                            <th>进程ID</th>
                            <th>状态</th>
                            <th>创建时间</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody">
                    </tbody>
                </table>
                <!-- 分页控件 -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">
                        共 <span id="totalItems">0</span> 条记录
                    </div>
                    <ul class="pagination mb-0" id="pagination">
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑进程模态框 -->
<div class="modal fade" id="processModal" tabindex="-1" aria-labelledby="processModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processModalLabel">添加进程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="processForm">
                    <div class="row mb-3">
                        <label for="processName" class="col-sm-3 col-form-label text-end">进程名称：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="processName" required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="processClient" class="col-sm-3 col-form-label text-end">进程客户端：</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <select class="form-control" id="processClient" required>
                                    <option value="">请选择客户端</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" onclick="loadClients()" id="refreshClientsBtn">
                                    <i class="fas fa-sync-alt" id="refreshClientsIcon"></i>
                                    <span id="clientsLoadingIndicator" class="d-none">加载中...</span>
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="appleId" class="col-sm-3 col-form-label text-end">Apple ID文本：</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <select class="form-control" id="appleId" required>
                                    <option value="">请选择Apple ID</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" onclick="refreshAppleIds()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                    <!-- 新增脚本选择区域 -->
                    <div class="row mb-3">
                        <label class="col-sm-3 col-form-label text-end">脚本选择：</label>
                        <div class="col-sm-8">
                            <div class="input-group mb-2">
                                <input type="text" class="form-control" id="scriptInput" placeholder="请选择脚本" readonly>
                                <button type="button" class="btn btn-primary" onclick="showScriptListModal()">
                                    <i class="fas fa-plus"></i> 添加
                                </button>
                            </div>
                            <!-- 已选择的脚本列表 -->
                            <div id="selectedScriptsList" class="mt-2">
                                <p class="text-muted">暂未选择任何脚本</p>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveProcess()">保存</button>
            </div>
        </div>
    </div>
</div>

<!-- 脚本列表模态框 -->
<div class="modal fade" id="scriptListModal" tabindex="-1" aria-labelledby="scriptListModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="scriptListModalLabel">选择脚本</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <div class="input-group">
                        <input type="text" id="scriptSearch" class="form-control" placeholder="搜索脚本...">
                        <button class="btn btn-outline-secondary" type="button" onclick="loadScriptList()">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div id="scriptListLoading" class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                </div>
                <div id="scriptListError" class="alert alert-danger d-none"></div>
                <div id="scriptListContent" class="list-group d-none"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>



<!-- 进程详情模态框 -->
<div class="modal fade" id="processDetailModal" tabindex="-1" aria-labelledby="processDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processDetailModalLabel">进程详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="processDetailContent">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/JavaScript">
// 直接在全局作用域定义所有函数
// 注意：addNewProcess函数的完整实现已在页面上方定义，请不要重复定义

// 旧版脚本选择功能的函数（保留但标记为废弃）
function showStaticScripts() {
    console.warn('showStaticScripts函数已废弃，请使用showScriptListModal代替');
}

function selectScript(scriptName) {
    console.warn('selectScript函数已废弃，请使用toggleScriptSelection代替');
}

function changePage(page) {
    if (page < 1 || page > Math.ceil(totalItems / itemsPerPage)) return;
    currentPage = page;
    renderProcessList();
}

function startProcess(processId) {
    if (!confirm('确定要启动该进程吗？')) return;
    fetch('/api/icloud/process/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.message);
        if (data.success) loadProcessList();
    })
    .catch(error => {
        console.error('启动进程失败:', error);
        console.log('启动进程失败，请检查网络连接');
    });
}

function stopProcess(processId) {
    if (!confirm('确定要停止该进程吗？')) return;
    fetch('/api/icloud/process/stop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        console.log(data.message);
        if (data.success) loadProcessList();
    })
    .catch(error => {
        console.error('停止进程失败:', error);
        console.log('停止进程失败，请检查网络连接');
    });
}

function deleteProcess(processId) {
    // 添加确认对话框
    if (!confirm(`确定要删除进程(ID:${processId})吗？此操作不可撤销。`)) {
        console.log('===== 进程删除操作取消 =====');
        return;
    }
    
    // 详细记录操作信息
    console.log('===== 进程删除操作开始 =====');
    console.log('目标进程ID:', processId);
    console.log('操作类型: 从后端数据库永久删除进程记录');
    
    // 检查当前列表中是否存在该进程
    const processExists = allProcesses.some(p => p.id === processId);
    console.log('当前前端列表中进程是否存在:', processExists);
    
    // 执行删除操作
    console.log('准备发送删除请求到后端...');
    
    fetch('/api/icloud/process/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => {
        console.log('API响应状态:', response.status, response.statusText);
        
        // 获取完整响应信息
        const contentType = response.headers.get('content-type');
        console.log('响应内容类型:', contentType);
        
        return response.json().catch(err => {
            console.error('JSON解析错误:', err);
            return {
                success: false,
                message: `无法解析API响应，HTTP状态: ${response.status}`
            };
        });
    })
    .then(data => {
        console.log('删除结果数据:', JSON.stringify(data, null, 2));
        
        if (data && data.success) {
            console.log('✅ 进程删除成功');
            console.log('成功消息:', data.message || '无详细消息');
            
            // 立即从前端列表中移除该项（无需等待重新加载）
            console.log('立即从前端列表中移除进程...');
            const initialLength = allProcesses.length;
            allProcesses = allProcesses.filter(p => p.id !== processId);
            console.log(`前端列表更新: 从${initialLength}个进程减少到${allProcesses.length}个进程`);
            
            console.log('重新渲染进程列表...');
            totalItems = allProcesses.length;
            document.getElementById('totalItems').textContent = totalItems;
            renderProcessList();
            renderPagination();
            
            console.log('同时调用loadProcessList确保与后端完全同步...');
            loadProcessList();
        } else {
            console.log('❌ 进程删除失败');
            console.log('失败原因:', data && data.message ? data.message : '未知错误');
            // 显示错误提示
            alert(`删除失败: ${data && data.message ? data.message : '未知错误'}`);
        }
        console.log('===== 进程删除操作结束 =====');
    })
    .catch(error => {
        console.error('❌ 删除进程时发生网络或请求错误:', error);
        console.log('错误类型:', error.name);
        console.log('错误消息:', error.message);
        console.log('错误堆栈:', error.stack);
        alert(`网络错误: ${error.message}`);
        console.log('===== 进程删除操作异常结束 =====');
    });
}

function showProcessDetail(processId) {
    fetch(`/api/icloud/process/detail/${processId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const process = data.data;
                const detailContent = document.getElementById('processDetailContent');
                // 转义特殊字符，防止XSS和模板字符串错误
                const escapeHtml = (unsafe) => {
                    return unsafe
                        .replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");
                };
                
                // 正确构建模板字符串
                detailContent.innerHTML = `
                <div class="process-detail-container text-sm">
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <tr><th style="width: 150px;">进程名称</th><td>${escapeHtml(process.name)}</td></tr>
                            <tr><th>进程ID</th><td>${escapeHtml(process.id)}</td></tr>
                            <tr><th>进程脚本</th><td><pre class="mb-0"><code>${escapeHtml(process.script || '')}</code></pre></td></tr>
                            <tr><th>进程客户端</th><td>${escapeHtml(process.client || '')}</td></tr>
                            <tr><th>Apple ID</th><td>${escapeHtml(process.apple_id || '')}</td></tr>
                            <tr><th>状态</th><td><span class="badge bg-${getStatusBadgeClass(process.status)}">${escapeHtml(process.status)}</span></td></tr>
                            <tr><th>创建时间</th><td>${escapeHtml(process.create_time || '')}</td></tr>
                        </table>
                    </div>
                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-info" onclick="loadProcessLogs('${processId}')">
                            <i class="fas fa-file-alt"></i> 查看进程日志
                        </button>
                    </div>
                    <div id="processLogsContainer" class="mt-3 d-none">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h6 class="mb-0">进程日志</h6>
                                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="refreshProcessLogs('${processId}')">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="processLogsContent" class="p-3 bg-light text-xs overflow-auto" style="max-height: 300px;">
                                    <div class="text-center text-muted">加载中...</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>`;
                const modal = new bootstrap.Modal(document.getElementById('processDetailModal'));
                modal.show();
            } else {
                console.log('获取进程详情失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('获取进程详情失败:', error);
            console.log('获取进程详情失败，请检查网络连接');
        });
}

// 加载进程日志
function loadProcessLogs(processId) {
    const logsContainer = document.getElementById('processLogsContainer');
    const logsContent = document.getElementById('processLogsContent');
    
    // 显示日志容器
    logsContainer.classList.remove('d-none');
    logsContent.innerHTML = '<div class="text-center text-muted">加载中...</div>';
    
    // 获取日志
    fetch(`/api/icloud/process/logs/${processId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const logs = data.data.logs;
                if (logs && logs.length > 0) {
                    logsContent.innerHTML = logs.map(log => 
                        `<div class="log-entry">${escapeHtml(log)}</div>`
                    ).join('');
                } else {
                    logsContent.innerHTML = '<div class="text-center text-muted">暂无日志记录</div>';
                }
                // 滚动到底部
                logsContent.scrollTop = logsContent.scrollHeight;
            } else {
                logsContent.innerHTML = `<div class="text-center text-danger">${data.message}</div>`;
            }
        })
        .catch(error => {
            console.error('获取进程日志失败:', error);
            logsContent.innerHTML = '<div class="text-center text-danger">获取日志失败，请检查网络连接</div>';
        });
}

// 刷新进程日志
function refreshProcessLogs(processId) {
    loadProcessLogs(processId);
}

// 转义HTML特殊字符
function escapeHtml(unsafe) {
    if (!unsafe) return '';
    return unsafe
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
}

// 其他变量和函数定义
</script>

<!-- 主要业务逻辑 -->
<script type="text/javascript">
let currentPage = 1;
const itemsPerPage = 10;
let totalItems = 0;
let allProcesses = [];

// 页面加载时自动加载客户端列表
window.addEventListener('DOMContentLoaded', function() {
    loadClients();
});

// 获取Apple ID列表（显示文本名称和可用数量）
function loadAppleIds() {
    fetch('/api/appleid_files')
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            return response.json();
        })
        .then(data => {
            const select = document.getElementById('appleId');
            if (!select) return;
            
            select.innerHTML = '<option value="">请选择Apple ID</option>';
            
            if (data.success && data.files && data.files.length > 0) {
                let totalAppleIdsCount = 0;
                const filePromises = [];
                
                // 为每个文件创建一个Promise来获取内容
                data.files.forEach(file => {
                    const filePromise = fetch(`/api/appleid_file_content?file=${encodeURIComponent(file.name)}`)
                        .then(response => response.json())
                        .then(fileData => {
                            let fileAppleIdCount = 0;
                            
                            if (fileData.success && fileData.content) {
                                // 统计有效Apple ID数量
                                fileData.content.forEach(line => {
                                    const parts = line.split('----');
                                    if (parts.length >= 4) {
                                        fileAppleIdCount++;
                                    }
                                });
                                
                                // 如果file_info中有lines字段，直接使用它
                                if (fileData.file_info && fileData.file_info.lines) {
                                    fileAppleIdCount = fileData.file_info.lines;
                                }
                            }
                            
                            totalAppleIdsCount += fileAppleIdCount;
                            
                            return {
                                file: file,
                                count: fileAppleIdCount
                            };
                        })
                        .catch(error => {
                            console.error(`加载文件内容失败 ${file.name}:`, error);
                            return {
                                file: file,
                                count: 0
                            };
                        });
                    
                    filePromises.push(filePromise);
                });
                
                // 等待所有文件内容获取完成
                Promise.all(filePromises).then(results => {
                    // 创建下拉选项
                    results.forEach(result => {
                        const option = document.createElement('option');
                        option.value = result.file.name;
                        // 显示Apple ID文本名称和数量
                        const displayText = result.file.display_name || result.file.name;
                        // 直接在选项文本中显示数量，格式为"文件名 (xx个)"
                        option.textContent = `${displayText} (${result.count}个)`;
                        // 保存原始信息的数据属性
                        option.setAttribute('data-count', result.count.toString());
                        option.setAttribute('data-display-text', `${displayText} (${result.count}个)`);
                        select.appendChild(option);
                    });
                    
                    // 更新可用Apple ID总数量
                    document.getElementById('availableAppleIdCount').textContent = totalAppleIdsCount;
                    console.log('Apple ID列表加载成功，共', totalAppleIdsCount, '个可用Apple ID');
                    
                    // 添加change事件监听器，仅记录选择信息
                    select.addEventListener('change', function() {
                        const selectedOption = this.options[this.selectedIndex];
                        if (selectedOption && selectedOption.value) {
                            const count = selectedOption.getAttribute('data-count');
                            const displayText = selectedOption.getAttribute('data-display-text');
                            
                            // 显示选中的Apple ID数量信息
                            console.log(`已选择${displayText}`);
                        }
                    });
                });
            } else {
                document.getElementById('availableAppleIdCount').textContent = '0';
                console.log('没有找到Apple ID文件');
            }
        })
        .catch(error => {
            console.error('加载Apple ID列表失败:', error);
            document.getElementById('availableAppleIdCount').textContent = '0';
            console.log('加载Apple ID列表失败，请稍后重试');
        });
}

// 刷新Apple ID列表
function refreshAppleIds() {
    loadAppleIds();
    console.log('Apple ID列表已刷新');
}

// 加载客户端列表（异步）
async function loadClients() {
    // 显示加载状态
    const refreshBtn = document.getElementById('refreshClientsBtn');
    const refreshIcon = document.getElementById('refreshClientsIcon');
    const loadingIndicator = document.getElementById('clientsLoadingIndicator');
    
    if (refreshBtn && refreshIcon && loadingIndicator) {
        refreshBtn.disabled = true;
        refreshIcon.classList.add('spinner-border', 'spinner-border-sm');
        refreshIcon.classList.add('fa-spin');
        loadingIndicator.classList.remove('d-none');
    }
    
    try {
        const response = await fetch('/api/scan_clients', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const data = await response.json();
        const select = document.getElementById('processClient');
        if (!select) return;
        
        // 清空现有选项，保留默认选项
        select.innerHTML = '<option value="">请选择客户端</option>';
        
        if (data.success && data.clients && data.clients.length > 0) {
            data.clients.forEach(client => {
                const option = document.createElement('option');
                const ipAddress = client.ip || client;
                option.value = ipAddress;
                option.textContent = ipAddress;
                select.appendChild(option);
            });
            
            console.log('客户端列表加载成功，共', data.clients.length, '个客户端');
        } else {
            // 添加提示选项
            const option = document.createElement('option');
            option.value = '';
            option.textContent = '未找到可用客户端';
            option.disabled = true;
            select.appendChild(option);
            console.log('没有找到客户端');
        }
    } catch (error) {
        console.error('加载客户端列表失败:', error);
        // 显示错误信息在下拉框中
        const select = document.getElementById('processClient');
        if (select) {
            select.innerHTML = '<option value="">请选择客户端</option>';
            const errorOption = document.createElement('option');
            errorOption.value = '';
            errorOption.textContent = '加载失败，请点击刷新重试';
            errorOption.disabled = true;
            select.appendChild(errorOption);
        }
    } finally {
        // 恢复按钮状态
        if (refreshBtn && refreshIcon && loadingIndicator) {
            refreshBtn.disabled = false;
            refreshIcon.classList.remove('spinner-border', 'spinner-border-sm');
            refreshIcon.classList.remove('fa-spin');
            loadingIndicator.classList.add('d-none');
        }
    }
}



// 渲染分页控件
function renderPagination() {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // 上一页
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>`;
    pagination.appendChild(prevLi);
    
    // 页码
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // 下一页
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>`;
    pagination.appendChild(nextLi);
}

// 切换页面
function changePage(page) {
    if (page < 1 || page > Math.ceil(totalItems / itemsPerPage)) return;
    currentPage = page;
    renderProcessList();
}

// 加载并渲染进程列表
function loadProcessList() {
    console.log('开始加载进程列表...');
    fetch('/api/icloud/process/list')
        .then(response => {
            console.log('收到API响应:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('解析的数据:', data);
            if (data.success) {
                allProcesses = data.data;
                totalItems = allProcesses.length;
                document.getElementById('totalItems').textContent = totalItems;
                renderProcessList();
                renderPagination();
                console.log('进程列表渲染完成，总数:', totalItems);
            } else {
                console.error('加载进程列表失败:', data.message);
            }
        })
        .catch(error => {
            console.error('加载进程列表失败:', error);
            console.log('加载进程列表失败，请检查网络连接');
        });
}

// 渲染进程列表
function renderProcessList() {
    console.log('开始渲染进程列表，总数据:', allProcesses);
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageProcesses = allProcesses.slice(start, end);
    
    const tbody = document.getElementById('processTableBody');
    tbody.innerHTML = '';
    
    if (pageProcesses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无数据</td></tr>';
        return;
    }
    
    pageProcesses.forEach(process => {
        // 获取文件名和数量，如果不存在则从其他字段推导
        const fileName = process.file_name || (process.apple_id ? process.apple_id.split('/').pop().split('\\').pop() : '未知');
        const fileCount = process.file_count || process.apple_id_count || '未知';
        
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${process.name}</td>
            <td>${process.id}</td>
            <td>
                <span class="badge bg-${getStatusBadgeClass(process.status)}">${process.status}</span>
            </td>
            <td>${process.create_time}</td>
            <td>
                <div class="btn-group btn-group-sm" role="group">
                        <button class="btn btn-success btn-sm" onclick="startProcess('${process.id}')">
                            <i class="fas fa-play mr-1"></i> 启动
                        </button>
                        <button class="btn btn-warning btn-sm" onclick="stopProcess('${process.id}')">
                            <i class="fas fa-stop mr-1"></i> 停止
                        </button>
                    <button class="btn btn-info mb-1" onclick="showProcessDetail('${process.id}')">
                        <i class="fas fa-info-circle"></i> 详情
                    </button>
                    <button class="btn btn-danger mb-1" onclick="deleteProcess('${process.id}')">
                        <i class="fas fa-trash"></i> 删除
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 获取状态对应的Badge类
function getStatusBadgeClass(status) {
    switch (status) {
        case '执行中':
            return 'success';
        case '已停止':
            return 'secondary';
        case '错误':
            return 'danger';
        case '执行完成':
            return 'info';
        default:
            return 'secondary';
    }
}

// 添加新进程
function addNewProcess() {
    document.getElementById('processModalLabel').textContent = '添加进程';
    document.getElementById('processForm').reset();
    
    // 先打开模态框
    const modal = new bootstrap.Modal(document.getElementById('processModal'));
    modal.show();
    
    // 然后异步加载数据，不阻塞UI
    // 加载Apple ID列表
    loadAppleIds();
    
    // 异步加载客户端信息
    // 先在下拉框中显示加载提示
    const clientSelect = document.getElementById('processClient');
    if (clientSelect) {
        clientSelect.innerHTML = '<option value="">正在获取客户端信息...</option>';
    }
    
    // 异步调用loadClients函数获取客户端列表
    loadClients().catch(error => {
        console.error('添加进程时加载客户端失败:', error);
    });
}

// 存储选中的脚本列表
let selectedScripts = [];

// 显示脚本列表模态框
function showScriptListModal() {
    // 清空搜索框
    document.getElementById('scriptSearch').value = '';
    // 显示加载状态
    document.getElementById('scriptListLoading').classList.remove('d-none');
    document.getElementById('scriptListContent').classList.add('d-none');
    document.getElementById('scriptListError').classList.add('d-none');
    
    // 打开模态框
    const modalElement = document.getElementById('scriptListModal');
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
    
    // 加载脚本列表
    loadScriptList();
    
    // 添加模态框关闭事件监听，确保关闭后脚本列表正确显示
    modalElement.addEventListener('hidden.bs.modal', function() {
        console.log('模态框关闭，更新脚本显示');
        updateSelectedScriptsDisplay();
    });
}

// 加载脚本列表
function loadScriptList() {
    const searchTerm = document.getElementById('scriptSearch').value.toLowerCase();
    
    fetch('/api/script/list')
        .then(response => response.json())
        .then(data => {
            document.getElementById('scriptListLoading').classList.add('d-none');
            
            if (data.success) {
                const scriptListContent = document.getElementById('scriptListContent');
                scriptListContent.innerHTML = '';
                scriptListContent.classList.remove('d-none');
                
                // 过滤脚本
                let filteredScripts = data.data;
                if (searchTerm) {
                    filteredScripts = data.data.filter(script => 
                        script.name.toLowerCase().includes(searchTerm)
                    );
                }
                
                if (filteredScripts.length === 0) {
                    scriptListContent.innerHTML = '<div class="text-center py-3 text-muted">未找到匹配的脚本</div>';
                    return;
                }
                
                // 显示脚本列表
                filteredScripts.forEach(script => {
                    // 检查是否已选中
                    const isSelected = selectedScripts.some(s => s.path === script.path);
                    
                    const listItem = document.createElement('div');
                    listItem.className = `list-group-item d-flex justify-content-between align-items-center ${isSelected ? 'list-group-item-info' : ''}`;
                    listItem.innerHTML = `
                        <div style="min-width: 0; flex: 1;">
                                <div class="d-flex w-100 justify-content-between">
                                    <h6 class="mb-1">${script.name}</h6>
                                    <small class="text-muted">${formatFileSize(script.size)}</small>
                                </div>
                                <p class="mb-0 text-sm text-muted overflow-hidden text-ellipsis whitespace-nowrap" style="max-width: 100%;">${script.path.replace(/\\/g, '/')}</p>
                            </div>
                        <button type="button" class="btn ${isSelected ? 'btn-danger' : 'btn-primary'} btn-sm script-toggle-btn"
                                data-script-path="${script.path}"
                                data-script-name="${script.name}"
                                data-script-size="${script.size}">
                            ${isSelected ? '移除' : '添加'}
                        </button>
                    `;
                    scriptListContent.appendChild(listItem);
                });
            } else {
                document.getElementById('scriptListError').textContent = data.message || '加载脚本列表失败';
                document.getElementById('scriptListError').classList.remove('d-none');
            }
        })
        .catch(error => {
            console.error('加载脚本列表失败:', error);
            document.getElementById('scriptListLoading').classList.add('d-none');
            document.getElementById('scriptListError').textContent = '加载脚本列表失败，请检查网络连接';
            document.getElementById('scriptListError').classList.remove('d-none');
        });
}

// 添加事件监听器来处理脚本按钮点击
function setupScriptToggleButtons() {
    // 为所有脚本切换按钮添加点击事件
    document.querySelectorAll('.script-toggle-btn').forEach(button => {
        button.addEventListener('click', function() {
            // 从数据属性获取脚本信息
            const scriptObj = {
                path: this.getAttribute('data-script-path'),
                name: this.getAttribute('data-script-name'),
                size: parseInt(this.getAttribute('data-script-size'))
            };
            toggleScriptSelection(this, scriptObj);
        });
    });
}

// 在DOM加载完成后初始化事件监听器
document.addEventListener('DOMContentLoaded', function() {
    // 监听脚本列表变化后重新设置事件监听器
    const scriptListContent = document.getElementById('scriptListContent');
    if (scriptListContent) {
        // 使用MutationObserver监听DOM变化
        const observer = new MutationObserver(function(mutations) {
            // 当脚本列表更新时，重新设置事件监听器
            setupScriptToggleButtons();
        });
        
        observer.observe(scriptListContent, {
            childList: true,
            subtree: true
        });
    }
});

// 切换脚本选择状态
function toggleScriptSelection(button, scriptObj) {
    // 检查button是否存在
    if (!button) {
        console.error('toggleScriptSelection: button参数为null或undefined');
        return;
    }
    
    // 检查scriptObj是否有效
    if (!scriptObj) {
        console.error('toggleScriptSelection: scriptObj参数为null或undefined');
        return;
    }
    
    // 确保script对象存在
    if (!scriptObj || !scriptObj.path || !scriptObj.name) {
        console.error('无效的脚本对象:', scriptObj);
        return;
    }
    // 使用解析后的对象
    script = scriptObj;
    
    // 再次检查button是否存在（可能在操作过程中被移除）
    if (!button) {
        console.error('toggleScriptSelection: button在操作过程中被移除');
        return;
    }
    // 检查当前状态
    const isSelected = button.textContent.trim() === '移除';
    
    if (isSelected) {
        // 移除脚本
        const initialLength = selectedScripts.length;
        selectedScripts = selectedScripts.filter(s => s.path !== script.path);
        
        if (selectedScripts.length < initialLength) {
            // 成功移除
            button.textContent = '添加';
            button.className = 'btn btn-primary btn-sm';
            const listItem = button.closest('.list-group-item');
            if (listItem) {
                listItem.classList.remove('list-group-item-info');
            }
            console.log('脚本已移除:', script.name);
        }
    } else {
        // 添加脚本（避免重复）
        if (!selectedScripts.some(s => s.path === script.path)) {
            // 创建脚本对象的副本
            const scriptCopy = { ...script };
            selectedScripts.push(scriptCopy);
            
            // 更新按钮状态
            button.textContent = '移除';
            button.className = 'btn btn-danger btn-sm';
            const listItem = button.closest('.list-group-item');
            if (listItem) {
                listItem.classList.add('list-group-item-info');
            }
            console.log('脚本已添加:', script.name);
        }
    }
    
    // 立即更新已选择脚本列表显示
    console.log('更新脚本显示，当前选中数量:', selectedScripts.length);
    updateSelectedScriptsDisplay();
    
    // 重新设置事件监听器，确保所有按钮事件正常工作
    setupScriptToggleButtons();
}

// 更新已选择脚本显示
function updateSelectedScriptsDisplay() {
    console.log('开始更新已选择脚本显示，脚本数量:', selectedScripts.length);
    
    const selectedScriptsList = document.getElementById('selectedScriptsList');
    
    if (!selectedScriptsList) {
        console.error('未找到selectedScriptsList元素');
        return;
    }
    
    if (selectedScripts.length === 0) {
        selectedScriptsList.innerHTML = '<p class="text-muted">暂未选择任何脚本</p>';
        // 清空输入框提示
        if (document.getElementById('scriptInput')) {
            document.getElementById('scriptInput').placeholder = '请选择脚本';
        }
        return;
    }
    
    // 更新输入框显示选中的脚本文件名
    if (document.getElementById('scriptInput')) {
        const scriptInput = document.getElementById('scriptInput');
        // 如果有选中的脚本，显示第一个脚本的文件名
        if (selectedScripts.length > 0) {
            scriptInput.value = selectedScripts[0].name;
            scriptInput.placeholder = ''; // 清空placeholder
        } else {
            scriptInput.value = '';
            scriptInput.placeholder = '请选择脚本';
        }
    }
    
    // 构建脚本列表HTML
    let html = '<div class="selected-scripts-container">';
    selectedScripts.forEach((script, index) => {
        // 安全地转义引号
        const escapedPath = script.path.replace(/'/g, "\\'");
        
        html += `
            <div class="mb-1 d-flex align-items-center p-1 border rounded">
                <span class="text-primary mr-2 font-weight-bold">${index + 1}.</span>
                <span class="mr-3 overflow-hidden text-ellipsis whitespace-nowrap" style="flex: 1;">${script.name}</span>
                <button type="button" class="btn btn-danger btn-sm btn-xs" 
                        onclick="removeSelectedScript('${escapedPath}')" 
                        title="删除此脚本">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `;
    });
    html += '</div>';
    
    // 清空并更新DOM
    selectedScriptsList.innerHTML = '';
    // 使用DocumentFragment优化DOM操作
    const fragment = document.createDocumentFragment();
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    
    while (tempDiv.firstChild) {
        fragment.appendChild(tempDiv.firstChild);
    }
    
    selectedScriptsList.appendChild(fragment);
    
    // 强制重排确保DOM更新生效
    void selectedScriptsList.offsetHeight;
    
    console.log('脚本显示更新完成');
}

// 从已选择列表中移除脚本
function removeSelectedScript(scriptPath) {
    console.log('尝试移除脚本:', scriptPath);
    
    // 移除脚本
    const initialLength = selectedScripts.length;
    selectedScripts = selectedScripts.filter(s => s.path !== scriptPath);
    
    if (selectedScripts.length < initialLength) {
        console.log('脚本移除成功');
        // 更新显示
        updateSelectedScriptsDisplay();
        
        // 如果脚本列表模态框是打开的，也需要更新其中的状态
        const scriptListModal = document.getElementById('scriptListModal');
        const modal = bootstrap.Modal.getInstance(scriptListModal);
        
        if (modal && scriptListModal.classList.contains('show')) {
            console.log('模态框已打开，更新其中的脚本状态');
            const scriptItems = document.querySelectorAll('#scriptListContent .list-group-item');
            scriptItems.forEach(item => {
                const pathElement = item.querySelector('.text-muted');
                if (pathElement && pathElement.textContent.trim() === scriptPath.trim()) {
                    const button = item.querySelector('button');
                    if (button) {
                        button.textContent = '添加';
                        button.className = 'btn btn-primary btn-sm';
                    }
                    item.classList.remove('list-group-item-info');
                }
            });
        }
    } else {
        console.warn('未找到要移除的脚本:', scriptPath);
    }
}

// 格式化文件大小
function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// 保存进程
function saveProcess() {
    const processData = {
        process_name: document.getElementById('processName').value,
        process_client: document.getElementById('processClient').value,
        apple_id: document.getElementById('appleId').value,
        scripts: selectedScripts  // 添加选中的脚本列表
    };

    if (!processData.process_name || !processData.process_client || !processData.apple_id) {
        console.log('请填写所有必填字段');
        return;
    }

    fetch('/api/icloud/process/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(processData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('processModal')).hide();
            console.log('进程添加成功');
            loadProcessList();
            // 清空已选择的脚本列表
            selectedScripts = [];
            updateSelectedScriptsDisplay();
        } else {
            console.log('进程添加失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('保存进程失败:', error);
        console.log('保存进程失败，请检查网络连接');
    });
}

// 已在页面上方定义了正确的startProcess函数，此处移除重复定义

// 显示进程详情
function showProcessDetail(processId) {
    fetch(`/api/icloud/process/detail/${processId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const process = data.data;
                const detailContent = document.getElementById('processDetailContent');
                detailContent.innerHTML = `
                    <!-- 进程配置信息 -->
                    <div class="mb-2">
                        <h7 class="mb-1"><i class="fas fa-cog"></i> 进程配置信息</h7>
                        <div class="table-responsive">
                            <table class="table table-bordered" style="font-size: 13px; margin-bottom: 0;">
                                <tr>
                                    <th style="width: 150px; font-size: 14px;">进程名称</th>
                                    <td>${process.name}</td>
                                </tr>
                                <tr>
                                    <th style="font-size: 14px;">进程ID</th>
                                    <td>${process.id}</td>
                                </tr>
                                <tr>
                                    <th style="font-size: 14px;">进程客户端</th>
                                    <td>${process.client}</td>
                                </tr>
                                <tr>
                                    <th style="font-size: 14px;">Apple ID文本信息</th>
                                     <td>文件名:${process.file_name || (process.apple_id ? process.apple_id.split('/').pop().split('\\').pop() : '未知')},
                                     appleid数量:${process.file_count || process.apple_id_count || '未知'}</td>
                                </tr>
                                <tr>
                                    <th style="font-size: 14px;">脚本信息</th>
                                    <td>${process.scripts ? `<pre class="bg-light p-2 rounded" style="white-space: pre-wrap; word-break: break-all; border: none; margin: 0;">${process.scripts}</pre>` : '未配置脚本'}</td>
                                </tr>
                                <tr>
                                    <th style="font-size: 14px;">状态</th>
                                    <td><span class="badge bg-${getStatusBadgeClass(process.status)}">${process.status}</span></td>
                                </tr>
                                <tr>
                                    <th style="font-size: 14px;">创建时间</th>
                                    <td>${process.create_time}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 模拟控制台页面 -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h7 class="mb-2"><i class="fas fa-terminal"></i> 控制台输出</h7>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearConsoleOutput('${processId}')">
                                    <i class="fas fa-eraser"></i> 清空
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshConsoleOutput('${processId}')">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                            </div>
                        </div>
                        <!-- 终端仿真容器 -->
                        <div class="terminal-container border border-gray-700 rounded-lg shadow-lg overflow-hidden" style="font-family: 'Courier New', Courier, monospace;">
                            <!-- 终端标题栏 -->
                            <div class="terminal-header bg-gray-800 p-2 flex items-center space-x-2 border-b border-gray-700">
                                <div class="flex space-x-2">
                                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                </div>
                                <span class="text-gray-400 text-xs ml-2">process_${processId.substring(0, 8)}_terminal</span>
                            </div>
                            <!-- 终端内容区域 -->
                            <div id="consoleOutput_${processId}" class="terminal-content bg-gray-900 text-green-400 p-3 font-mono text-xs overflow-auto" style="white-space: pre-wrap; height: calc(90vh - 400px);">
                                <span class="text-gray-500">正在获取进程输出信息...</span>
                            </div>
                        </div>
                        <style>
                            /* 终端仿真样式 */
                            .terminal-container {
                                background-color: #1e1e1e;
                                border-radius: 8px;
                                box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
                                transition: all 0.3s ease;
                            }
                            
                            .terminal-container:hover {
                                box-shadow: 0 6px 12px rgba(0, 0, 0, 0.4);
                            }
                            
                            .terminal-header {
                                background: linear-gradient(to right, #2d2d2d, #1e1e1e);
                                border-bottom: 1px solid #3e3e3e;
                                user-select: none;
                            }
                            
                            .terminal-content {
                                background-color: #1a1a1a;
                                background-image: 
                                    radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
                                    radial-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px);
                                background-size: 20px 20px;
                                background-position: 0 0, 10px 10px;
                                line-height: 1.4;
                                tab-size: 4;
                            }
                            
                            /* 优化滚动条样式 */
                            .terminal-content::-webkit-scrollbar {
                                width: 8px;
                                height: 8px;
                            }
                            
                            .terminal-content::-webkit-scrollbar-track {
                                background: #2d2d2d;
                                border-left: 1px solid #3e3e3e;
                            }
                            
                            .terminal-content::-webkit-scrollbar-thumb {
                                background: #555;
                                border-radius: 4px;
                            }
                            
                            .terminal-content::-webkit-scrollbar-thumb:hover {
                                background: #666;
                            }
                            
                            /* 命令提示符样式 */
                            .terminal-prompt {
                                font-weight: bold;
                                color: #00bfff;
                            }
                            
                            /* 日志级别颜色 */
                            .log-info { color: #00ff00; }
                            .log-warning { color: #ffaa00; }
                            .log-error { color: #ff5555; }
                            .log-success { color: #00cc66; }
                            .log-debug { color: #8888ff; }
                            
                            /* 文本选择样式 */
                            .terminal-content::selection {
                                background-color: #0066ff;
                                color: #ffffff;
                            }
                            
                            .terminal-content::-moz-selection {
                                background-color: #0066ff;
                                color: #ffffff;
                            }
                            
                            /* 进程详情容器样式 */
                            .process-detail-container {
                                font-size: 13px;
                            }
                            
                            /* 进程详情模态框样式 */
                            #processDetailModal .modal-dialog {
                                height: 90vh; /* 减少高度 */
                                margin: auto;
                                margin-top: 5vh;
                            }
                            
                            #processDetailModal .modal-content {
                                height: 90vh;
                                border-radius: 0;
                            }
                            
                            #processDetailModal .modal-body {
                                max-height: calc(90vh - 100px);
                                overflow-y: hidden; /* 移除滚动条 */
                            }
                            
                            /* 控制台日志文字进一步减小 */
                            .terminal-content {
                                font-size: 11px !important;
                            }
                        </style>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('processDetailModal'));
                modal.show();
                
                // 获取并显示进程输出信息
                fetchConsoleOutput(processId);
                
                // 如果进程正在执行，设置自动刷新
                if (process.status === '执行中') {
                    const intervalId = setInterval(() => {
                        fetchConsoleOutput(processId);
                    }, 3000);
                    
                    // 模态框关闭时清除定时器
                    const modalElement = document.getElementById('processDetailModal');
                    modalElement.addEventListener('hidden.bs.modal', function() {
                        clearInterval(intervalId);
                    }, { once: true });
                }
            } else {
                console.log('获取进程详情失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('获取进程详情失败:', error);
            console.log('获取进程详情失败，请检查网络连接');
        });
}

// 格式化日志行，添加颜色
function formatLogLine(line) {
    // 根据日志级别添加颜色类
    let formattedLine = line;
    
    if (line.toLowerCase().includes('error') || line.toLowerCase().includes('错误')) {
        formattedLine = `<span class="log-error">${line}</span>`;
    } else if (line.toLowerCase().includes('warning') || line.toLowerCase().includes('警告')) {
        formattedLine = `<span class="log-warning">${line}</span>`;
    } else if (line.toLowerCase().includes('success') || line.toLowerCase().includes('成功')) {
        formattedLine = `<span class="log-success">${line}</span>`;
    } else if (line.toLowerCase().includes('debug') || line.toLowerCase().includes('调试')) {
        formattedLine = `<span class="log-debug">${line}</span>`;
    } else {
        formattedLine = `<span class="log-info">${line}</span>`;
    }
    
    return formattedLine;
}

// 获取进程控制台输出
function fetchConsoleOutput(processId) {
    fetch(`/api/icloud/process/output/${processId}`)
        .then(response => response.json())
        .then(data => {
            const consoleElement = document.getElementById(`consoleOutput_${processId}`);
            if (consoleElement) {
                if (data.success && data.output) {
                    // 清空内容
                    consoleElement.innerHTML = '';
                    
                    // 按行分割并格式化输出
                    const lines = data.output.split('\n');
                    if (lines.length > 0) {
                        lines.forEach(line => {
                            if (line.trim()) {  // 只处理非空行
                                const logDiv = document.createElement('div');
                                logDiv.innerHTML = formatLogLine(line);
                                consoleElement.appendChild(logDiv);
                            }
                        });
                    } else {
                        // 如果没有实际内容，显示提示信息
                        const logDiv = document.createElement('div');
                        logDiv.innerHTML = `<span class="text-gray-500">暂无实际输出内容</span>`;
                        consoleElement.appendChild(logDiv);
                    }
                } else {
                    // 显示错误或无输出信息
                    consoleElement.innerHTML = `<span class="text-gray-500">${data.output || '暂无输出信息'}</span>`;
                }
                // 自动滚动到底部
                consoleElement.scrollTop = consoleElement.scrollHeight;
            }
        })
        .catch(error => {
            console.error('获取进程输出失败:', error);
            const consoleElement = document.getElementById(`consoleOutput_${processId}`);
            if (consoleElement) {
                consoleElement.innerHTML = `<span class="log-error">获取输出信息失败</span>`;
            }
        });
}

// 清空控制台输出
function clearConsoleOutput(processId) {
    const consoleElement = document.getElementById(`consoleOutput_${processId}`);
    if (consoleElement) {
        consoleElement.innerHTML = `<span class="text-gray-500">控制台输出已清空</span>`;
    }
}

// 刷新控制台输出
function refreshConsoleOutput(processId) {
    const consoleElement = document.getElementById(`consoleOutput_${processId}`);
    if (consoleElement) {
        // 显示刷新提示
        consoleElement.innerHTML = `<span class="text-gray-500">正在刷新输出信息...</span>`;
    }
    // 延迟执行实际刷新，以显示刷新状态
    setTimeout(() => {
        fetchConsoleOutput(processId);
    }, 300);
}

// 使用立即执行函数包装所有代码
// 页面加载完成后加载进程列表
document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成，开始初始化...");
    loadProcessList();
    // 每5秒刷新一次进程列表
    setInterval(loadProcessList, 5000);
});
</script>
{% endblock %}