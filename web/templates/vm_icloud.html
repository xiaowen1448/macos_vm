{% extends "base.html" %}

{% block title %}MacOS VM 虚拟机管理平台 - iCloud管理{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="card">
        <div class="card-header">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="card-title mb-0">iCloud进程管理</h4>
                </div>
                <div class="col-auto">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" onclick="addNewProcess()">
                            <i class="fas fa-plus"></i> 添加进程
                        </button>
                    </div>
                </div>
            </div>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="processTable">
                    <thead>
                        <tr>
                            <th>进程名称</th>
                            <th>进程ID</th>
                            <th>状态</th>
                            <th>Apple ID</th>
                            <th>创建时间</th>
                            <th style="width: 280px;">操作</th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody">
                    </tbody>
                </table>
                <!-- 分页控件 -->
                <div class="d-flex justify-content-between align-items-center mt-3">
                    <div class="text-muted">
                        共 <span id="totalItems">0</span> 条记录
                    </div>
                    <ul class="pagination mb-0" id="pagination">
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加/编辑进程模态框 -->
<div class="modal fade" id="processModal" tabindex="-1" aria-labelledby="processModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processModalLabel">添加进程</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="processForm">
                    <div class="row mb-3">
                        <label for="processName" class="col-sm-3 col-form-label text-end">进程名称：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="processName" required>
                        </div>
                    </div>
                    <!-- 进程脚本选项已删除 -->
                    <div class="row mb-3">
                        <label for="processClient" class="col-sm-3 col-form-label text-end">进程客户端：</label>
                        <div class="col-sm-8">
                            <input type="text" class="form-control" id="processClient" required placeholder="请输入客户端名称">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <label for="appleId" class="col-sm-3 col-form-label text-end">Apple ID：</label>
                        <div class="col-sm-8">
                            <div class="input-group">
                                <select class="form-control" id="appleId" required>
                                    <option value="">请选择Apple ID</option>
                                </select>
                                <button class="btn btn-outline-secondary" type="button" onclick="refreshAppleIds()">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="mt-1 text-muted">
                                <small><i class="fas fa-info-circle"></i> 可用Apple ID数量：<span id="availableAppleIdCount">0</span></small>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <button type="button" class="btn btn-primary" onclick="saveProcess()">保存</button>
            </div>
        </div>
    </div>
</div>



<!-- 进程详情模态框 -->
<div class="modal fade" id="processDetailModal" tabindex="-1" aria-labelledby="processDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="processDetailModalLabel">进程详情</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="processDetailContent">
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script type="text/JavaScript">
// 直接在全局作用域定义所有函数
function addNewProcess() {
    document.getElementById('processModalLabel').textContent = '添加进程';
    document.getElementById('processForm').reset();
    loadAppleIds();
    const modal = new bootstrap.Modal(document.getElementById('processModal'));
    modal.show();
}

function showStaticScripts() {
    const modal = new bootstrap.Modal(document.getElementById('staticScriptsModal'));
    modal.show();
}

function selectScript(scriptName) {
    document.getElementById('processScript').value = scriptName;
    bootstrap.Modal.getInstance(document.getElementById('staticScriptsModal')).hide();
}

function changePage(page) {
    if (page < 1 || page > Math.ceil(totalItems / itemsPerPage)) return;
    currentPage = page;
    renderProcessList();
}

function startProcess(processId) {
    if (!confirm('确定要启动该进程吗？')) return;
    fetch('/api/icloud/process/start', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) loadProcessList();
    })
    .catch(error => {
        console.error('启动进程失败:', error);
        alert('启动进程失败，请检查网络连接');
    });
}

function stopProcess(processId) {
    if (!confirm('确定要停止该进程吗？')) return;
    fetch('/api/icloud/process/stop', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) loadProcessList();
    })
    .catch(error => {
        console.error('停止进程失败:', error);
        alert('停止进程失败，请检查网络连接');
    });
}

function deleteProcess(processId) {
    if (!confirm('确定要删除该进程吗？该操作不可恢复！')) return;
    fetch('/api/icloud/process/delete', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) loadProcessList();
    })
    .catch(error => {
        console.error('删除进程失败:', error);
        alert('删除进程失败，请检查网络连接');
    });
}

function showProcessDetail(processId) {
    fetch(`/api/icloud/process/detail/${processId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const process = data.data;
                const detailContent = document.getElementById('processDetailContent');
                detailContent.innerHTML = `
                    <div class="table-responsive">
                        <table class="table table-bordered">
                            <tr><th style="width: 150px;">进程名称</th><td>${process.name}</td></tr>
                            <tr><th>进程ID</th><td>${process.id}</td></tr>
                            <tr><th>进程脚本</th><td><pre class="mb-0"><code>${process.script}</code></pre></td></tr>
                            <tr><th>进程客户端</th><td>${process.client}</td></tr>
                            <tr><th>Apple ID</th><td>${process.apple_id}</td></tr>
                            <tr><th>状态</th><td><span class="badge bg-${getStatusBadgeClass(process.status)}">${process.status}</span></td></tr>
                            <tr><th>创建时间</th><td>${process.create_time}</td></tr>
                        </table>
                    </div>`;
                const modal = new bootstrap.Modal(document.getElementById('processDetailModal'));
                modal.show();
            } else {
                alert('获取进程详情失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('获取进程详情失败:', error);
            alert('获取进程详情失败，请检查网络连接');
        });
}

// 其他变量和函数定义
</script>

<!-- 主要业务逻辑 -->
<script type="text/javascript">
let currentPage = 1;
const itemsPerPage = 10;
let totalItems = 0;
let allProcesses = [];

// 获取Apple ID列表
function loadAppleIds() {
    fetch('/api/id/list')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const select = document.getElementById('appleId');
                select.innerHTML = '<option value="">请选择Apple ID</option>';
                data.data.forEach(id => {
                    select.innerHTML += `<option value="${id.id}">${id.apple_id}</option>`;
                });
                // 更新可用Apple ID数量
                document.getElementById('availableAppleIdCount').textContent = data.data.length;
            }
        })
        .catch(error => {
            console.error('加载Apple ID列表失败:', error);
            alert('加载Apple ID列表失败，请检查网络连接');
        });
}

// 刷新Apple ID列表
function refreshAppleIds() {
    loadAppleIds();
    alert('Apple ID列表已刷新');
}



// 渲染分页控件
function renderPagination() {
    const totalPages = Math.ceil(totalItems / itemsPerPage);
    const pagination = document.getElementById('pagination');
    pagination.innerHTML = '';
    
    // 上一页
    const prevLi = document.createElement('li');
    prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
    prevLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage - 1})">上一页</a>`;
    pagination.appendChild(prevLi);
    
    // 页码
    for (let i = 1; i <= totalPages; i++) {
        const li = document.createElement('li');
        li.className = `page-item ${i === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="changePage(${i})">${i}</a>`;
        pagination.appendChild(li);
    }
    
    // 下一页
    const nextLi = document.createElement('li');
    nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
    nextLi.innerHTML = `<a class="page-link" href="#" onclick="changePage(${currentPage + 1})">下一页</a>`;
    pagination.appendChild(nextLi);
}

// 切换页面
function changePage(page) {
    if (page < 1 || page > Math.ceil(totalItems / itemsPerPage)) return;
    currentPage = page;
    renderProcessList();
}

// 加载并渲染进程列表
function loadProcessList() {
    console.log('开始加载进程列表...');
    fetch('/api/icloud/process/list')
        .then(response => {
            console.log('收到API响应:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('解析的数据:', data);
            if (data.success) {
                allProcesses = data.data;
                totalItems = allProcesses.length;
                document.getElementById('totalItems').textContent = totalItems;
                renderProcessList();
                renderPagination();
                console.log('进程列表渲染完成，总数:', totalItems);
            } else {
                console.error('加载进程列表失败:', data.message);
            }
        })
        .catch(error => {
            console.error('加载进程列表失败:', error);
            alert('加载进程列表失败，请检查网络连接');
        });
}

// 渲染进程列表
function renderProcessList() {
    console.log('开始渲染进程列表，总数据:', allProcesses);
    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageProcesses = allProcesses.slice(start, end);
    
    const tbody = document.getElementById('processTableBody');
    tbody.innerHTML = '';
    
    if (pageProcesses.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="text-center">暂无数据</td></tr>';
        return;
    }
    
    pageProcesses.forEach(process => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td>${process.name}</td>
            <td>${process.id}</td>
            <td>
                <span class="badge bg-${getStatusBadgeClass(process.status)}">${process.status}</span>
            </td>
            <td>${process.apple_id}</td>
            <td>${process.create_time}</td>
            <td>
                <div class="btn-group">
                    <button class="btn btn-sm btn-success" onclick="startProcess('${process.id}')" ${process.status === '执行中' ? 'disabled' : ''}>
                        <i class="fas fa-play"></i> 启动
                    </button>
                    <button class="btn btn-sm btn-warning" onclick="stopProcess('${process.id}')" ${process.status !== '执行中' ? 'disabled' : ''}>
                        <i class="fas fa-stop"></i> 停止
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteProcess('${process.id}')" ${process.status === '执行中' ? 'disabled' : ''}>
                        <i class="fas fa-trash"></i> 删除
                    </button>
                    <button class="btn btn-sm btn-info" onclick="showProcessDetail('${process.id}')">
                        <i class="fas fa-info-circle"></i> 详情
                    </button>
                </div>
            </td>
        `;
        tbody.appendChild(tr);
    });
}

// 获取状态对应的Badge类
function getStatusBadgeClass(status) {
    switch (status) {
        case '执行中':
            return 'success';
        case '已停止':
            return 'secondary';
        case '错误':
            return 'danger';
        case '执行完成':
            return 'info';
        default:
            return 'secondary';
    }
}

// 添加新进程
function addNewProcess() {
    document.getElementById('processModalLabel').textContent = '添加进程';
    document.getElementById('processForm').reset();
    loadAppleIds();
    const modal = new bootstrap.Modal(document.getElementById('processModal'));
    modal.show();
}

// 保存进程
function saveProcess() {
    const processData = {
        process_name: document.getElementById('processName').value,
        process_client: document.getElementById('processClient').value,
        apple_id: document.getElementById('appleId').value
        // 移除进程脚本字段
    };

    if (!processData.process_name || !processData.process_client || !processData.apple_id) {
        alert('请填写所有必填字段');
        return;
    }

    fetch('/api/icloud/process/add', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(processData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            bootstrap.Modal.getInstance(document.getElementById('processModal')).hide();
            alert('进程添加成功');
            loadProcessList();
        } else {
            alert('进程添加失败: ' + data.message);
        }
    })
    .catch(error => {
        console.error('保存进程失败:', error);
        alert('保存进程失败，请检查网络连接');
    });
}

// 启动进程
function startProcess(processId) {
    if (!confirm('确定要启动该进程吗？')) return;
    
    fetch('/api/process/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            loadProcessList();
        }
    })
    .catch(error => {
        console.error('启动进程失败:', error);
        alert('启动进程失败，请检查网络连接');
    });
}

// 停止进程
function stopProcess(processId) {
    if (!confirm('确定要停止该进程吗？')) return;
    
    fetch('/api/process/stop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            loadProcessList();
        }
    })
    .catch(error => {
        console.error('停止进程失败:', error);
        alert('停止进程失败，请检查网络连接');
    });
}

// 删除进程
function deleteProcess(processId) {
    if (!confirm('确定要删除该进程吗？该操作不可恢复！')) return;
    
    fetch('/api/process/delete', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ process_id: processId })
    })
    .then(response => response.json())
    .then(data => {
        alert(data.message);
        if (data.success) {
            loadProcessList();
        }
    })
    .catch(error => {
        console.error('删除进程失败:', error);
        alert('删除进程失败，请检查网络连接');
    });
}

// 显示进程详情
function showProcessDetail(processId) {
    fetch(`/api/icloud/process/detail/${processId}`)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const process = data.data;
                const detailContent = document.getElementById('processDetailContent');
                detailContent.innerHTML = `
                    <!-- 进程配置信息 -->
                    <div class="mb-4">
                        <h5><i class="fas fa-cog"></i> 进程配置信息</h5>
                        <div class="table-responsive">
                            <table class="table table-bordered">
                                <tr>
                                    <th style="width: 150px;">进程名称</th>
                                    <td>${process.name}</td>
                                </tr>
                                <tr>
                                    <th>进程ID</th>
                                    <td>${process.id}</td>
                                </tr>
                                <tr>
                                    <th>进程客户端</th>
                                    <td>${process.client}</td>
                                </tr>
                                <tr>
                                    <th>Apple ID</th>
                                    <td>${process.apple_id}</td>
                                </tr>
                                <tr>
                                    <th>状态</th>
                                    <td><span class="badge bg-${getStatusBadgeClass(process.status)}">${process.status}</span></td>
                                </tr>
                                <tr>
                                    <th>创建时间</th>
                                    <td>${process.create_time}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                    
                    <!-- 模拟控制台页面 -->
                    <div class="mt-4">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h5><i class="fas fa-terminal"></i> 控制台输出</h5>
                            <div>
                                <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearConsoleOutput('${processId}')">
                                    <i class="fas fa-eraser"></i> 清空
                                </button>
                                <button class="btn btn-sm btn-outline-primary" onclick="refreshConsoleOutput('${processId}')">
                                    <i class="fas fa-sync-alt"></i> 刷新
                                </button>
                            </div>
                        </div>
                        <div class="card" style="border-radius: 8px;">
                            <div class="card-header bg-gray-800 text-white py-2" style="border-radius: 8px 8px 0 0;">
                                <div class="d-flex gap-2">
                                    <span class="w-3 h-3 rounded-full bg-red-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-yellow-500"></span>
                                    <span class="w-3 h-3 rounded-full bg-green-500"></span>
                                    <span class="ml-2 text-sm">进程输出日志</span>
                                </div>
                            </div>
                            <div id="consoleOutput_${processId}" class="card-body bg-gray-900 text-green-400 p-3 font-mono text-sm h-64 overflow-auto" style="white-space: pre-wrap;">
                                <i class="fas fa-spinner fa-spin mr-2"></i>正在获取进程输出信息...
                            </div>
                        </div>
                    </div>
                `;
                
                const modal = new bootstrap.Modal(document.getElementById('processDetailModal'));
                modal.show();
                
                // 获取并显示进程输出信息
                fetchConsoleOutput(processId);
                
                // 如果进程正在执行，设置自动刷新
                if (process.status === '执行中') {
                    const intervalId = setInterval(() => {
                        fetchConsoleOutput(processId);
                    }, 3000);
                    
                    // 模态框关闭时清除定时器
                    const modalElement = document.getElementById('processDetailModal');
                    modalElement.addEventListener('hidden.bs.modal', function() {
                        clearInterval(intervalId);
                    }, { once: true });
                }
            } else {
                alert('获取进程详情失败: ' + data.message);
            }
        })
        .catch(error => {
            console.error('获取进程详情失败:', error);
            alert('获取进程详情失败，请检查网络连接');
        });
}

// 获取进程控制台输出
function fetchConsoleOutput(processId) {
    fetch(`/api/icloud/process/output/${processId}`)
        .then(response => response.json())
        .then(data => {
            const consoleElement = document.getElementById(`consoleOutput_${processId}`);
            if (consoleElement) {
                if (data.success && data.output) {
                    consoleElement.textContent = data.output;
                } else {
                    consoleElement.textContent = data.output || '暂无输出信息';
                }
                // 自动滚动到底部
                consoleElement.scrollTop = consoleElement.scrollHeight;
            }
        })
        .catch(error => {
            console.error('获取进程输出失败:', error);
            const consoleElement = document.getElementById(`consoleOutput_${processId}`);
            if (consoleElement) {
                consoleElement.textContent = '获取输出信息失败';
            }
        });
}

// 清空控制台输出
function clearConsoleOutput(processId) {
    const consoleElement = document.getElementById(`consoleOutput_${processId}`);
    if (consoleElement) {
        consoleElement.textContent = '控制台输出已清空';
    }
}

// 刷新控制台输出
function refreshConsoleOutput(processId) {
    fetchConsoleOutput(processId);
}

// 使用立即执行函数包装所有代码
// 页面加载完成后加载进程列表
document.addEventListener('DOMContentLoaded', function() {
    console.log("页面加载完成，开始初始化...");
    loadProcessList();
    // 每5秒刷新一次进程列表
    setInterval(loadProcessList, 5000);
});
</script>
{% endblock %}