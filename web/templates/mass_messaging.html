<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群发管理 - 虚拟机管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 15px rgba(102, 126, 234, 0.3);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            width: 280px;
            color: white;
        }
        
        /* 调整顶部导航栏 */
        .navbar {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            z-index: 999;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .accordion-button:not(.collapsed) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            box-shadow: none;
        }
        
        .accordion-button {
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            font-weight: 600;
        }
        
        .accordion-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .accordion-button:focus {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button::after {
            filter: invert(1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .accordion-item {
            background: transparent;
            border: none;
        }
        
        .accordion-body {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 0 8px;
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
        }
        .table-responsive {
            width: 100%;
        }
        .card {
            width: 100%;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .main-content {
                width: 100%;
                margin-left: 0;
            }
        }
        
        @media (min-width: 769px) {
            .main-content {
                width: calc(100% - 280px);
                margin-left: 280px;
            }
        }

    
            .main-content {
                margin-left: 280px;
                padding: 20px;
                background: #f8f9fa;
                min-height: 100vh;
                width: calc(100% - 280px);
                box-sizing: border-box;
            }

        html, body { width: 100%; overflow-x: hidden !important; }
        
        /* 统一布局规则 */
        .sidebar { width: 280px; position: fixed; height: 100vh; }
        .main-content { 
            margin-left: 280px; 
            width: calc(100vw - 280px); 
            min-width: 0; 
            padding: 20px;
            min-height: 100vh;
            overflow-x: auto;
            box-sizing: border-box;
            background: white; 
            border-radius: 10px;
        }
        .card-body { padding: 1.5rem; }
        .table-responsive { border-radius: 8px; overflow: hidden; }
        
        /* 统计卡片样式 */
        .phone-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 150px;
            flex: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #0d6efd;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* 表格样式 */
        .phone-table {
            margin-bottom: 0;
        }
        
        .phone-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            padding: 15px 12px;
        }
        
        .phone-table td {
            padding: 12px;
            vertical-align: middle;
        }
        
        .phone-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 数据容器样式 */
        .phone-data-container .alert {
            border-radius: 8px;
            border: none;
            padding: 15px;
        }
        
        /* 分页样式 */
        .pagination-sm .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .pagination-sm .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        /* 卡片头部样式 */
        .card-header {
            padding: 4rem 4.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .card-header .d-flex {
            min-height: 50px;
        }
        
        .card-header .btn {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* 响应式按钮布局 */
        @media (max-width: 1200px) {
            .card-header .d-flex {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start !important;
            }
            
            .card-header .d-flex > div {
                width: 100%;
                justify-content: flex-start;
            }
            
            .card-header .input-group {
                width: 100% !important;
                max-width: 400px;
                min-width: auto !important;
            }
        }
        
        @media (max-width: 768px) {
            .card-header .d-flex > div {
                flex-direction: column;
                gap: 10px;
            }
            
            .card-header .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 侧边栏标题样式 */
        .sidebar-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        
        .brand-text {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-header h4 {
            margin-bottom: 5px !important;
        }
        
        .sidebar-header small {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        </style>
    <!-- 左侧菜单 -->
    <nav class="col-md-3 col-lg-2 sidebar p-3">
                <div class="sidebar-header text-center mb-4">
                <h4 class="mb-0">
                                                <span class="brand-text">MacOS VM 虚拟机管理平台</span>
                </h4>
                
            </div>
                <div class="accordion" id="accordionMenu">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingVM">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVM" aria-expanded="false" aria-controls="collapseVM">
                        虚拟机管理
                    </button>
                </h2>
                <div id="collapseVM" class="accordion-collapse collapse" aria-labelledby="headingVM" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('clone_vm_page') }}">虚拟机批量克隆</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('vm_management_page') }}">虚拟机信息管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('vm_script_page') }}">虚拟机脚本管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingClient">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClient" aria-expanded="false" aria-controls="collapseClient">
                        客户端管理
                    </button>
                </h2>
                <div id="collapseClient" class="accordion-collapse collapse" aria-labelledby="headingClient" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('client_management_page') }}">ScptRunner客户端管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('json_parser_page') }}"><i class="fas fa-code me-2"></i>JSON解析功能</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
             <!-- 发信管理主菜单 -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingMessaging">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMessaging" aria-expanded="true" aria-controls="collapseMessaging">
                        发信管理
                    </button>
                </h2>
                <div id="collapseMessaging" class="accordion-collapse collapse show" aria-labelledby="headingMessaging" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="{{ url_for('phone_management_page') }}"><i class="fas fa-phone me-2"></i>手机号管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('mass_messaging_page') }}"><i class="fas fa-broadcast-tower me-2"></i>群发管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingBoot">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBoot" aria-expanded="false" aria-controls="collapseBoot">
                        杂项管理
                    </button>
                </h2>
                <div id="collapseBoot" class="accordion-collapse collapse" aria-labelledby="headingBoot" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('wuma_page') }}">虚拟机五码管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('mupan_page') }}">虚拟机母盘管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('id_management_page') }}">Apple ID管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingEncrypt">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncrypt" aria-expanded="false" aria-controls="collapseEncrypt">
                        数据加密功能
                    </button>
                </h2>
                <div id="collapseEncrypt" class="accordion-collapse collapse" aria-labelledby="headingEncrypt" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_code_page') }}">代码加密</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_wuma_page') }}">五码加密</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_id_page') }}">ID加密</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingProxy">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProxy" aria-expanded="false" aria-controls="collapseProxy">
                        代理IP配置
                    </button>
                </h2>
                <div id="collapseProxy" class="accordion-collapse collapse" aria-labelledby="headingProxy" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('proxy_assign_page') }}">代理IP分配</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSoft">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSoft" aria-expanded="false" aria-controls="collapseSoft">
                        虚拟机软件管理
                    </button>
                </h2>
                <div id="collapseSoft" class="accordion-collapse collapse" aria-labelledby="headingSoft" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('soft_version_page') }}">版本查看</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('soft_env_page') }}">环境变量</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSystem">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSystem" aria-expanded="false" aria-controls="collapseSystem">
                        系统管理
                    </button>
                </h2>
                <div id="collapseSystem" class="accordion-collapse collapse" aria-labelledby="headingSystem" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="#">系统版本</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">系统插件管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">用户管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">授权管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
            </nav>
            
            <!-- 右侧内容区域 -->
            <div class="main-content">
                <!-- 顶部导航栏 -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1">
                        <i class="fas fa-broadcast-tower me-3"></i>群发管理
                        </span>
                        <div class="d-flex">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-3">
                                <i class="fas fa-home me-2"></i>主页
                            </a>
                            <div class="dropdown me-3">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    语言
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="langDropdown">
                                    <li><a class="dropdown-item" href="?lang=zh">中文</a></li>
                                    <li><a class="dropdown-item" href="?lang=en">English</a></li>
                                </ul>
                            </div>
                            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">登出</a>
                        </div>
                    </div>
                </nav>

                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <h4 class="mb-0">
                                <i class="fas fa-broadcast-tower me-2"></i>群发任务管理
                            </h4>
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                <button type="button" class="btn btn-primary" onclick="scanClients()">
                                    <i class="fas fa-search me-2"></i>扫描客户端
                                </button>
                                <button type="button" class="btn btn-success btn-sm" id="autoScanBtn" onclick="toggleAutoScan()">
                                    <i class="fas fa-play"></i> 开启自动扫描
                                </button>
                                <button type="button" class="btn btn-warning" onclick="batchSendMessage()" id="batchSendBtn" disabled>
                                    <i class="fas fa-paper-plane me-2"></i>批量发信
                                </button>
                                <button type="button" class="btn btn-success" onclick="createNewTemplate()">
                                    <i class="fas fa-file-alt me-2"></i>新建模版
                                </button>
                                <div class="input-group" style="width: 300px; min-width: 250px;">
                                    <input type="text" class="form-control" id="clientSearch" placeholder="搜索客户端...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchClients()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 客户端统计信息 -->
                        <div class="phone-stats" id="clientStats">
                            <div class="stat-card">
                                <div class="stat-number" id="totalClients">0</div>
                                <div class="stat-label">总客户端数量</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="onlineClients">0</div>
                                <div class="stat-label">在线数量</div>
                            </div>
                        </div>
                        
                        <!-- 客户端数据展示区域 -->
                        <div class="phone-data-container" id="clientDataContainer">
                            <!-- 表格容器 -->
                            <div class="table-responsive" id="table-container">
                                <table class="table table-hover phone-table">
                                    <thead>
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                                            </th>
                                            <th><i class="fas fa-hashtag me-1"></i>序号</th>
                                            <th><i class="fas fa-tag me-1"></i>客户端版本</th>
                                            <th><i class="fas fa-network-wired me-1"></i>客户端IP地址</th>
                                            <th><i class="fas fa-signal me-1"></i>状态</th>
                                            <th><i class="fas fa-cogs me-1"></i>操作列</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientList">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">
                                                <i class="fas fa-search me-2"></i>点击"扫描客户端"开始扫描网络中的ScptRunner客户端
                                            </td>
                                        </tr>
                                    </tbody>
                            </table>
                        </div>
                            
                            <!-- 分页控件 -->
                            <div class="d-flex justify-content-between align-items-center mt-3" id="paginationContainer">
                                <div class="d-flex align-items-center">
                                    <div class="text-muted me-3">
                                        <i class="fas fa-info-circle me-1"></i>
                                        显示 <span id="startRecord" class="fw-bold">1</span> - <span id="endRecord" class="fw-bold">3</span> 条，共 <span id="totalRecords" class="fw-bold">3</span> 条记录
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">每页显示:</label>
                                        <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;" onchange="changePageSize()">
                                            <option value="5" selected>5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                    </div>
                                </div>
                                <nav aria-label="任务列表分页">
                                    <ul class="pagination pagination-sm mb-0" id="taskPagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" onclick="previousPage()">
                                                <i class="fas fa-chevron-left"></i> 上一页
                                            </a>
                                        </li>
                                        <li class="page-item active">
                                            <a class="page-link" href="#" onclick="goToPage(1)">1</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="#" onclick="nextPage()">
                                                下一页 <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建群发任务模态框 -->
    <div class="modal fade" id="newTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建群发任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newTaskForm">
                        <div class="mb-3">
                            <label for="taskName" class="form-label">任务名称</label>
                            <input type="text" class="form-control" id="taskName" placeholder="请输入任务名称">
                        </div>
                        <div class="mb-3">
                            <label for="clientIds" class="form-label">选择客户端 <small class="text-muted">(可多选)</small></label>
                            <select class="form-control" id="clientIds" multiple size="4">
                                <option value="" disabled>正在加载客户端列表...</option>
                            </select>
                            <small class="form-text text-muted">按住Ctrl键可选择多个客户端</small>
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumbers" class="form-label">选择手机号 <small class="text-muted">(可多选)</small></label>
                            <select class="form-control" id="phoneNumbers" multiple size="6">
                                <option value="" disabled>正在加载手机号列表...</option>
                            </select>
                            <small class="form-text text-muted">按住Ctrl键可选择多个手机号</small>
                        </div>
                        <div class="mb-3">
                            <label for="taskTemplate" class="form-label">选择模版</label>
                            <select class="form-control" id="taskTemplate">
                                <option value="">请选择模版</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="taskMessage" class="form-label">消息内容</label>
                            <textarea class="form-control" id="taskMessage" rows="4" placeholder="请输入消息内容"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskSchedule" class="form-label">执行时间</label>
                            <input type="datetime-local" class="form-control" id="taskSchedule">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewTask()">创建任务</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建模版模态框 -->
    <div class="modal fade" id="newTemplateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建模版</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newTemplateForm">
                        <div class="mb-3">
                            <label for="templateName" class="form-label">模版名称</label>
                            <input type="text" class="form-control" id="templateName" placeholder="请输入模版名称">
                        </div>
                        <div class="mb-3">
                            <label for="templateContent" class="form-label">模版内容</label>
                            <textarea class="form-control" id="templateContent" rows="6" placeholder="请输入模版内容"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="templateAttachment" class="form-label">模版附件</label>
                            <input type="file" class="form-control" id="templateAttachment" name="templateAttachment" accept="*/*">
                            <small class="form-text text-muted">支持上传单个附件文件</small>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewTemplate()">保存模版</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 任务详情模态框 -->
    <div class="modal fade" id="taskDetailModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">任务详细信息</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="taskDetailContent">
                        <!-- 任务详情内容将在这里动态加载 -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 批量发信模态框 -->
    <div class="modal fade" id="batchSendModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量发信</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- 左侧：模板选择和预览 -->
                        <div class="col-md-6">
                            <div class="card" style="height: 350px;">
                                <div class="card-header py-2">
                                    <h6 class="mb-0 small">发信模板</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="mb-2">
                                        <label for="batchTemplate" class="form-label small">选择模板</label>
                                        <select class="form-control form-control-sm" id="batchTemplate" onchange="previewTemplate()">
                                            <option value="">请选择模板</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 文本预览 -->
                                    <div class="mb-2">
                                        <label class="form-label small">文本内容预览</label>
                                        <div class="border rounded p-2 small" id="textPreview" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                            <span class="text-muted">请选择模板查看预览</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 附件预览 -->
                                    <div class="mb-2">
                                        <label class="form-label small">附件预览</label>
                                        <div class="border rounded p-2 small" id="attachmentPreview" style="height: 80px; overflow-y: auto; background-color: #f8f9fa;">
                                            <span class="text-muted">暂无附件</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：选中的客户端信息 -->
                        <div class="col-md-6">
                            <div class="card" style="height: 350px;">
                                <div class="card-header py-2">
                                    <h6 class="mb-0 small">选中的客户端 (<span id="selectedClientCount">0</span>)</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="selectedClientsInfo" style="height: 300px; overflow-y: auto;">
                                        <div class="text-muted text-center py-3 small">
                                            暂无选中的客户端
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="executeBatchSend()" id="executeSendBtn">执行</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VNC连接模态框 -->
    <div class="modal fade" id="vncModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-desktop me-2"></i>VNC远程连接
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- 加载状态 -->
                    <div id="vncLoadingDiv" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">连接中...</span>
                        </div>
                        <p class="mt-3 text-muted">正在建立VNC连接，请稍候...</p>
                    </div>
                    
                    <!-- VNC连接内容 -->
                    <div id="vncContentDiv" style="display: none;">
                        <!-- 工具栏 -->
                        <div class="vnc-toolbar bg-light border-bottom px-3 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="vnc-info">
                                    <small class="text-muted">
                                        <i class="fas fa-server me-1"></i>
                                        <span id="vncHostInfo">连接信息</span>
                                    </small>
                                </div>
                                <div class="vnc-controls">
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="refreshVNC()" title="刷新连接">
                                        <i class="fas fa-sync-alt"></i> 刷新
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning me-2" onclick="sendCtrlAltDel()" title="发送Ctrl+Alt+Del">
                                        <i class="fas fa-keyboard"></i> Ctrl+Alt+Del
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="disconnectVNC()" title="断开连接">
                                        <i class="fas fa-times"></i> 断开
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- VNC显示区域 -->
                        <div id="vncViewerDiv" class="vnc-viewer position-relative">
                            <div class="vnc-screen bg-dark d-flex align-items-center justify-content-center" style="height: 600px;">
                                <div class="text-center text-light">
                                    <i class="fas fa-desktop fa-3x mb-3" style="opacity: 0.5;"></i>
                                    <p class="mb-0">VNC连接界面</p>
                                    <small class="text-muted">远程桌面将在此处显示</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 错误信息 -->
                    <div id="vncErrorDiv" class="alert alert-danger m-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>连接失败</strong>
                                <div id="vncErrorMessage" class="mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <small class="text-muted me-auto">
                        <i class="fas fa-info-circle me-1"></i>
                        提示：可使用工具栏按钮进行远程操作
                    </small>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 新建群发任务
        async function createNewTask() {
            // 加载客户端和手机号列表
            loadClientList();
            loadPhoneList();
            
            // 确保模板列表已加载
            if (!globalTemplates || globalTemplates.length === 0) {
                await loadTemplates();
            }
            
            new bootstrap.Modal(document.getElementById('newTaskModal')).show();
        }

        // 加载客户端列表
        async function loadClientList() {
            const clientSelect = document.getElementById('clientIds');
            clientSelect.innerHTML = '<option value="" disabled>正在加载客户端列表...</option>';
            
            try {
                const response = await fetch('/api/scan_clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.clients) {
                    clientSelect.innerHTML = '';
                    data.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id || client.ip;
                        option.textContent = `${client.ip} (${client.vm_name || '未知虚拟机'})`;
                        clientSelect.appendChild(option);
                    });
                    
                    if (data.clients.length === 0) {
                        clientSelect.innerHTML = '<option value="" disabled>暂无可用客户端</option>';
                    }
                } else {
                    clientSelect.innerHTML = '<option value="" disabled>加载客户端列表失败</option>';
                }
            } catch (error) {
                console.error('加载客户端列表失败:', error);
                clientSelect.innerHTML = '<option value="" disabled>加载客户端列表失败</option>';
            }
        }

        // 加载手机号列表
        async function loadPhoneList() {
            const phoneSelect = document.getElementById('phoneNumbers');
            phoneSelect.innerHTML = '<option value="" disabled>正在加载手机号列表...</option>';
            
            try {
                const response = await fetch('/api/phone_list?page=1&size=100');
                const data = await response.json();
                
                if (data.success && data.phones) {
                    phoneSelect.innerHTML = '';
                    data.phones.forEach(phone => {
                        const option = document.createElement('option');
                        option.value = phone.phone_number || phone;
                        option.textContent = phone.phone_number || phone;
                        phoneSelect.appendChild(option);
                    });
                    
                    if (data.phones.length === 0) {
                        phoneSelect.innerHTML = '<option value="" disabled>暂无可用手机号</option>';
                    }
                } else {
                    phoneSelect.innerHTML = '<option value="" disabled>加载手机号列表失败</option>';
                }
            } catch (error) {
                console.error('加载手机号列表失败:', error);
                phoneSelect.innerHTML = '<option value="" disabled>加载手机号列表失败</option>';
            }
        }

        // 新建模版
        function createNewTemplate() {
            new bootstrap.Modal(document.getElementById('newTemplateModal')).show();
        }

        // 保存新任务
        function saveNewTask() {
            const taskName = document.getElementById('taskName').value;
            const clientSelect = document.getElementById('clientIds');
            const phoneSelect = document.getElementById('phoneNumbers');
            const taskMessage = document.getElementById('taskMessage').value;
            
            // 获取选中的客户端
            const selectedClients = Array.from(clientSelect.selectedOptions).map(option => option.value);
            // 获取选中的手机号
            const selectedPhones = Array.from(phoneSelect.selectedOptions).map(option => option.value);
            
            if (!taskName || selectedClients.length === 0 || selectedPhones.length === 0 || !taskMessage) {
                alert('请填写任务名称、选择至少一个客户端、至少一个手机号，并输入消息内容');
                return;
            }
            
            // 构建任务数据
            const taskData = {
                name: taskName,
                clients: selectedClients,
                phones: selectedPhones,
                message: taskMessage,
                template: document.getElementById('taskTemplate').value,
                schedule: document.getElementById('taskSchedule').value
            };
            
            console.log('创建任务数据:', taskData);
            
            // 显示选择的信息
            const clientInfo = selectedClients.length > 1 ? `${selectedClients.length}个客户端` : selectedClients[0];
            const phoneInfo = selectedPhones.length > 1 ? `${selectedPhones.length}个手机号` : selectedPhones[0];
            
            alert(`任务创建成功！\n客户端: ${clientInfo}\n手机号: ${phoneInfo}`);
            bootstrap.Modal.getInstance(document.getElementById('newTaskModal')).hide();
            
            // 清空表单
            document.getElementById('newTaskForm').reset();
            
            // 这里可以添加实际的保存逻辑和刷新列表
        }


        // 保存新模版
        async function saveNewTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const content = document.getElementById('templateContent').value;
            const attachmentInput = document.getElementById('templateAttachment');
            
            if (!name || !content) {
                alert('请填写模版名称和内容');
                return;
            }
            
            try {
                // 首先保存模板文本内容
                const templateData = {
                    name: name,
                    content: content
                };
                
                const templateResponse = await fetch('/api/mass_messaging/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                const templateResult = await templateResponse.json();
                
                if (!templateResult.success) {
                    alert('保存模板失败: ' + templateResult.message);
                    return;
                }
                
                // 如果有附件，上传附件
                if (attachmentInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append('template_name', name);
                    formData.append('file', attachmentInput.files[0]);
                    
                    const attachmentResponse = await fetch('/api/mass_messaging/templates/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const attachmentResult = await attachmentResponse.json();
                    
                    if (!attachmentResult.success) {
                        alert('模板保存成功，但附件上传失败: ' + attachmentResult.message);
                    } else {
                        alert('模板和附件保存成功！');
                    }
                } else {
                    alert('模板保存成功！');
                }
                
                bootstrap.Modal.getInstance(document.getElementById('newTemplateModal')).hide();
                // 清空表单
                document.getElementById('newTemplateForm').reset();
                // 重新加载模板列表
                loadTemplates();
                
            } catch (error) {
                console.error('保存模版失败:', error);
                alert('保存失败: 网络错误');
            }
        }

        // 扫描客户端
        async function scanClients() {
            const tbody = document.querySelector('#clientList');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>正在扫描客户端...</td></tr>';
            
            try {
                const data = await getClientStatus();
                
                if (data && data.clients) {
                    displayClients(data.clients);
                    updateClientStats(data.clients);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">扫描失败: ' + (data?.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('扫描客户端失败:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">扫描失败: 网络错误</td></tr>';
            }
        }

        // 显示客户端列表
        function displayClients(clients) {
            const tbody = document.querySelector('#clientList');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">未发现任何客户端</td></tr>';
                return;
            }
            
            tbody.innerHTML = clients.map((client, index) => `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input client-checkbox" 
                               value="${client.ip}" data-client='${JSON.stringify(client)}' 
                               onchange="updateBatchSendButton()">
                    </td>
                    <td>${index + 1}</td>
                    <td>${client.version || '未知版本'}</td>
                    <td>${client.ip}</td>
                    <td>
                        <span class="badge ${client.status === 'online' ? 'bg-success' : 'bg-secondary'}">
                            ${client.status === 'online' ? '在线' : '离线'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary me-1" onclick="viewClientDetail('${client.ip}')">
                            <i class="fas fa-eye"></i> 详情
                        </button>
                        <button class="btn btn-sm btn-outline-success" onclick="connectVNC('${client.ip}')" title="VNC登录">
                            <i class="fas fa-desktop"></i> VNC
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 更新客户端统计信息
        function updateClientStats(clients) {
            const totalClients = clients.length;
            const onlineClients = clients.filter(c => c.status === 'online').length;
            
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('onlineClients').textContent = onlineClients;
        }

        // 更新批量发信按钮状态
        function updateBatchSendButton() {
            const checkboxes = document.querySelectorAll('.client-checkbox:checked');
            const onlineCheckboxes = Array.from(checkboxes).filter(cb => {
                const clientData = JSON.parse(cb.dataset.client);
                return clientData.status === 'online';
            });
            
            const batchSendBtn = document.getElementById('batchSendBtn');
            batchSendBtn.disabled = onlineCheckboxes.length === 0;
        }

        // 批量发信
        async function batchSendMessage() {
            const checkboxes = document.querySelectorAll('.client-checkbox:checked');
            const selectedClients = Array.from(checkboxes)
                .map(cb => JSON.parse(cb.dataset.client))
                .filter(client => client.status === 'online');
            
            if (selectedClients.length === 0) {
                alert('请选择至少一个在线的客户端');
                return;
            }
            
            // 显示选中的客户端信息
            displaySelectedClients(selectedClients);
            
            // 确保模板列表已加载
            if (globalTemplates.length === 0) {
                await loadTemplates();
            }
            
            // 显示批量发信模态框
            new bootstrap.Modal(document.getElementById('batchSendModal')).show();
        }

        // 显示选中的客户端信息
        function displaySelectedClients(clients) {
            const container = document.getElementById('selectedClientsInfo');
            const countSpan = document.getElementById('selectedClientCount');
            
            countSpan.textContent = clients.length;
            
            container.innerHTML = clients.map(client => `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${client.ip}</strong>
                            <small class="text-muted d-block">版本: ${client.version || '未知'}</small>
                        </div>
                        <span class="badge bg-success">在线</span>
                    </div>
                </div>
            `).join('');
        }

        // 全局模板数据
        let globalTemplates = [];
        
        // 加载模板列表
        async function loadTemplates() {
            try {
                const data = await getTemplateList();
                
                if (data && data.data) {
                    globalTemplates = data.data;
                    updateTemplateSelect();
                } else {
                    console.error('加载模板失败:', data?.message);
                    alert('加载模板失败: ' + (data?.message || '未知错误'));
                }
            } catch (error) {
                console.error('加载模板失败:', error);
                alert('加载模板失败: ' + error.message);
            }
        }
        
        // 更新模板下拉选择
        function updateTemplateSelect() {
            // 更新批量发信模态框中的模板选择
            const batchSelect = document.getElementById('batchTemplate');
            if (batchSelect) {
                batchSelect.innerHTML = '<option value="">请选择模板</option>';
                
                globalTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    batchSelect.appendChild(option);
                });
            }
            
            // 更新新建任务模态框中的模板选择
            const taskSelect = document.getElementById('taskTemplate');
            if (taskSelect) {
                taskSelect.innerHTML = '<option value="">请选择模版</option>';
                
                globalTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    taskSelect.appendChild(option);
                });
            }
        }
        
        // 模板预览
        function previewTemplate() {
            const templateId = document.getElementById('batchTemplate').value;
            const textPreview = document.getElementById('textPreview');
            const attachmentPreview = document.getElementById('attachmentPreview');
            
            if (!templateId) {
                textPreview.innerHTML = '<span class="text-muted">请选择模板查看预览</span>';
                attachmentPreview.innerHTML = '<span class="text-muted">暂无附件</span>';
                return;
            }
            
            // 从全局模板数据中查找
            const template = globalTemplates.find(t => t.id == templateId);
            if (template) {
                textPreview.innerHTML = template.content || '<span class="text-muted">无文本内容</span>';
                
                if (template.has_attachment && template.attachment_name) {
                    attachmentPreview.innerHTML = `
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-file me-2"></i>
                            <span>${template.attachment_name}</span>
                        </div>
                    `;
                } else {
                    attachmentPreview.innerHTML = '<span class="text-muted">暂无附件</span>';
                }
            } else {
                textPreview.innerHTML = '<span class="text-danger">模板不存在</span>';
                attachmentPreview.innerHTML = '<span class="text-muted">暂无附件</span>';
            }
        }

        // 执行批量发信
        function executeBatchSend() {
            const templateId = document.getElementById('batchTemplate').value;
            
            if (!templateId) {
                alert('请选择发信模板');
                return;
            }
            
            if (confirm('确定要执行批量发信吗？')) {
                alert('批量发信任务已提交，请在任务列表中查看执行状态');
                bootstrap.Modal.getInstance(document.getElementById('batchSendModal')).hide();
            }
        }

        // 查看客户端详情
        function viewClientDetail(clientIp) {
            alert(`查看客户端详情: ${clientIp}\n功能开发中...`);
        }

        // VNC连接
        async function connectVNC(clientIp) {
            console.log('连接VNC:', clientIp);
            
            // 显示加载状态
            const loadingContent = `
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">连接中...</span>
                    </div>
                    <div class="mt-2">正在读取VMX文件并建立VNC连接...</div>
                </div>
            `;
            
            document.getElementById('vncContentDiv').innerHTML = loadingContent;
            const modal = new bootstrap.Modal(document.getElementById('vncModal'));
            modal.show();
            
            try {
                // 调用后端API获取VNC连接信息
                const response = await fetch('/api/vnc/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_ip: clientIp
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 显示VNC连接界面
                    const vncContent = `
                        <div class="vnc-container">
                            <div class="vnc-info mb-3">
                                <div class="row">
                                    <div class="col-md-6">
                                        <h6>连接信息</h6>
                                        <table class="table table-sm">
                                            <tr><td>客户端IP:</td><td>${clientIp}</td></tr>
                                            <tr><td>VNC端口:</td><td>${data.vnc_port}</td></tr>
                                            <tr><td>VMX文件:</td><td>${data.vmx_file}</td></tr>
                                            <tr><td>连接状态:</td><td><span class="badge bg-success">已连接</span></td></tr>
                                        </table>
                                    </div>
                                    <div class="col-md-6">
                                        <h6>操作控制</h6>
                                        <div class="btn-group-vertical d-grid gap-2">
                                            <button class="btn btn-sm btn-outline-primary" onclick="refreshVNC()">
                                                <i class="fas fa-sync-alt"></i> 刷新连接
                                            </button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="sendCtrlAltDel()">
                                                <i class="fas fa-keyboard"></i> Ctrl+Alt+Del
                                            </button>
                                            <button class="btn btn-sm btn-outline-danger" onclick="disconnectVNC()">
                                                <i class="fas fa-times"></i> 断开连接
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="vnc-viewer">
                                <div class="border" style="height: 500px; background-color: #000; position: relative; overflow: hidden;">
                                    <div class="text-center text-white" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
                                        <i class="fas fa-desktop fa-3x mb-3"></i>
                                        <div>VNC连接已建立</div>
                                        <div class="small mt-2">端口: ${data.vnc_port}</div>
                                        <div class="small">密码: ${data.vnc_password ? '已设置' : '无密码'}</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    
                    document.getElementById('vncContentDiv').innerHTML = vncContent;
                } else {
                    // 显示错误信息
                    const errorContent = `
                        <div class="alert alert-danger" role="alert">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            VNC连接失败: ${data.message}
                        </div>
                        <div class="text-muted">
                            <h6>可能的原因:</h6>
                            <ul>
                                <li>VMX文件不存在或无法读取</li>
                                <li>VNC配置未启用</li>
                                <li>虚拟机未运行</li>
                                <li>网络连接问题</li>
                            </ul>
                        </div>
                    `;
                    document.getElementById('vncContentDiv').innerHTML = errorContent;
                }
            } catch (error) {
                console.error('VNC连接失败:', error);
                const errorContent = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        VNC连接失败: ${error.message}
                    </div>
                `;
                document.getElementById('vncContentDiv').innerHTML = errorContent;
            }
        }

        // 刷新VNC连接
        function refreshVNC() {
            console.log('刷新VNC连接');
            alert('VNC连接已刷新');
        }

        // 发送Ctrl+Alt+Del
        function sendCtrlAltDel() {
            console.log('发送Ctrl+Alt+Del');
            alert('已发送Ctrl+Alt+Del组合键');
        }

        // 断开VNC连接
        function disconnectVNC() {
            if (confirm('确定要断开VNC连接吗？')) {
                bootstrap.Modal.getInstance(document.getElementById('vncModal')).hide();
                console.log('VNC连接已断开');
            }
        }

        // 搜索客户端
        function searchClients() {
            const keyword = document.getElementById('clientSearch').value;
            console.log('搜索客户端:', keyword);
            // 这里添加搜索逻辑
        }

        // 启动任务
        function startTask(taskId) {
            if (confirm('确定要启动这个任务吗？')) {
                console.log('启动任务:', taskId);
                // 这里添加启动任务的逻辑
                alert('任务启动成功！');
            }
        }

        // 暂停任务
        function pauseTask(taskId) {
            if (confirm('确定要暂停这个任务吗？')) {
                console.log('暂停任务:', taskId);
                // 这里添加暂停任务的逻辑
                alert('任务已暂停！');
            }
        }

        // 停止任务
        function stopTask(taskId) {
            if (confirm('确定要停止这个任务吗？')) {
                console.log('停止任务:', taskId);
                // 这里添加停止任务的逻辑
                alert('任务已停止！');
            }
        }

        // 删除任务
        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？此操作不可恢复！')) {
                console.log('删除任务:', taskId);
                // 这里添加删除任务的逻辑
                alert('任务已删除！');
            }
        }

        // 编辑任务
        function editTask(taskId) {
            console.log('编辑任务:', taskId);
            // 这里添加编辑任务的逻辑
            alert('编辑任务功能开发中...');
        }

        // 查看任务详情
        function viewTaskDetail(taskId) {
            console.log('查看任务详情:', taskId);
            
            // 显示加载状态
            const loadingContent = `
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div class="mt-2">正在获取任务详情和截图...</div>
                </div>
            `;
            
            document.getElementById('taskDetailContent').innerHTML = loadingContent;
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();
            
            // 获取虚拟机IP（这里需要根据实际情况获取，暂时使用示例IP）
            const vmIp = '192.168.119.137'; // 可以从客户端列表或其他地方获取
            
            // 调用截图API
            fetch('/api/task_screenshot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    task_id: taskId,
                    vm_ip: vmIp
                })
            })
            .then(response => response.json())
            .then(data => {
                let screenshotSection = '';
                
                if (data.success) {
                    screenshotSection = `
                        <div class="mt-3">
                            <h6>虚拟机截图</h6>
                            <div class="border p-3 text-center">
                                <img src="${data.screenshot_path}" alt="任务截图" class="img-fluid" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 4px;">
                                <div class="mt-2 text-muted small">截图时间: ${data.timestamp}</div>
                            </div>
                        </div>
                    `;
                } else {
                    screenshotSection = `
                        <div class="mt-3">
                            <h6>虚拟机截图</h6>
                            <div class="border p-3 text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                截图获取失败: ${data.message}
                            </div>
                        </div>
                    `;
                }
                
                // 构建完整的任务详情内容
                const taskDetail = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>基本信息</h6>
                            <table class="table table-sm">
                                <tr><td>任务ID:</td><td>${taskId}</td></tr>
                                <tr><td>任务名称:</td><td>新年祝福群发</td></tr>
                                <tr><td>虚拟机IP:</td><td>${vmIp}</td></tr>
                                <tr><td>创建时间:</td><td>2025-01-15 10:30:00</td></tr>
                                <tr><td>状态:</td><td><span class="badge bg-success">运行中</span></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>执行统计</h6>
                            <table class="table table-sm">
                                <tr><td>总数:</td><td>1000</td></tr>
                                <tr><td>已发送:</td><td>856</td></tr>
                                <tr><td>成功:</td><td>823</td></tr>
                                <tr><td>失败:</td><td>33</td></tr>
                                <tr><td>成功率:</td><td>96.1%</td></tr>
                            </table>
                        </div>
                    </div>
                    ${screenshotSection}
                    <div class="mt-3">
                        <h6>消息内容</h6>
                        <div class="border p-3 bg-light">
                            亲爱的{姓名}，新年快乐！祝您在新的一年里身体健康，工作顺利，阖家幸福！
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>执行日志</h6>
                        <div class="border p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <small>
                                2025-01-15 10:30:01 - 任务开始执行<br>
                                2025-01-15 10:30:05 - 开始发送消息到手机号 138****1234<br>
                                2025-01-15 10:30:06 - 消息发送成功 138****1234<br>
                                2025-01-15 10:30:07 - 开始发送消息到手机号 139****5678<br>
                                2025-01-15 10:30:08 - 消息发送成功 139****5678<br>
                                2025-01-15 10:30:09 - 开始发送消息到手机号 136****9012<br>
                                2025-01-15 10:30:10 - 消息发送失败 136****9012 - 号码异常<br>
                                ...
                            </small>
                        </div>
                    </div>
                `;
                
                document.getElementById('taskDetailContent').innerHTML = taskDetail;
            })
            .catch(error => {
                console.error('获取任务详情失败:', error);
                const errorContent = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        获取任务详情失败: ${error.message}
                    </div>
                `;
                document.getElementById('taskDetailContent').innerHTML = errorContent;
            });
        }

        // 分页功能
        function previousPage() {
            console.log('上一页');
            // 这里添加上一页逻辑
        }

        function nextPage() {
            console.log('下一页');
            // 这里添加下一页逻辑
        }

        function goToPage(page) {
            console.log('跳转到第', page, '页');
            // 这里添加跳转页面逻辑
        }
        
        // 改变每页显示数量
        function changePageSize() {
            const pageSize = document.getElementById('pageSizeSelect').value;
            console.log('改变每页显示数量为:', pageSize);
            // 这里添加改变页面大小的逻辑
        }

        // 自动扫描定时器
        let autoScanInterval = null;
        let isAutoScanEnabled = false;
        
        // 开启自动扫描
        function startAutoScan() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
            }
            
            isAutoScanEnabled = true;
            console.log('开启自动扫描，每30秒扫描一次');
            
            // 立即执行一次扫描
            scanClients();
            
            // 设置定时器，每30秒扫描一次
            autoScanInterval = setInterval(() => {
                if (isAutoScanEnabled) {
                    console.log('自动扫描客户端...');
                    scanClients();
                }
            }, 30000); // 30秒
            
            // 更新按钮状态
            updateAutoScanButton();
        }
        
        // 停止自动扫描
        function stopAutoScan() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
            }
            
            isAutoScanEnabled = false;
            console.log('停止自动扫描');
            
            // 更新按钮状态
            updateAutoScanButton();
        }
        
        // 切换自动扫描状态
        function toggleAutoScan() {
            if (isAutoScanEnabled) {
                stopAutoScan();
            } else {
                startAutoScan();
            }
        }
        
        // 更新自动扫描按钮状态
        function updateAutoScanButton() {
            const autoScanBtn = document.getElementById('autoScanBtn');
            if (autoScanBtn) {
                if (isAutoScanEnabled) {
                    autoScanBtn.innerHTML = '<i class="fas fa-stop"></i> 停止自动扫描';
                    autoScanBtn.className = 'btn btn-warning btn-sm';
                } else {
                    autoScanBtn.innerHTML = '<i class="fas fa-play"></i> 开启自动扫描';
                    autoScanBtn.className = 'btn btn-success btn-sm';
                }
            }
        }
        
        // 异步获取JSON数据的通用函数
        async function fetchJsonData(url, options = {}) {
            try {
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                const finalOptions = { ...defaultOptions, ...options };
                
                const response = await fetch(url, finalOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return { success: true, data };
                
            } catch (error) {
                console.error(`获取数据失败 (${url}):`, error);
                return { success: false, error: error.message };
            }
        }
        
        // 异步获取客户端状态
        async function getClientStatus() {
            const result = await fetchJsonData('/api/scan_clients', {
                method: 'POST'
            });
            
            if (result.success) {
                return result.data;
            } else {
                console.error('获取客户端状态失败:', result.error);
                return null;
            }
        }
        
        // 异步获取模板列表
        async function getTemplateList() {
            const result = await fetchJsonData('/api/mass_messaging/templates');
            
            if (result.success) {
                return result.data;
            } else {
                console.error('获取模板列表失败:', result.error);
                return null;
            }
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('群发管理界面已加载');
            
            // 自动开始扫描客户端
            scanClients();
            
            // 加载模板列表
            loadTemplates();
            
            // 开启自动扫描
            startAutoScan();
            
            // 保持发信管理菜单栏展开状态
            // 移除了自动关闭菜单的功能，让用户手动控制菜单展开/折叠
        });
    </script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>