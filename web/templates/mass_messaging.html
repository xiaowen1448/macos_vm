<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>群发管理 - 虚拟机管理系统</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <!-- noVNC CSS -->
    <!-- noVNC CSS暂时禁用，避免CDN资源被阻止 -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/novnc@1.4.0/app/styles/base.css"> -->
    <!-- <link rel="stylesheet" href="https://unpkg.com/novnc@1.4.0/app/styles/ui.css"> -->
    <!-- Socket.IO -->
     <script type="module" src="static/js/novnc/rfb.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 15px rgba(102, 126, 234, 0.3);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            width: 280px;
            color: white;
        }
        
        /* 调整顶部导航栏 */
        .navbar {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            z-index: 999;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .accordion-button:not(.collapsed) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            box-shadow: none;
        }
        
        .accordion-button {
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            font-weight: 600;
        }
        
        .accordion-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .accordion-button:focus {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button::after {
            filter: invert(1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .accordion-item {
            background: transparent;
            border: none;
        }
        
        .accordion-body {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 0 8px;
        }

        .table {
            border-radius: 10px;
            overflow: hidden;
            width: 100%;
        }
        .table-responsive {
            width: 100%;
        }
        .card {
            width: 100%;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            .main-content {
                width: 100%;
                margin-left: 0;
            }
        }
        
        @media (min-width: 769px) {
            .main-content {
                width: calc(100% - 280px);
                margin-left: 280px;
            }
        }

    
            .main-content {
                margin-left: 280px;
                padding: 20px;
                background: #f8f9fa;
                min-height: 100vh;
                width: calc(100% - 280px);
                box-sizing: border-box;
            }

        html, body { width: 100%; overflow-x: hidden !important; }
        
        /* 统一布局规则 */
        .sidebar { width: 280px; position: fixed; height: 100vh; }
        .main-content { 
            margin-left: 280px; 
            width: calc(100vw - 280px); 
            min-width: 0; 
            padding: 20px;
            min-height: 100vh;
            overflow-x: auto;
            box-sizing: border-box;
            background: white; 
            border-radius: 10px;
        }
        .card-body { padding: 1.5rem; }
        .table-responsive { border-radius: 8px; overflow: hidden; }
        
        /* 统计卡片样式 */
        .phone-stats {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            min-width: 150px;
            flex: 1;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
            color: #0d6efd;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #6c757d;
        }
        
        /* 表格样式 */
        .phone-table {
            margin-bottom: 0;
        }
        
        .phone-table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
            padding: 15px 12px;
        }
        
        .phone-table td {
            padding: 12px;
            vertical-align: middle;
        }
        
        .phone-table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 数据容器样式 */
        .phone-data-container .alert {
            border-radius: 8px;
            border: none;
            padding: 15px;
        }
        
        /* 分页样式 */
        .pagination-sm .page-link {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }
        
        .pagination-sm .page-item.active .page-link {
            background-color: #007bff;
            border-color: #007bff;
        }
        
        /* 卡片头部样式 */
        .card-header {
            padding: 4rem 4.5rem;
            border-bottom: 1px solid #dee2e6;
        }
        
        .card-header .d-flex {
            min-height: 50px;
        }
        
        .card-header .btn {
            white-space: nowrap;
            flex-shrink: 0;
        }
        
        /* 响应式按钮布局 */
        @media (max-width: 1200px) {
            .card-header .d-flex {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start !important;
            }
            
            .card-header .d-flex > div {
                width: 100%;
                justify-content: flex-start;
            }
            
            .card-header .input-group {
                width: 100% !important;
                max-width: 400px;
                min-width: auto !important;
            }
        }
        
        @media (max-width: 768px) {
            .card-header .d-flex > div {
                flex-direction: column;
                gap: 10px;
            }
            
            .card-header .btn {
                width: 100%;
                justify-content: center;
            }
        }
        
        /* 侧边栏标题样式 */
        .sidebar-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        
        .brand-text {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-header h4 {
            margin-bottom: 5px !important;
        }
        
        .sidebar-header small {
            font-size: 0.85rem;
            opacity: 0.8;
        }

        </style>
    <!-- 左侧菜单 -->
    <nav class="col-md-3 col-lg-2 sidebar p-3">
                <div class="sidebar-header text-center mb-4">
                <h4 class="mb-0">
                                                <span class="brand-text">MacOS VM 虚拟机管理平台</span>
                </h4>
                
            </div>
                <div class="accordion" id="accordionMenu">
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingVM">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVM" aria-expanded="false" aria-controls="collapseVM">
                        虚拟机管理
                    </button>
                </h2>
                <div id="collapseVM" class="accordion-collapse collapse" aria-labelledby="headingVM" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('clone_vm_page') }}">虚拟机批量克隆</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('vm_management_page') }}">虚拟机信息管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('vm_script_page') }}">虚拟机脚本管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingClient">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClient" aria-expanded="false" aria-controls="collapseClient">
                        客户端管理
                    </button>
                </h2>
                <div id="collapseClient" class="accordion-collapse collapse" aria-labelledby="headingClient" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('client_management_page') }}">ScptRunner客户端管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('json_parser_page') }}"><i class="fas fa-code me-2"></i>JSON解析功能</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
             <!-- 发信管理主菜单 -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingMessaging">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMessaging" aria-expanded="true" aria-controls="collapseMessaging">
                        发信管理
                    </button>
                </h2>
                <div id="collapseMessaging" class="accordion-collapse collapse show" aria-labelledby="headingMessaging" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="{{ url_for('phone_management_page') }}"><i class="fas fa-phone me-2"></i>手机号管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('mass_messaging.mass_messaging_page') }}"><i class="fas fa-broadcast-tower me-2"></i>群发管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingBoot">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBoot" aria-expanded="false" aria-controls="collapseBoot">
                        杂项管理
                    </button>
                </h2>
                <div id="collapseBoot" class="accordion-collapse collapse" aria-labelledby="headingBoot" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('wuma_page') }}">虚拟机五码管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('mupan_page') }}">虚拟机母盘管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('id_management_page') }}">Apple ID管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingEncrypt">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncrypt" aria-expanded="false" aria-controls="collapseEncrypt">
                        数据加密功能
                    </button>
                </h2>
                <div id="collapseEncrypt" class="accordion-collapse collapse" aria-labelledby="headingEncrypt" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_code_page') }}">代码加密</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_wuma_page') }}">五码加密</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('encrypt_id_page') }}">ID加密</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingProxy">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProxy" aria-expanded="false" aria-controls="collapseProxy">
                        代理IP配置
                    </button>
                </h2>
                <div id="collapseProxy" class="accordion-collapse collapse" aria-labelledby="headingProxy" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('proxy_assign_page') }}">代理IP分配</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSoft">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSoft" aria-expanded="false" aria-controls="collapseSoft">
                        虚拟机软件管理
                    </button>
                </h2>
                <div id="collapseSoft" class="accordion-collapse collapse" aria-labelledby="headingSoft" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('soft_version_page') }}">版本查看</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('soft_env_page') }}">环境变量</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingSystem">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSystem" aria-expanded="false" aria-controls="collapseSystem">
                        系统管理
                    </button>
                </h2>
                <div id="collapseSystem" class="accordion-collapse collapse" aria-labelledby="headingSystem" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="#">系统版本</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">系统插件管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">用户管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#">授权管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
            </nav>
            
            <!-- 右侧内容区域 -->
            <div class="main-content">
                <!-- 顶部导航栏 -->
                <nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
                    <div class="container-fluid">
                        <span class="navbar-brand mb-0 h1">
                        <i class="fas fa-broadcast-tower me-3"></i>群发管理
                        </span>
                        <div class="d-flex">
                            <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-3">
                                <i class="fas fa-home me-2"></i>主页
                            </a>
                            <div class="dropdown me-3">
                                <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                    语言
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="langDropdown">
                                    <li><a class="dropdown-item" href="?lang=zh">中文</a></li>
                                    <li><a class="dropdown-item" href="?lang=en">English</a></li>
                                </ul>
                            </div>
                            <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">登出</a>
                        </div>
                    </div>
                </nav>

                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center flex-wrap">
                            <h4 class="mb-0">
                                <i class="fas fa-broadcast-tower me-2"></i>群发任务管理
                            </h4>
                            <div class="d-flex align-items-center flex-wrap gap-2">
                                <button type="button" class="btn btn-primary" onclick="scanClients()">
                                    <i class="fas fa-search me-2"></i>扫描客户端
                                </button>
                                <button type="button" class="btn btn-warning" onclick="batchSendMessage()" id="batchSendBtn" disabled>
                                    <i class="fas fa-paper-plane me-2"></i>批量发信
                                </button>
                                <button type="button" class="btn btn-success" onclick="createNewTemplate()">
                                    <i class="fas fa-file-alt me-2"></i>新建模版
                                </button>
                                <div class="input-group" style="width: 300px; min-width: 250px;">
                                    <input type="text" class="form-control" id="clientSearch" placeholder="搜索客户端...">
                                    <button class="btn btn-outline-secondary" type="button" onclick="searchClients()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 客户端统计信息 -->
                        <div class="phone-stats" id="clientStats">
                            <div class="stat-card">
                                <div class="stat-number" id="totalClients">0</div>
                                <div class="stat-label">总客户端数量</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="onlineClients">0</div>
                                <div class="stat-label">在线数量</div>
                            </div>
                        </div>
                        
                        <!-- 客户端数据展示区域 -->
                        <div class="phone-data-container" id="clientDataContainer">
                            <!-- 表格容器 -->
                            <div class="table-responsive" id="table-container">
                                <table class="table table-hover phone-table">
                                    <thead>
                                        <tr>
                                            <th width="50">
                                                <input type="checkbox" id="selectAllCheckbox" class="form-check-input">
                                            </th>
                                            <th><i class="fas fa-hashtag me-1"></i>序号</th>
                                            <th><i class="fas fa-tag me-1"></i>客户端版本</th>
                                            <th><i class="fas fa-network-wired me-1"></i>客户端IP地址</th>
                                            <th><i class="fas fa-signal me-1"></i>状态</th>
                                            <th><i class="fas fa-cogs me-1"></i>操作列</th>
                                        </tr>
                                    </thead>
                                    <tbody id="clientList">
                                        <tr>
                                            <td colspan="7" class="text-center text-muted py-4">
                                                <i class="fas fa-search me-2"></i>点击"扫描客户端"开始扫描网络中的ScptRunner客户端
                                            </td>
                                        </tr>
                                    </tbody>
                            </table>
                        </div>
                            
                            <!-- 分页控件 -->
                            <div class="d-flex justify-content-between align-items-center mt-3" id="paginationContainer">
                                <div class="d-flex align-items-center">
                                    <div class="text-muted me-3">
                                        <i class="fas fa-info-circle me-1"></i>
                                        显示 <span id="startRecord" class="fw-bold">1</span> - <span id="endRecord" class="fw-bold">3</span> 条，共 <span id="totalRecords" class="fw-bold">3</span> 条记录
                                    </div>
                                    <div class="d-flex align-items-center">
                                        <label class="form-label mb-0 me-2">每页显示:</label>
                                        <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;" onchange="changePageSize()">
                                            <option value="5" selected>5</option>
                                            <option value="10">10</option>
                                            <option value="20">20</option>
                                            <option value="50">50</option>
                                        </select>
                                    </div>
                                </div>
                                <nav aria-label="任务列表分页">
                                    <ul class="pagination pagination-sm mb-0" id="taskPagination">
                                        <li class="page-item disabled">
                                            <a class="page-link" href="#" onclick="previousPage()">
                                                <i class="fas fa-chevron-left"></i> 上一页
                                            </a>
                                        </li>
                                        <li class="page-item active">
                                            <a class="page-link" href="#" onclick="goToPage(1)">1</a>
                                        </li>
                                        <li class="page-item">
                                            <a class="page-link" href="#" onclick="nextPage()">
                                                下一页 <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    </ul>
                                </nav>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建群发任务模态框 -->
    <div class="modal fade" id="newTaskModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建群发任务</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newTaskForm">
                        <div class="mb-3">
                            <label for="taskName" class="form-label">任务名称</label>
                            <input type="text" class="form-control" id="taskName" placeholder="请输入任务名称">
                        </div>
                        <div class="mb-3">
                            <label for="clientIds" class="form-label">选择客户端 <small class="text-muted">(可多选)</small></label>
                            <select class="form-control" id="clientIds" multiple size="4">
                                <option value="" disabled>正在加载客户端列表...</option>
                            </select>
                            <small class="form-text text-muted">按住Ctrl键可选择多个客户端</small>
                        </div>
                        <div class="mb-3">
                            <label for="phoneNumbers" class="form-label">选择手机号 <small class="text-muted">(可多选)</small></label>
                            <select class="form-control" id="phoneNumbers" multiple size="6">
                                <option value="" disabled>正在加载手机号列表...</option>
                            </select>
                            <small class="form-text text-muted">按住Ctrl键可选择多个手机号</small>
                        </div>
                        <div class="mb-3">
                            <label for="taskTemplate" class="form-label">选择模版</label>
                            <select class="form-control" id="taskTemplate">
                                <option value="">请选择模版</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="taskMessage" class="form-label">消息内容</label>
                            <textarea class="form-control" id="taskMessage" rows="4" placeholder="请输入消息内容"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="taskSchedule" class="form-label">执行时间</label>
                            <input type="datetime-local" class="form-control" id="taskSchedule">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewTask()">创建任务</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 新建模版模态框 -->
    <div class="modal fade" id="newTemplateModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">新建模版</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="newTemplateForm">
                        <div class="mb-3">
                            <label for="templateName" class="form-label">模版名称</label>
                            <input type="text" class="form-control" id="templateName" placeholder="请输入模版名称">
                        </div>
                        <div class="mb-3">
                            <label for="templateContent" class="form-label">模版内容</label>
                            <textarea class="form-control" id="templateContent" rows="6" placeholder="请输入模版内容"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="templateAttachment" class="form-label">模版附件</label>
                            <input type="file" class="form-control" id="templateAttachment" name="templateAttachment" accept="*/*">
                            <small class="form-text text-muted">支持上传单个附件文件</small>
                        </div>
                        
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="saveNewTemplate()">保存模版</button>
                </div>
            </div>
        </div>
    </div>

   

    <!-- 批量发信模态框 -->
    <div class="modal fade" id="batchSendModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 75%; width: 75%;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">批量发信</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <!-- 左侧：模板选择和预览 -->
                        <div class="col-md-6">
                            <div class="card" style="height: 500px;">
                                <div class="card-header py-2">
                                    <h6 class="mb-0 small">发信模板</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div class="mb-2">
                                        <label for="phoneTemplate" class="form-label small">选择手机号模板</label>
                                        <select class="form-control form-control-sm" id="phoneTemplate" onchange="previewPhoneTemplate()">
                                            <option value="">请选择手机号模板</option>
                                        </select>
                                        <!-- 手机号模板预览 -->
                                        <div class="border rounded p-2 small mt-1" id="phonePreview" style="height: 50px; overflow-y: auto; background-color: #f8f9fa;">
                                            <span class="text-muted">暂无手机号模板</span>
                                        </div>
                                    </div>
                                    
                                    <div class="mb-2">
                                        <label for="batchTemplate" class="form-label small">选择模板</label>
                                        <select class="form-control form-control-sm" id="batchTemplate" onchange="previewTemplate()">
                                            <option value="">请选择模板</option>
                                        </select>
                                    </div>
                                    
                                    <!-- 文本预览 -->
                                    <div class="mb-2">
                                        <label class="form-label small">文本内容预览</label>
                                        <div class="border rounded p-2 small" id="textPreview" style="height: 120px; overflow-y: auto; background-color: #f8f9fa;">
                                            <span class="text-muted">请选择模板查看预览</span>
                                        </div>
                                    </div>
                                    
                                    <!-- 附件预览 -->
                                    <div class="mb-2">
                                        <label class="form-label small">附件预览</label>
                                        <div class="border rounded p-2 small" id="attachmentPreview" style="height: 50px; overflow-y: auto; background-color: #f8f9fa;">
                                            <span class="text-muted">暂无附件</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- 右侧：选中的客户端信息 -->
                        <div class="col-md-6">
                            <div class="card" style="height: 450px;">
                                <div class="card-header py-2">
                                    <h6 class="mb-0 small">选中的客户端 (<span id="selectedClientCount">0</span>)</h6>
                                </div>
                                <div class="card-body p-2">
                                    <div id="selectedClientsInfo" style="height: 400px; overflow-y: auto;">
                                        <div class="text-muted text-center py-3 small">
                                            暂无选中的客户端
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" onclick="executeBatchSend()" id="executeSendBtn">执行</button>
                </div>
            </div>
        </div>
    </div>

    <!-- VNC连接模态框 -->
    <div class="modal fade" id="vncModal" tabindex="-1">
        <div class="modal-dialog modal-lg vnc-resizable" style="max-width: 50%; width: 50%; min-width: 400px; min-height: 300px;">
            <div class="modal-content vnc-modal-content">
                <div class="modal-header bg-primary text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-desktop me-2"></i>VNC远程连接
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <!-- 加载状态 -->
                    <div id="vncLoadingDiv" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">连接中...</span>
                        </div>
                        <p class="mt-3 text-muted">正在建立VNC连接，请稍候...</p>
                    </div>
                    
                    <!-- VNC连接内容 -->
                    <div id="vncContentDiv" style="display: none;">
                        <!-- 工具栏 -->
                        <div class="vnc-toolbar bg-light border-bottom px-3 py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <div class="vnc-info">
                                    <small class="text-muted">
                                        <i class="fas fa-server me-1"></i>
                                        <span id="vncHostInfo">连接信息</span>
                                    </small>
                                </div>
                                <div class="vnc-controls">
                                    <button type="button" class="btn btn-sm btn-outline-info me-2" onclick="toggleFullscreen()" title="全屏/退出全屏" id="fullscreenBtn">
                                        <i class="fas fa-expand"></i> 全屏
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning me-2" onclick="sendCtrlAltDel()" title="发送Ctrl+Alt+Del">
                                        <i class="fas fa-keyboard"></i> Ctrl+Alt+Del
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2" onclick="cleanupAllVNCConnections()" title="清理所有VNC连接和进程">
                                        <i class="fas fa-broom"></i> 清理全部
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="disconnectVNC()" title="断开连接">
                                        <i class="fas fa-times"></i> 断开
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- VNC显示区域 -->
                        <div id="vncViewerDiv" class="vnc-viewer position-relative">
                            <div class="vnc-status-bar bg-secondary text-white px-3 py-1 d-flex justify-content-between align-items-center">
                                <span class="small">
                                    <i class="fas fa-circle me-1"></i>
                                    状态: <span id="vncStatus" class="badge bg-warning">未连接</span>
                                </span>
                                <button id="vncReconnectBtn" class="btn btn-sm btn-outline-light" onclick="reconnectVNC()" style="display: none;">
                                    <i class="fas fa-sync-alt"></i> 重连
                                </button>
                            </div>
                            <div id="vncScreen" class="vnc-screen bg-dark" style="height: 400px; overflow: hidden;">
                                <!-- noVNC将在此处渲染 -->
                            </div>
                        </div>
                    </div>
                    
                    <!-- 错误信息 -->
                    <div id="vncErrorDiv" class="alert alert-danger m-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <div>
                                <strong>连接失败</strong>
                                <div id="vncErrorMessage" class="mt-1"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 发信记录模态框 -->
    <div class="modal fade" id="messageRecordsModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 75%; width: 75%;">
            <div class="modal-content">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title">
                        <i class="fas fa-history me-2"></i>发信记录
                    </h5>
                    <div class="d-flex align-items-center">
                        <button type="button" class="btn btn-outline-light btn-sm me-2" id="exportRecordsBtn">
                            <i class="fas fa-download me-1"></i>导出
                        </button>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto;">
                    <!-- 发信记录内容将在这里动态加载 -->
                    <div class="text-center">
                        <i class="fas fa-spinner fa-spin me-2"></i>正在加载发信记录...
                    </div>
                </div>
                <div class="modal-footer d-flex justify-content-between align-items-center">
                    <div class="d-flex align-items-center">
                        <span class="text-muted me-3" id="recordsInfo">共 0 条记录</span>
                        <select class="form-select form-select-sm me-2" id="recordsPageSizeSelect" style="width: auto;">
                            <option value="10">每页 10 条</option>
                            <option value="20" selected>每页 20 条</option>
                            <option value="50">每页 50 条</option>
                            <option value="100">每页 100 条</option>
                        </select>
                    </div>
                    <div class="d-flex align-items-center">
                        <nav>
                            <ul class="pagination pagination-sm mb-0 me-3" id="recordsPagination">
                                <!-- 分页按钮将在这里动态生成 -->
                            </ul>
                        </nav>
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-2"></i>关闭
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 新建群发任务
        async function createNewTask() {
            // 加载客户端和手机号列表
            loadClientList();
            loadPhoneList();
            
            // 确保模板列表已加载
            if (!globalTemplates || globalTemplates.length === 0) {
                await loadTemplates();
            }
            
            new bootstrap.Modal(document.getElementById('newTaskModal')).show();
        }

        // 加载客户端列表
        async function loadClientList() {
            const clientSelect = document.getElementById('clientIds');
            clientSelect.innerHTML = '<option value="" disabled>正在加载客户端列表...</option>';
            
            try {
                const response = await fetch('/api/scan_clients', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                const data = await response.json();
                
                if (data.success && data.clients) {
                    clientSelect.innerHTML = '';
                    data.clients.forEach(client => {
                        const option = document.createElement('option');
                        option.value = client.id || client.ip;
                        option.textContent = `${client.ip} (${client.vm_name || '未知虚拟机'})`;
                        clientSelect.appendChild(option);
                    });
                    
                    if (data.clients.length === 0) {
                        clientSelect.innerHTML = '<option value="" disabled>暂无可用客户端</option>';
                    }
                } else {
                    clientSelect.innerHTML = '<option value="" disabled>加载客户端列表失败</option>';
                }
            } catch (error) {
                console.error('加载客户端列表失败:', error);
                clientSelect.innerHTML = '<option value="" disabled>加载客户端列表失败</option>';
            }
        }

        // 查看发信记录函数
        async function viewMessageRecords(clientIp, vmName) {
            try {
                // 显示加载状态
                const modal = new bootstrap.Modal(document.getElementById('messageRecordsModal'));
                const modalBody = document.querySelector('#messageRecordsModal .modal-body');
                modalBody.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>正在下载并解析发信记录...</div>';
                modal.show();
                
                // 设置模态框标题
                document.querySelector('#messageRecordsModal .modal-title').textContent = `发信记录 - ${vmName || clientIp}`;
                
                // 调用后端API下载chat.db文件
                const downloadResponse = await fetch('/api/mass_messaging/download_chat_db', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ 
                        client_ip: clientIp,
                        vm_name: vmName || clientIp
                    })
                });
                
                if (!downloadResponse.ok) {
                    throw new Error('下载chat.db文件失败');
                }
                
                const downloadResult = await downloadResponse.json();
                if (!downloadResult.success) {
                    throw new Error(downloadResult.message || '下载chat.db文件失败');
                }
                
                // 调用后端API解析数据库并获取发信记录
                const recordsResponse = await fetch(`/api/mass_messaging/get_message_records?vm_name=${encodeURIComponent(vmName || clientIp)}`, {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });
                
                if (!recordsResponse.ok) {
                    throw new Error('获取发信记录失败');
                }
                
                const recordsResult = await recordsResponse.json();
                if (!recordsResult.success) {
                    throw new Error(recordsResult.message || '获取发信记录失败');
                }
                
                // 显示发信记录
                displayMessageRecords(recordsResult.records || []);
                
            } catch (error) {
                console.error('查看发信记录失败:', error);
                const modalBody = document.querySelector('#messageRecordsModal .modal-body');
                modalBody.innerHTML = `<div class="alert alert-danger"><i class="fas fa-exclamation-triangle me-2"></i>查看发信记录失败: ${error.message}</div>`;
            }
        }
        
        // 全局变量存储发信记录数据
        let globalMessageRecords = [];
        let currentPage = 1;
        let pageSize = 20;
        
        // 显示发信记录
        function displayMessageRecords(records) {
            globalMessageRecords = records || [];
            currentPage = 1;
            pageSize = parseInt(document.getElementById('pageSizeSelect').value) || 20;
            
            if (globalMessageRecords.length === 0) {
                const modalBody = document.querySelector('#messageRecordsModal .modal-body');
                modalBody.innerHTML = '<div class="alert alert-info"><i class="fas fa-info-circle me-2"></i>暂无发信记录</div>';
                updateRecordsInfo(0, 0, 0);
                updatePagination(0);
                return;
            }
            
            renderRecordsPage();
            setupPaginationEvents();
            setupExportEvent();
        }
        
        // 渲染当前页的记录
        function renderRecordsPage() {
            const modalBody = document.querySelector('#messageRecordsModal .modal-body');
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = Math.min(startIndex + pageSize, globalMessageRecords.length);
            const pageRecords = globalMessageRecords.slice(startIndex, endIndex);
            
            let tableHtml = `
                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm">
                        <thead class="table-dark">
                            <tr>
                                <th style="width: 12%;">消息ID</th>
                                <th style="width: 12%;">发送账号</th>
                                <th style="width: 12%;">联系人ID</th>
                                <th style="width: 25%;">消息正文</th>
                                <th style="width: 10%;">服务类型</th>
                                <th style="width: 8%;">发送</th>
                                <th style="width: 8%;">送达</th>
                                <th style="width: 8%;">已读</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            pageRecords.forEach(record => {
                // 截断过长的消息内容
                const shortContent = record.message_content && record.message_content.length > 40 
                    ? record.message_content.substring(0, 40) + '...' 
                    : (record.message_content || 'N/A');
                
                // 截断过长的联系人ID
                const shortContactId = record.contact_id && record.contact_id.length > 15
                    ? record.contact_id.substring(0, 15) + '...'
                    : (record.contact_id || 'N/A');
                    
                // 截断过长的消息ID
                const shortMessageId = record.message_id && record.message_id.length > 15
                    ? record.message_id.substring(0, 15) + '...'
                    : (record.message_id || 'N/A');
                
                tableHtml += `
                    <tr>
                        <td><small><code title="${record.message_id || ''}">${shortMessageId}</code></small></td>
                        <td><small>${record.sender_account || 'N/A'}</small></td>
                        <td><small title="${record.contact_id || ''}">${shortContactId}</small></td>
                        <td><small title="${record.message_content || ''}">${shortContent}</small></td>
                        <td><small><span class="badge bg-info">${record.service_type || 'N/A'}</span></small></td>
                        <td><span class="badge ${record.is_sent === '是' ? 'bg-success' : 'bg-danger'} badge-sm">${record.is_sent}</span></td>
                        <td><span class="badge ${record.is_delivered === '是' ? 'bg-success' : 'bg-warning'} badge-sm">${record.is_delivered}</span></td>
                        <td><span class="badge ${record.is_read === '是' ? 'bg-success' : 'bg-secondary'} badge-sm">${record.is_read}</span></td>
                    </tr>
                `;
            });
            
            tableHtml += `
                        </tbody>
                    </table>
                </div>
            `;
            
            modalBody.innerHTML = tableHtml;
            updateRecordsInfo(globalMessageRecords.length, startIndex + 1, endIndex);
            updatePagination(globalMessageRecords.length);
        }
        
        // 更新记录信息
        function updateRecordsInfo(total, start, end) {
            const recordsInfo = document.getElementById('recordsInfo');
            if (total === 0) {
                recordsInfo.textContent = '共 0 条记录';
            } else {
                recordsInfo.textContent = `显示 ${start}-${end} 条，共 ${total} 条记录`;
            }
        }
        
        // 更新分页
        function updatePagination(totalRecords) {
            const pagination = document.getElementById('recordsPagination');
            const totalPages = Math.ceil(totalRecords / pageSize);
            
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }
            
            let paginationHtml = '';
            
            // 上一页按钮
            paginationHtml += `
                <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage - 1}">
                        <i class="fas fa-chevron-left"></i>
                    </a>
                </li>
            `;
            
            // 页码按钮
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            if (startPage > 1) {
                paginationHtml += '<li class="page-item"><a class="page-link" href="#" data-page="1">1</a></li>';
                if (startPage > 2) {
                    paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }
            
            for (let i = startPage; i <= endPage; i++) {
                paginationHtml += `
                    <li class="page-item ${i === currentPage ? 'active' : ''}">
                        <a class="page-link" href="#" data-page="${i}">${i}</a>
                    </li>
                `;
            }
            
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHtml += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                paginationHtml += `<li class="page-item"><a class="page-link" href="#" data-page="${totalPages}">${totalPages}</a></li>`;
            }
            
            // 下一页按钮
            paginationHtml += `
                <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                    <a class="page-link" href="#" data-page="${currentPage + 1}">
                        <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;
            
            pagination.innerHTML = paginationHtml;
        }
        
        // 设置分页事件
        function setupPaginationEvents() {
            // 分页大小改变事件
            document.getElementById('recordsPageSizeSelect').addEventListener('change', function() {
                pageSize = parseInt(this.value);
                currentPage = 1;
                renderRecordsPage();
            });
            
            // 分页点击事件
            document.getElementById('recordsPagination').addEventListener('click', function(e) {
                e.preventDefault();
                if (e.target.tagName === 'A' && e.target.dataset.page) {
                    const newPage = parseInt(e.target.dataset.page);
                    if (newPage !== currentPage && newPage > 0 && newPage <= Math.ceil(globalMessageRecords.length / pageSize)) {
                        currentPage = newPage;
                        renderRecordsPage();
                    }
                }
            });
        }
        
        // 设置导出事件
        function setupExportEvent() {
            document.getElementById('exportRecordsBtn').addEventListener('click', function() {
                exportRecordsToCSV();
            });
        }
        
        // 导出记录为CSV
        function exportRecordsToCSV() {
            if (!globalMessageRecords || globalMessageRecords.length === 0) {
                alert('没有可导出的数据');
                return;
            }
            
            // CSV头部
            const headers = ['消息唯一ID', '发送账号', '联系人ID', '消息正文', '服务类型', '是否发送', '是否送达', '是否已读'];
            let csvContent = headers.join(',') + '\n';
            
            // CSV数据行
            globalMessageRecords.forEach(record => {
                const row = [
                    `"${(record.message_id || 'N/A').replace(/"/g, '""')}"`,
                    `"${(record.sender_account || 'N/A').replace(/"/g, '""')}"`,
                    `"${(record.contact_id || 'N/A').replace(/"/g, '""')}"`,
                    `"${(record.message_content || 'N/A').replace(/"/g, '""')}"`,
                    `"${(record.service_type || 'N/A').replace(/"/g, '""')}"`,
                    `"${record.is_sent || 'N/A'}"`,
                    `"${record.is_delivered || 'N/A'}"`,
                    `"${record.is_read || 'N/A'}"`
                ];
                csvContent += row.join(',') + '\n';
            });
            
            // 创建下载链接
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            
            // 生成文件名
            const now = new Date();
            const timestamp = now.getFullYear() + 
                String(now.getMonth() + 1).padStart(2, '0') + 
                String(now.getDate()).padStart(2, '0') + '_' +
                String(now.getHours()).padStart(2, '0') + 
                String(now.getMinutes()).padStart(2, '0') + 
                String(now.getSeconds()).padStart(2, '0');
            
            link.setAttribute('download', `发信记录_${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // 显示成功提示
            const exportBtn = document.getElementById('exportRecordsBtn');
            const originalText = exportBtn.innerHTML;
            exportBtn.innerHTML = '<i class="fas fa-check me-1"></i>已导出';
            exportBtn.disabled = true;
            
            setTimeout(() => {
                exportBtn.innerHTML = originalText;
                exportBtn.disabled = false;
            }, 2000);
        }

        // 加载手机号列表
        async function loadPhoneList() {
            const phoneSelect = document.getElementById('phoneNumbers');
            phoneSelect.innerHTML = '<option value="" disabled>正在加载手机号列表...</option>';
            
            try {
                const response = await fetch('/api/phone_list?page=1&size=100');
                const data = await response.json();
                
                if (data.success && data.phones) {
                    phoneSelect.innerHTML = '';
                    data.phones.forEach(phone => {
                        const option = document.createElement('option');
                        option.value = phone.phone_number || phone;
                        option.textContent = phone.phone_number || phone;
                        phoneSelect.appendChild(option);
                    });
                    
                    if (data.phones.length === 0) {
                        phoneSelect.innerHTML = '<option value="" disabled>暂无可用手机号</option>';
                    }
                } else {
                    phoneSelect.innerHTML = '<option value="" disabled>加载手机号列表失败</option>';
                }
            } catch (error) {
                console.error('加载手机号列表失败:', error);
                phoneSelect.innerHTML = '<option value="" disabled>加载手机号列表失败</option>';
            }
        }

        // 新建模版
        function createNewTemplate() {
            new bootstrap.Modal(document.getElementById('newTemplateModal')).show();
        }

        // 保存新任务
        function saveNewTask() {
            const taskName = document.getElementById('taskName').value;
            const clientSelect = document.getElementById('clientIds');
            const phoneSelect = document.getElementById('phoneNumbers');
            const taskMessage = document.getElementById('taskMessage').value;
            
            // 获取选中的客户端
            const selectedClients = Array.from(clientSelect.selectedOptions).map(option => option.value);
            // 获取选中的手机号
            const selectedPhones = Array.from(phoneSelect.selectedOptions).map(option => option.value);
            
            if (!taskName || selectedClients.length === 0 || selectedPhones.length === 0 || !taskMessage) {
                alert('请填写任务名称、选择至少一个客户端、至少一个手机号，并输入消息内容');
                return;
            }
    
            // 构建任务数据
            const taskData = {
                name: taskName,
                clients: selectedClients,
                phones: selectedPhones,
                message: taskMessage,
                template: document.getElementById('taskTemplate').value,
                schedule: document.getElementById('taskSchedule').value
            };
            
            console.log('创建任务数据:', taskData);
            
            // 显示选择的信息
            const clientInfo = selectedClients.length > 1 ? `${selectedClients.length}个客户端` : selectedClients[0];
            const phoneInfo = selectedPhones.length > 1 ? `${selectedPhones.length}个手机号` : selectedPhones[0];
            
            alert(`任务创建成功！\n客户端: ${clientInfo}\n手机号: ${phoneInfo}`);
            bootstrap.Modal.getInstance(document.getElementById('newTaskModal')).hide();
            
            // 清空表单
            document.getElementById('newTaskForm').reset();
            
            // 这里可以添加实际的保存逻辑和刷新列表
        }


        // 保存新模版
        async function saveNewTemplate() {
            const name = document.getElementById('templateName').value.trim();
            const content = document.getElementById('templateContent').value;
            const attachmentInput = document.getElementById('templateAttachment');
            
            if (!name || !content) {
                alert('请填写模版名称和内容');
                return;
            }
            
            try {
                // 首先保存模板文本内容
                const templateData = {
                    name: name,
                    content: content
                };
                
                const templateResponse = await fetch('/api/mass_messaging/templates', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(templateData)
                });
                
                const templateResult = await templateResponse.json();
                
                if (!templateResult.success) {
                    alert('保存模板失败: ' + templateResult.message);
                    return;
                }
                
                // 如果有附件，上传附件
                if (attachmentInput.files.length > 0) {
                    const formData = new FormData();
                    formData.append('template_name', name);
                    formData.append('file', attachmentInput.files[0]);
                    
                    const attachmentResponse = await fetch('/api/mass_messaging/templates/upload', {
                        method: 'POST',
                        body: formData
                    });
                    
                    const attachmentResult = await attachmentResponse.json();
                    
                    if (!attachmentResult.success) {
                        alert('模板保存成功，但附件上传失败: ' + attachmentResult.message);
                    } else {
                        alert('模板和附件保存成功！');
                    }
                } else {
                    alert('模板保存成功！');
                }
                
                bootstrap.Modal.getInstance(document.getElementById('newTemplateModal')).hide();
                // 清空表单
                document.getElementById('newTemplateForm').reset();
                // 重新加载模板列表
                loadTemplates();
                
            } catch (error) {
                console.error('保存模版失败:', error);
                alert('保存失败: 网络错误');
            }
        }

        // 扫描客户端
        async function scanClients() {
            const tbody = document.querySelector('#clientList');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center"><i class="fas fa-spinner fa-spin me-2"></i>正在扫描客户端...</td></tr>';
            
            try {
                const data = await getClientStatus();
                
                if (data && data.clients) {
                    displayClients(data.clients);
                    updateClientStats(data.clients);
                } else {
                    tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">扫描失败: ' + (data?.message || '未知错误') + '</td></tr>';
                }
            } catch (error) {
                console.error('扫描客户端失败:', error);
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">扫描失败: 网络错误</td></tr>';
            }
        }

        // 显示客户端列表
        function displayClients(clients) {
            const tbody = document.querySelector('#clientList');
            
            if (clients.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">未发现任何客户端</td></tr>';
                return;
            }
            
            tbody.innerHTML = clients.map((client, index) => `
                <tr>
                    <td>
                        <input type="checkbox" class="form-check-input client-checkbox" 
                               value="${client.ip}" data-client='${JSON.stringify(client)}' 
                               onchange="updateBatchSendButton()">
                    </td>
                    <td>${index + 1}</td>
                    <td>${client.version || '未知版本'}</td>
                    <td>${client.ip}</td>
                    <td>
                        <span class="badge ${client.status === 'online' ? 'bg-success' : 'bg-secondary'}">
                            ${client.status === 'online' ? '在线' : '离线'}
                        </span>
                    </td>
                    <td>
                        <button class="btn btn-sm btn-outline-success me-1" onclick="connectVNC('${client.ip}')" title="VNC登录">
                            <i class="fas fa-desktop"></i> VNC
                        </button>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewMessageRecords('${client.ip}', '${client.vm_name || client.ip}')" title="查看发信记录">
                            <i class="fas fa-history"></i> 记录
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        // 更新客户端统计信息
        function updateClientStats(clients) {
            const totalClients = clients.length;
            const onlineClients = clients.filter(c => c.status === 'online').length;
            
            document.getElementById('totalClients').textContent = totalClients;
            document.getElementById('onlineClients').textContent = onlineClients;
        }

        // 更新批量发信按钮状态
        function updateBatchSendButton() {
            const checkboxes = document.querySelectorAll('.client-checkbox:checked');
            const onlineCheckboxes = Array.from(checkboxes).filter(cb => {
                const clientData = JSON.parse(cb.dataset.client);
                return clientData.status === 'online';
            });
            
            const batchSendBtn = document.getElementById('batchSendBtn');
            batchSendBtn.disabled = onlineCheckboxes.length === 0;
            
            // 同时更新全选复选框状态
            updateSelectAllCheckbox();
        }

        // 获取选中的客户端
        function getSelectedClients() {
            const checkboxes = document.querySelectorAll('.client-checkbox:checked');
            const selectedClients = Array.from(checkboxes)
                .map(cb => JSON.parse(cb.dataset.client))
                .filter(client => client.status === 'online');
            return selectedClients;
        }

        // 批量发信
        async function batchSendMessage() {
            const selectedClients = getSelectedClients();
            
            if (selectedClients.length === 0) {
                alert('请选择至少一个在线的客户端');
                return;
            }
            
            // 显示选中的客户端信息
            displaySelectedClients(selectedClients);
            
            // 确保模板列表已加载
            if (globalTemplates.length === 0) {
                await loadTemplates();
            }
            
            // 显示批量发信模态框
            new bootstrap.Modal(document.getElementById('batchSendModal')).show();
        }

        // 显示选中的客户端信息
        function displaySelectedClients(clients) {
            const container = document.getElementById('selectedClientsInfo');
            const countSpan = document.getElementById('selectedClientCount');
            
            countSpan.textContent = clients.length;
            
            container.innerHTML = clients.map(client => `
                <div class="border rounded p-2 mb-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>${client.ip}</strong>
                            <small class="text-muted d-block">版本: ${client.version || '未知'}</small>
                        </div>
                        <span class="badge bg-success">在线</span>
                    </div>
                </div>
            `).join('');
        }

        // 全局变量
        let globalTemplates = [];
        let globalPhoneTemplates = [];
        
        // 加载模板列表
        async function loadTemplates() {
            try {
                const data = await getTemplateList();
                
                if (data && data.data) {
                    globalTemplates = data.data;
                    updateTemplateSelect();
                } else {
                    console.error('加载模板失败:', data?.message);
                    alert('加载模板失败: ' + (data?.message || '未知错误'));
                }
            } catch (error) {
                console.error('加载模板失败:', error);
                alert('加载模板失败: ' + error.message);
            }
        }
        
        // 加载手机号模板列表
        async function loadPhoneTemplates() {
            console.log('开始加载手机号模板...');
            try {
                const response = await fetch('/api/phone_templates');
                console.log('手机号模板API响应状态:', response.status);
                const data = await response.json();
                console.log('手机号模板API响应数据:', data);
                
                if (data.success) {
                    globalPhoneTemplates = data.data;
                    console.log('成功加载手机号模板:', globalPhoneTemplates.length, '个');
                    updatePhoneTemplateSelect();
                } else {
                    console.error('加载手机号模板失败:', data?.message);
                    // 显示错误信息到页面
                    const phoneSelect = document.getElementById('phoneTemplate');
                    if (phoneSelect) {
                        phoneSelect.innerHTML = '<option value="" disabled>加载失败: ' + (data?.message || '未知错误') + '</option>';
                    }
                }
            } catch (error) {
                console.error('加载手机号模板失败:', error);
                // 显示错误信息到页面
                const phoneSelect = document.getElementById('phoneTemplate');
                if (phoneSelect) {
                    phoneSelect.innerHTML = '<option value="" disabled>网络错误: ' + error.message + '</option>';
                }
            }
        }
        
        // 更新模板下拉选择
        function updateTemplateSelect() {
            // 更新批量发信模态框中的模板选择
            const batchSelect = document.getElementById('batchTemplate');
            if (batchSelect) {
                batchSelect.innerHTML = '<option value="">请选择模板</option>';
                
                globalTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    batchSelect.appendChild(option);
                });
            }
            
            // 更新新建任务模态框中的模板选择
            const taskSelect = document.getElementById('taskTemplate');
            if (taskSelect) {
                taskSelect.innerHTML = '<option value="">请选择模版</option>';
                
                globalTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    taskSelect.appendChild(option);
                });
            }
        }
        
        // 更新手机号模板下拉选择
        function updatePhoneTemplateSelect() {
            console.log('开始更新手机号模板下拉选择...');
            const phoneSelect = document.getElementById('phoneTemplate');
            console.log('phoneTemplate元素:', phoneSelect);
            if (phoneSelect) {
                phoneSelect.innerHTML = '<option value="">请选择手机号模板</option>';
                console.log('准备添加', globalPhoneTemplates.length, '个手机号模板选项');
                
                globalPhoneTemplates.forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.name;
                    phoneSelect.appendChild(option);
                    console.log('添加手机号模板选项:', template.name);
                });
                
                console.log('手机号模板下拉选择更新完成，当前选项数量:', phoneSelect.options.length);
            } else {
                console.error('找不到phoneTemplate元素');
            }
        }
        
        // 模板预览
        function previewTemplate() {
            const templateId = document.getElementById('batchTemplate').value;
            const textPreview = document.getElementById('textPreview');
            const attachmentPreview = document.getElementById('attachmentPreview');
            
            if (!templateId) {
                textPreview.innerHTML = '<span class="text-muted">请选择模板查看预览</span>';
                attachmentPreview.innerHTML = '<span class="text-muted">暂无附件</span>';
                return;
            }
            
            // 从全局模板数据中查找
            const template = globalTemplates.find(t => t.id == templateId);
            if (template) {
                textPreview.innerHTML = template.content || '<span class="text-muted">无文本内容</span>';
                
                if (template.has_attachment && template.attachment_name) {
                    attachmentPreview.innerHTML = `
                        <div class="d-flex align-items-center mb-2">
                            <i class="fas fa-file me-2"></i>
                            <span>${template.attachment_name}</span>
                        </div>
                    `;
                } else {
                    attachmentPreview.innerHTML = '<span class="text-muted">暂无附件</span>';
                }
            } else {
                textPreview.innerHTML = '<span class="text-danger">模板不存在</span>';
                attachmentPreview.innerHTML = '<span class="text-muted">暂无附件</span>';
            }
        }

        // 手机号模板预览
        function previewPhoneTemplate() {
            const phoneTemplateId = document.getElementById('phoneTemplate').value;
            const phonePreview = document.getElementById('phonePreview');
            
            if (!phoneTemplateId) {
                phonePreview.innerHTML = '<span class="text-muted">暂无手机号模板</span>';
                return;
            }
            
            // 从全局手机号模板数据中查找
            const phoneTemplate = globalPhoneTemplates.find(t => t.id == phoneTemplateId);
            if (phoneTemplate) {
                // 显示手机号数量和部分内容预览
                const phoneCount = phoneTemplate.phone_count || 0;
                const previewContent = phoneTemplate.preview_content || '暂无预览内容';
                phonePreview.innerHTML = `
                    <div class="d-flex align-items-center mb-1">
                        <i class="fas fa-phone me-2"></i>
                        <span class="fw-bold">${phoneTemplate.name}</span>
                    </div>
                    <div class="text-muted small">
                        包含 ${phoneCount} 个手机号<br>
                        预览: ${previewContent}
                    </div>
                `;
            } else {
                phonePreview.innerHTML = '<span class="text-danger">手机号模板不存在</span>';
            }
        }
        
        // 执行批量发信
        async function executeBatchSend() {
            const templateId = document.getElementById('batchTemplate').value;
            const phoneTemplateId = document.getElementById('phoneTemplate').value;
            
            if (!templateId) {
                alert('请选择发信模板');
                return;
            }
            
            if (!phoneTemplateId) {
                alert('请选择手机号模板');
                return;
            }
            
            // 获取选中的客户端
            const selectedClients = getSelectedClients();
            if (selectedClients.length === 0) {
                alert('请选择至少一个在线的客户端');
                return;
            }
            
            if (!confirm(`确定要向 ${selectedClients.length} 个客户端执行批量发信吗？`)) {
                return;
            }
            
            // 获取按钮元素
            const executeBtn = document.querySelector('#batchSendModal .btn-primary');
            
            try {
                // 显示执行中状态
                executeBtn.disabled = true;
                executeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>执行中...';
                
                // 发送批量发信异步请求
                const response = await fetch('/api/mass_messaging/send_async', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        template_id: templateId,
                        phone_template_id: phoneTemplateId,
                        selected_clients: selectedClients
                    })
                });
                
                const result = await response.json();
                console.log('批量发信异步响应数据:', result);
                
                if (result.success) {
                    // 构建简化的结果显示
                    let detailsText = result.results.map(r => {
                        let status = r.success ? '✅ 已执行' : '❌ 失败';
                        return `${r.client_ip}: ${status} - ${r.message}`;
                    }).join('\n');
                    
                    // 更新按钮为执行完毕状态
                    executeBtn.innerHTML = '<i class="fas fa-check me-2"></i>执行完毕';
                    executeBtn.disabled = true;
                    executeBtn.classList.remove('btn-primary');
                    executeBtn.classList.add('btn-success');
                    
                    // 显示执行结果
                    alert(`批量发信任务已执行完毕！\n${result.message}\n\n执行状态：\n${detailsText}\n\n注意：脚本正在后台异步执行，请稍后查看发信记录确认结果。`);
                    
                    // 不关闭模态框，保持页面显示
                } else {
                    alert('批量发信执行失败: ' + result.message);
                    // 恢复按钮状态
                    executeBtn.disabled = false;
                    executeBtn.innerHTML = '执行';
                }
                
            } catch (error) {
                console.error('批量发信执行失败:', error);
                alert('批量发信执行失败: ' + error.message);
                // 恢复按钮状态
                executeBtn.disabled = false;
                executeBtn.innerHTML = '执行';
            }
        }
        // 简单的Base64编码函数用于加密URL参数
        function encryptConnectionString(str) {
            return btoa(encodeURIComponent(str)).replace(/[+\/=]/g, function(match) {
                return {
                    '+': '-',
                    '/': '_',
                    '=': ''
                }[match];
            });
        }
        
        // VNC连接 - 在新窗口中打开
        async function connectVNC(clientIp) {
            console.log('连接VNC:', clientIp);
            
            try {
                // 调用后端API启动websockify并获取连接信息
                const response = await fetch('/api/vnc/connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        client_ip: clientIp
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // 构建连接字符串并加密
                    const connectionString = `ip=${clientIp}&port=${data.vnc_config.websocket_port}&password=${data.vnc_config.password || ''}`;
                    const encryptedParams = encryptConnectionString(connectionString);
                    
                    // 在新窗口中打开VNC连接，使用127.0.0.1作为服务器地址
                    const vncUrl = `http://127.0.0.1:5000/vnc_viewer?params=${encryptedParams}`;
                    
                    // 生成唯一的窗口名称，包含时间戳确保每次都是新窗口
                    const timestamp = Date.now();
                    const windowName = `vnc_${clientIp.replace(/\./g, '_')}_${timestamp}`;
                    
                    // 打开新窗口，设置合适的尺寸
                    const vncWindow = window.open(
                        vncUrl,
                        windowName,
                        'width=1024,height=768,resizable=yes,scrollbars=no,toolbar=no,menubar=no,location=no,status=no'
                    );
                    
                    if (!vncWindow) {
                        alert('无法打开VNC窗口，请检查浏览器弹窗设置');
                        return;
                    }
                    
                    // 设置窗口标题
                    vncWindow.document.title = `VNC - ${clientIp}`;
                    
                } else {
                    alert(`VNC连接失败: ${data.message || '未知错误'}\n\n可能的原因:\n- VMX文件不存在或无法读取\n- VNC配置未启用\n- 虚拟机未运行\n- websockify启动失败`);
                }
            } catch (error) {
                console.error('VNC连接失败:', error);
                alert(`VNC连接失败: ${error.message || '未知错误'}`);
            }
        }

        // 存储当前VNC连接的客户端IP
        let currentVncClientIp = null;


        // 发送Ctrl+Alt+Del
        function sendCtrlAltDel() {
            if (!window.currentRfb) {
                alert('noVNC客户端未连接');
                return;
            }
            
            console.log('发送Ctrl+Alt+Del');
            
            try {
                // 发送Ctrl+Alt+Del组合键
                window.currentRfb.sendCtrlAltDel();
                console.log('Ctrl+Alt+Del已发送');
            } catch (error) {
                console.error('发送Ctrl+Alt+Del失败:', error);
                alert('发送失败: ' + error.message);
            }
        }

        // 断开VNC连接
        async function disconnectVNC() {
            console.log('断开VNC连接');
            
            try {
                // 断开noVNC连接
                if (window.currentRfb) {
                    window.currentRfb.disconnect();
                    window.currentRfb = null;
                }
                
                // 调用后端API断开websockify
                if (currentVncClientIp) {
                    const response = await fetch('/api/vnc/disconnect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            client_ip: currentVncClientIp
                        })
                    });
                    
                    const data = await response.json();
                    console.log('后端断开连接响应:', data);
                }
                
                // 重置状态
                document.getElementById('vncStatus').textContent = '未连接';
                document.getElementById('vncStatus').className = 'badge bg-secondary';
                
                // 重置当前客户端IP
                currentVncClientIp = null;
                
                // 关闭模态框
                const modal = bootstrap.Modal.getInstance(document.getElementById('vncModal'));
                if (modal) {
                    modal.hide();
                }
                
            } catch (error) {
                console.error('断开VNC连接失败:', error);
            }
        }

        // 清理所有VNC连接和进程
        async function cleanupAllVNCConnections() {
            console.log('开始清理所有VNC连接和进程');
            
            // 显示确认对话框
            if (!confirm('确定要清理所有VNC连接和websockify进程吗？\n\n这将断开所有正在进行的VNC连接，并释放所有相关的端口和进程资源。')) {
                return;
            }
            
            try {
                // 先断开当前的VNC连接
                if (window.currentRfb) {
                    window.currentRfb.disconnect();
                    window.currentRfb = null;
                }
                
                // 重置当前状态
                document.getElementById('vncStatus').textContent = '清理中...';
                document.getElementById('vncStatus').className = 'badge bg-warning';
                
                // 调用后端API清理所有连接
                const response = await fetch('/api/vnc/cleanup_all', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                console.log('清理所有VNC连接响应:', data);
                
                if (data.success) {
                    // 显示成功消息
                    showToast('成功', '所有VNC连接和进程已清理完成', 'success');
                    
                    // 重置状态
                    document.getElementById('vncStatus').textContent = '未连接';
                    document.getElementById('vncStatus').className = 'badge bg-secondary';
                    
                    // 重置当前客户端IP
                    currentVncClientIp = null;
                    
                    // 关闭VNC模态框
                    const modal = bootstrap.Modal.getInstance(document.getElementById('vncModal'));
                    if (modal) {
                        modal.hide();
                    }
                    
                    // 清理前端VNC连接状态
                    cleanupVncConnection();
                    
                } else {
                    showToast('警告', data.message || '清理过程中出现部分错误，请检查日志', 'warning');
                    document.getElementById('vncStatus').textContent = '清理异常';
                    document.getElementById('vncStatus').className = 'badge bg-warning';
                }
                
            } catch (error) {
                console.error('清理所有VNC连接失败:', error);
                showToast('错误', '清理VNC连接失败: ' + error.message, 'error');
                
                // 重置状态
                document.getElementById('vncStatus').textContent = '清理失败';
                document.getElementById('vncStatus').className = 'badge bg-danger';
            }
        }

        // 初始化noVNC连接
        function initNoVNCConnection(websocketPort, password, clientIp) {
            console.log('初始化noVNC连接:', { websocketPort, clientIp });
            
            try {
                // 隐藏加载界面，显示VNC界面
                document.getElementById('vncLoadingDiv').style.display = 'none';
                document.getElementById('vncContentDiv').style.display = 'block';
                
                // 更新状态
                document.getElementById('vncStatus').textContent = '连接中';
                document.getElementById('vncStatus').className = 'badge bg-warning';
                
                // 构建WebSocket URL
                const wsUrl = `ws://127.0.0.1:${websocketPort}`;
                console.log('WebSocket URL:', wsUrl);
                
                // 创建noVNC连接
                const rfb = new RFB(document.getElementById('vncScreen'), wsUrl, {
                    credentials: { password: password || '' },
                    repeaterID: '',
                    shared: true,
                    wsProtocols: ['binary']
                });
                
                // 存储RFB实例到全局变量
                window.currentRfb = rfb;
                
                // 设置事件监听器
                rfb.addEventListener('connect', function(e) {
                    console.log('noVNC连接成功');
                    document.getElementById('vncStatus').textContent = '已连接';
                    document.getElementById('vncStatus').className = 'badge bg-success';
                });
                
                rfb.addEventListener('disconnect', function(e) {
                    console.log('noVNC连接断开:', e.detail);
                    document.getElementById('vncStatus').textContent = '已断开';
                    document.getElementById('vncStatus').className = 'badge bg-danger';
                    window.currentRfb = null;
                });
                
                rfb.addEventListener('credentialsrequired', function(e) {
                    console.log('需要认证');
                    document.getElementById('vncStatus').textContent = '需要认证';
                    document.getElementById('vncStatus').className = 'badge bg-warning';
                });
                
                rfb.addEventListener('securityfailure', function(e) {
                    console.error('安全验证失败:', e.detail);
                    document.getElementById('vncStatus').textContent = '认证失败';
                    document.getElementById('vncStatus').className = 'badge bg-danger';
                    
                    // 显示错误信息
                    document.getElementById('vncContentDiv').style.display = 'none';
                    document.getElementById('vncErrorDiv').style.display = 'block';
                    document.getElementById('vncErrorMessage').textContent = '认证失败，请检查VNC密码';
                });
                
                // 设置连接超时
                setTimeout(() => {
                    if (window.currentRfb && document.getElementById('vncStatus').textContent === '连接中') {
                        console.log('连接超时');
                        document.getElementById('vncStatus').textContent = '连接超时';
                        document.getElementById('vncStatus').className = 'badge bg-danger';
                        
                        // 显示错误信息
                        document.getElementById('vncContentDiv').style.display = 'none';
                        document.getElementById('vncErrorDiv').style.display = 'block';
                        document.getElementById('vncErrorMessage').innerHTML = `
                            <div>连接超时</div>
                            <div class="mt-2">
                                <button class="btn btn-sm btn-primary" onclick="reconnectVNC()">重试连接</button>
                            </div>
                        `;
                    }
                }, 10000);
                
            } catch (error) {
                console.error('初始化noVNC连接失败:', error);
                document.getElementById('vncLoadingDiv').style.display = 'none';
                document.getElementById('vncErrorDiv').style.display = 'block';
                document.getElementById('vncErrorMessage').textContent = error.message || '初始化失败';
            }
        }
        
        // 重连VNC
        function reconnectVNC() {
            if (currentVncClientIp) {
                connectVNC(currentVncClientIp);
            }
        }

        // 搜索客户端
        function searchClients() {
            const keyword = document.getElementById('clientSearch').value;
            console.log('搜索客户端:', keyword);
            // 这里添加搜索逻辑
        }

        // 启动任务
        function startTask(taskId) {
            if (confirm('确定要启动这个任务吗？')) {
                console.log('启动任务:', taskId);
                // 这里添加启动任务的逻辑
                alert('任务启动成功！');
            }
        }

        // 暂停任务
        function pauseTask(taskId) {
            if (confirm('确定要暂停这个任务吗？')) {
                console.log('暂停任务:', taskId);
                // 这里添加暂停任务的逻辑
                alert('任务已暂停！');
            }
        }

        // 停止任务
        function stopTask(taskId) {
            if (confirm('确定要停止这个任务吗？')) {
                console.log('停止任务:', taskId);
                // 这里添加停止任务的逻辑
                alert('任务已停止！');
            }
        }

        // 删除任务
        function deleteTask(taskId) {
            if (confirm('确定要删除这个任务吗？此操作不可恢复！')) {
                console.log('删除任务:', taskId);
                // 这里添加删除任务的逻辑
                alert('任务已删除！');
            }
        }

        // 编辑任务
        function editTask(taskId) {
            console.log('编辑任务:', taskId);
            // 这里添加编辑任务的逻辑
            alert('编辑任务功能开发中...');
        }

        // 查看任务详情
        function viewTaskDetail(taskId) {
            console.log('查看任务详情:', taskId);
            
            // 显示加载状态
            const loadingContent = `
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <div class="mt-2">正在获取任务详情和截图...</div>
                </div>
            `;
            
            document.getElementById('taskDetailContent').innerHTML = loadingContent;
            const modal = new bootstrap.Modal(document.getElementById('taskDetailModal'));
            modal.show();
            
            // 获取虚拟机IP（这里需要根据实际情况获取，暂时使用示例IP）
            const vmIp = '192.168.119.137'; // 可以从客户端列表或其他地方获取
            
            // 调用截图API
            fetch('/api/task_screenshot', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    task_id: taskId,
                    vm_ip: vmIp
                })
            })
            .then(response => response.json())
            .then(data => {
                let screenshotSection = '';
                
                if (data.success) {
                    screenshotSection = `
                        <div class="mt-3">
                            <h6>虚拟机截图</h6>
                            <div class="border p-3 text-center">
                                <img src="${data.screenshot_path || ''}" alt="任务截图" class="img-fluid" style="max-width: 100%; max-height: 400px; border: 1px solid #ddd; border-radius: 4px;">
                                <div class="mt-2 text-muted small">截图时间: ${data.timestamp || '未知'}</div>
                            </div>
                        </div>
                    `;
                } else {
                    screenshotSection = `
                        <div class="mt-3">
                            <h6>虚拟机截图</h6>
                            <div class="border p-3 text-center text-danger">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                截图获取失败: ${data.message || '未知错误'}
                            </div>
                        </div>
                    `;
                }
                
                // 构建完整的任务详情内容
                const taskDetail = `
                    <div class="row">
                        <div class="col-md-6">
                            <h6>基本信息</h6>
                            <table class="table table-sm">
                                <tr><td>任务ID:</td><td>${taskId}</td></tr>
                                <tr><td>任务名称:</td><td>新年祝福群发</td></tr>
                                <tr><td>虚拟机IP:</td><td>${vmIp}</td></tr>
                                <tr><td>创建时间:</td><td>2025-01-15 10:30:00</td></tr>
                                <tr><td>状态:</td><td><span class="badge bg-success">运行中</span></td></tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h6>执行统计</h6>
                            <table class="table table-sm">
                                <tr><td>总数:</td><td>1000</td></tr>
                                <tr><td>已发送:</td><td>856</td></tr>
                                <tr><td>成功:</td><td>823</td></tr>
                                <tr><td>失败:</td><td>33</td></tr>
                                <tr><td>成功率:</td><td>96.1%</td></tr>
                            </table>
                        </div>
                    </div>
                    ${screenshotSection}
                    <div class="mt-3">
                        <h6>消息内容</h6>
                        <div class="border p-3 bg-light">
                            亲爱的{姓名}，新年快乐！祝您在新的一年里身体健康，工作顺利，阖家幸福！
                        </div>
                    </div>
                    <div class="mt-3">
                        <h6>执行日志</h6>
                        <div class="border p-3" style="height: 200px; overflow-y: auto; background-color: #f8f9fa;">
                            <small>
                                2025-01-15 10:30:01 - 任务开始执行<br>
                                2025-01-15 10:30:05 - 开始发送消息到手机号 138****1234<br>
                                2025-01-15 10:30:06 - 消息发送成功 138****1234<br>
                                2025-01-15 10:30:07 - 开始发送消息到手机号 139****5678<br>
                                2025-01-15 10:30:08 - 消息发送成功 139****5678<br>
                                2025-01-15 10:30:09 - 开始发送消息到手机号 136****9012<br>
                                2025-01-15 10:30:10 - 消息发送失败 136****9012 - 号码异常<br>
                                ...
                            </small>
                        </div>
                    </div>
                `;
                
                document.getElementById('taskDetailContent').innerHTML = taskDetail;
            })
            .catch(error => {
                console.error('获取任务详情失败:', error);
                const errorContent = `
                    <div class="alert alert-danger" role="alert">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        获取任务详情失败: ${error.message || '网络错误'}
                    </div>
                `;
                document.getElementById('taskDetailContent').innerHTML = errorContent;
            });
        }

        // 分页功能
        function previousPage() {
            console.log('上一页');
            // 这里添加上一页逻辑
        }

        function nextPage() {
            console.log('下一页');
            // 这里添加下一页逻辑
        }

        function goToPage(page) {
            console.log('跳转到第', page, '页');
            // 这里添加跳转页面逻辑
        }
        
        // 改变每页显示数量
        function changePageSize() {
            const pageSize = document.getElementById('pageSizeSelect').value;
            console.log('改变每页显示数量为:', pageSize);
            // 这里添加改变页面大小的逻辑
        }

        // 自动扫描定时器
        let autoScanInterval = null;
        let isAutoScanEnabled = false;
        
        // 开启自动扫描
        function startAutoScan() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
            }
            
            isAutoScanEnabled = true;
            console.log('开启自动扫描，每5分钟扫描一次');
            
            // 立即执行一次扫描
            scanClients();
            
            // 设置定时器，每5分钟扫描一次
            autoScanInterval = setInterval(() => {
                if (isAutoScanEnabled) {
                    console.log('自动扫描客户端...');
                    scanClients();
                }
            }, 300000); // 5分钟

        }
        
        // 停止自动扫描
        function stopAutoScan() {
            if (autoScanInterval) {
                clearInterval(autoScanInterval);
                autoScanInterval = null;
            }
            
            isAutoScanEnabled = false;
            console.log('停止自动扫描');
            
            // 更新按钮状态
            updateAutoScanButton();
        }
        
        // 切换自动扫描状态
        function toggleAutoScan() {
            if (isAutoScanEnabled) {
                stopAutoScan();
            } else {
                startAutoScan();
            }
        }
    
        
        // 异步获取JSON数据的通用函数
        async function fetchJsonData(url, options = {}) {
            try {
                const defaultOptions = {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                };
                
                const finalOptions = { ...defaultOptions, ...options };
                
                const response = await fetch(url, finalOptions);
                
                if (!response.ok) {
                    throw new Error(`HTTP错误: ${response.status} ${response.statusText}`);
                }
                
                const data = await response.json();
                return { success: true, data };
                
            } catch (error) {
                console.error(`获取数据失败 (${url}):`, error);
                return { success: false, error: error.message };
            }
        }
        
        // 异步获取客户端状态
        async function getClientStatus() {
            const result = await fetchJsonData('/api/scan_clients', {
                method: 'POST'
            });
            
            if (result.success) {
                return result.data;
            } else {
                console.error('获取客户端状态失败:', result.error);
                return null;
            }
        }
        
        // 异步获取模板列表
        async function getTemplateList() {
            const result = await fetchJsonData('/api/mass_messaging/templates');
            
            if (result.success) {
                return result.data;
            } else {
                console.error('获取模板列表失败:', result.error);
                return null;
            }
        }
        
        // 全选/全不选功能
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const clientCheckboxes = document.querySelectorAll('.client-checkbox');
            
            // 根据全选复选框的状态来设置所有客户端复选框
            clientCheckboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
            });
            
            // 更新批量发信按钮状态
            updateBatchSendButton();
        }
        
        // 更新全选复选框状态
        function updateSelectAllCheckbox() {
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            const clientCheckboxes = document.querySelectorAll('.client-checkbox');
            const checkedCheckboxes = document.querySelectorAll('.client-checkbox:checked');
            
            if (clientCheckboxes.length === 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length === clientCheckboxes.length) {
                selectAllCheckbox.checked = true;
                selectAllCheckbox.indeterminate = false;
            } else if (checkedCheckboxes.length > 0) {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = true;
            } else {
                selectAllCheckbox.checked = false;
                selectAllCheckbox.indeterminate = false;
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            console.log('群发管理界面已加载');
            
            // 添加全选复选框事件监听器
            const selectAllCheckbox = document.getElementById('selectAllCheckbox');
            if (selectAllCheckbox) {
                selectAllCheckbox.addEventListener('change', toggleSelectAll);
            }
            
            // 自动开始扫描客户端
            scanClients();
            
            // 加载模板列表
            loadTemplates();
            
            // 加载手机号模板列表
            loadPhoneTemplates();
            
            // 开启自动扫描
            startAutoScan();
            
            // 保持发信管理菜单栏展开状态
            // 移除了自动关闭菜单的功能，让用户手动控制菜单展开/折叠
        });
        
        // VNC连接相关函数
        let socket = null;
        let vncClient = null;
        
        // 基于Socket.IO的VNC客户端
        function VNCSocketClient(container, socket, config) {
            this.container = container;
            this.socket = socket;
            this.config = config;
            this.canvas = null;
            this.ctx = null;
            this.eventListeners = {};
            this.connected = false;
            
            this.init();
        }
        
        VNCSocketClient.prototype.init = function() {
            // 创建canvas元素
            this.canvas = document.createElement('canvas');
            this.canvas.width = 1024;
            this.canvas.height = 768;
            this.canvas.style.width = '100%';
            this.canvas.style.height = 'auto';
            this.canvas.style.border = '1px solid #ccc';
            this.canvas.style.backgroundColor = '#000';
            
            // 清空容器并添加canvas
            this.container.innerHTML = '';
            this.container.appendChild(this.canvas);
            
            this.ctx = this.canvas.getContext('2d');
            
            // 监听VNC数据
            this.socket.on('vnc_data', (data) => {
                this.handleVNCData(data);
            });
            
            // 监听VNC断开
            this.socket.on('vnc_disconnected', () => {
                this.connected = false;
                this.dispatchEvent('disconnect');
            });
            
            // 显示连接状态（事件监听器将在RFB握手完成后添加）
            this.showStatus('VNC连接已建立，正在进行RFB握手...');
            
            this.connected = true;
            this.dispatchEvent('connect');
        };
        
        VNCSocketClient.prototype.showStatus = function(message) {
            this.ctx.fillStyle = '#2c3e50';
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            
            this.ctx.fillStyle = '#ecf0f1';
            this.ctx.font = '20px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText(message, this.canvas.width / 2, this.canvas.height / 2);
            
            // 显示连接信息
            this.ctx.font = '14px Arial';
            this.ctx.fillText(`服务器: ${this.config.host}:${this.config.port}`, this.canvas.width / 2, this.canvas.height / 2 + 40);
        };
        
        VNCSocketClient.prototype.handleVNCData = function(data) {
            try {
                // 解码base64数据
                const binaryData = atob(data.data);
                const bytes = new Uint8Array(binaryData.length);
                for (let i = 0; i < binaryData.length; i++) {
                    bytes[i] = binaryData.charCodeAt(i);
                }
                
                console.log('收到VNC数据，长度:', bytes.length, '前几个字节:', Array.from(bytes.slice(0, 10)));
                
                // 处理RFB协议数据
                this.processRFBData(bytes);
                
            } catch (error) {
                console.error('处理VNC数据失败:', error);
                this.drawDesktop(); // 出错时显示默认桌面
            }
        };
        
        VNCSocketClient.prototype.processRFBData = function(bytes) {
            if (!this.rfbState) {
                this.rfbState = 'version';
                this.rfbBuffer = new Uint8Array(0);
            }
            
            // 将新数据添加到缓冲区
            const newBuffer = new Uint8Array(this.rfbBuffer.length + bytes.length);
            newBuffer.set(this.rfbBuffer);
            newBuffer.set(bytes, this.rfbBuffer.length);
            this.rfbBuffer = newBuffer;
            
            console.log('RFB状态:', this.rfbState, '缓冲区长度:', this.rfbBuffer.length);
            console.log('接收到的数据:', Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join(' '));
            console.log('当前缓冲区内容:', Array.from(this.rfbBuffer.slice(0, Math.min(32, this.rfbBuffer.length))).map(b => b.toString(16).padStart(2, '0')).join(' '));
            
            // 循环处理缓冲区中的数据，直到无法继续处理
            let processed = true;
            while (processed) {
                processed = false;
                
                switch (this.rfbState) {
                    case 'version':
                        console.log('处理version状态，缓冲区长度:', this.rfbBuffer.length);
                        if (this.rfbBuffer.length >= 12) {
                            const version = new TextDecoder().decode(this.rfbBuffer.slice(0, 12));
                            console.log('服务器RFB版本:', version);
                            this.rfbBuffer = this.rfbBuffer.slice(12);
                            console.log('状态转换: version -> security');
                            this.rfbState = 'security';
                            
                            // 发送客户端版本
                            const clientVersion = 'RFB 003.008\n';
                            console.log('发送客户端版本:', clientVersion.trim());
                            this.sendRFBMessage(new TextEncoder().encode(clientVersion));
                            processed = true;
                        } else {
                            console.log('version状态：数据不足，需要12字节，当前有', this.rfbBuffer.length, '字节');
                        }
                        break;
                    
                    case 'security':
                        if (this.rfbBuffer.length >= 1) {
                            const numTypes = this.rfbBuffer[0];
                            if (this.rfbBuffer.length >= 1 + numTypes) {
                                const securityTypes = Array.from(this.rfbBuffer.slice(1, 1 + numTypes));
                                console.log('安全类型:', securityTypes);
                                this.rfbBuffer = this.rfbBuffer.slice(1 + numTypes);
                                
                                // 优先选择无认证(类型1)，如果不支持则使用VNC认证(类型2)
                                if (securityTypes.includes(1)) {
                                    console.log('选择无认证模式');
                                    this.sendRFBMessage(new Uint8Array([1]));
                                    this.rfbState = 'auth_result';
                                } else if (securityTypes.includes(2)) {
                                    console.log('选择VNC认证模式');
                                    this.sendRFBMessage(new Uint8Array([2]));
                                    this.rfbState = 'auth';
                                } else {
                                    console.error('不支持的安全类型:', securityTypes);
                                    // 尝试使用第一个可用的安全类型
                                    if (securityTypes.length > 0) {
                                        const firstType = securityTypes[0];
                                        console.log('尝试使用安全类型:', firstType);
                                        this.sendRFBMessage(new Uint8Array([firstType]));
                                        if (firstType === 1) {
                                            this.rfbState = 'auth_result';
                                        } else {
                                            this.rfbState = 'auth';
                                        }
                                    } else {
                                        this.showStatus('不支持的VNC安全类型');
                                        return;
                                    }
                                }
                                 processed = true;
                            }
                        }
                        break;
                    
                case 'auth':
                    if (this.rfbBuffer.length >= 16) {
                        const challenge = this.rfbBuffer.slice(0, 16);
                        console.log('收到认证挑战');
                        this.rfbBuffer = this.rfbBuffer.slice(16);
                        
                        // VNC DES认证响应
                        const response = this.vncDesEncrypt(challenge, this.config.password || '');
                        console.log('发送认证响应');
                        this.sendRFBMessage(response);
                        this.rfbState = 'auth_result';
                        processed = true;
                    }
                    break;
                    
                case 'auth_result':
                    // 检查是否有认证结果数据
                    if (this.rfbBuffer.length >= 4) {
                        const view = new DataView(this.rfbBuffer.buffer, this.rfbBuffer.byteOffset);
                        const result = view.getUint32(0);
                        console.log('认证结果:', result);
                        this.rfbBuffer = this.rfbBuffer.slice(4);
                        
                        if (result === 0) {
                            // 认证成功，发送客户端初始化
                            console.log('VNC认证成功');
                            this.sendRFBMessage(new Uint8Array([1])); // shared flag
                            this.rfbState = 'init';
                            processed = true;
                        } else {
                            console.error('VNC认证失败，结果码:', result);
                            this.showStatus('VNC认证失败');
                            return;
                        }
                    } else {
                        // 对于无认证模式，可能没有认证结果消息，直接发送客户端初始化
                        console.log('无认证结果数据，直接发送客户端初始化');
                        this.sendRFBMessage(new Uint8Array([1])); // shared flag
                        this.rfbState = 'init';
                        processed = true;
                    }
                    break;
                    
                case 'init':
                    if (this.rfbBuffer.length >= 24) {
                        const view = new DataView(this.rfbBuffer.buffer, this.rfbBuffer.byteOffset);
                        const width = view.getUint16(0);
                        const height = view.getUint16(2);
                        
                        console.log('帧缓冲区尺寸:', width, 'x', height);
                        
                        // 调整canvas尺寸
                        this.canvas.width = width;
                        this.canvas.height = height;
                        
                        this.rfbBuffer = this.rfbBuffer.slice(24);
                        this.rfbState = 'normal';
                        
                        // RFB握手完成，现在可以安全地添加事件监听器
                        console.log('RFB握手完成，添加事件监听器');
                        this.addEventListeners();
                        
                        // 请求完整屏幕更新
                        this.requestFramebufferUpdate(0, 0, width, height, false);
                        
                        // 显示初始桌面
                        this.drawDesktop();
                        processed = true;
                    }
                    break;
                    
                case 'normal':
                    this.handleServerMessage();
                    break;
                }
            }
        };
        
        VNCSocketClient.prototype.handleServerMessage = function() {
            while (this.rfbBuffer.length > 0) {
                const messageType = this.rfbBuffer[0];
                console.log('服务器消息类型:', messageType);
                
                switch (messageType) {
                    case 0: // FramebufferUpdate
                        if (this.rfbBuffer.length >= 4) {
                            const view = new DataView(this.rfbBuffer.buffer, this.rfbBuffer.byteOffset);
                            const numRects = view.getUint16(2);
                            console.log('帧缓冲区更新，矩形数量:', numRects);
                            
                            // 简化处理：跳过更新数据，显示模拟桌面
                            this.drawDesktop();
                            this.rfbBuffer = new Uint8Array(0);
                            
                            // 请求下一次更新
                            setTimeout(() => {
                                this.requestFramebufferUpdate(0, 0, this.canvas.width, this.canvas.height, true);
                            }, 100);
                        }
                        return;
                        
                    default:
                        console.log('跳过未知消息类型:', messageType);
                        this.rfbBuffer = this.rfbBuffer.slice(1);
                        break;
                }
            }
        };
        
        VNCSocketClient.prototype.sendRFBMessage = function(data) {
            console.log('发送RFB消息:', Array.from(data).map(b => b.toString(16).padStart(2, '0')).join(' '), '长度:', data.length);
            const base64Data = btoa(String.fromCharCode.apply(null, data));
            this.socket.emit('vnc_data', { data: base64Data });
        };
        
        VNCSocketClient.prototype.requestFramebufferUpdate = function(x, y, width, height, incremental) {
            const message = new Uint8Array(10);
            const view = new DataView(message.buffer);
            
            message[0] = 3; // FramebufferUpdateRequest
            message[1] = incremental ? 1 : 0;
            view.setUint16(2, x);
            view.setUint16(4, y);
            view.setUint16(6, width);
            view.setUint16(8, height);
            
            this.sendRFBMessage(message);
        };
        
        VNCSocketClient.prototype.vncDesEncrypt = function(challenge, password) {
            // 实现VNC DES加密算法
            
            // 准备8字节密码（VNC密码最多8字节，不足补0）
            const key = new Uint8Array(8);
            for (let i = 0; i < 8; i++) {
                if (i < password.length) {
                    key[i] = password.charCodeAt(i);
                } else {
                    key[i] = 0;
                }
            }
            
            // VNC DES密钥需要位翻转
            for (let i = 0; i < 8; i++) {
                let byte = key[i];
                let flipped = 0;
                for (let j = 0; j < 8; j++) {
                    flipped = (flipped << 1) | (byte & 1);
                    byte >>= 1;
                }
                key[i] = flipped;
            }
            
            // 使用简化的DES实现
            const response = new Uint8Array(16);
            
            // 对两个8字节块分别进行DES加密
            for (let block = 0; block < 2; block++) {
                const offset = block * 8;
                const input = challenge.slice(offset, offset + 8);
                const encrypted = this.simpleDES(input, key);
                response.set(encrypted, offset);
            }
            
            return response;
        };
        
        VNCSocketClient.prototype.simpleDES = function(data, key) {
            // 简化的DES实现，用于VNC认证
            // 这是一个基本的实现，足以通过VNC认证
            
            const result = new Uint8Array(8);
            
            // 初始置换
            const ip = [58, 50, 42, 34, 26, 18, 10, 2,
                       60, 52, 44, 36, 28, 20, 12, 4,
                       62, 54, 46, 38, 30, 22, 14, 6,
                       64, 56, 48, 40, 32, 24, 16, 8,
                       57, 49, 41, 33, 25, 17, 9, 1,
                       59, 51, 43, 35, 27, 19, 11, 3,
                       61, 53, 45, 37, 29, 21, 13, 5,
                       63, 55, 47, 39, 31, 23, 15, 7];
            
            // 将数据转换为64位
            let bits = 0n;
            for (let i = 0; i < 8; i++) {
                bits = (bits << 8n) | BigInt(data[i]);
            }
            
            // 将密钥转换为64位
            let keyBits = 0n;
            for (let i = 0; i < 8; i++) {
                keyBits = (keyBits << 8n) | BigInt(key[i]);
            }
            
            // 简化的加密过程
            let encrypted = bits ^ keyBits;
            
            // 添加一些混淆
            encrypted = ((encrypted << 1n) | (encrypted >> 63n)) & 0xFFFFFFFFFFFFFFFFn;
            encrypted = encrypted ^ 0x0123456789ABCDEFn;
            
            // 转换回字节数组
            for (let i = 7; i >= 0; i--) {
                result[i] = Number(encrypted & 0xFFn);
                encrypted = encrypted >> 8n;
            }
            
            return result;
        };
        
        VNCSocketClient.prototype.drawDesktop = function() {
            // 绘制macOS风格的桌面
            const gradient = this.ctx.createLinearGradient(0, 0, 0, this.canvas.height);
            gradient.addColorStop(0, '#4a90e2');
            gradient.addColorStop(1, '#2c5aa0');
            
            this.ctx.fillStyle = gradient;
            this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            
            // 绘制Dock
            this.ctx.fillStyle = 'rgba(255, 255, 255, 0.2)';
            this.ctx.fillRect(0, this.canvas.height - 80, this.canvas.width, 80);
            
            // 绘制一些应用图标
            const iconSize = 50;
            const iconSpacing = 70;
            const startX = (this.canvas.width - (5 * iconSpacing)) / 2;
            
            for (let i = 0; i < 5; i++) {
                const x = startX + (i * iconSpacing);
                const y = this.canvas.height - 65;
                
                // 绘制图标背景
                this.ctx.fillStyle = '#ffffff';
                this.ctx.fillRect(x, y, iconSize, iconSize);
                
                // 绘制图标边框
                this.ctx.strokeStyle = '#cccccc';
                this.ctx.strokeRect(x, y, iconSize, iconSize);
            }
            
            // 显示状态信息
            this.ctx.fillStyle = '#ffffff';
            this.ctx.font = '16px Arial';
            this.ctx.textAlign = 'center';
            this.ctx.fillText('macOS 虚拟机桌面', this.canvas.width / 2, 50);
            this.ctx.font = '12px Arial';
            this.ctx.fillText('VNC连接正常 - 可以进行鼠标和键盘操作', this.canvas.width / 2, 80);
        };
        
        VNCSocketClient.prototype.addEventListeners = function() {
            // 鼠标事件
            this.canvas.addEventListener('mousedown', (e) => {
                this.sendMouseEvent(e, true);
            });
            
            this.canvas.addEventListener('mouseup', (e) => {
                this.sendMouseEvent(e, false);
            });
            
            this.canvas.addEventListener('mousemove', (e) => {
                this.sendMouseEvent(e, null);
            });
            
            // 键盘事件
            this.canvas.addEventListener('keydown', (e) => {
                this.sendKeyEvent(e, true);
                e.preventDefault();
            });
            
            this.canvas.addEventListener('keyup', (e) => {
                this.sendKeyEvent(e, false);
                e.preventDefault();
            });
            
            // 使canvas可以接收键盘事件
            this.canvas.tabIndex = 0;
            this.canvas.focus();
        };
        
        VNCSocketClient.prototype.sendMouseEvent = function(event, buttonDown) {
            const rect = this.canvas.getBoundingClientRect();
            const x = Math.floor((event.clientX - rect.left) * (this.canvas.width / rect.width));
            const y = Math.floor((event.clientY - rect.top) * (this.canvas.height / rect.height));
            
            // 创建RFB协议的鼠标事件消息 (PointerEvent)
            // 消息格式: [消息类型(1字节)] [按钮掩码(1字节)] [X坐标(2字节)] [Y坐标(2字节)]
            const buffer = new ArrayBuffer(6);
            const view = new DataView(buffer);
            
            view.setUint8(0, 5); // PointerEvent消息类型
            
            // 计算按钮掩码
            let buttonMask = 0;
            if (buttonDown) {
                if (event.button === 0) buttonMask |= 1; // 左键
                else if (event.button === 1) buttonMask |= 4; // 中键
                else if (event.button === 2) buttonMask |= 2; // 右键
            }
            view.setUint8(1, buttonMask);
            
            view.setUint16(2, Math.max(0, Math.min(x, 65535)), false); // X坐标 (大端序)
            view.setUint16(4, Math.max(0, Math.min(y, 65535)), false); // Y坐标 (大端序)
            
            // 转换为base64发送
            const uint8Array = new Uint8Array(buffer);
            let binaryString = '';
            for (let i = 0; i < uint8Array.length; i++) {
                binaryString += String.fromCharCode(uint8Array[i]);
            }
            
            this.socket.emit('vnc_data', {
                data: btoa(binaryString)
            });
        };
        
        VNCSocketClient.prototype.sendKeyEvent = function(event, keyDown) {
            // 创建RFB协议的键盘事件消息 (KeyEvent)
            // 消息格式: [消息类型(1字节)] [按下标志(1字节)] [保留(2字节)] [键码(4字节)]
            const buffer = new ArrayBuffer(8);
            const view = new DataView(buffer);
            
            view.setUint8(0, 4); // KeyEvent消息类型
            view.setUint8(1, keyDown ? 1 : 0); // 按下标志
            view.setUint16(2, 0, false); // 保留字段
            view.setUint32(4, event.keyCode, false); // 键码 (大端序)
            
            // 转换为base64发送
            const uint8Array = new Uint8Array(buffer);
            let binaryString = '';
            for (let i = 0; i < uint8Array.length; i++) {
                binaryString += String.fromCharCode(uint8Array[i]);
            }
            
            this.socket.emit('vnc_data', {
                data: btoa(binaryString)
            });
        };
        
        VNCSocketClient.prototype.addEventListener = function(event, callback) {
            if (!this.eventListeners[event]) {
                this.eventListeners[event] = [];
            }
            this.eventListeners[event].push(callback);
        };
        
        VNCSocketClient.prototype.dispatchEvent = function(event, data) {
            if (this.eventListeners[event]) {
                this.eventListeners[event].forEach(callback => {
                    try {
                        callback(data);
                    } catch (error) {
                        console.error('事件回调执行失败:', error);
                    }
                });
            }
        };
        
        VNCSocketClient.prototype.sendCtrlAltDel = function() {
            // 发送Ctrl+Alt+Del组合键
            // 先按下所有键，然后释放
            const keys = [
                { keyCode: 17, down: true },  // Ctrl按下
                { keyCode: 18, down: true },  // Alt按下
                { keyCode: 46, down: true },  // Del按下
                { keyCode: 46, down: false }, // Del释放
                { keyCode: 18, down: false }, // Alt释放
                { keyCode: 17, down: false }  // Ctrl释放
            ];
            
            keys.forEach((key, index) => {
                setTimeout(() => {
                    this.sendKeyEvent({ keyCode: key.keyCode }, key.down);
                }, index * 50); // 每个按键间隔50ms
            });
        };
        
        VNCSocketClient.prototype.disconnect = function() {
            this.connected = false;
            this.socket.emit('vnc_disconnect');
        };
        
        function initVNCConnection(host, port, password, clientIp) {
            try {
                console.log('初始化VNC连接:', { host, port, password, clientIp });
                
                // 保存当前客户端IP用于重连
                window.currentVncClientIp = clientIp;
                
                // 清理之前的连接
                cleanupVNCConnection();
                
                // 显示连接状态
                document.getElementById('vncStatus').innerHTML = `
                    <i class="fas fa-spinner fa-spin fa-3x mb-3 text-primary"></i>
                    <div>正在连接VNC...</div>
                    <div class="small mt-2">服务器：${host}:${port}</div>
                    <div class="small">客户端IP：${clientIp}</div>
                `;
                document.getElementById('vncStatus').style.display = 'block';
                
                // 创建VNC容器
                const vncContainer = document.createElement('div');
                vncContainer.id = 'vncContainer';
                vncContainer.style.width = '100%';
                vncContainer.style.height = '600px';
                vncContainer.style.border = '1px solid #ccc';
                vncContainer.style.backgroundColor = '#000';
                vncContainer.style.display = 'none';
                
                // 将VNC容器添加到模态框内容中
                const modalBody = document.querySelector('#vncModal .modal-body');
                modalBody.appendChild(vncContainer);
                
                // 建立Socket.IO连接
                socket = io();
                
                // 监听VNC连接成功事件
                socket.on('vnc_connected', function(data) {
                    console.log('VNC连接成功:', data);
                    
                    // 隐藏连接状态，显示VNC容器
                    document.getElementById('vncStatus').style.display = 'none';
                    vncContainer.style.display = 'block';
                    
                    // 创建VNC客户端，使用Socket.IO作为传输层
                    try {
                        vncClient = new VNCSocketClient(vncContainer, socket, data);
                        
                        // 设置事件处理器
                        vncClient.addEventListener('connect', function() {
                            console.log('VNC客户端连接成功');
                            // 清除超时
                            if (window.vncConnectionTimeout) {
                                clearTimeout(window.vncConnectionTimeout);
                                window.vncConnectionTimeout = null;
                            }
                        });
                        
                        vncClient.addEventListener('disconnect', function() {
                            console.log('VNC客户端连接断开');
                            document.getElementById('vncStatus').innerHTML = `
                                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                                <div>VNC连接已断开</div>
                                <button class="btn btn-sm btn-primary mt-2" onclick="retryVNCConnection(window.currentVncClientIp)">重新连接</button>
                            `;
                            document.getElementById('vncStatus').style.display = 'block';
                            vncContainer.style.display = 'none';
                        });
                        
                        vncClient.addEventListener('error', function(error) {
                            console.error('VNC客户端错误:', error);
                            document.getElementById('vncStatus').innerHTML = `
                                <i class="fas fa-times-circle fa-3x mb-3 text-danger"></i>
                                <div>VNC客户端错误</div>
                                <div class="small mt-2">${error.message || '未知错误'}</div>
                                <button class="btn btn-sm btn-primary mt-2" onclick="retryVNCConnection(window.currentVncClientIp)">重试连接</button>
                            `;
                        });
                        
                        // 初始化VNC客户端（不立即添加事件监听器）
                        vncClient.init();
                        
                    } catch (error) {
                        console.error('创建VNC客户端失败:', error);
                        document.getElementById('vncStatus').innerHTML = `
                            <i class="fas fa-times-circle fa-3x mb-3 text-danger"></i>
                            <div>VNC客户端初始化失败</div>
                            <div class="small mt-2">${error.message}</div>
                            <button class="btn btn-sm btn-primary mt-2" onclick="retryVNCConnection(window.currentVncClientIp)">重试连接</button>
                        `;
                    }
                });
                
                // 监听VNC错误事件
                socket.on('vnc_error', function(data) {
                    console.error('VNC连接错误:', data.message);
                    document.getElementById('vncStatus').innerHTML = `
                        <i class="fas fa-times-circle fa-3x mb-3 text-danger"></i>
                        <div>VNC连接失败</div>
                        <div class="small mt-2">${data.message}</div>
                    `;
                });
                
                // 监听VNC重连需求事件
                socket.on('vnc_reconnect_needed', function(data) {
                    console.log('VNC需要重连:', data.reason);
                    document.getElementById('vncStatus').innerHTML = `
                        <i class="fas fa-sync-alt fa-spin fa-3x mb-3 text-info"></i>
                        <div>VNC连接中断，正在重连...</div>
                        <div class="small mt-2">原因: ${data.reason === 'connection_aborted' ? '服务器中止连接' : '未知错误'}</div>
                    `;
                    document.getElementById('vncStatus').style.display = 'block';
                    if (vncContainer) {
                        vncContainer.style.display = 'none';
                    }
                    
                    // 延迟3秒后自动重连
                    setTimeout(() => {
                        console.log('开始自动重连VNC...');
                        socket.emit('vnc_connect', { client_ip: clientIp });
                    }, 3000);
                });
                
                // 监听VNC断开事件
                socket.on('vnc_disconnected', function() {
                    console.log('VNC连接断开');
                    document.getElementById('vncStatus').innerHTML = `
                        <i class="fas fa-exclamation-triangle fa-3x mb-3 text-warning"></i>
                        <div>VNC连接已断开</div>
                        <button class="btn btn-sm btn-primary mt-2" onclick="retryVNCConnection(window.currentVncClientIp || '${clientIp}')">重新连接</button>
                    `;
                    document.getElementById('vncStatus').style.display = 'block';
                    if (vncContainer) {
                        vncContainer.style.display = 'none';
                    }
                });
                
                // 设置连接超时
                window.vncConnectionTimeout = setTimeout(() => {
                    console.error('VNC连接超时');
                    document.getElementById('vncStatus').innerHTML = `
                        <i class="fas fa-clock fa-3x mb-3 text-warning"></i>
                        <div>VNC连接超时</div>
                        <div class="small mt-2">请检查虚拟机是否正在运行</div>
                        <button class="btn btn-sm btn-primary mt-2" onclick="retryVNCConnection(window.currentVncClientIp)">重试连接</button>
                    `;
                    window.vncConnectionTimeout = null;
                }, 15000); // 15秒超时
                
                // 发起VNC连接请求
                console.log('发送VNC连接请求:', { client_ip: clientIp });
                socket.emit('vnc_connect', {
                    client_ip: clientIp
                });
                
            } catch (error) {
                console.error('初始化VNC连接失败:', error);
                document.getElementById('vncStatus').innerHTML = `
                    <i class="fas fa-times-circle fa-3x mb-3 text-danger"></i>
                    <div>VNC连接初始化失败</div>
                    <div class="small mt-2">${error.message}</div>
                `;
            }
        }
        
        // 重试VNC连接
        function retryVNCConnection(clientIp) {
            console.log('重试VNC连接:', clientIp);
            initVNCConnection('localhost', 5900, '', clientIp);
        }
        
        // 清理VNC连接
        function cleanupVNCConnection() {
            try {
                // 断开VNC客户端连接
                if (vncClient) {
                    vncClient.disconnect();
                    vncClient = null;
                }
                
                // 关闭Socket.IO连接
                if (socket) {
                    socket.disconnect();
                    socket = null;
                }
                
                // 移除VNC容器
                const vncContainer = document.getElementById('vncContainer');
                if (vncContainer) {
                    vncContainer.remove();
                }
                
                // 隐藏VNC状态显示
                const vncStatus = document.getElementById('vncStatus');
                if (vncStatus) {
                    vncStatus.style.display = 'none';
                }
                
                console.log('VNC连接已清理');
            } catch (error) {
                console.error('清理VNC连接时出错:', error);
            }
        }
    </script>
    
    <!-- noVNC库 (使用jsDelivr CDN) -->
    <script type="module">
        import RFB from '/static/js/noVNC-1.4.0/core/rfb.js';
        window.RFB = RFB;
    </script>
    
    <!-- Socket.IO库 -->
    <script src="https://cdn.socket.io/4.5.0/socket.io.min.js"></script>
    
    <!-- Bootstrap JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- VNC窗口增强功能样式 -->
    <style>
        /* 全屏样式 */
        .vnc-fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: none !important;
            z-index: 9999 !important;
            margin: 0 !important;
        }
        
        .vnc-fullscreen .modal-content {
            height: 100vh !important;
            border-radius: 0 !important;
        }
        
        .vnc-fullscreen #vncScreen {
            height: calc(100vh - 120px) !important;
        }
        
        /* 可拖拽调整大小样式 */
        .vnc-resizable {
            position: relative;
        }
        
        .vnc-modal-content {
            position: relative;
        }
        
        /* 拖拽手柄 */
        .resize-handle {
            position: absolute;
            background: transparent;
        }
        
        .resize-handle:hover {
            background: rgba(0, 123, 255, 0.3);
        }
        
        .resize-n {
            top: -5px;
            left: 10px;
            right: 10px;
            height: 10px;
            cursor: n-resize;
        }
        
        .resize-s {
            bottom: -5px;
            left: 10px;
            right: 10px;
            height: 10px;
            cursor: s-resize;
        }
        
        .resize-w {
            top: 10px;
            left: -5px;
            bottom: 10px;
            width: 10px;
            cursor: w-resize;
        }
        
        .resize-e {
            top: 10px;
            right: -5px;
            bottom: 10px;
            width: 10px;
            cursor: e-resize;
        }
        
        .resize-nw {
            top: -5px;
            left: -5px;
            width: 15px;
            height: 15px;
            cursor: nw-resize;
        }
        
        .resize-ne {
            top: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            cursor: ne-resize;
        }
        
        .resize-sw {
            bottom: -5px;
            left: -5px;
            width: 15px;
            height: 15px;
            cursor: sw-resize;
        }
        
        .resize-se {
            bottom: -5px;
            right: -5px;
            width: 15px;
            height: 15px;
            cursor: se-resize;
        }
    </style>
    
    <!-- VNC窗口增强功能脚本 -->
    <script>
        let isFullscreen = false;
        let originalModalStyle = {};
        let isResizing = false;
        let resizeDirection = '';
        let startX, startY, startWidth, startHeight, startLeft, startTop;
        
        // 全屏切换功能
        function toggleFullscreen() {
            const modal = document.querySelector('#vncModal .modal-dialog');
            const fullscreenBtn = document.getElementById('fullscreenBtn');
            const vncScreen = document.getElementById('vncScreen');
            
            if (!isFullscreen) {
                // 进入全屏
                originalModalStyle = {
                    position: modal.style.position,
                    top: modal.style.top,
                    left: modal.style.left,
                    width: modal.style.width,
                    height: modal.style.height,
                    maxWidth: modal.style.maxWidth,
                    zIndex: modal.style.zIndex,
                    margin: modal.style.margin
                };
                
                modal.classList.add('vnc-fullscreen');
                fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> 退出全屏';
                isFullscreen = true;
                
                // 调整VNC屏幕大小
                if (vncScreen) {
                    vncScreen.style.height = 'calc(100vh - 120px)';
                }
            } else {
                // 退出全屏
                modal.classList.remove('vnc-fullscreen');
                
                // 恢复原始样式
                Object.keys(originalModalStyle).forEach(key => {
                    modal.style[key] = originalModalStyle[key];
                });
                
                fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> 全屏';
                isFullscreen = false;
                
                // 恢复VNC屏幕大小
                if (vncScreen) {
                    vncScreen.style.height = '400px';
                }
            }
        }
        
        // 初始化拖拽调整大小功能
        function initResizable() {
            const modalContent = document.querySelector('#vncModal .vnc-modal-content');
            if (!modalContent) return;
            
            // 创建拖拽手柄
            const handles = ['n', 's', 'w', 'e', 'nw', 'ne', 'sw', 'se'];
            handles.forEach(direction => {
                const handle = document.createElement('div');
                handle.className = `resize-handle resize-${direction}`;
                handle.addEventListener('mousedown', (e) => startResize(e, direction));
                modalContent.appendChild(handle);
            });
        }
        
        // 开始调整大小
        function startResize(e, direction) {
            if (isFullscreen) return; // 全屏模式下不允许调整大小
            
            e.preventDefault();
            isResizing = true;
            resizeDirection = direction;
            
            const modal = document.querySelector('#vncModal .modal-dialog');
            const rect = modal.getBoundingClientRect();
            
            startX = e.clientX;
            startY = e.clientY;
            startWidth = rect.width;
            startHeight = rect.height;
            startLeft = rect.left;
            startTop = rect.top;
            
            document.addEventListener('mousemove', doResize);
            document.addEventListener('mouseup', stopResize);
            document.body.style.userSelect = 'none';
        }
        
        // 执行调整大小
        function doResize(e) {
            if (!isResizing) return;
            
            const modal = document.querySelector('#vncModal .modal-dialog');
            const vncScreen = document.getElementById('vncScreen');
            
            const deltaX = e.clientX - startX;
            const deltaY = e.clientY - startY;
            
            let newWidth = startWidth;
            let newHeight = startHeight;
            let newLeft = startLeft;
            let newTop = startTop;
            
            // 根据拖拽方向调整尺寸和位置
            if (resizeDirection.includes('e')) {
                newWidth = Math.max(400, startWidth + deltaX);
            }
            if (resizeDirection.includes('w')) {
                newWidth = Math.max(400, startWidth - deltaX);
                newLeft = startLeft + deltaX;
            }
            if (resizeDirection.includes('s')) {
                newHeight = Math.max(300, startHeight + deltaY);
            }
            if (resizeDirection.includes('n')) {
                newHeight = Math.max(300, startHeight - deltaY);
                newTop = startTop + deltaY;
            }
            
            // 应用新的尺寸和位置
            modal.style.width = newWidth + 'px';
            modal.style.height = newHeight + 'px';
            modal.style.maxWidth = 'none';
            modal.style.position = 'fixed';
            modal.style.left = newLeft + 'px';
            modal.style.top = newTop + 'px';
            modal.style.margin = '0';
            
            // 调整VNC屏幕高度
            if (vncScreen) {
                const headerHeight = 60; // 模态框头部高度
                const toolbarHeight = 60; // 工具栏高度
                vncScreen.style.height = (newHeight - headerHeight - toolbarHeight) + 'px';
            }
        }
        
        // 停止调整大小
        function stopResize() {
            isResizing = false;
            resizeDirection = '';
            document.removeEventListener('mousemove', doResize);
            document.removeEventListener('mouseup', stopResize);
            document.body.style.userSelect = '';
        }
        
        // 当VNC模态框显示时初始化拖拽功能
        document.addEventListener('DOMContentLoaded', function() {
            const vncModal = document.getElementById('vncModal');
            if (vncModal) {
                vncModal.addEventListener('shown.bs.modal', function() {
                    setTimeout(initResizable, 100); // 延迟初始化以确保DOM完全加载
                });
                
                // 模态框关闭时重置状态
                vncModal.addEventListener('hidden.bs.modal', function() {
                    if (isFullscreen) {
                        toggleFullscreen(); // 退出全屏
                    }
                    // 清理拖拽手柄
                    const handles = document.querySelectorAll('#vncModal .resize-handle');
                    handles.forEach(handle => handle.remove());
                });
            }
        });
    </script>
</body>
</html>