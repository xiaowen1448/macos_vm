<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>批量克隆虚拟机</title>
    <link href="{{ url_for('static', filename='css/bootstrap-5.3.0.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/font-awesome.min.css') }}" rel="stylesheet">
    <script src="{{ url_for('static', filename='lib/bootstrap-5.3.0.bundle.min.js') }}"></script>
    <style>
         body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
        }
        
        .sidebar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            box-shadow: 2px 0 15px rgba(102, 126, 234, 0.3);
            min-height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            z-index: 1000;
            width: 280px;
            color: white;
        }
        
        /* 调整顶部导航栏 */
        .navbar {
            position: fixed;
            top: 0;
            left: 280px;
            right: 0;
            z-index: 999;
            background: white;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .accordion-button:not(.collapsed) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            box-shadow: none;
        }
        
        .accordion-button {
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            font-weight: 600;
        }
        
        .accordion-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .accordion-button:focus {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button::after {
            filter: invert(1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .accordion-item {
            background: transparent;
            border: none;
        }
        
        .accordion-body {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 0 8px;
        }
        
        /* 紧凑布局样式 */
        .compact-form .form-label {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
            font-weight: 500;
        }
        
        .compact-form .form-control,
        .compact-form .form-select {
            font-size: 0.875rem;
            padding: 0.375rem 0.5rem;
            height: auto;
        }
        
        .compact-form .row {
            margin-bottom: 0.5rem;
        }
        
        .compact-form .col-md-4 {
            padding: 0 0.25rem;
            padding-left:0;padding-right:0;
        }
        
        /* 主内容区域铺满 */
        main {
            margin-left: 280px;
            margin-top: 56px;
            width: calc(100% - 280px);
            height: calc(100vh - 56px);
            overflow: hidden;
        }
        
        .main-content {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .form-section {
            flex: 0 0 auto;
            padding: 0.5rem;
        }
        
        .log-section {
            flex: 1;
            padding: 0.5rem;
            overflow: hidden;
        }
        
        .log-card {
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        
        .log-card .card-body {
            flex: 1;
            overflow: hidden;
        }
        
        .log-terminal {
            background: #1e1e1e;
            color: #e0e0e0;
            font-family: 'Fira Mono', 'Consolas', 'Menlo', monospace;
            border-radius: 8px;
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
            height: 100%;
            display: flex;
            flex-direction: column;
        }
        .log-header {
            padding: 8px 12px;
            border-bottom: 1px solid #333;
            font-weight: bold;
            background: #2d2d2d;
            color: #00ff88;
            border-radius: 8px 8px 0 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }
        .log-content {
            padding: 12px;
            font-size: 13px;
            line-height: 1.4;
            flex: 1;
            overflow-y: auto;
        }
        .log-line {
            margin: 1px 0;
            padding: 1px 0;
        }
        .log-info { color: #00ff88; }
        .log-warning { color: #ffaa00; }
        .log-error { color: #ff4444; }
        .log-success { color: #44ff44; }
        .btn-clone {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            color: white;
            font-weight: bold;
            padding: 8px 24px;
            border-radius: 20px;
            transition: all 0.3s ease;
            font-size: 0.875rem;
        }
        .btn-clone:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .status-idle { background-color: #6c757d; }
        .status-running { background-color: #ffc107; animation: pulse 1.5s infinite; }
        .status-success { background-color: #28a745; }
        .status-error { background-color: #dc3545; }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        .progress-container {
            margin-top: 12px;
            display: none;
        }
        .clone-stats {
            background: #e9ecef;
            border-radius: 6px;
            padding: 12px;
            margin-top: 12px;
        }
        
     /* 侧边栏标题样式 */
     
        .sidebar-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: left;
            min-height: 60px;
        }
        
        .brand-text {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-header h4 {
            margin-bottom: 5px !important;
        }
        
        .sidebar-header small {
            font-size: 0.85rem;
            opacity: 0.8;
        }
        
        /* 静态文本框样式 */
        .static-message {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            max-width: 400px;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 14px;
            line-height: 1.4;
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.3s ease;
        }
        
        .static-message.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        .static-message.warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .static-message.error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .static-message.info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        
        .static-message.success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .static-message .close-btn {
            position: absolute;
            top: 8px;
            right: 12px;
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: inherit;
            opacity: 0.7;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: left;
        }
        
        .static-message .close-btn:hover {
            opacity: 1;
        }
        
        /* 布局样式 */
        .col-md-9.col-lg-10 { width: calc(100vw - 280px); min-width: 0; margin: 0; height: calc(100vh - 80px); overflow: auto; }
        .main-wrapper { display: flex; height: 100vh; }
        .sidebar { width: 280px; }
        .main-content { flex: 1; min-width: 0; overflow: auto; }
        .card-body { overflow: visible; }
        .table-responsive { overflow: auto; }
    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" style="position: fixed; top: 0; left: 280px; right: 0; z-index: 1000;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-clone me-2"></i>虚拟机批量克隆
            </span>
            <div class="d-flex">
                <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-home me-2"></i>主页
                </a>
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        语言
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="langDropdown">
                        <li><a class="dropdown-item" href="?lang=zh">中文</a></li>
                        <li><a class="dropdown-item" href="?lang=en">English</a></li>
                    </ul>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">登出</a>
            </div>
        </div>
    </div>
    
    <!-- 左侧菜单 -->
            <nav class="col-md-3 col-lg-2 sidebar p-3">
                    <div class="sidebar-header text-center mb-4">
                <h4 class="mb-0">
                                                <span class="brand-text">VM 虚拟机管理平台</span>
                </h4>
                
            </div>
        <div class="accordion" id="accordionMenu">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingVM">
                                                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVM" aria-expanded="false" aria-controls="collapseVM">
                            虚拟机管理
                        </button>
                        </h2>
                        <div id="collapseVM" class="accordion-collapse collapse" aria-labelledby="headingVM" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link active" href="{{ url_for('clone_vm_page') }}" onclick="handleCloneClick()">虚拟机批量克隆</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('vm_management_page') }}" onclick="handleVMManagementClick()">虚拟机克隆列表</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('vm_script_page') }}" onclick="handleVMScriptClick()">虚拟机脚本管理</a>
                                    </li>
                                       <li class="nav-item">
                                        <a class="nav-link active" href="{{ url_for('icloud_manager.vm_icloud') }}">iCloud管理</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                      <div class="accordion-item">
                <h2 class="accordion-header" id="headingClient">
                    <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseClient" aria-expanded="false" aria-controls="collapseClient">
                        客户端管理
                    </button>
                </h2>
                <div id="collapseClient" class="accordion-collapse collapse" aria-labelledby="headingClient" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('client_management_page') }}">ScptRunner客户端管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('json_parser_page') }}"><i class="fas fa-code me-2"></i>JSON解析功能</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
            <!-- IM管理主菜单 -->
            <div class="accordion-item">
                <h2 class="accordion-header" id="headingMessaging">
                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMessaging" aria-expanded="false" aria-controls="collapseMessaging">
                        IM管理
                    </button>
                </h2>
                <div id="collapseMessaging" class="accordion-collapse collapse " aria-labelledby="headingMessaging" data-bs-parent="#accordionMenu">
                    <div class="accordion-body p-0">
                        <ul class="nav flex-column">
                            <li class="nav-item">
                                <a class="nav-link active" href="{{ url_for('phone_management_page') }}"><i class="fas fa-phone me-2"></i>手机号管理</a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="{{ url_for('mass_messaging.mass_messaging_page') }}"><i class="fas fa-broadcast-tower me-2"></i>群发管理</a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingBoot">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBoot" aria-expanded="false" aria-controls="collapseBoot">
                                杂项管理
                            </button>
                        </h2>
                        <div id="collapseBoot" class="accordion-collapse collapse" aria-labelledby="headingBoot" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('wuma_page') }}" onclick="handleWumaClick()">虚拟机五码管理</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('mupan_page') }}" onclick="handleMupanClick()">虚拟机母盘管理</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('id_management_page') }}" onclick="handleIdManagementClick()">Apple ID管理</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingEncrypt">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncrypt" aria-expanded="false" aria-controls="collapseEncrypt">
                                数据加密功能
                            </button>
                        </h2>
                        <div id="collapseEncrypt" class="accordion-collapse collapse" aria-labelledby="headingEncrypt" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showPanel('encrypt-code')">代码加密</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showPanel('encrypt-wuma')">五码加密</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showPanel('encrypt-id')">id加密</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingProxy">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProxy" aria-expanded="false" aria-controls="collapseProxy">
                                代理ip配置
                            </button>
                        </h2>
                        <div id="collapseProxy" class="accordion-collapse collapse" aria-labelledby="headingProxy" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showPanel('proxy-assign')">代理ip分配</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSoft">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSoft" aria-expanded="false" aria-controls="collapseSoft">
                                虚拟机软件管理
                            </button>
                        </h2>
                        <div id="collapseSoft" class="accordion-collapse collapse" aria-labelledby="headingSoft" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showPanel('soft-version')">版本查看</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="#" onclick="showPanel('soft-env')">环境变量</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>

                </div>
            </nav>
            
            <!-- 主内容区域 -->
            <main>
                <div class="main-content">
                    <!-- 参数配置区域 -->
                    <div class="form-section" style="padding-top:0;margin-top:0;">
                        <div class="card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>批量克隆参数</h5>
                            </div>
                            <div class="card-body">
                                <form id="cloneForm" class="compact-form" autocomplete="off">
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <label for="templateVM" class="form-label">模板虚拟机</label>
                                            <select class="form-select" id="templateVM" name="templateVM" style="width: 50%;"  required>
                                                <option value="">选择模板虚拟机</option>
                                                {% for vm in template_vms %}
                                                <option value="{{ vm.name }}">{{ vm.name }}</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="cloneCount" class="form-label">克隆数量</label>
                                            <input type="number" class="form-control form-control-sm" id="cloneCount" name="cloneCount" min="1" max="100" value="2" style="width: 50%;" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="targetDir" class="form-label">虚拟克隆目录</label>
                                            <input type="text" class="form-control" style="width: 65%;" id="targetDir" name="targetDir" 
                                           value="{{ clone_dir }}" readonly>
                                           <!-- <small class="form-text text-muted d-block">默认克隆目录: {{ clone_dir }}</small> -->
                                        </div>
                                        <div class="col-md-4">
                                            <label for="configPlist" class="form-label">五码配置文件</label>
                                            <select class="form-select" id="configPlist" name="configPlist" style="width: 60%;" required>
                                                <option value="">选择五码配置文件</option>
                                                {% for config in configs %}
                                                <option value="{{ config.path }}">{{ config.display_name }} ({{ config.available_count }}个可用五码)</option>
                                                {% endfor %}
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="namingPattern" class="form-label">命名模式</label>
                                            <select class="form-select form-select-sm" id="namingPattern" name="namingPattern" style="width: 50%;" required>
                                                <option value="VM_{timestamp}_{index}" selected>VM_{timestamp}_{index}</option>
                                                <option value="{vmname}_clone_{timestamp}">{vmname}_clone_{timestamp}</option>
                                                <option value="{timestamp}_VM_{index}">{timestamp}_VM_{index}</option>
                                                <option value="custom">自定义...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <label for="snapshotName" class="form-label">快照命名</label>
                                            <select class="form-select form-select-sm" id="snapshotName" name="snapshotName" style="width: 60%;" required>
                                                <option value="{vmname}_snapshot_{timestamp}" selected>{vmname}_snapshot_{timestamp}</option>
                                                <option value="snapshot_{vmname}_{timestamp}">snapshot_{vmname}_{timestamp}</option>
                                                <option value="{vmname}_backup_{timestamp}">{vmname}_backup_{timestamp}</option>
                                                <option value="snapshot_{timestamp}_{vmname}">snapshot_{timestamp}_{vmname}</option>
                                                <option value="backup_{vmname}_{timestamp}">backup_{vmname}_{timestamp}</option>
                                                <option value="custom">自定义...</option>
                                            </select>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="form-check mt-4">
                                                <input class="form-check-input" type="checkbox" id="autoStart" name="autoStart" value="true" checked>
                                                <label class="form-check-label" for="autoStart">
                                                    自动启动虚拟机
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="d-flex justify-content-between align-items-center mt-2">
                                        <div>
                                            <span class="status-indicator status-idle" id="statusIndicator"></span>
                                            <span id="statusText">就绪</span>
                                        </div>
                                        <button type="submit" class="btn btn-clone btn-sm" id="cloneBtn">
                                            开始克隆
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
        
                    <!-- 日志显示区域 -->
                    <div class="log-section">
                        <div class="card log-card">
                            <div class="card-header">
                                <h5 class="mb-0"><i class="fas fa-terminal me-2"></i>实时执行日志</h5>
                            </div>
                            <div class="card-body p-0">
                                <div class="log-terminal" id="logTerminal">
                                    <div class="log-header">
                                        <span>日志</span>
                                        <div>
                                            <button class="btn btn-sm btn-outline-secondary" id="clearLog">清空</button>
                                            <button class="btn btn-sm btn-outline-secondary" id="copyLog">复制</button>
                                            <button class="btn btn-sm btn-outline-warning" onclick="clearHistory()">清除历史</button>
                                        </div>
                                    </div>
                                    <div class="log-content" id="logContent">
                                        <div class="log-line log-info">系统就绪，等待开始克隆...</div>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>
            </main>

    <!-- 静态文本框容器 -->
    <div id="staticMessageContainer"></div>

    <script>
        let eventSource = null;
        let isCloning = false;
        let reconnectCount = 0;
        let maxReconnectAttempts = 3;
        
        // 静态文本框函数
        function showStaticMessage(message, type = 'info', duration = 5000) {
            const container = document.getElementById('staticMessageContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = `static-message ${type}`;
            messageDiv.innerHTML = `
                ${message}
                <button class="close-btn" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            container.appendChild(messageDiv);
            
            // 显示动画
            setTimeout(() => {
                messageDiv.classList.add('show');
            }, 10);
            
            // 自动隐藏
            if (duration > 0) {
                setTimeout(() => {
                    messageDiv.classList.remove('show');
                    setTimeout(() => {
                        if (messageDiv.parentElement) {
                            messageDiv.remove();
                        }
                    }, 300);
                }, duration);
            }
        }
        
        // 替换alert函数
        function alert(message) {
            showStaticMessage(message, 'warning', 5000);
        }
        
        // 表单提交处理
        document.getElementById('cloneForm').addEventListener('submit', function(e) {
            e.preventDefault();
            if (isCloning) return;
            
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            
            // 处理复选框值（未勾选时不会包含在FormData中）
            data.autoStart = document.getElementById('autoStart').checked ? 'true' : 'false';            
            console.log('表单数据:', data);
            startClone(data);
        });
        
        // 开始克隆
        function startClone(data) {
            isCloning = true;
            updateStatus('running', '克隆进行中...');
            document.getElementById('cloneBtn').disabled = true;

            
            // 清空日志
            document.getElementById('logContent').innerHTML = '<div class="log-line log-info">开始克隆任务...</div>';
            
            // 发送克隆请求
            fetch('/api/clone_vm', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(data)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // 设置克隆状态
                    isCloning = true;
                    
                    // 保存任务ID到localStorage
                    localStorage.setItem('currentCloneTaskId', data.task_id);
                    console.log('保存任务ID到localStorage:', data.task_id);
                    
                    // 开始监听日志
                    startLogStream(data.task_id);
                } else {
                    addLog('error', '启动克隆任务失败: ' + data.message);
                    updateStatus('error', '克隆失败');
                    resetForm();
                }
            })
            .catch(error => {
                addLog('error', '网络错误: ' + error.message);
                updateStatus('error', '网络错误');
                resetForm();
            });
        }
        
        // 连接到任务
        function connectToTask(taskId) {
            if (eventSource) {
                eventSource.close();
            }
            
            eventSource = new EventSource(`/api/clone_logs/${taskId}`);
            
            // 连接成功时重置重连计数器
            eventSource.onopen = function(event) {
                console.log('日志流连接成功');
                // 只有在真正连接成功并收到数据时才重置计数器
                // reconnectCount = 0; // 移除这里的重置，改为在收到第一条消息时重置
            };
            
            eventSource.onmessage = function(event) {
                try {
                    // 检查消息是否为空或无效
                    if (!event.data || event.data.trim() === '') {
                        console.warn('收到空消息，跳过处理');
                        return;
                    }
                    
                    // 收到有效消息时重置重连计数器
                    reconnectCount = 0;
                    
                    console.log('收到EventSource消息:', event.data);
                    console.log('消息类型:', typeof event.data);
                    console.log('消息长度:', event.data.length);
                    
                    // 尝试解析JSON
                    const data = JSON.parse(event.data);
                    console.log('JSON解析成功:', data);
                    
                    if (data.type === 'log') {
                        addLog(data.level, data.message);
                    } else if (data.type === 'progress') {
                        updateProgress(data.current, data.total);
                        // 更新详细进度信息
                        if (data.current_vm) {
                            updateCurrentCloneProgress(data.current_vm, data.current_vm_progress || 0);
                        }
                        if (data.estimated_remaining !== undefined) {
                            updateEstimatedTime(data.estimated_remaining);
                        }

                    } else if (data.type === 'monitoring_progress') {
                        console.log('处理监控进度数据:', data);
                        // 更新重启进度
                        if (data.restart_progress) {
                            updateRestartProgress(data.restart_progress.current, data.restart_progress.total);
                        }
                        // 更新更改五码进度
                        if (data.wuma_progress) {
                            updateWumaProgress(data.wuma_progress.current, data.wuma_progress.total);
                        }
                    } else if (data.type === 'complete') {
                        console.log('处理完成信号:', data);
                        handleComplete(data);
                    } else if (data.type === 'error') {
                        addLog('error', data.message);
                        console.error('服务器错误:', data.message);
                    } else {
                        console.warn('未知消息类型:', data.type);
                    }
                } catch (error) {
                    console.error('解析EventSource消息失败:', error);
                    console.error('原始消息数据:', event.data);
                    console.error('消息长度:', event.data.length);
                    console.error('消息类型:', typeof event.data);
                    
                    // 尝试显示原始消息内容
                    try {
                        // 检查是否是有效的JSON格式
                        const trimmedData = event.data.trim();
                        if (trimmedData.startsWith('{') && trimmedData.endsWith('}')) {
                            // 可能是JSON格式，尝试重新解析
                            try {
                                const parsedData = JSON.parse(trimmedData);
                                console.log('重新解析成功:', parsedData);
                                // 如果重新解析成功，说明是有效的JSON，可能是其他问题
                                addLog('error', `消息处理异常，但JSON格式正确: ${trimmedData.substring(0, 50)}...`);
                            } catch (reparseError) {
                                addLog('error', `消息解析失败: ${trimmedData.substring(0, 100)}...`);
                            }
                        } else {
                            addLog('error', `消息格式异常: ${event.data.substring(0, 100)}...`);
                        }
                    } catch (e) {
                        addLog('error', '解析服务器消息失败');
                    }
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('EventSource连接错误:', event);
                
                // 关闭当前连接
                if (eventSource) {
                    eventSource.close();
                }
                
                // 检查是否是任务不存在的错误（通过检查最近的日志）
                const logContent = document.getElementById('logContent');
                const lastLogEntry = logContent ? logContent.lastElementChild : null;
                const isTaskNotExistError = lastLogEntry && lastLogEntry.textContent.includes('任务不存在');
                
                if (isTaskNotExistError) {
                    // 任务不存在，直接停止重连并清理状态
                    addLog('info', '任务已完成或不存在，停止重连');
                    isCloning = false;
                    localStorage.removeItem('currentCloneTaskId');
                    reconnectCount = 0;
                    return;
                }
                
                addLog('error', '日志流连接错误，尝试重连...');
                
                // 如果任务仍在运行，尝试重连
                if (isCloning && reconnectCount < maxReconnectAttempts) {
                    reconnectCount++;
                    addLog('warning', `第 ${reconnectCount}/${maxReconnectAttempts} 次重连尝试...`);
                    setTimeout(() => {
                        console.log(`尝试重新连接日志流... (${reconnectCount}/${maxReconnectAttempts})`);
                        connectToTask(taskId);
                    }, 2000); // 2秒后重连
                } else if (reconnectCount >= maxReconnectAttempts) {
                    addLog('error', `已达到最大重连次数 (${maxReconnectAttempts})，停止重连`);
                    isCloning = false;
                    localStorage.removeItem('currentCloneTaskId');
                    reconnectCount = 0;
                } else {
                    isCloning = false;
                    localStorage.removeItem('currentCloneTaskId');
                    reconnectCount = 0;
                }
            };
        }
        
        // 开始日志流
        function startLogStream(taskId) {
            // 开始新任务时重置重连计数器
            reconnectCount = 0;
            connectToTask(taskId);
        }
        
        // 添加日志
        function addLog(level, message) {
            const logContent = document.getElementById('logContent');
            const timestamp = new Date().toLocaleTimeString();
            const logLine = document.createElement('div');
            logLine.className = `log-line log-${level}`;
            logLine.innerHTML = `[${timestamp}] ${message}`;
            logContent.appendChild(logLine);
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        // 更新状态
        function updateStatus(status, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }
        
        // 更新进度
        function updateProgress(current, total) {
            try {
                console.log('更新进度:', current, total);
                const progressBar = document.getElementById('progressBar');
                const progressText = document.getElementById('progressText');
                const percentage = total > 0 ? (current / total) * 100 : 0;
                
                if (progressBar) progressBar.style.width = percentage + '%';
                if (progressText) progressText.textContent = `${current} / ${total} 完成`;
                
                // 更新克隆统计区域的进度条
                updateCloneProgress(current, total);
            } catch (error) {
                console.error('更新进度失败:', error);
                addLog('error', `进度更新失败: ${error.message}`);
            }
        }
        
        // 更新克隆进度条
        function updateCloneProgress(current, total) {
            // 使用统一进度条显示克隆进度
            updateUnifiedProgress('克隆进度', current, total);
            
            // 显示详细进度信息
            const detailedProgress = document.getElementById('detailedProgress');
            if (detailedProgress && current > 0) {
                detailedProgress.style.display = 'block';
            }
        }
        
        // 更新当前克隆进度
        function updateCurrentCloneProgress(vmName, progress) {
            const currentCloneName = document.getElementById('currentCloneName');
            const currentCloneProgress = document.getElementById('currentCloneProgress');
            
            if (currentCloneName && currentCloneProgress) {
                currentCloneName.textContent = vmName || '-';
                currentCloneProgress.style.width = progress + '%';
            }
        }
        
        // 更新预计剩余时间
        function updateEstimatedTime(remainingTime) {
            const estimatedTime = document.getElementById('estimatedTime');
            if (estimatedTime) {
                if (remainingTime > 0) {
                    const minutes = Math.floor(remainingTime / 60);
                    const seconds = remainingTime % 60;
                    estimatedTime.textContent = `${minutes}分${seconds}秒`;
                } else {
                    estimatedTime.textContent = '-';
                }
            }
        }
        

        
        // 更新统一进度条
        function updateUnifiedProgress(label, current, total) {
            try {
                console.log('更新统一进度条:', label, current, total);
                const unifiedProgressSection = document.getElementById('unifiedProgressSection');
                const unifiedProgressLabel = document.getElementById('unifiedProgressLabel');
                const unifiedProgressBar = document.getElementById('unifiedProgressBar');
                const unifiedProgressText = document.getElementById('unifiedProgressText');
                
                if (total > 0) {
                    // 显示统一进度区域
                    if (unifiedProgressSection) {
                        unifiedProgressSection.style.display = 'block';
                    }
                    
                    // 更新标签文字
                    if (unifiedProgressLabel) {
                        unifiedProgressLabel.textContent = label;
                    }
                    
                    const percentage = (current / total) * 100;
                    if (unifiedProgressBar) {
                        unifiedProgressBar.style.width = percentage + '%';
                        unifiedProgressBar.setAttribute('aria-valuenow', percentage);
                    }
                    if (unifiedProgressText) {
                        unifiedProgressText.textContent = `${current} / ${total}`;
                    }
                } else {
                    // 隐藏统一进度区域
                    if (unifiedProgressSection) {
                        unifiedProgressSection.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('更新统一进度条失败:', error);
                addLog('error', `统一进度条更新失败: ${error.message}`);
            }
        }
        
        // 更新重启进度（兼容性函数）
        function updateRestartProgress(current, total) {
            updateUnifiedProgress('重启进度', current, total);
        }
        
        // 更新更改五码进度（兼容性函数）
        function updateWumaProgress(current, total) {
            updateUnifiedProgress('更改五码进度', current, total);
        }
        
        // 处理完成
        function handleComplete(data) {
            try {
                console.log('处理完成信号:', data);
                isCloning = false;
                
                if (eventSource) {
                    eventSource.close();
                }
                
                // 保存任务完成状态到localStorage
                const taskInfo = {
                    taskId: localStorage.getItem('currentCloneTaskId'),
                    completed: true,
                    success: data.success,
                    completedAt: new Date().toISOString()
                };
                localStorage.setItem('lastCompletedTask', JSON.stringify(taskInfo));
                
                // 添加完成日志到文件
                addLog('info', '任务已完成，日志已保存到文件');
                
                // 清除localStorage中的任务ID，避免页面刷新后重连
                localStorage.removeItem('currentCloneTaskId');
                console.log('保存任务完成信息到localStorage，并清除任务ID');
                addLog('success', '克隆任务完成！');
                updateStatus('success', '准备就绪');

                // 重置表单但保留日志
                resetFormKeepLogs();
            } catch (error) {
                console.error('处理完成信号失败:', error);
                addLog('error', `处理完成信号失败: ${error.message}`);
            }
        }
        
        // 重置表单
        function resetForm() {
            isCloning = false;
            document.getElementById('cloneBtn').disabled = false;
        }
        
        // 重置表单但保留日志
        function resetFormKeepLogs() {
            isCloning = false;
            const cloneBtn = document.getElementById('cloneBtn');
            if (cloneBtn) {
                cloneBtn.disabled = false;
                cloneBtn.textContent = '开始克隆';
            }
            

        }
        
        // 显示已完成的任务
        function displayCompletedTask(completedTask) {
            console.log('显示已完成的任务:', completedTask);
            

            

            
            // 设置进度条为100%
            const progressBar = document.getElementById('progressBar');
            const progressText = document.getElementById('progressText');
            if (progressBar) {
                progressBar.style.width = '100%';
            }
            if (progressText) {
                progressText.textContent = '任务已完成';
            }
            
            // 更新状态
            if (completedTask.success) {
                updateStatus('success', '准备就绪');
            } else {
                updateStatus('error', '克隆失败');
            }
            
            // 只重置按钮状态，保持进度容器和统计区域显示
            isCloning = false;
            const cloneBtn = document.getElementById('cloneBtn');
            if (cloneBtn) {
                cloneBtn.disabled = false;
                cloneBtn.textContent = '开始克隆';
            }
            
            // 从文件加载日志
            loadTaskLogsFromFile(completedTask.taskId);
        }
        
        // 清空日志
        document.getElementById('clearLog').addEventListener('click', function() {
            document.getElementById('logContent').innerHTML = '<div class="log-line log-info">日志已清空...</div>';
        });
        
        // 清除历史记录
        function clearHistory() {
            localStorage.removeItem('currentCloneTaskId');
            localStorage.removeItem('lastCompletedTask');
            console.log('已清除历史记录');
            
            // 清空日志内容
            const logContent = document.getElementById('logContent');
            logContent.innerHTML = '<div class="log-line log-info">系统就绪，等待开始克隆...</div>';
            
            addLog('info', '历史记录已清除');
            
            // 重置页面状态
            resetForm();
            updateStatus('idle', '准备就绪');
        }
        
        // 从文件加载任务日志
        function loadTaskLogsFromFile(taskId) {
            console.log('从文件加载任务日志:', taskId);
            
            fetch(`/api/task_logs/${taskId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success' && data.logs) {
                        console.log('成功加载日志文件');
                        
                        // 清空当前日志内容
                        const logContent = document.getElementById('logContent');
                        logContent.innerHTML = '';
                        
                        // 解析日志内容并添加到界面
                        const logLines = data.logs.split('\n');
                        logLines.forEach(line => {
                            if (line.trim()) {
                                // 解析日志格式: [时间] [级别] 消息
                                const match = line.match(/\[(.*?)\] \[(.*?)\] (.*)/);
                                if (match) {
                                    const timestamp = match[1];
                                    const level = match[2].toLowerCase();
                                    const message = match[3];
                                    
                                    const logLine = document.createElement('div');
                                    logLine.className = `log-line log-${level}`;
                                    logLine.innerHTML = `[${timestamp}] ${message}`;
                                    logContent.appendChild(logLine);
                                } else {
                                    // 如果无法解析格式，直接显示原始行
                                    const logLine = document.createElement('div');
                                    logLine.className = 'log-line log-info';
                                    logLine.innerHTML = line;
                                    logContent.appendChild(logLine);
                                }
                            }
                        });
                        
                        // 滚动到底部
                        logContent.scrollTop = logContent.scrollHeight;
                        
                        // 添加加载完成信息
                        const loadInfo = document.createElement('div');
                        loadInfo.className = 'log-line log-info';
                        loadInfo.innerHTML = '[系统] 已从文件加载历史日志';
                        logContent.appendChild(loadInfo);
                        logContent.scrollTop = logContent.scrollHeight;
                    } else {
                        console.log('日志文件不存在或为空');
                        addLog('info', '未找到历史日志文件');
                    }
                })
                .catch(error => {
                    console.error('加载日志文件失败:', error);
                    addLog('error', `加载日志文件失败: ${error.message}`);
                });
        }
        
        // 复制日志
        document.getElementById('copyLog').addEventListener('click', function() {
            const logContent = document.getElementById('logContent');
            const text = logContent.innerText;
            
            navigator.clipboard.writeText(text).then(function() {
                addLog('info', '日志已复制到剪贴板');
            }).catch(function() {
                addLog('error', '复制失败');
            });
        });
        
        // 处理自定义命名模式
        document.getElementById('namingPattern').addEventListener('change', function() {
            if (this.value === 'custom') {
                const customInput = document.createElement('input');
                customInput.type = 'text';
                customInput.className = 'form-control mt-2';
                customInput.name = 'customNamingPattern';
                customInput.placeholder = '输入自定义命名模式，支持 {timestamp}、{index}、{vmname} 占位符';
                customInput.required = true;
                
                const container = this.parentElement;
                const existingInput = container.querySelector('input[name="customNamingPattern"]');
                if (!existingInput) {
                    container.appendChild(customInput);
                }
            } else {
                const existingInput = this.parentElement.querySelector('input[name="customNamingPattern"]');
                if (existingInput) {
                    existingInput.remove();
                }
            }
        });
        
        // 处理自定义快照命名模式
        document.getElementById('snapshotName').addEventListener('change', function() {
            if (this.value === 'custom') {
                const customInput = document.createElement('input');
                customInput.type = 'text';
                customInput.className = 'form-control mt-2';
                customInput.name = 'customSnapshotName';
                customInput.placeholder = '输入自定义快照命名模式，支持 {vmname}、{timestamp} 占位符';
                customInput.required = true;
                
                const container = this.parentElement;
                const existingInput = container.querySelector('input[name="customSnapshotName"]');
                if (!existingInput) {
                    container.appendChild(customInput);
                }
            } else {
                const existingInput = this.parentElement.querySelector('input[name="customSnapshotName"]');
                if (existingInput) {
                    existingInput.remove();
                }
            }
        });
        
        // 检查plist文件数量
        document.getElementById('configPlist').addEventListener('change', function() {
            const cloneCount = parseInt(document.getElementById('cloneCount').value) || 0;
            const selectedOption = this.options[this.selectedIndex];
            const countText = selectedOption.text.match(/\((\d+)个可用五码\)/);
            
            if (countText) {
                const plistCount = parseInt(countText[1]);
                if (plistCount < cloneCount) {
                    alert(`警告：选择的五码配置文件只有 ${plistCount} 个可用五码，但需要克隆 ${cloneCount} 个虚拟机。请增加五码或减少克隆数量。`);
                }
            }
        });
        
        // 页面卸载时关闭连接
        window.addEventListener('beforeunload', function() {
            if (eventSource) {
                eventSource.close();
            }
            // 注意：页面卸载时不清除localStorage，以便刷新时重新连接
        });
        
        // 页面加载时确保菜单展开
        document.addEventListener('DOMContentLoaded', function() {
            // 确保虚拟机管理菜单展开
            const vmCollapse = document.getElementById('collapseVM');
            const vmButton = document.getElementById('headingVM').querySelector('.accordion-button');
            
            if (vmCollapse && vmButton) {
                // 移除折叠类，添加展开类
                vmCollapse.classList.remove('collapse');
                vmCollapse.classList.add('show');
                vmButton.setAttribute('aria-expanded', 'true');
                vmButton.classList.remove('collapsed');
            }
            
            // 检查是否有正在运行的任务，如果有则重新连接
            checkAndReconnectTasks();
        });
        
        // 检查并重新连接任务
        function checkAndReconnectTasks() {
            // 从localStorage获取任务ID
            const taskId = localStorage.getItem('currentCloneTaskId');
            if (taskId) {
                console.log('发现任务ID:', taskId);
                
                // 检查是否有已完成的任务信息
                const lastCompletedTask = localStorage.getItem('lastCompletedTask');
                if (lastCompletedTask) {
                    try {
                        const completedTask = JSON.parse(lastCompletedTask);
                        if (completedTask.taskId === taskId && completedTask.completed) {
                            console.log('发现已完成的任务，显示历史记录');
                            displayCompletedTask(completedTask);
                            // 从文件加载日志
                            loadTaskLogsFromFile(taskId);
                            // 清除localStorage中的任务ID，避免重连
                            localStorage.removeItem('currentCloneTaskId');
                            return;
                        }
                    } catch (error) {
                        console.error('解析已完成任务信息失败:', error);
                    }
                }
                
                console.log('检查任务是否仍在运行:', taskId);
                
                // 先尝试连接一次来验证任务是否真的还在运行
                // 如果任务已完成，后端会发送complete信号
                // 如果任务不存在，会触发error并停止重连
                isCloning = true;
                
                // 显示进度容器
                const progressContainer = document.getElementById('progressContainer');
                if (progressContainer) {
                    progressContainer.style.display = 'block';
                }
                
                // 显示克隆统计区域
                const cloneStats = document.getElementById('cloneStats');
                if (cloneStats) {
                    cloneStats.style.display = 'block';
                }
                
                // 禁用克隆按钮
                const cloneButton = document.getElementById('cloneBtn');
                if (cloneButton) {
                    cloneButton.disabled = true;
                    cloneButton.textContent = '克隆进行中...';
                }
                
                // 更新状态为运行中
                updateStatus('running', '重新连接任务...');
                
                // 从文件加载日志
                loadTaskLogsFromFile(taskId);
                
                // 重新连接EventSource
                connectToTask(taskId);
            }
        }
        
        // 处理克隆链接点击，只设置激活状态
        function handleCloneClick() {
            // 只设置当前链接为激活状态，不进行任何菜单操作
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 处理虚拟机管理链接点击，只设置激活状态
        function handleVMManagementClick() {
            // 只设置当前链接为激活状态，不进行任何菜单操作
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 处理虚拟机成品信息链接点击，只设置激活状态
        function handleVMInfoClick() {
            // 只设置当前链接为激活状态，允许Bootstrap默认行为关闭菜单
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // 不阻止默认行为，允许菜单正常关闭
        }

        // 处理虚拟机脚本管理链接点击，只设置激活状态
        function handleVMScriptClick() {
            // 只设置当前链接为激活状态，允许Bootstrap默认行为关闭菜单
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // 不阻止默认行为，允许菜单正常关闭
        }

        // 通用函数：确保菜单展开并设置链接激活状态
        function ensureMenuExpanded(menuId, linkContainerId) {
            const menuCollapse = document.getElementById(menuId);
            const menuButton = document.getElementById(menuId.replace('collapse', 'heading')).querySelector('.accordion-button');
            
            if (menuCollapse && menuButton) {
                // 移除折叠类，添加展开类
                menuCollapse.classList.remove('collapse');
                menuCollapse.classList.add('show');
                menuButton.setAttribute('aria-expanded', 'true');
                menuButton.classList.remove('collapsed');
            }
            
            // 设置当前链接为激活状态
            const links = document.querySelectorAll(`#${linkContainerId} .nav-link`);
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 处理虚拟机五码管理链接点击，确保菜单保持展开状态
        function handleWumaClick() {
            // 不展开任何菜单，只设置当前链接为激活状态
            const links = document.querySelectorAll('#collapseBoot .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 处理虚拟机母盘管理链接点击
        function handleMupanClick() {
            // 不展开任何菜单，只设置当前链接为激活状态
            const links = document.querySelectorAll('#collapseBoot .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }
    </script>
</body>
</html>