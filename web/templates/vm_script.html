<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacOS VM è™šæ‹Ÿæœºç®¡ç†å¹³å° - è„šæœ¬ç®¡ç†</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
            .sidebar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 2px 0 15px rgba(102, 126, 234, 0.3);
        min-height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
        width: 280px;
        color: white;
    }
        
        .accordion-button:not(.collapsed) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            box-shadow: none;
        }
        
        .accordion-button {
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            font-weight: 600;
        }
        
        .accordion-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .accordion-button:focus {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button::after {
            filter: invert(1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .accordion-item {
            background: transparent;
            border: none;
        }
        
        .accordion-body {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 0 8px;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 20px;
        }
        html, body { width: 100vw; overflow-x: hidden !important; }
        .col-md-9.col-lg-10 { width: calc(100vw - 280px); min-width: 0; margin: 0; height: calc(100vh - 80px); overflow-y: auto; overflow-x: hidden; }
        

        
        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .btn-group-sm .btn {
            margin-right: 2px;
        }
        
        /* è¡¨æ ¼å®¹å™¨æ ·å¼ - ç¡®ä¿æ»šåŠ¨æ¡æ˜¾ç¤ºåœ¨æ•°æ®åŒºåŸŸå†…éƒ¨ */
        .table-responsive {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
        }
        
        /* è‡ªå®šä¹‰æ»šåŠ¨æ¡æ ·å¼ */
        .table-responsive::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* ç¡®ä¿è¡¨æ ¼å®¹å™¨æœ‰åˆé€‚çš„é«˜åº¦å’Œè¾¹æ¡† */
        .table-container {
            position: relative;
            background: white;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        /* ç¡®ä¿è¡¨æ ¼å¤´éƒ¨å›ºå®šåœ¨é¡¶éƒ¨ */
        .table-responsive thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
        }
        
        /* è¡¨æ ¼è¡Œæ ·å¼ä¼˜åŒ– */
        .table-responsive tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* ä¾§è¾¹æ æ ‡é¢˜æ ·å¼ */
        .sidebar-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        
        .brand-text {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-header h4 {
            margin-bottom: 5px !important;
        }
        
        .sidebar-header small {
            font-size: 0.85rem;
            opacity: 0.8;
        }

    </style>
</head>
<body>
    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" style="position: fixed; top: 0; left: 280px; right: 0; z-index: 1000;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-code me-2"></i>è™šæ‹Ÿæœºè„šæœ¬ç®¡ç†
            </span>
            <div class="d-flex">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        è¯­è¨€
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="langDropdown">
                        <li><a class="dropdown-item" href="?lang=zh">ä¸­æ–‡</a></li>
                        <li><a class="dropdown-item" href="?lang=en">English</a></li>
                    </ul>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">ç™»å‡º</a>
            </div>
        </div>
    </div>
    
    <div class="container-fluid" style="margin-left: 280px; margin-top: 80px;">
        <div class="row">
            <!-- å·¦ä¾§èœå• -->
            <nav class="col-md-3 col-lg-2 sidebar p-3">
                <div class="sidebar-header text-center mb-4">
                <h4 class="mb-0">
                                                <span class="brand-text">MacOS VM è™šæ‹Ÿæœºç®¡ç†å¹³å°</span>
                </h4>
                
            </div>
                <div class="accordion" id="accordionMenu">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingVM">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVM" aria-expanded="true" aria-controls="collapseVM">
                                è™šæ‹Ÿæœºç®¡ç†
                            </button>
                        </h2>
                        <div id="collapseVM" class="accordion-collapse collapse show" aria-labelledby="headingVM" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('clone_vm_page') }}" onclick="handleCloneClick()">è™šæ‹Ÿæœºæ‰¹é‡å…‹éš†</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('vm_management_page') }}" onclick="handleVMManagementClick()">è™šæ‹Ÿæœºå…‹éš†åˆ—è¡¨</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('vm_info_page') }}" onclick="handleVMInfoClick()">è™šæ‹Ÿæœºæˆå“ä¿¡æ¯</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" href="{{ url_for('vm_script_page') }}" onclick="handleVMScriptClick()">è™šæ‹Ÿæœºè„šæœ¬ç®¡ç†</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingBoot">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBoot" aria-expanded="false" aria-controls="collapseBoot">
                                ç™»å½•å¼•å¯¼ç®¡ç†
                            </button>
                        </h2>
                        <div id="collapseBoot" class="accordion-collapse collapse" aria-labelledby="headingBoot" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('wuma_page') }}" onclick="handleWumaClick()">è™šæ‹Ÿæœºäº”ç ç®¡ç†</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('mupan_page') }}" onclick="handleMupanClick()">è™šæ‹Ÿæœºæ¯ç›˜ç®¡ç†</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('id_management_page') }}" onclick="handleIdManagementClick()">Apple IDç®¡ç†</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingEncrypt">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncrypt" aria-expanded="false" aria-controls="collapseEncrypt">
                                æ•°æ®åŠ å¯†åŠŸèƒ½
                            </button>
                        </h2>
                        <div id="collapseEncrypt" class="accordion-collapse collapse" aria-labelledby="headingEncrypt" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('encrypt_code_page') }}" onclick="handleEncryptCodeClick()">ä»£ç åŠ å¯†</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('encrypt_wuma_page') }}" onclick="handleEncryptWumaClick()">äº”ç åŠ å¯†</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('encrypt_id_page') }}" onclick="handleEncryptIdClick()">idåŠ å¯†</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingProxy">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProxy" aria-expanded="false" aria-controls="collapseProxy">
                                ä»£ç†ipé…ç½®
                            </button>
                        </h2>
                        <div id="collapseProxy" class="accordion-collapse collapse" aria-labelledby="headingProxy" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('proxy_assign_page') }}" onclick="handleProxyAssignClick()">ä»£ç†ipåˆ†é…</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSoft">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSoft" aria-expanded="false" aria-controls="collapseSoft">
                                è™šæ‹Ÿæœºè½¯ä»¶ç®¡ç†
                            </button>
                        </h2>
                        <div id="collapseSoft" class="accordion-collapse collapse" aria-labelledby="headingSoft" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('soft_version_page') }}" onclick="handleSoftVersionClick()">ç‰ˆæœ¬æŸ¥çœ‹</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('soft_env_page') }}" onclick="handleSoftEnvClick()">ç¯å¢ƒå˜é‡</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- å³ä¾§å†…å®¹åŒºåŸŸ -->
            <div class="col-md-9 col-lg-10">
                <div class="card mt-0" style="margin-top:0;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">
                                <i class="fas fa-code me-2"></i>è™šæ‹Ÿæœºè„šæœ¬ç®¡ç†
                            </h4>
                            <div>
                                <button class="btn btn-success me-2" onclick="addScript()">
                                    <i class="fas fa-plus me-2"></i>æ·»åŠ è„šæœ¬
                                </button>
                                <button class="btn btn-primary" onclick="refreshScripts()" title="åˆ·æ–°æ•°æ®">
                                    <i class="fas fa-sync-alt me-2"></i>åˆ·æ–°æ•°æ®
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <h5>è„šæœ¬ç®¡ç†</h5>
                                <p class="text-muted">ç®¡ç†è™šæ‹Ÿæœºç›¸å…³çš„è„šæœ¬æ–‡ä»¶ï¼ŒåŒ…æ‹¬å®‰è£…è„šæœ¬ã€é…ç½®è„šæœ¬ã€ç»´æŠ¤è„šæœ¬ç­‰ã€‚</p>
                                
                                <!-- è„šæœ¬æœç´¢åŒºåŸŸ -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" class="form-control" id="scriptSearchInput" 
                                                   placeholder="æœç´¢è„šæœ¬åç§°..." 
                                                   oninput="searchScripts()" 
                                                   onkeyup="if(event.key === 'Enter') searchScripts()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearScriptSearch()" title="æ¸…ç©ºæœç´¢">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <span class="text-muted" id="searchResultInfo">
                                            å…±æ‰¾åˆ° <span id="searchResultCount">0</span> ä¸ªè„šæœ¬
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>è„šæœ¬åç§°</th>
                                                    <th>è„šæœ¬å¤‡æ³¨</th>
                                                    <th>å¤§å°</th>
                                                    <th>ä¿®æ”¹æ—¶é—´</th>
                                                    <th>æ“ä½œ</th>
                                                </tr>
                                            </thead>
                                            <tbody id="scriptTableBody">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin me-2"></i>åŠ è½½ä¸­...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- åˆ†é¡µæ§ä»¶ -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="d-flex align-items-center">
                                        <div class="text-muted me-3">
                                            æ˜¾ç¤º <span id="startRecord">0</span> - <span id="endRecord">0</span> æ¡ï¼Œå…± <span id="totalRecords">0</span> æ¡è®°å½•
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <label class="form-label mb-0 me-2">æ¯é¡µæ˜¾ç¤º:</label>
                                            <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;" onchange="changePageSize()" oninput="console.log('åˆ†é¡µå¤§å°é€‰æ‹©å™¨å€¼å˜åŒ–:', this.value)">
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="20">20</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>
                                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="resetToAuto()" title="é‡ç½®ä¸ºè‡ªåŠ¨åˆ†é¡µ">
                                                <i class="fas fa-magic"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <nav aria-label="è„šæœ¬åˆ—è¡¨åˆ†é¡µ">
                                        <ul class="pagination pagination-sm mb-0" id="pagination">
                                            <!-- åˆ†é¡µæŒ‰é’®å°†åœ¨è¿™é‡ŒåŠ¨æ€ç”Ÿæˆ -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘è„šæœ¬å¼¹çª— -->
    <div class="modal fade" id="editScriptModal" tabindex="-1" aria-labelledby="editScriptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScriptModalLabel">ç¼–è¾‘è„šæœ¬</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3" id="scriptNameGroup" style="display: none;">
                        <label for="scriptName" class="form-label">è„šæœ¬åç§° <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="scriptName" placeholder="è¯·è¾“å…¥è„šæœ¬åç§°ï¼ˆä»¥.shç»“å°¾ï¼Œä¸èƒ½åŒ…å«ä¸­æ–‡ï¼‰" required>
                    </div>
                    <div class="mb-3">
                        <label for="scriptNote" class="form-label">è„šæœ¬å¤‡æ³¨</label>
                        <textarea class="form-control" id="scriptNote" rows="3" placeholder="è¯·è¾“å…¥è„šæœ¬å¤‡æ³¨..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="scriptContent" class="form-label">è„šæœ¬å†…å®¹</label>
                        <textarea class="form-control" id="scriptContent" rows="8" placeholder="è¯·è¾“å…¥è„šæœ¬å†…å®¹..." style="font-family: 'Courier New', monospace;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å–æ¶ˆ</button>
                    <button type="button" class="btn btn-primary" id="saveScriptBtn" onclick="saveScript()">ä¿å­˜</button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // å¼¹çª—å…³é—­æ—¶é‡ç½®è„šæœ¬åç§°è¾“å…¥æ¡†
        document.getElementById('editScriptModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('scriptNameGroup').style.display = 'none';
        });
        

        


        // è„šæœ¬åç§°è¾“å…¥éªŒè¯ - é˜²æ­¢è¾“å…¥ä¸­æ–‡å­—ç¬¦
        document.getElementById('scriptName').addEventListener('input', function(e) {
            const value = e.target.value;
            // ç§»é™¤ä¸­æ–‡å­—ç¬¦
            const filteredValue = value.replace(/[\u4e00-\u9fa5]/g, '');
            if (value !== filteredValue) {
                e.target.value = filteredValue;
                alert('è„šæœ¬åç§°ä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦');
            }
        });

        // èœå•å¤„ç†å‡½æ•°
        function handleCloneClick() {
            // åªè®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€ï¼Œä¸è¿›è¡Œä»»ä½•èœå•æ“ä½œ
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleVMManagementClick() {
            // åªè®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€ï¼Œä¸è¿›è¡Œä»»ä½•èœå•æ“ä½œ
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleVMInfoClick() {
            // åªè®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€ï¼Œå…è®¸Bootstrapé»˜è®¤è¡Œä¸ºå…³é—­èœå•
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // ä¸é˜»æ­¢é»˜è®¤è¡Œä¸ºï¼Œå…è®¸èœå•æ­£å¸¸å…³é—­
        }

        function handleVMScriptClick() {
            console.log('ğŸ”„ handleVMScriptClick() è¢«è°ƒç”¨ (vm_script.html)');
            console.log('ğŸ“ å½“å‰äº‹ä»¶ç›®æ ‡:', event.target);
            console.log('ğŸ“ å½“å‰äº‹ä»¶ç›®æ ‡æ–‡æœ¬:', event.target.textContent);
            
            // åªè®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€ï¼Œå®Œå…¨ä¸å¹²é¢„Bootstrap accordionè¡Œä¸º
            const links = document.querySelectorAll('#collapseVM .nav-link');
            console.log('ğŸ“ æ‰¾åˆ°çš„é“¾æ¥æ•°é‡:', links.length);
            links.forEach(link => {
                console.log('ğŸ“ ç§»é™¤é“¾æ¥æ¿€æ´»çŠ¶æ€:', link.textContent);
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            console.log('âœ… è®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€:', event.target.textContent);
            
            // å®Œå…¨ä¸å¹²é¢„èœå•çŠ¶æ€ï¼Œè®©Bootstrapè‡ªå·±å¤„ç†
            console.log('ğŸ“ ä¸å¹²é¢„èœå•çŠ¶æ€ï¼Œè®©Bootstrapè‡ªå·±å¤„ç†å±•å¼€/å…³é—­');
            
            // ç¡®ä¿ä¸é˜»æ­¢äº‹ä»¶ä¼ æ’­
            console.log('ğŸ“ å…è®¸äº‹ä»¶ç»§ç»­ä¼ æ’­åˆ°Bootstrap');
        }

        function handleWumaClick() {
            // ä¸å±•å¼€ä»»ä½•èœå•ï¼Œåªè®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€
            const links = document.querySelectorAll('#collapseBoot .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleMupanClick() {
            // ä¸å±•å¼€ä»»ä½•èœå•ï¼Œåªè®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€
            const links = document.querySelectorAll('#collapseBoot .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleEncryptCodeClick() {
            ensureMenuExpanded('collapseEncrypt', 'collapseEncrypt');
        }

        function handleEncryptWumaClick() {
            ensureMenuExpanded('collapseEncrypt', 'collapseEncrypt');
        }

        function handleEncryptIdClick() {
            ensureMenuExpanded('collapseEncrypt', 'collapseEncrypt');
        }

        function handleProxyAssignClick() {
            ensureMenuExpanded('collapseProxy', 'collapseProxy');
        }

        function handleSoftVersionClick() {
            ensureMenuExpanded('collapseSoft', 'collapseSoft');
        }

        function handleSoftEnvClick() {
            ensureMenuExpanded('collapseSoft', 'collapseSoft');
        }

        // é€šç”¨å‡½æ•°ï¼šç¡®ä¿èœå•å±•å¼€å¹¶è®¾ç½®é“¾æ¥æ¿€æ´»çŠ¶æ€
        function ensureMenuExpanded(menuId, linkContainerId) {
            const menuCollapse = document.getElementById(menuId);
            const menuButton = document.getElementById(menuId.replace('collapse', 'heading')).querySelector('.accordion-button');
            
            if (menuCollapse && menuButton) {
                // ç§»é™¤æŠ˜å ç±»ï¼Œæ·»åŠ å±•å¼€ç±»
                menuCollapse.classList.remove('collapse');
                menuCollapse.classList.add('show');
                menuButton.setAttribute('aria-expanded', 'true');
                menuButton.classList.remove('collapsed');
            }
            
            // è®¾ç½®å½“å‰é“¾æ¥ä¸ºæ¿€æ´»çŠ¶æ€
            const links = document.querySelectorAll(`#${linkContainerId} .nav-link`);
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        // åˆ†é¡µç›¸å…³å˜é‡
        let currentPage = 1;
        let pageSize = 5; // ä¿®æ”¹é»˜è®¤åˆ†é¡µå¤§å°ä¸º5
        let totalScripts = []; // å­˜å‚¨æ‰€æœ‰è„šæœ¬æ•°æ®
        let totalPages = 0;
        let isAutoCalculated = true; // æ ‡è®°æ˜¯å¦ä¸ºè‡ªåŠ¨è®¡ç®—çš„åˆ†é¡µå¤§å°
        
        // é¡µé¢åŠ è½½æ—¶è·å–è„šæœ¬åˆ—è¡¨
        document.addEventListener('DOMContentLoaded', function() {
            // ç¡®ä¿è™šæ‹Ÿæœºç®¡ç†èœå•ä¿æŒå±•å¼€çŠ¶æ€
            setTimeout(() => {
                console.log('ç¬¬ä¸€æ¬¡å°è¯•å±•å¼€è™šæ‹Ÿæœºç®¡ç†èœå•...');
                const menuCollapse = document.getElementById('collapseVM');
                const menuButton = document.getElementById('headingVM').querySelector('.accordion-button');
                console.log('èœå•å®¹å™¨:', menuCollapse);
                console.log('èœå•æŒ‰é’®:', menuButton);
                if (menuCollapse && menuButton) {
                    console.log('å±•å¼€å‰çš„èœå•çŠ¶æ€:', menuCollapse.className);
                    console.log('å±•å¼€å‰çš„æŒ‰é’®çŠ¶æ€:', menuButton.className);
                    menuCollapse.classList.remove('collapse');
                    menuCollapse.classList.add('show');
                    menuButton.setAttribute('aria-expanded', 'true');
                    menuButton.classList.remove('collapsed');
                    console.log('å±•å¼€åçš„èœå•çŠ¶æ€:', menuCollapse.className);
                    console.log('å±•å¼€åçš„æŒ‰é’®çŠ¶æ€:', menuButton.className);
                } else {
                    console.error('æ‰¾ä¸åˆ°èœå•å…ƒç´ ');
                }
            }, 100);
            
            // å†æ¬¡ç¡®ä¿èœå•å±•å¼€ï¼ˆåŒé‡ä¿é™©ï¼‰
            setTimeout(() => {
                console.log('ç¬¬äºŒæ¬¡å°è¯•å±•å¼€è™šæ‹Ÿæœºç®¡ç†èœå•...');
                const menuCollapse = document.getElementById('collapseVM');
                const menuButton = document.getElementById('headingVM').querySelector('.accordion-button');
                if (menuCollapse && menuButton) {
                    console.log('ç¬¬äºŒæ¬¡å±•å¼€å‰çš„èœå•çŠ¶æ€:', menuCollapse.className);
                    console.log('ç¬¬äºŒæ¬¡å±•å¼€å‰çš„æŒ‰é’®çŠ¶æ€:', menuButton.className);
                    menuCollapse.classList.remove('collapse');
                    menuCollapse.classList.add('show');
                    menuButton.setAttribute('aria-expanded', 'true');
                    menuButton.classList.remove('collapsed');
                    console.log('ç¬¬äºŒæ¬¡å±•å¼€åçš„èœå•çŠ¶æ€:', menuCollapse.className);
                    console.log('ç¬¬äºŒæ¬¡å±•å¼€åçš„æŒ‰é’®çŠ¶æ€:', menuButton.className);
                }
            }, 500);
            
            // å…è®¸è™šæ‹Ÿæœºç®¡ç†èœå•æ­£å¸¸å…³é—­
            const vmCollapse = document.getElementById('collapseVM');
            if (vmCollapse) {
                console.log('ğŸ“ å…è®¸"è™šæ‹Ÿæœºç®¡ç†"èœå•æ­£å¸¸å…³é—­');
                vmCollapse.addEventListener('hidden.bs.collapse', function() {
                    console.log('ğŸ”„ "è™šæ‹Ÿæœºç®¡ç†"èœå•è¢«å…³é—­');
                    console.log('ğŸ“ å…è®¸èœå•æ­£å¸¸å…³é—­ï¼Œä¸é‡æ–°å±•å¼€');
                });
            }
            
            // å…è®¸è™šæ‹Ÿæœºç®¡ç†èœå•æ­£å¸¸æŠ˜å /å±•å¼€
            const vmButton = document.getElementById('headingVM').querySelector('.accordion-button');
            if (vmButton) {
                console.log('ğŸ“ å…è®¸"è™šæ‹Ÿæœºç®¡ç†"èœå•æ­£å¸¸æŠ˜å /å±•å¼€');
                // ç§»é™¤ä»»ä½•å¯èƒ½é˜»æ­¢æŠ˜å çš„äº‹ä»¶ç›‘å¬å™¨
                vmButton.addEventListener('click', function(e) {
                    console.log('ğŸ”„ "è™šæ‹Ÿæœºç®¡ç†"èœå•æŒ‰é’®è¢«ç‚¹å‡»');
                    console.log('ğŸ“ å…è®¸Bootstrapæ­£å¸¸å¤„ç†æŠ˜å /å±•å¼€');
                });
            }
            
            // æ™ºèƒ½è®¡ç®—æœ€ä½³æ•°æ®æ˜¾ç¤ºé‡
            const optimalDataDisplay = calculateOptimalDataDisplay();
            console.log('é¡µé¢åŠ è½½æ—¶è®¡ç®—çš„æœ€ä½³æ•°æ®æ˜¾ç¤ºé‡:', optimalDataDisplay);
            
            // ç¡®ä¿åˆ†é¡µå¤§å°åœ¨å¯ç”¨é€‰é¡¹ä¸­ï¼Œä¼˜å…ˆé€‰æ‹©èƒ½å……åˆ†åˆ©ç”¨ç©ºé—´çš„å¤§å°
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const availableSizes = Array.from(pageSizeSelect.options).map(opt => parseInt(opt.value));
            
            // é€‰æ‹©æœ€æ¥è¿‘ä½†ä¸è¶…è¿‡æœ€ä½³æ˜¾ç¤ºé‡çš„åˆ†é¡µå¤§å°
            let selectedSize = 5; // é»˜è®¤å€¼
            for (let size of availableSizes) {
                if (size <= optimalDataDisplay && size > selectedSize) {
                    selectedSize = size;
                }
            }
            
            console.log('å¯ç”¨çš„åˆ†é¡µå¤§å°:', availableSizes);
            console.log('æœ€ä½³æ•°æ®æ˜¾ç¤ºé‡:', optimalDataDisplay);
            console.log('é€‰æ‹©çš„åˆ†é¡µå¤§å°:', selectedSize);
            
            pageSizeSelect.value = selectedSize.toString();
            pageSize = selectedSize;
            
            // è‡ªåŠ¨æ¨¡å¼ä¸‹ï¼Œæ ¹æ®åˆ†é¡µå¤§å°æ™ºèƒ½å†³å®šæ˜¯å¦æ˜¾ç¤ºæ»šåŠ¨æ¡
            const tableContainer = document.querySelector('.table-responsive');
            const mainContent = document.querySelector('.col-md-9.col-lg-10');
            
            // ä½¿ç”¨æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨æ¡
            const needsScrollbar = shouldEnableScrollbar(selectedSize);
            setScrollbarState(needsScrollbar, `é¡µé¢åˆå§‹åŒ–ï¼Œåˆ†é¡µå¤§å°: ${selectedSize}`);
            
            // é¡µé¢åŠ è½½å®Œæˆåè°ƒæ•´è¡¨æ ¼å®¹å™¨é«˜åº¦
            setTimeout(() => {
                adjustTableContainerHeight();
            }, 100);
            
            loadScripts(1);
            
            // ç›‘å¬çª—å£å¤§å°å˜åŒ–ï¼Œè‡ªåŠ¨è°ƒæ•´åˆ†é¡µå¤§å°
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // åªæœ‰åœ¨è‡ªåŠ¨æ¨¡å¼ä¸‹æ‰è‡ªåŠ¨è°ƒæ•´
                    if (isAutoCalculated) {
                        const newPageSize = calculateOptimalPageSize();
                        if (newPageSize !== pageSize) {
                            document.getElementById('pageSizeSelect').value = newPageSize.toString();
                            pageSize = newPageSize;
                            currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                            
                            // è‡ªåŠ¨è°ƒæ•´æ—¶ï¼Œæ ¹æ®åˆ†é¡µå¤§å°æ™ºèƒ½å†³å®šæ˜¯å¦æ˜¾ç¤ºæ»šåŠ¨æ¡
                            const tableContainer = document.querySelector('.table-responsive');
                            const mainContent = document.querySelector('.col-md-9.col-lg-10');
                            
                            // ä½¿ç”¨æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨æ¡
                            const needsScrollbar = shouldEnableScrollbar(newPageSize);
                            setScrollbarState(needsScrollbar, `çª—å£å¤§å°å˜åŒ–ï¼Œåˆ†é¡µå¤§å°: ${newPageSize}`);
                            
                            // ç›‘æ§è¡¨æ ¼å®¹é‡å˜åŒ–
                            setTimeout(() => {
                                monitorTableCapacity();
                            }, 100);
                            
                            loadScripts(1);
                        }
                    }
                }, 300);
            });
        });
        
        // å…¨å±€å˜é‡å­˜å‚¨æ‰€æœ‰è„šæœ¬æ•°æ®
        let allScripts = [];
        let filteredScripts = [];
        let isSearchMode = false;
        
        // æœç´¢è„šæœ¬
        function searchScripts() {
            const searchInput = document.getElementById('scriptSearchInput');
            const searchTerm = searchInput.value.trim().toLowerCase();
            const searchResultCount = document.getElementById('searchResultCount');
            const searchResultInfo = document.getElementById('searchResultInfo');
            
            if (searchTerm === '') {
                // æ¸…ç©ºæœç´¢ï¼Œæ˜¾ç¤ºæ‰€æœ‰è„šæœ¬
                isSearchMode = false;
                searchResultInfo.style.display = 'none';
                // æ¸…ç©ºæ‰€æœ‰è„šæœ¬æ•°æ®ï¼Œé‡æ–°åŠ è½½åˆ†é¡µæ•°æ®
                allScripts = [];
                filteredScripts = [];
                loadScripts(1);
                return;
            }
            
            // æ€»æ˜¯åŠ è½½æ‰€æœ‰è„šæœ¬æ•°æ®è¿›è¡Œæœç´¢
            loadAllScriptsForSearch(searchTerm);
        }
        
        // åŠ è½½æ‰€æœ‰è„šæœ¬æ•°æ®ç”¨äºæœç´¢
        function loadAllScriptsForSearch(searchTerm) {
            console.log('åŠ è½½æ‰€æœ‰è„šæœ¬æ•°æ®ç”¨äºæœç´¢...');
            
            fetch('/api/scripts/all')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // å­˜å‚¨æ‰€æœ‰è„šæœ¬æ•°æ®
                        allScripts = data.scripts;
                        console.log(`æˆåŠŸåŠ è½½ ${allScripts.length} ä¸ªè„šæœ¬ç”¨äºæœç´¢`);
                        
                        // æ‰§è¡Œæœç´¢
                        isSearchMode = true;
                        filteredScripts = allScripts.filter(script => 
                            script.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (script.note && script.note.toLowerCase().includes(searchTerm.toLowerCase()))
                        );
                        
                        // æ›´æ–°æœç´¢ç»“æœä¿¡æ¯
                        const searchResultCount = document.getElementById('searchResultCount');
                        const searchResultInfo = document.getElementById('searchResultInfo');
                        searchResultCount.textContent = filteredScripts.length;
                        searchResultInfo.style.display = 'inline';
                        
                        // æ›´æ–°è¡¨æ ¼æ˜¾ç¤ºæœç´¢ç»“æœ
                        updateScriptTableWithSearch(filteredScripts);
                    } else {
                        console.error('åŠ è½½æ‰€æœ‰è„šæœ¬å¤±è´¥:', data.message);
                        alert('åŠ è½½è„šæœ¬æ•°æ®å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½æ‰€æœ‰è„šæœ¬å‡ºé”™:', error);
                    alert('åŠ è½½è„šæœ¬æ•°æ®å‡ºé”™: ' + error.message);
                });
        }
        
        // æ¸…ç©ºæœç´¢
        function clearScriptSearch() {
            const searchInput = document.getElementById('scriptSearchInput');
            const searchResultInfo = document.getElementById('searchResultInfo');
            
            searchInput.value = '';
            isSearchMode = false;
            searchResultInfo.style.display = 'none';
            
            // æ¸…ç©ºæ‰€æœ‰è„šæœ¬æ•°æ®ï¼Œé‡æ–°åŠ è½½åˆ†é¡µæ•°æ®
            allScripts = [];
            filteredScripts = [];
            
            // é‡æ–°åŠ è½½åˆ†é¡µè„šæœ¬
            loadScripts(1);
        }
        

        
        // æ›´æ–°æœç´¢ç»“æœçš„è¡¨æ ¼æ˜¾ç¤º
        function updateScriptTableWithSearch(scripts) {
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '';
            
            if (scripts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æœªæ‰¾åˆ°åŒ¹é…çš„è„šæœ¬</td></tr>';
                // æ¸…ç©ºåˆ†é¡µä¿¡æ¯
                document.getElementById('startRecord').textContent = '0';
                document.getElementById('endRecord').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }
            
            // è®¡ç®—åˆ†é¡µ
            const startIndex = 0;
            const endIndex = Math.min(pageSize, scripts.length);
            
            // æ›´æ–°è®°å½•æ˜¾ç¤ºä¿¡æ¯
            document.getElementById('startRecord').textContent = scripts.length > 0 ? startIndex + 1 : 0;
            document.getElementById('endRecord').textContent = endIndex;
            document.getElementById('totalRecords').textContent = scripts.length;
            
            // æ˜¾ç¤ºæœç´¢ç»“æœ
            scripts.slice(startIndex, endIndex).forEach(script => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${script.name}</strong>
                    </td>
                    <td>${script.note || '<span class="text-muted">-</span>'}</td>
                    <td>${script.size}</td>
                    <td>${script.modified_time}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editScript('${script.name}')" title="ç¼–è¾‘è„šæœ¬" style="cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteScript('${script.name}')" title="åˆ é™¤è„šæœ¬" style="cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function loadScripts(page = 1) {
            console.log(`åŠ è½½è„šæœ¬åˆ—è¡¨... (ç¬¬ ${page} é¡µï¼Œæ¯é¡µ ${pageSize} æ¡)`);
            console.log(`å…¨å±€pageSizeå˜é‡å€¼: ${pageSize}`);
            console.log(`è¯·æ±‚URL: /api/scripts?page=${page}&page_size=${pageSize}`);
            console.log(`å½“å‰åˆ†é¡µé€‰æ‹©å™¨å€¼: ${document.getElementById('pageSizeSelect').value}`);
            console.log(`åˆ†é¡µé€‰æ‹©å™¨æ˜¯å¦ä¸å…¨å±€å˜é‡ä¸€è‡´: ${document.getElementById('pageSizeSelect').value == pageSize}`);
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>åŠ è½½ä¸­...</td></tr>';
            
            const requestUrl = `/api/scripts?page=${page}&page_size=${pageSize}&_t=${Date.now()}`;
            console.log(`å‘é€è¯·æ±‚: ${requestUrl}`);
            fetch(requestUrl)
                .then(response => {
                    console.log('APIå“åº”çŠ¶æ€:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('APIå“åº”æ•°æ®:', data);
                    if (data.success) {
                        console.log('æ›´æ–°è¡¨æ ¼æ•°æ®:', {
                            page: page,
                            pagination: data.pagination,
                            scriptsCount: data.scripts.length
                        });
                        
                        // å­˜å‚¨åˆ†é¡µè„šæœ¬æ•°æ®ç”¨äºæœç´¢ï¼ˆå¦‚æœè¿˜æ²¡æœ‰åŠ è½½æ‰€æœ‰æ•°æ®ä¸”ä¸åœ¨æœç´¢æ¨¡å¼ï¼‰
                        // æ³¨æ„ï¼šè¿™é‡Œåªå­˜å‚¨å½“å‰åˆ†é¡µæ•°æ®ï¼Œæœç´¢æ—¶ä¼šåŠ è½½æ‰€æœ‰æ•°æ®
                        if (allScripts.length === 0 && !isSearchMode) {
                            allScripts = data.scripts;
                            filteredScripts = [...allScripts];
                        }
                        
                        // å­˜å‚¨åˆ†é¡µä¿¡æ¯
                        totalPages = data.pagination.total_pages;
                        currentPage = page;
                        
                        console.log('åˆ†é¡µæ•°æ®å­˜å‚¨:', {
                            totalPages: totalPages,
                            currentPage: currentPage,
                            scriptsCount: data.scripts.length,
                            pagination: data.pagination
                        });
                        
                        // å¦‚æœå½“å‰åœ¨æœç´¢æ¨¡å¼ï¼Œæ›´æ–°æœç´¢ç»“æœ
                        if (isSearchMode) {
                            const searchInput = document.getElementById('scriptSearchInput');
                            if (searchInput.value.trim() !== '') {
                                searchScripts();
                                return;
                            }
                        }
                        
                        updateScriptTableWithPagination(page, data.pagination, data.scripts);
                        
                        // æ•°æ®åŠ è½½å®Œæˆåï¼Œé‡æ–°æ£€æŸ¥æ»šåŠ¨æ¡çŠ¶æ€
                        setTimeout(() => {
                            // å…ˆç¦ç”¨æ»šåŠ¨æ¡ï¼Œè®©å†…å®¹è‡ªç„¶å±•å¼€
                            const tableContainer = document.querySelector('.table-responsive');
                            const mainContent = document.querySelector('.col-md-9.col-lg-10');
                            
                            tableContainer.style.overflow = 'visible';
                            tableContainer.style.maxHeight = 'none';
                            if (mainContent) mainContent.style.overflow = 'visible';
                            
                            // ç­‰å¾…å†…å®¹å®Œå…¨å±•å¼€åå†åˆ¤æ–­
                            setTimeout(() => {
                                // è·å–å½“å‰è¡¨æ ¼æ•°æ®å±•ç¤ºåŒºåŸŸçš„å®¹é‡
                                const tableCapacity = getTableDisplayCapacity();
                                console.log('æ•°æ®åŠ è½½å®Œæˆåçš„è¡¨æ ¼å®¹é‡åˆ†æ:', tableCapacity);
                                
                                const needsScrollbar = shouldEnableScrollbar(pageSize);
                                setScrollbarState(needsScrollbar, 'æ•°æ®åŠ è½½å®Œæˆå');
                                
                                // æ˜¾ç¤ºå®¹é‡åˆ†æç»“æœ
                                console.log(`å½“å‰è¡¨æ ¼æœ€å¤šå¯æ˜¾ç¤º ${tableCapacity.maxRows} æ¡æ•°æ®ï¼Œåˆ†é¡µå¤§å°ä¸º ${pageSize} æ¡`);
                                if (pageSize > tableCapacity.maxRows) {
                                    console.log(`æ•°æ®è¶…å‡ºæ˜¾ç¤ºåŒºåŸŸï¼Œå¯ç”¨å†…éƒ¨æ»šåŠ¨æ¡`);
                                } else {
                                    console.log(`æ•°æ®åœ¨æ˜¾ç¤ºåŒºåŸŸå†…ï¼Œæ— éœ€æ»šåŠ¨æ¡`);
                                }
                            }, 50);
                        }, 100);
                    } else {
                        console.error('åŠ è½½è„šæœ¬å¤±è´¥:', data.message);
                        showError('åŠ è½½è„šæœ¬å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('åŠ è½½è„šæœ¬å‡ºé”™:', error);
                    showError('åŠ è½½è„šæœ¬å‡ºé”™: ' + error.message);
                });
        }
        
        function updateScriptTableWithPagination(page, pagination = null, scripts = []) {
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '';
            
            console.log('æ›´æ–°è„šæœ¬è¡¨æ ¼:', { page, pagination, scriptsCount: scripts.length });
            
            if (!pagination || pagination.total_count === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">æš‚æ— è„šæœ¬æ–‡ä»¶</td></tr>';
                // æ¸…ç©ºåˆ†é¡µä¿¡æ¯
                document.getElementById('startRecord').textContent = '0';
                document.getElementById('endRecord').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // æ›´æ–°è®°å½•æ˜¾ç¤ºä¿¡æ¯ - ä½¿ç”¨å®é™…æ˜¾ç¤ºçš„è®°å½•æ•°é‡
            const actualStart = pagination.start_index + 1;
            const actualEnd = pagination.start_index + scripts.length;
            document.getElementById('startRecord').textContent = actualStart;
            document.getElementById('endRecord').textContent = actualEnd;
            document.getElementById('totalRecords').textContent = pagination.total_count;
            
            console.log('åˆ†é¡µæ˜¾ç¤ºä¿¡æ¯æ›´æ–°:', {
                actualStart: actualStart,
                actualEnd: actualEnd,
                scriptsLength: scripts.length,
                paginationStart: pagination.start_index,
                paginationEnd: pagination.end_index,
                totalCount: pagination.total_count
            });
            
            console.log('æ›´æ–°åˆ†é¡µä¿¡æ¯:', {
                start: pagination.start_index + 1,
                end: pagination.end_index,
                total: pagination.total_count,
                pageSize: pageSize
            });
            
            // ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„è„šæœ¬æ•°æ®
            scripts.forEach(script => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${script.name}</strong></td>
                    <td>${script.note || '<span class="text-muted">æ— å¤‡æ³¨</span>'}</td>
                    <td>${script.size}</td>
                    <td>${script.modified_time}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" title="ç¼–è¾‘è„šæœ¬" onclick="editScript('${script.name}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" title="åˆ é™¤è„šæœ¬" onclick="deleteScript('${script.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // æ›´æ–°åˆ†é¡µæ§ä»¶
            updatePagination(page);
        }
        
        function refreshScripts() {
            console.log('åˆ·æ–°è„šæœ¬æ•°æ®...');
            
            // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>åˆ·æ–°ä¸­...</td></tr>';
            
            // é‡ç½®åˆ†é¡µä¿¡æ¯
            document.getElementById('startRecord').textContent = '0';
            document.getElementById('endRecord').textContent = '0';
            document.getElementById('totalRecords').textContent = '0';
            
            // æ¸…ç©ºåˆ†é¡µæ§ä»¶
            document.getElementById('pagination').innerHTML = '';
            
            // æ¸…ç©ºæœç´¢çŠ¶æ€
            isSearchMode = false;
            allScripts = [];
            filteredScripts = [];
            const searchInput = document.getElementById('scriptSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            const searchResultInfo = document.getElementById('searchResultInfo');
            if (searchResultInfo) {
                searchResultInfo.style.display = 'none';
            }
            
            // å¼‚æ­¥é‡æ–°åŠ è½½å½“å‰é¡µæ•°æ®
            loadScripts(currentPage);
        }
        
        function addScript() {
            console.log('æ·»åŠ è„šæœ¬');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('scriptName').value = '';
            document.getElementById('scriptNote').value = '';
            document.getElementById('scriptContent').value = '';
            
            // æ˜¾ç¤ºè„šæœ¬åç§°è¾“å…¥æ¡†
            document.getElementById('scriptNameGroup').style.display = 'block';
            
            // æ›´æ–°å¼¹çª—æ ‡é¢˜å’ŒæŒ‰é’®æ–‡æœ¬
            document.getElementById('editScriptModalLabel').textContent = 'è„šæœ¬æ–°å¢';
            document.getElementById('saveScriptBtn').textContent = 'æ–°å¢';
            
            // æ˜¾ç¤ºå¼¹çª—
            const modal = new bootstrap.Modal(document.getElementById('editScriptModal'));
            modal.show();
        }
        
        let currentScriptName = '';
        let currentVMs = [];
        
        function deleteScript(scriptName) {
            if (confirm(`ç¡®å®šè¦åˆ é™¤è„šæœ¬ "${scriptName}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) {
                fetch('/api/script/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_name: scriptName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`è„šæœ¬ "${scriptName}" åˆ é™¤æˆåŠŸï¼`);
                        // åˆ·æ–°è„šæœ¬åˆ—è¡¨
                        refreshScripts();
                    } else {
                        alert(`åˆ é™¤å¤±è´¥: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('åˆ é™¤è„šæœ¬å‡ºé”™:', error);
                    alert('åˆ é™¤è„šæœ¬å‡ºé”™: ' + error.message);
                });
            }
        }
        
        function editScript(scriptName) {
            console.log('ç¼–è¾‘è„šæœ¬:', scriptName);
            currentScriptName = scriptName;
            
            // è·å–è„šæœ¬å†…å®¹
            fetch(`/api/script/content/${scriptName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('scriptContent').value = data.content;
                        document.getElementById('scriptNote').value = data.note || '';
                        
                        // éšè—è„šæœ¬åç§°è¾“å…¥æ¡†
                        document.getElementById('scriptNameGroup').style.display = 'none';
                        
                        // æ›´æ–°å¼¹çª—æ ‡é¢˜å’ŒæŒ‰é’®æ–‡æœ¬
                        document.getElementById('editScriptModalLabel').textContent = 'ç¼–è¾‘è„šæœ¬';
                        document.getElementById('saveScriptBtn').textContent = 'ä¿å­˜';
                        
                        // æ˜¾ç¤ºå¼¹çª—
                        const modal = new bootstrap.Modal(document.getElementById('editScriptModal'));
                        modal.show();
                    } else {
                        alert('è·å–è„šæœ¬å†…å®¹å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('è·å–è„šæœ¬å†…å®¹å‡ºé”™:', error);
                    alert('è·å–è„šæœ¬å†…å®¹å‡ºé”™: ' + error.message);
                });
        }
        
        function saveScript() {
            const content = document.getElementById('scriptContent').value;
            const note = document.getElementById('scriptNote').value;
            const modalTitle = document.getElementById('editScriptModalLabel').textContent;
            
            if (!content.trim()) {
                alert('è„šæœ¬å†…å®¹ä¸èƒ½ä¸ºç©º');
                return;
            }
            
            // åˆ¤æ–­æ˜¯æ–°å¢è¿˜æ˜¯ç¼–è¾‘
            if (modalTitle === 'è„šæœ¬æ–°å¢') {
                // æ–°å¢è„šæœ¬
                const scriptName = document.getElementById('scriptName').value.trim();
                if (!scriptName) {
                    alert('è„šæœ¬åç§°ä¸ºå¿…å¡«é¡¹ï¼Œè¯·è¾“å…¥è„šæœ¬åç§°');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                // æ£€æŸ¥æ˜¯å¦åŒ…å«ä¸­æ–‡å­—ç¬¦
                if (/[\u4e00-\u9fa5]/.test(scriptName)) {
                    alert('è„šæœ¬åç§°ä¸èƒ½åŒ…å«ä¸­æ–‡å­—ç¬¦');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶åæ ¼å¼
                if (!scriptName.endsWith('.sh')) {
                    alert('è„šæœ¬æ–‡ä»¶åå¿…é¡»ä»¥.shç»“å°¾');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                // æ£€æŸ¥æ–‡ä»¶åæ˜¯å¦åªåŒ…å«åˆæ³•å­—ç¬¦ï¼ˆå­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦ã€ç‚¹ï¼‰
                if (!/^[a-zA-Z0-9_.-]+\.sh$/.test(scriptName)) {
                    alert('è„šæœ¬åç§°åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿ã€è¿å­—ç¬¦å’Œç‚¹ï¼Œä¸”å¿…é¡»ä»¥.shç»“å°¾');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                fetch('/api/script/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_name: scriptName,
                        content: content,
                        note: note
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('è„šæœ¬æ–°å¢æˆåŠŸ');
                        // å…³é—­å¼¹çª—
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editScriptModal'));
                        modal.hide();
                        // åˆ·æ–°è„šæœ¬åˆ—è¡¨
                        loadScripts(currentPage);
                    } else {
                        alert('æ–°å¢å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('æ–°å¢è„šæœ¬å‡ºé”™:', error);
                    alert('æ–°å¢è„šæœ¬å‡ºé”™: ' + error.message);
                });
            } else {
                // ç¼–è¾‘è„šæœ¬
                fetch('/api/script/edit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_name: currentScriptName,
                        content: content,
                        note: note
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('è„šæœ¬ä¿å­˜æˆåŠŸ');
                        // å…³é—­å¼¹çª—
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editScriptModal'));
                        modal.hide();
                        // åˆ·æ–°è„šæœ¬åˆ—è¡¨
                        loadScripts(currentPage);
                    } else {
                        alert('ä¿å­˜å¤±è´¥: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('ä¿å­˜è„šæœ¬å‡ºé”™:', error);
                    alert('ä¿å­˜è„šæœ¬å‡ºé”™: ' + error.message);
                });
            }
        }
        

        

        

        

        

        

        

        

        
        function updateVMList(vms, trustedVMs = []) {
            const vmList = document.getElementById('vmList');
            vmList.innerHTML = '';
            
            if (vms.length === 0) {
                vmList.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        æ²¡æœ‰å¯ç”¨çš„è™šæ‹Ÿæœº
                    </div>
                `;
                return;
            }
            
            // åˆ›å»ºäº’ä¿¡è™šæ‹Ÿæœºç»„
            if (trustedVMs.length > 0) {
                const trustedGroup = document.createElement('div');
                trustedGroup.className = 'mb-3';
                trustedGroup.innerHTML = `
                    <h6 class="text-success mb-2">
                        <i class="fas fa-check-circle me-2"></i>SSHäº’ä¿¡è™šæ‹Ÿæœº (${trustedVMs.length})
                    </h6>
                `;
                vmList.appendChild(trustedGroup);
                
                trustedVMs.forEach(vm => {
                    const vmItem = document.createElement('div');
                    vmItem.className = 'form-check mb-2 ms-3';
                    vmItem.innerHTML = `
                        <input class="form-check-input vm-checkbox trusted-vm" type="checkbox" value="${vm.name}" id="vm_${vm.name}" onchange="updateSelectedCount()">
                        <label class="form-check-label" for="vm_${vm.name}">
                            <strong>${vm.name}</strong> 
                            <small class="text-muted">(${vm.ip})</small>
                            <span class="badge bg-success ms-2">
                                <i class="fas fa-shield-alt me-1"></i>å·²äº’ä¿¡
                            </span>
                        </label>
                    `;
                    trustedGroup.appendChild(vmItem);
                });
            }
            
            // åˆ›å»ºéƒ¨åˆ†åœ¨çº¿è™šæ‹Ÿæœºç»„
            const partialVMs = vms.filter(vm => !trustedVMs.some(tvm => tvm.name === vm.name));
            if (partialVMs.length > 0) {
                const partialGroup = document.createElement('div');
                partialGroup.className = 'mb-3';
                partialGroup.innerHTML = `
                    <h6 class="text-warning mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>éƒ¨åˆ†åœ¨çº¿è™šæ‹Ÿæœº (${partialVMs.length})
                        <small class="text-muted">- ç«¯å£å¼€æ”¾ä½†æœªäº’ä¿¡ï¼Œå¯èƒ½æ— æ³•å‘é€è„šæœ¬</small>
                    </h6>
                `;
                vmList.appendChild(partialGroup);
                
                partialVMs.forEach(vm => {
                    const vmItem = document.createElement('div');
                    vmItem.className = 'form-check mb-2 ms-3';
                    vmItem.innerHTML = `
                        <input class="form-check-input vm-checkbox partial-vm" type="checkbox" value="${vm.name}" id="vm_${vm.name}" onchange="updateSelectedCount()">
                        <label class="form-check-label" for="vm_${vm.name}">
                            <strong>${vm.name}</strong> 
                            <small class="text-muted">(${vm.ip})</small>
                            <span class="badge bg-warning ms-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>æœªäº’ä¿¡
                            </span>
                        </label>
                    `;
                    partialGroup.appendChild(vmItem);
                });
            }
        }
        
        function selectAllVMs() {
            document.querySelectorAll('.vm-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        }
        
        function selectAllTrustedVMs() {
            // åªé€‰æ‹©SSHäº’ä¿¡çš„è™šæ‹Ÿæœº
            document.querySelectorAll('.vm-checkbox.trusted-vm').forEach(checkbox => {
                checkbox.checked = true;
            });
            // å–æ¶ˆé€‰æ‹©éƒ¨åˆ†åœ¨çº¿çš„è™šæ‹Ÿæœº
            document.querySelectorAll('.vm-checkbox.partial-vm').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.vm-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = selectedCount;
        }
        
        function deselectAllVMs() {
            document.querySelectorAll('.vm-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }
        
        function confirmSendScript() {
            const selectedVMs = Array.from(document.querySelectorAll('.vm-checkbox:checked')).map(cb => cb.value);
            const selectedTrustedVMs = Array.from(document.querySelectorAll('.vm-checkbox.trusted-vm:checked')).map(cb => cb.value);
            const selectedPartialVMs = Array.from(document.querySelectorAll('.vm-checkbox.partial-vm:checked')).map(cb => cb.value);
            
            if (selectedVMs.length === 0) {
                alert('è¯·é€‰æ‹©è‡³å°‘ä¸€ä¸ªè™šæ‹Ÿæœº');
                return;
            }
            
            // æ£€æŸ¥æ˜¯å¦é€‰æ‹©äº†æœªäº’ä¿¡çš„è™šæ‹Ÿæœº
            if (selectedPartialVMs.length > 0) {
                const warningMessage = `âš ï¸ è­¦å‘Šï¼šæ‚¨é€‰æ‹©äº† ${selectedPartialVMs.length} ä¸ªæœªäº’ä¿¡çš„è™šæ‹Ÿæœºã€‚\n\nè¿™äº›è™šæ‹Ÿæœºå¯èƒ½æ— æ³•æˆåŠŸæ¥æ”¶è„šæœ¬ã€‚\n\nå»ºè®®åªé€‰æ‹©SSHäº’ä¿¡çš„è™šæ‹Ÿæœºä»¥ç¡®ä¿è„šæœ¬å‘é€æˆåŠŸã€‚\n\næ˜¯å¦ç»§ç»­å‘é€ï¼Ÿ`;
                if (!confirm(warningMessage)) {
                    return;
                }
            }
            
            const confirmMessage = `ç¡®å®šè¦å‘é€è„šæœ¬ ${currentScriptName} åˆ° ${selectedVMs.length} ä¸ªè™šæ‹Ÿæœºå—ï¼Ÿ\n\n` +
                `â€¢ SSHäº’ä¿¡è™šæ‹Ÿæœºï¼š${selectedTrustedVMs.length} ä¸ª\n` +
                `â€¢ éƒ¨åˆ†åœ¨çº¿è™šæ‹Ÿæœºï¼š${selectedPartialVMs.length} ä¸ª`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            fetch('/api/script/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    script_name: currentScriptName,
                    vm_names: selectedVMs
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = 'è„šæœ¬å‘é€å®Œæˆ:\n\n';
                    let successCount = 0;
                    let failCount = 0;
                    
                    data.results.forEach(result => {
                        const status = result.status === 'success' ? 'âœ…' : 'âŒ';
                        const statusText = result.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥';
                        message += `${status} ${result.vm_name} (${result.ip}): ${statusText}\n`;
                        message += `   åŸå› : ${result.message}\n\n`;
                        
                        if (result.status === 'success') {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    });
                    
                    message += `\næ€»ç»“:\n`;
                    message += `â€¢ æˆåŠŸ: ${successCount} ä¸ªè™šæ‹Ÿæœº\n`;
                    message += `â€¢ å¤±è´¥: ${failCount} ä¸ªè™šæ‹Ÿæœº\n`;
                    message += `â€¢ æ€»è®¡: ${data.results.length} ä¸ªè™šæ‹Ÿæœº`;
                    
                    alert(message);
                    
                    // å…³é—­å¼¹çª—
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sendScriptModal'));
                    modal.hide();
                } else {
                    alert('å‘é€å¤±è´¥: ' + data.message);
                }
            })
            .catch(error => {
                console.error('å‘é€è„šæœ¬å‡ºé”™:', error);
                alert('å‘é€è„šæœ¬å‡ºé”™: ' + error.message);
            });
        }
        
        function showError(message) {
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </td></tr>`;
        }
        
        // è®¡ç®—æœ€ä½³åˆ†é¡µå¤§å°
        function calculateOptimalPageSize() {
            const windowHeight = window.innerHeight;
            const availableHeight = windowHeight - 300; // å‡å»å¤´éƒ¨ã€å¯¼èˆªç­‰é«˜åº¦
            const rowHeight = 60; // æ¯è¡Œå¤§çº¦é«˜åº¦
            const optimalRows = Math.floor(availableHeight / rowHeight);
            
            // ç¡®ä¿åœ¨åˆç†èŒƒå›´å†…ï¼Œé»˜è®¤è¿”å›5
            if (optimalRows < 5) return 5;
            if (optimalRows > 50) return 50;
            return Math.max(5, Math.min(50, optimalRows));
        }
        
        // æ™ºèƒ½è®¡ç®—å½“å‰ç•Œé¢èƒ½æ˜¾ç¤ºçš„æœ€ä½³æ•°æ®é‡
        function calculateOptimalDataDisplay() {
            // è·å–å½“å‰è¡¨æ ¼æ•°æ®å±•ç¤ºåŒºåŸŸçš„å®¹é‡
            const tableCapacity = getTableDisplayCapacity();
            const maxVisibleRows = tableCapacity.maxRows;
            
            // è€ƒè™‘åˆ†é¡µæ§ä»¶çš„ç©ºé—´ï¼Œé¢„ç•™ä¸€äº›ç©ºé—´ç»™åˆ†é¡µ
            const optimalRows = Math.max(5, maxVisibleRows - 1);
            
            // ç¡®ä¿ä¸è¶…è¿‡å¯ç”¨é€‰é¡¹çš„æœ€å¤§å€¼
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const availableSizes = Array.from(pageSizeSelect.options).map(opt => parseInt(opt.value));
            const maxAvailableSize = Math.max(...availableSizes);
            
            const finalOptimalRows = Math.min(optimalRows, maxAvailableSize);
            
            console.log('æ™ºèƒ½è®¡ç®—æœ€ä½³æ•°æ®æ˜¾ç¤ºé‡:', {
                tableCapacity: tableCapacity,
                maxVisibleRows: maxVisibleRows,
                optimalRows: optimalRows,
                maxAvailableSize: maxAvailableSize,
                finalOptimalRows: finalOptimalRows
            });
            
            return finalOptimalRows;
        }
        
        // è®¡ç®—å½“å‰ç•Œé¢èƒ½æ˜¾ç¤ºçš„æœ€å¤§è¡Œæ•°
        function calculateMaxVisibleRows() {
            // è·å–é¡µé¢å¯ç”¨é«˜åº¦
            const windowHeight = window.innerHeight;
            
            // ä¼°ç®—å…¶ä»–å…ƒç´ å ç”¨çš„é«˜åº¦
            const headerHeight = 200; // å¤´éƒ¨åŒºåŸŸ
            const footerHeight = 100; // åº•éƒ¨åŒºåŸŸ
            const paginationHeight = 50; // åˆ†é¡µæ§ä»¶
            const tableHeaderHeight = 50; // è¡¨æ ¼å¤´éƒ¨
            const paddingHeight = 40; // å„ç§é—´è·
            
            // è®¡ç®—è¡¨æ ¼å®¹å™¨çš„å¯ç”¨é«˜åº¦
            const availableHeight = windowHeight - headerHeight - footerHeight - paginationHeight - tableHeaderHeight - paddingHeight;
            const rowHeight = 60; // é¢„ä¼°æ¯è¡Œé«˜åº¦
            const maxRows = Math.floor(availableHeight / rowHeight);
            
            console.log('è®¡ç®—å½“å‰ç•Œé¢èƒ½æ˜¾ç¤ºçš„æœ€å¤§è¡Œæ•°:', {
                windowHeight: windowHeight,
                availableHeight: availableHeight,
                rowHeight: rowHeight,
                maxRows: maxRows,
                headerHeight: headerHeight,
                footerHeight: footerHeight,
                paginationHeight: paginationHeight,
                tableHeaderHeight: tableHeaderHeight,
                paddingHeight: paddingHeight
            });
            
            return Math.max(1, maxRows); // è‡³å°‘æ˜¾ç¤º1è¡Œ
        }
        
        // åˆ¤æ–­æ˜¯å¦éœ€è¦å¯ç”¨æ»šåŠ¨æ¡
        function shouldEnableScrollbar(pageSize) {
            // è·å–å½“å‰è¡¨æ ¼æ•°æ®å±•ç¤ºåŒºåŸŸçš„å®¹é‡
            const tableCapacity = getTableDisplayCapacity();
            const maxVisibleRows = tableCapacity.maxRows;
            
            // å‡å°‘å®¹é”™ç©ºé—´ï¼Œæ›´å……åˆ†åœ°åˆ©ç”¨å¯ç”¨ç©ºé—´
            const adjustedMaxRows = maxVisibleRows + 1; // åªå¢åŠ 1è¡Œçš„å®¹é”™ç©ºé—´
            
            // åªæœ‰å½“æ˜æ˜¾è¶…å‡ºæ—¶æ‰å¯ç”¨æ»šåŠ¨æ¡
            const needsScrollbar = pageSize > adjustedMaxRows && (pageSize - adjustedMaxRows) >= 1;
            
            console.log('åˆ¤æ–­æ˜¯å¦éœ€è¦å¯ç”¨æ»šåŠ¨æ¡:', {
                pageSize: pageSize,
                maxVisibleRows: maxVisibleRows,
                adjustedMaxRows: adjustedMaxRows,
                needsScrollbar: needsScrollbar,
                difference: pageSize - adjustedMaxRows,
                tableCapacity: tableCapacity
            });
            
            // åœ¨æ§åˆ¶å°æ˜¾ç¤ºè¯¦ç»†çš„ç©ºé—´ä½¿ç”¨ä¿¡æ¯
            if (pageSize === 10 || pageSize === 20) {
                console.log(`=== åˆ†é¡µå¤§å°ä¸º${pageSize}æ—¶çš„è¯¦ç»†åˆ†æ ===`);
                console.log('å½“å‰è¡¨æ ¼æ•°æ®å±•ç¤ºåŒºåŸŸå®¹é‡:', tableCapacity);
                console.log('å½“å‰ç•Œé¢èƒ½æ˜¾ç¤ºçš„æœ€å¤§è¡Œæ•°:', maxVisibleRows);
                console.log('è°ƒæ•´åçš„æœ€å¤§è¡Œæ•°ï¼ˆå«å®¹é”™ç©ºé—´ï¼‰:', adjustedMaxRows);
                console.log('æ˜¯å¦éœ€è¦æ»šåŠ¨æ¡:', needsScrollbar);
                console.log('è¶…å‡ºè°ƒæ•´åæœ€å¤§è¡Œæ•°çš„æ•°é‡:', pageSize - adjustedMaxRows);
                console.log('================================');
            }
            
            return needsScrollbar;
        }
        
        // ç»Ÿä¸€è®¾ç½®æ»šåŠ¨æ¡çŠ¶æ€
        function setScrollbarState(needsScrollbar, context = '') {
            const tableContainer = document.querySelector('.table-responsive');
            const mainContent = document.querySelector('.col-md-9.col-lg-10');
            
            if (needsScrollbar) {
                // éœ€è¦æ»šåŠ¨æ¡æ—¶ï¼Œå¯ç”¨æ»šåŠ¨ - æ»šåŠ¨æ¡æ˜¾ç¤ºåœ¨è¡¨æ ¼æ•°æ®åŒºåŸŸå†…éƒ¨
                tableContainer.style.overflow = 'auto';
                
                // è°ƒæ•´è¡¨æ ¼å®¹å™¨é«˜åº¦ä»¥ä¼˜åŒ–æ»šåŠ¨æ¡æ˜¾ç¤º
                adjustTableContainerHeight();
                
                // ç¡®ä¿å¤–å±‚å®¹å™¨ä¸æ˜¾ç¤ºæ»šåŠ¨æ¡ï¼Œè®©æ»šåŠ¨æ¡åªæ˜¾ç¤ºåœ¨è¡¨æ ¼åŒºåŸŸ
                if (mainContent) {
                    mainContent.style.overflow = 'hidden';
                }
                
                // ç¡®ä¿è¡¨æ ¼å¤´éƒ¨å›ºå®šåœ¨é¡¶éƒ¨
                const thead = tableContainer.querySelector('thead');
                if (thead) {
                    thead.style.position = 'sticky';
                    thead.style.top = '0';
                    thead.style.zIndex = '1';
                }
                
                console.log(`å¯ç”¨æ»šåŠ¨æ¡ (${context}) - æ»šåŠ¨æ¡æ˜¾ç¤ºåœ¨è¡¨æ ¼æ•°æ®åŒºåŸŸå†…éƒ¨`);
            } else {
                // ä¸éœ€è¦æ»šåŠ¨æ¡æ—¶ï¼Œç¦ç”¨æ»šåŠ¨
                tableContainer.style.overflow = 'visible';
                tableContainer.style.maxHeight = 'none';
                tableContainer.style.height = 'auto';
                
                if (mainContent) {
                    mainContent.style.overflow = 'visible';
                }
                
                // æ¢å¤è¡¨æ ¼å¤´éƒ¨æ ·å¼
                const thead = tableContainer.querySelector('thead');
                if (thead) {
                    thead.style.position = '';
                    thead.style.top = '';
                    thead.style.zIndex = '';
                }
                
                console.log(`ç¦ç”¨æ»šåŠ¨æ¡ (${context})`);
            }
        }
        
        // åŠ¨æ€æµ‹é‡å®é™…å¯ç”¨ç©ºé—´
        function measureActualAvailableSpace() {
            const tableContainer = document.querySelector('.table-responsive');
            const mainContent = document.querySelector('.col-md-9.col-lg-10');
            
            if (!tableContainer || !mainContent) {
                console.log('æ— æ³•æ‰¾åˆ°è¡¨æ ¼å®¹å™¨ï¼Œä½¿ç”¨ä¼°ç®—å€¼');
                return calculateMaxVisibleRows();
            }
            
            // ä¸´æ—¶è®¾ç½®å®¹å™¨ä¸ºå¯è§çŠ¶æ€ä»¥æµ‹é‡å®é™…é«˜åº¦
            const originalOverflow = tableContainer.style.overflow;
            const originalMaxHeight = tableContainer.style.maxHeight;
            
            tableContainer.style.overflow = 'visible';
            tableContainer.style.maxHeight = 'none';
            
            // è·å–å®é™…å¯ç”¨é«˜åº¦
            const containerRect = tableContainer.getBoundingClientRect();
            const mainContentRect = mainContent.getBoundingClientRect();
            
            // è®¡ç®—å®é™…å¯ç”¨é«˜åº¦ - æ›´ç²¾ç¡®çš„è®¡ç®—
            const distanceToBottom = window.innerHeight - containerRect.top;
            const mainContentAvailable = mainContentRect.height - 60; // è¿›ä¸€æ­¥å‡å°‘è¾¹è·
            
            // ä½¿ç”¨æ›´ç²¾ç¡®çš„å€¼ï¼Œå……åˆ†åˆ©ç”¨ç©ºé—´
            const availableHeight = Math.max(distanceToBottom - 20, mainContentAvailable);
            
            const rowHeight = 55; // æ¯è¡Œé«˜åº¦
            const maxRows = Math.floor(availableHeight / rowHeight);
            
            // æ¢å¤åŸå§‹çŠ¶æ€
            tableContainer.style.overflow = originalOverflow;
            tableContainer.style.maxHeight = originalMaxHeight;
            
            console.log('åŠ¨æ€æµ‹é‡å®é™…å¯ç”¨ç©ºé—´:', {
                containerTop: containerRect.top,
                distanceToBottom: distanceToBottom,
                mainContentHeight: mainContentRect.height,
                mainContentAvailable: mainContentAvailable,
                availableHeight: availableHeight,
                maxRows: maxRows,
                windowHeight: window.innerHeight
            });
            
            return Math.max(1, maxRows);
        }
        
        // è·å–å½“å‰è¡¨æ ¼æ•°æ®å±•ç¤ºåŒºåŸŸçš„å¤§å°å¹¶è®¡ç®—æœ€å¤§æ˜¾ç¤ºæ•°æ®é‡
        function getTableDisplayCapacity() {
            const tableContainer = document.querySelector('.table-responsive');
            const tableContainerWrapper = document.querySelector('.table-container');
            
            if (!tableContainer || !tableContainerWrapper) {
                console.log('æ— æ³•æ‰¾åˆ°è¡¨æ ¼å®¹å™¨');
                return { maxRows: 10, containerHeight: 0, rowHeight: 55 };
            }
            
            // è·å–è¡¨æ ¼å®¹å™¨çš„å®é™…å°ºå¯¸
            const containerRect = tableContainer.getBoundingClientRect();
            const wrapperRect = tableContainerWrapper.getBoundingClientRect();
            
            // è®¡ç®—è¡¨æ ¼å¤´éƒ¨é«˜åº¦
            const thead = tableContainer.querySelector('thead');
            const headerHeight = thead ? thead.offsetHeight : 50;
            
            // è®¡ç®—å¯ç”¨æ•°æ®åŒºåŸŸé«˜åº¦
            const totalContainerHeight = wrapperRect.height;
            const availableDataHeight = totalContainerHeight - headerHeight - 20; // é¢„ç•™ä¸€äº›è¾¹è·
            
            // è®¡ç®—æ¯è¡Œæ•°æ®çš„é«˜åº¦
            const rowHeight = 55; // é¢„ä¼°æ¯è¡Œé«˜åº¦
            
            // è®¡ç®—æœ€å¤§å¯æ˜¾ç¤ºçš„æ•°æ®è¡Œæ•°
            const maxRows = Math.floor(availableDataHeight / rowHeight);
            
            console.log('è¡¨æ ¼æ•°æ®å±•ç¤ºåŒºåŸŸå®¹é‡åˆ†æ:', {
                totalContainerHeight: totalContainerHeight,
                headerHeight: headerHeight,
                availableDataHeight: availableDataHeight,
                rowHeight: rowHeight,
                maxRows: maxRows,
                containerRect: {
                    width: containerRect.width,
                    height: containerRect.height
                },
                wrapperRect: {
                    width: wrapperRect.width,
                    height: wrapperRect.height
                }
            });
            
            return {
                maxRows: Math.max(1, maxRows),
                containerHeight: totalContainerHeight,
                rowHeight: rowHeight,
                availableDataHeight: availableDataHeight
            };
        }
        
        // è°ƒæ•´è¡¨æ ¼å®¹å™¨é«˜åº¦ä»¥ä¼˜åŒ–æ»šåŠ¨æ¡æ˜¾ç¤º
        function adjustTableContainerHeight() {
            const tableContainer = document.querySelector('.table-responsive');
            const tableContainerWrapper = document.querySelector('.table-container');
            
            if (!tableContainer || !tableContainerWrapper) return;
            
            // è®¡ç®—æœ€ä½³é«˜åº¦
            const windowHeight = window.innerHeight;
            const containerTop = tableContainer.getBoundingClientRect().top;
            const optimalHeight = windowHeight - containerTop - 200; // é¢„ç•™ç©ºé—´ç»™åˆ†é¡µæ§ä»¶ç­‰
            
            // è®¾ç½®è¡¨æ ¼å®¹å™¨é«˜åº¦
            tableContainer.style.maxHeight = `${Math.max(300, optimalHeight)}px`;
            
            console.log('è°ƒæ•´è¡¨æ ¼å®¹å™¨é«˜åº¦:', {
                windowHeight: windowHeight,
                containerTop: containerTop,
                optimalHeight: optimalHeight,
                maxHeight: tableContainer.style.maxHeight
            });
        }
        
        // ç›‘æ§è¡¨æ ¼å®¹é‡å˜åŒ–å¹¶æ›´æ–°æ˜¾ç¤º
        function monitorTableCapacity() {
            const tableCapacity = getTableDisplayCapacity();
            const currentPageSize = pageSize;
            
            console.log('è¡¨æ ¼å®¹é‡ç›‘æ§:', {
                currentCapacity: tableCapacity.maxRows,
                currentPageSize: currentPageSize,
                needsScrollbar: currentPageSize > tableCapacity.maxRows,
                remainingSpace: Math.max(0, tableCapacity.maxRows - currentPageSize)
            });
            
            // å¦‚æœå®¹é‡å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°è¯„ä¼°æ»šåŠ¨æ¡çŠ¶æ€
            if (currentPageSize > tableCapacity.maxRows) {
                const needsScrollbar = shouldEnableScrollbar(currentPageSize);
                setScrollbarState(needsScrollbar, 'å®¹é‡ç›‘æ§è§¦å‘');
            }
        }
        
        // æ›´æ–°åˆ†é¡µæ§ä»¶
        function updatePagination(currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // è·å–æ€»é¡µæ•°
            const totalRecords = parseInt(document.getElementById('totalRecords').textContent) || 0;
            const totalPages = Math.ceil(totalRecords / pageSize);
            
            console.log('æ›´æ–°åˆ†é¡µæ§ä»¶:', { currentPage, totalRecords, totalPages, pageSize });
            
            if (totalPages <= 1) {
                console.log('æ€»é¡µæ•°å°äºç­‰äº1ï¼Œä¸æ˜¾ç¤ºåˆ†é¡µæ§ä»¶');
                return;
            }
            
            // ä¸Šä¸€é¡µæŒ‰é’®
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">ä¸Šä¸€é¡µ</a>`;
            pagination.appendChild(prevLi);
            
            // é¡µç æŒ‰é’®
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
                pagination.appendChild(pageLi);
            }
            
            // ä¸‹ä¸€é¡µæŒ‰é’®
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">ä¸‹ä¸€é¡µ</a>`;
            pagination.appendChild(nextLi);
            
            console.log('åˆ†é¡µæ§ä»¶æ›´æ–°å®Œæˆ');
        }
        
        // è·³è½¬åˆ°æŒ‡å®šé¡µ
        function goToPage(page) {
            console.log('è·³è½¬åˆ°é¡µé¢:', page);
            
            if (page < 1 || page > totalPages) {
                console.log('é¡µç è¶…å‡ºèŒƒå›´ï¼Œå¿½ç•¥');
                return;
            }
            
            currentPage = page;
            loadScripts(page);
        }
        
        // æ”¹å˜åˆ†é¡µå¤§å°
        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSizeSelect').value);
            console.log('æ”¹å˜åˆ†é¡µå¤§å°:', { oldSize: pageSize, newSize: newPageSize });
            
            if (newPageSize !== pageSize) {
                console.log('åˆ†é¡µå¤§å°å‘ç”Ÿå˜åŒ–ï¼Œé‡æ–°åŠ è½½æ•°æ®...');
                
                // æ›´æ–°å…¨å±€å˜é‡
                pageSize = newPageSize;
                currentPage = 1; // é‡ç½®åˆ°ç¬¬ä¸€é¡µ
                isAutoCalculated = false; // æ ‡è®°ä¸ºæ‰‹åŠ¨è®¾ç½®
                
                // æ˜¾ç¤ºåŠ è½½çŠ¶æ€
                const tbody = document.getElementById('scriptTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>åŠ è½½ä¸­...</td></tr>';
                
                // æ¸…ç©ºåˆ†é¡µä¿¡æ¯
                document.getElementById('startRecord').textContent = '0';
                document.getElementById('endRecord').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                document.getElementById('pagination').innerHTML = '';
                
                // æ ¹æ®åˆ†é¡µå¤§å°æ™ºèƒ½è°ƒæ•´æ»šåŠ¨æ¡è®¾ç½®
                const tableContainer = document.querySelector('.table-responsive');
                const mainContent = document.querySelector('.col-md-9.col-lg-10');
                
                // ä½¿ç”¨æ™ºèƒ½åˆ¤æ–­æ˜¯å¦éœ€è¦æ»šåŠ¨æ¡
                const needsScrollbar = shouldEnableScrollbar(newPageSize);
                setScrollbarState(needsScrollbar, `åˆ†é¡µå¤§å°æ”¹å˜ï¼Œåˆ†é¡µå¤§å°: ${newPageSize}`);
                
                // æ˜¾ç¤ºæ™ºèƒ½å»ºè®®
                const optimalDisplay = calculateOptimalDataDisplay();
                const tableCapacity = getTableDisplayCapacity();
                
                console.log(`=== åˆ†é¡µå¤§å°æ”¹å˜åˆ†æ ===`);
                console.log(`å½“å‰è¡¨æ ¼æ•°æ®å±•ç¤ºåŒºåŸŸå®¹é‡: ${tableCapacity.maxRows} æ¡`);
                console.log(`å½“å‰ç•Œé¢æœ€ä½³æ˜¾ç¤ºé‡: ${optimalDisplay} æ¡`);
                console.log(`æ‚¨é€‰æ‹©çš„åˆ†é¡µå¤§å°: ${newPageSize} æ¡`);
                
                if (newPageSize > tableCapacity.maxRows) {
                    console.log(`âš ï¸ æ•°æ®å°†è¶…å‡ºæ˜¾ç¤ºåŒºåŸŸï¼Œå°†å¯ç”¨å†…éƒ¨æ»šåŠ¨æ¡`);
                    console.log(`è¶…å‡ºæ•°é‡: ${newPageSize - tableCapacity.maxRows} æ¡`);
                } else {
                    console.log(`âœ… æ•°æ®åœ¨æ˜¾ç¤ºåŒºåŸŸå†…ï¼Œæ— éœ€æ»šåŠ¨æ¡`);
                    console.log(`å‰©ä½™ç©ºé—´: ${tableCapacity.maxRows - newPageSize} æ¡`);
                }
                console.log(`================================`);
                
                // é‡æ–°åŠ è½½æ•°æ®
                console.log('è°ƒç”¨ loadScripts(1) é‡æ–°åŠ è½½æ•°æ®ï¼Œå½“å‰pageSize:', pageSize);
                console.log('å¼ºåˆ¶åˆ·æ–°ç¼“å­˜ï¼Œä½¿ç”¨æ–°çš„æ—¶é—´æˆ³');
                
                // å¼ºåˆ¶å»¶è¿Ÿä¸€ä¸‹ï¼Œç¡®ä¿pageSizeå˜é‡å·²ç»æ›´æ–°
                setTimeout(() => {
                    console.log('å»¶è¿Ÿåé‡æ–°æ£€æŸ¥pageSize:', pageSize);
                    loadScripts(1);
                }, 100);
            } else {
                console.log('åˆ†é¡µå¤§å°æœªå‘ç”Ÿå˜åŒ–ï¼Œè·³è¿‡é‡æ–°åŠ è½½');
            }
        }
        
        // é‡ç½®ä¸ºè‡ªåŠ¨åˆ†é¡µ
        function resetToAuto() {
            const autoPageSize = calculateOptimalPageSize();
            console.log('é‡ç½®ä¸ºè‡ªåŠ¨åˆ†é¡µ:', { autoPageSize });
            
            // ç¡®ä¿åˆ†é¡µå¤§å°åœ¨å¯ç”¨é€‰é¡¹ä¸­
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const availableSizes = Array.from(pageSizeSelect.options).map(opt => parseInt(opt.value));
            const closestSize = availableSizes.reduce((prev, curr) => 
                Math.abs(curr - autoPageSize) < Math.abs(prev - autoPageSize) ? curr : prev
            );
            
            console.log('å¯ç”¨çš„åˆ†é¡µå¤§å°:', availableSizes);
            console.log('è®¡ç®—çš„åˆ†é¡µå¤§å°:', closestSize);
            console.log('å¼ºåˆ¶è®¾ç½®ä¸º5');
            
            // å¼ºåˆ¶è®¾ç½®ä¸º5
            pageSizeSelect.value = '5';
            pageSize = 5;
            currentPage = 1;
            isAutoCalculated = true;
            loadScripts(1);
        }
    </script>
</body>
</html> 