<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MacOS VM 虚拟机管理平台 - 脚本管理</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
            .sidebar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        box-shadow: 2px 0 15px rgba(102, 126, 234, 0.3);
        min-height: 100vh;
        position: fixed;
        top: 0;
        left: 0;
        z-index: 1000;
        width: 280px;
        color: white;
    }
        
        .accordion-button:not(.collapsed) {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            border: none;
            box-shadow: none;
        }
        
        .accordion-button {
            background: transparent;
            color: white;
            border: none;
            box-shadow: none;
            font-weight: 600;
        }
        
        .accordion-button:hover {
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }
        
        .accordion-button:focus {
            background: rgba(255, 255, 255, 0.1);
            color: white;
            box-shadow: none;
        }
        
        .accordion-button::after {
            filter: invert(1);
        }
        
        .nav-link {
            color: rgba(255, 255, 255, 0.8);
            padding: 12px 20px;
            border-radius: 8px;
            margin: 4px 8px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .nav-link:hover {
            background: rgba(255, 255, 255, 0.15);
            color: white;
            transform: translateX(5px);
        }
        
        .nav-link.active {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        .accordion-item {
            background: transparent;
            border: none;
        }
        
        .accordion-body {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 0 8px;
        }
        
        .card {
            border: none;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-radius: 10px;
        }
        
        .card-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px 10px 0 0 !important;
            padding: 20px;
        }
        html, body { width: 100vw; overflow-x: hidden !important; }
        .col-md-9.col-lg-10 { width: calc(100vw - 280px); min-width: 0; margin: 0; height: calc(100vh - 80px); overflow-y: auto; overflow-x: hidden; }
        

        
        .table th {
            background-color: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            font-weight: 600;
            color: #495057;
        }
        
        .table td {
            vertical-align: middle;
        }
        
        .btn-group-sm .btn {
            margin-right: 2px;
        }
        
        /* 表格容器样式 - 确保滚动条显示在数据区域内部 */
        .table-responsive {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            background: white;
        }
        
        /* 自定义滚动条样式 */
        .table-responsive::-webkit-scrollbar {
            width: 8px;
        }
        
        .table-responsive::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        .table-responsive::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
        
        /* 确保表格容器有合适的高度和边框 */
        .table-container {
            position: relative;
            background: white;
            border-radius: 0.375rem;
            overflow: hidden;
        }
        
        /* 确保表格头部固定在顶部 */
        .table-responsive thead th {
            position: sticky;
            top: 0;
            background-color: #f8f9fa;
            z-index: 1;
        }
        
        /* 表格行样式优化 */
        .table-responsive tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* 侧边栏标题样式 */
        .sidebar-header {
            border-bottom: 2px solid rgba(255, 255, 255, 0.2);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 60px;
        }
        
        .brand-text {
            color: white;
            font-weight: 700;
            font-size: 1.2rem;
            letter-spacing: 0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }
        
        .sidebar-header h4 {
            margin-bottom: 5px !important;
        }
        
        .sidebar-header small {
            font-size: 0.85rem;
            opacity: 0.8;
        }

    </style>
</head>
<body>
    <!-- 顶部导航栏 -->
    <div class="navbar navbar-expand-lg navbar-light bg-white shadow-sm" style="position: fixed; top: 0; left: 280px; right: 0; z-index: 1000;">
        <div class="container-fluid">
            <span class="navbar-brand mb-0 h1">
                <i class="fas fa-code me-2"></i>虚拟机脚本管理
            </span>
            <div class="d-flex">
                <div class="dropdown me-3">
                    <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="langDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        语言
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="langDropdown">
                        <li><a class="dropdown-item" href="?lang=zh">中文</a></li>
                        <li><a class="dropdown-item" href="?lang=en">English</a></li>
                    </ul>
                </div>
                <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">登出</a>
            </div>
        </div>
    </div>
    
    <div class="container-fluid" style="margin-left: 280px; margin-top: 80px;">
        <div class="row">
            <!-- 左侧菜单 -->
            <nav class="col-md-3 col-lg-2 sidebar p-3">
                <div class="sidebar-header text-center mb-4">
                <h4 class="mb-0">
                                                <span class="brand-text">MacOS VM 虚拟机管理平台</span>
                </h4>
                
            </div>
                <div class="accordion" id="accordionMenu">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingVM">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseVM" aria-expanded="true" aria-controls="collapseVM">
                                虚拟机管理
                            </button>
                        </h2>
                        <div id="collapseVM" class="accordion-collapse collapse show" aria-labelledby="headingVM" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('clone_vm_page') }}" onclick="handleCloneClick()">虚拟机批量克隆</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('vm_management_page') }}" onclick="handleVMManagementClick()">虚拟机克隆列表</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('vm_info_page') }}" onclick="handleVMInfoClick()">虚拟机成品信息</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link active" href="{{ url_for('vm_script_page') }}" onclick="handleVMScriptClick()">虚拟机脚本管理</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingBoot">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseBoot" aria-expanded="false" aria-controls="collapseBoot">
                                登录引导管理
                            </button>
                        </h2>
                        <div id="collapseBoot" class="accordion-collapse collapse" aria-labelledby="headingBoot" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('wuma_page') }}" onclick="handleWumaClick()">虚拟机五码管理</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('mupan_page') }}" onclick="handleMupanClick()">虚拟机母盘管理</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('id_management_page') }}" onclick="handleIdManagementClick()">Apple ID管理</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingEncrypt">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEncrypt" aria-expanded="false" aria-controls="collapseEncrypt">
                                数据加密功能
                            </button>
                        </h2>
                        <div id="collapseEncrypt" class="accordion-collapse collapse" aria-labelledby="headingEncrypt" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('encrypt_code_page') }}" onclick="handleEncryptCodeClick()">代码加密</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('encrypt_wuma_page') }}" onclick="handleEncryptWumaClick()">五码加密</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('encrypt_id_page') }}" onclick="handleEncryptIdClick()">id加密</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingProxy">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseProxy" aria-expanded="false" aria-controls="collapseProxy">
                                代理ip配置
                            </button>
                        </h2>
                        <div id="collapseProxy" class="accordion-collapse collapse" aria-labelledby="headingProxy" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('proxy_assign_page') }}" onclick="handleProxyAssignClick()">代理ip分配</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="headingSoft">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSoft" aria-expanded="false" aria-controls="collapseSoft">
                                虚拟机软件管理
                            </button>
                        </h2>
                        <div id="collapseSoft" class="accordion-collapse collapse" aria-labelledby="headingSoft" data-bs-parent="#accordionMenu">
                            <div class="accordion-body p-0">
                                <ul class="nav flex-column">
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('soft_version_page') }}" onclick="handleSoftVersionClick()">版本查看</a>
                                    </li>
                                    <li class="nav-item">
                                        <a class="nav-link" href="{{ url_for('soft_env_page') }}" onclick="handleSoftEnvClick()">环境变量</a>
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </nav>
            
            <!-- 右侧内容区域 -->
            <div class="col-md-9 col-lg-10">
                <div class="card mt-0" style="margin-top:0;">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="mb-0">
                                <i class="fas fa-code me-2"></i>虚拟机脚本管理
                            </h4>
                            <div>
                                <button class="btn btn-success me-2" onclick="addScript()">
                                    <i class="fas fa-plus me-2"></i>添加脚本
                                </button>
                                <button class="btn btn-primary" onclick="refreshScripts()" title="刷新数据">
                                    <i class="fas fa-sync-alt me-2"></i>刷新数据
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-12">
                                <h5>脚本管理</h5>
                                <p class="text-muted">管理虚拟机相关的脚本文件，包括安装脚本、配置脚本、维护脚本等。</p>
                                
                                <!-- 脚本搜索区域 -->
                                <div class="row mb-3">
                                    <div class="col-md-6">
                                        <div class="input-group">
                                            <span class="input-group-text">
                                                <i class="fas fa-search"></i>
                                            </span>
                                            <input type="text" class="form-control" id="scriptSearchInput" 
                                                   placeholder="搜索脚本名称..." 
                                                   oninput="searchScripts()" 
                                                   onkeyup="if(event.key === 'Enter') searchScripts()">
                                            <button class="btn btn-outline-secondary" type="button" onclick="clearScriptSearch()" title="清空搜索">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="col-md-6 text-end">
                                        <span class="text-muted" id="searchResultInfo">
                                            共找到 <span id="searchResultCount">0</span> 个脚本
                                        </span>
                                    </div>
                                </div>
                                
                                <div class="table-container">
                                    <div class="table-responsive">
                                        <table class="table table-hover mb-0">
                                            <thead>
                                                <tr>
                                                    <th>脚本名称</th>
                                                    <th>脚本备注</th>
                                                    <th>大小</th>
                                                    <th>修改时间</th>
                                                    <th>操作</th>
                                                </tr>
                                            </thead>
                                            <tbody id="scriptTableBody">
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">
                                                        <i class="fas fa-spinner fa-spin me-2"></i>加载中...
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                                
                                <!-- 分页控件 -->
                                <div class="d-flex justify-content-between align-items-center mt-3">
                                    <div class="d-flex align-items-center">
                                        <div class="text-muted me-3">
                                            显示 <span id="startRecord">0</span> - <span id="endRecord">0</span> 条，共 <span id="totalRecords">0</span> 条记录
                                        </div>
                                        <div class="d-flex align-items-center">
                                            <label class="form-label mb-0 me-2">每页显示:</label>
                                            <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;" onchange="changePageSize()" oninput="console.log('分页大小选择器值变化:', this.value)">
                                                <option value="5">5</option>
                                                <option value="10">10</option>
                                                <option value="20">20</option>
                                                <option value="50">50</option>
                                                <option value="100">100</option>
                                            </select>
                                            <button class="btn btn-outline-secondary btn-sm ms-2" onclick="resetToAuto()" title="重置为自动分页">
                                                <i class="fas fa-magic"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <nav aria-label="脚本列表分页">
                                        <ul class="pagination pagination-sm mb-0" id="pagination">
                                            <!-- 分页按钮将在这里动态生成 -->
                                        </ul>
                                    </nav>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 编辑脚本弹窗 -->
    <div class="modal fade" id="editScriptModal" tabindex="-1" aria-labelledby="editScriptModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScriptModalLabel">编辑脚本</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3" id="scriptNameGroup" style="display: none;">
                        <label for="scriptName" class="form-label">脚本名称 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="scriptName" placeholder="请输入脚本名称（以.sh结尾，不能包含中文）" required>
                    </div>
                    <div class="mb-3">
                        <label for="scriptNote" class="form-label">脚本备注</label>
                        <textarea class="form-control" id="scriptNote" rows="3" placeholder="请输入脚本备注..."></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="scriptContent" class="form-label">脚本内容</label>
                        <textarea class="form-control" id="scriptContent" rows="8" placeholder="请输入脚本内容..." style="font-family: 'Courier New', monospace;"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="saveScriptBtn" onclick="saveScript()">保存</button>
                </div>
            </div>
        </div>
    </div>



    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 弹窗关闭时重置脚本名称输入框
        document.getElementById('editScriptModal').addEventListener('hidden.bs.modal', function () {
            document.getElementById('scriptNameGroup').style.display = 'none';
        });
        

        


        // 脚本名称输入验证 - 防止输入中文字符
        document.getElementById('scriptName').addEventListener('input', function(e) {
            const value = e.target.value;
            // 移除中文字符
            const filteredValue = value.replace(/[\u4e00-\u9fa5]/g, '');
            if (value !== filteredValue) {
                e.target.value = filteredValue;
                alert('脚本名称不能包含中文字符');
            }
        });

        // 菜单处理函数
        function handleCloneClick() {
            // 只设置当前链接为激活状态，不进行任何菜单操作
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleVMManagementClick() {
            // 只设置当前链接为激活状态，不进行任何菜单操作
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleVMInfoClick() {
            // 只设置当前链接为激活状态，允许Bootstrap默认行为关闭菜单
            const links = document.querySelectorAll('#collapseVM .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
            
            // 不阻止默认行为，允许菜单正常关闭
        }

        function handleVMScriptClick() {
            console.log('🔄 handleVMScriptClick() 被调用 (vm_script.html)');
            console.log('📍 当前事件目标:', event.target);
            console.log('📍 当前事件目标文本:', event.target.textContent);
            
            // 只设置当前链接为激活状态，完全不干预Bootstrap accordion行为
            const links = document.querySelectorAll('#collapseVM .nav-link');
            console.log('📍 找到的链接数量:', links.length);
            links.forEach(link => {
                console.log('📍 移除链接激活状态:', link.textContent);
                link.classList.remove('active');
            });
            event.target.classList.add('active');
            console.log('✅ 设置当前链接为激活状态:', event.target.textContent);
            
            // 完全不干预菜单状态，让Bootstrap自己处理
            console.log('📝 不干预菜单状态，让Bootstrap自己处理展开/关闭');
            
            // 确保不阻止事件传播
            console.log('📝 允许事件继续传播到Bootstrap');
        }

        function handleWumaClick() {
            // 不展开任何菜单，只设置当前链接为激活状态
            const links = document.querySelectorAll('#collapseBoot .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleMupanClick() {
            // 不展开任何菜单，只设置当前链接为激活状态
            const links = document.querySelectorAll('#collapseBoot .nav-link');
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        function handleEncryptCodeClick() {
            ensureMenuExpanded('collapseEncrypt', 'collapseEncrypt');
        }

        function handleEncryptWumaClick() {
            ensureMenuExpanded('collapseEncrypt', 'collapseEncrypt');
        }

        function handleEncryptIdClick() {
            ensureMenuExpanded('collapseEncrypt', 'collapseEncrypt');
        }

        function handleProxyAssignClick() {
            ensureMenuExpanded('collapseProxy', 'collapseProxy');
        }

        function handleSoftVersionClick() {
            ensureMenuExpanded('collapseSoft', 'collapseSoft');
        }

        function handleSoftEnvClick() {
            ensureMenuExpanded('collapseSoft', 'collapseSoft');
        }

        // 通用函数：确保菜单展开并设置链接激活状态
        function ensureMenuExpanded(menuId, linkContainerId) {
            const menuCollapse = document.getElementById(menuId);
            const menuButton = document.getElementById(menuId.replace('collapse', 'heading')).querySelector('.accordion-button');
            
            if (menuCollapse && menuButton) {
                // 移除折叠类，添加展开类
                menuCollapse.classList.remove('collapse');
                menuCollapse.classList.add('show');
                menuButton.setAttribute('aria-expanded', 'true');
                menuButton.classList.remove('collapsed');
            }
            
            // 设置当前链接为激活状态
            const links = document.querySelectorAll(`#${linkContainerId} .nav-link`);
            links.forEach(link => link.classList.remove('active'));
            event.target.classList.add('active');
        }

        // 分页相关变量
        let currentPage = 1;
        let pageSize = 5; // 修改默认分页大小为5
        let totalScripts = []; // 存储所有脚本数据
        let totalPages = 0;
        let isAutoCalculated = true; // 标记是否为自动计算的分页大小
        
        // 页面加载时获取脚本列表
        document.addEventListener('DOMContentLoaded', function() {
            // 确保虚拟机管理菜单保持展开状态
            setTimeout(() => {
                console.log('第一次尝试展开虚拟机管理菜单...');
                const menuCollapse = document.getElementById('collapseVM');
                const menuButton = document.getElementById('headingVM').querySelector('.accordion-button');
                console.log('菜单容器:', menuCollapse);
                console.log('菜单按钮:', menuButton);
                if (menuCollapse && menuButton) {
                    console.log('展开前的菜单状态:', menuCollapse.className);
                    console.log('展开前的按钮状态:', menuButton.className);
                    menuCollapse.classList.remove('collapse');
                    menuCollapse.classList.add('show');
                    menuButton.setAttribute('aria-expanded', 'true');
                    menuButton.classList.remove('collapsed');
                    console.log('展开后的菜单状态:', menuCollapse.className);
                    console.log('展开后的按钮状态:', menuButton.className);
                } else {
                    console.error('找不到菜单元素');
                }
            }, 100);
            
            // 再次确保菜单展开（双重保险）
            setTimeout(() => {
                console.log('第二次尝试展开虚拟机管理菜单...');
                const menuCollapse = document.getElementById('collapseVM');
                const menuButton = document.getElementById('headingVM').querySelector('.accordion-button');
                if (menuCollapse && menuButton) {
                    console.log('第二次展开前的菜单状态:', menuCollapse.className);
                    console.log('第二次展开前的按钮状态:', menuButton.className);
                    menuCollapse.classList.remove('collapse');
                    menuCollapse.classList.add('show');
                    menuButton.setAttribute('aria-expanded', 'true');
                    menuButton.classList.remove('collapsed');
                    console.log('第二次展开后的菜单状态:', menuCollapse.className);
                    console.log('第二次展开后的按钮状态:', menuButton.className);
                }
            }, 500);
            
            // 允许虚拟机管理菜单正常关闭
            const vmCollapse = document.getElementById('collapseVM');
            if (vmCollapse) {
                console.log('📍 允许"虚拟机管理"菜单正常关闭');
                vmCollapse.addEventListener('hidden.bs.collapse', function() {
                    console.log('🔄 "虚拟机管理"菜单被关闭');
                    console.log('📍 允许菜单正常关闭，不重新展开');
                });
            }
            
            // 允许虚拟机管理菜单正常折叠/展开
            const vmButton = document.getElementById('headingVM').querySelector('.accordion-button');
            if (vmButton) {
                console.log('📍 允许"虚拟机管理"菜单正常折叠/展开');
                // 移除任何可能阻止折叠的事件监听器
                vmButton.addEventListener('click', function(e) {
                    console.log('🔄 "虚拟机管理"菜单按钮被点击');
                    console.log('📍 允许Bootstrap正常处理折叠/展开');
                });
            }
            
            // 智能计算最佳数据显示量
            const optimalDataDisplay = calculateOptimalDataDisplay();
            console.log('页面加载时计算的最佳数据显示量:', optimalDataDisplay);
            
            // 确保分页大小在可用选项中，优先选择能充分利用空间的大小
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const availableSizes = Array.from(pageSizeSelect.options).map(opt => parseInt(opt.value));
            
            // 选择最接近但不超过最佳显示量的分页大小
            let selectedSize = 5; // 默认值
            for (let size of availableSizes) {
                if (size <= optimalDataDisplay && size > selectedSize) {
                    selectedSize = size;
                }
            }
            
            console.log('可用的分页大小:', availableSizes);
            console.log('最佳数据显示量:', optimalDataDisplay);
            console.log('选择的分页大小:', selectedSize);
            
            pageSizeSelect.value = selectedSize.toString();
            pageSize = selectedSize;
            
            // 自动模式下，根据分页大小智能决定是否显示滚动条
            const tableContainer = document.querySelector('.table-responsive');
            const mainContent = document.querySelector('.col-md-9.col-lg-10');
            
            // 使用智能判断是否需要滚动条
            const needsScrollbar = shouldEnableScrollbar(selectedSize);
            setScrollbarState(needsScrollbar, `页面初始化，分页大小: ${selectedSize}`);
            
            // 页面加载完成后调整表格容器高度
            setTimeout(() => {
                adjustTableContainerHeight();
            }, 100);
            
            loadScripts(1);
            
            // 监听窗口大小变化，自动调整分页大小
            let resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    // 只有在自动模式下才自动调整
                    if (isAutoCalculated) {
                        const newPageSize = calculateOptimalPageSize();
                        if (newPageSize !== pageSize) {
                            document.getElementById('pageSizeSelect').value = newPageSize.toString();
                            pageSize = newPageSize;
                            currentPage = 1; // 重置到第一页
                            
                            // 自动调整时，根据分页大小智能决定是否显示滚动条
                            const tableContainer = document.querySelector('.table-responsive');
                            const mainContent = document.querySelector('.col-md-9.col-lg-10');
                            
                            // 使用智能判断是否需要滚动条
                            const needsScrollbar = shouldEnableScrollbar(newPageSize);
                            setScrollbarState(needsScrollbar, `窗口大小变化，分页大小: ${newPageSize}`);
                            
                            // 监控表格容量变化
                            setTimeout(() => {
                                monitorTableCapacity();
                            }, 100);
                            
                            loadScripts(1);
                        }
                    }
                }, 300);
            });
        });
        
        // 全局变量存储所有脚本数据
        let allScripts = [];
        let filteredScripts = [];
        let isSearchMode = false;
        
        // 搜索脚本
        function searchScripts() {
            const searchInput = document.getElementById('scriptSearchInput');
            const searchTerm = searchInput.value.trim().toLowerCase();
            const searchResultCount = document.getElementById('searchResultCount');
            const searchResultInfo = document.getElementById('searchResultInfo');
            
            if (searchTerm === '') {
                // 清空搜索，显示所有脚本
                isSearchMode = false;
                searchResultInfo.style.display = 'none';
                // 清空所有脚本数据，重新加载分页数据
                allScripts = [];
                filteredScripts = [];
                loadScripts(1);
                return;
            }
            
            // 总是加载所有脚本数据进行搜索
            loadAllScriptsForSearch(searchTerm);
        }
        
        // 加载所有脚本数据用于搜索
        function loadAllScriptsForSearch(searchTerm) {
            console.log('加载所有脚本数据用于搜索...');
            
            fetch('/api/scripts/all')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // 存储所有脚本数据
                        allScripts = data.scripts;
                        console.log(`成功加载 ${allScripts.length} 个脚本用于搜索`);
                        
                        // 执行搜索
                        isSearchMode = true;
                        filteredScripts = allScripts.filter(script => 
                            script.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                            (script.note && script.note.toLowerCase().includes(searchTerm.toLowerCase()))
                        );
                        
                        // 更新搜索结果信息
                        const searchResultCount = document.getElementById('searchResultCount');
                        const searchResultInfo = document.getElementById('searchResultInfo');
                        searchResultCount.textContent = filteredScripts.length;
                        searchResultInfo.style.display = 'inline';
                        
                        // 更新表格显示搜索结果
                        updateScriptTableWithSearch(filteredScripts);
                    } else {
                        console.error('加载所有脚本失败:', data.message);
                        alert('加载脚本数据失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('加载所有脚本出错:', error);
                    alert('加载脚本数据出错: ' + error.message);
                });
        }
        
        // 清空搜索
        function clearScriptSearch() {
            const searchInput = document.getElementById('scriptSearchInput');
            const searchResultInfo = document.getElementById('searchResultInfo');
            
            searchInput.value = '';
            isSearchMode = false;
            searchResultInfo.style.display = 'none';
            
            // 清空所有脚本数据，重新加载分页数据
            allScripts = [];
            filteredScripts = [];
            
            // 重新加载分页脚本
            loadScripts(1);
        }
        

        
        // 更新搜索结果的表格显示
        function updateScriptTableWithSearch(scripts) {
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '';
            
            if (scripts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">未找到匹配的脚本</td></tr>';
                // 清空分页信息
                document.getElementById('startRecord').textContent = '0';
                document.getElementById('endRecord').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                return;
            }
            
            // 计算分页
            const startIndex = 0;
            const endIndex = Math.min(pageSize, scripts.length);
            
            // 更新记录显示信息
            document.getElementById('startRecord').textContent = scripts.length > 0 ? startIndex + 1 : 0;
            document.getElementById('endRecord').textContent = endIndex;
            document.getElementById('totalRecords').textContent = scripts.length;
            
            // 显示搜索结果
            scripts.slice(startIndex, endIndex).forEach(script => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>
                        <strong>${script.name}</strong>
                    </td>
                    <td>${script.note || '<span class="text-muted">-</span>'}</td>
                    <td>${script.size}</td>
                    <td>${script.modified_time}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary btn-sm" onclick="editScript('${script.name}')" title="编辑脚本" style="cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger btn-sm" onclick="deleteScript('${script.name}')" title="删除脚本" style="cursor: pointer;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function loadScripts(page = 1) {
            console.log(`加载脚本列表... (第 ${page} 页，每页 ${pageSize} 条)`);
            console.log(`全局pageSize变量值: ${pageSize}`);
            console.log(`请求URL: /api/scripts?page=${page}&page_size=${pageSize}`);
            console.log(`当前分页选择器值: ${document.getElementById('pageSizeSelect').value}`);
            console.log(`分页选择器是否与全局变量一致: ${document.getElementById('pageSizeSelect').value == pageSize}`);
            
            // 显示加载状态
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</td></tr>';
            
            const requestUrl = `/api/scripts?page=${page}&page_size=${pageSize}&_t=${Date.now()}`;
            console.log(`发送请求: ${requestUrl}`);
            fetch(requestUrl)
                .then(response => {
                    console.log('API响应状态:', response.status);
                    return response.json();
                })
                .then(data => {
                    console.log('API响应数据:', data);
                    if (data.success) {
                        console.log('更新表格数据:', {
                            page: page,
                            pagination: data.pagination,
                            scriptsCount: data.scripts.length
                        });
                        
                        // 存储分页脚本数据用于搜索（如果还没有加载所有数据且不在搜索模式）
                        // 注意：这里只存储当前分页数据，搜索时会加载所有数据
                        if (allScripts.length === 0 && !isSearchMode) {
                            allScripts = data.scripts;
                            filteredScripts = [...allScripts];
                        }
                        
                        // 存储分页信息
                        totalPages = data.pagination.total_pages;
                        currentPage = page;
                        
                        console.log('分页数据存储:', {
                            totalPages: totalPages,
                            currentPage: currentPage,
                            scriptsCount: data.scripts.length,
                            pagination: data.pagination
                        });
                        
                        // 如果当前在搜索模式，更新搜索结果
                        if (isSearchMode) {
                            const searchInput = document.getElementById('scriptSearchInput');
                            if (searchInput.value.trim() !== '') {
                                searchScripts();
                                return;
                            }
                        }
                        
                        updateScriptTableWithPagination(page, data.pagination, data.scripts);
                        
                        // 数据加载完成后，重新检查滚动条状态
                        setTimeout(() => {
                            // 先禁用滚动条，让内容自然展开
                            const tableContainer = document.querySelector('.table-responsive');
                            const mainContent = document.querySelector('.col-md-9.col-lg-10');
                            
                            tableContainer.style.overflow = 'visible';
                            tableContainer.style.maxHeight = 'none';
                            if (mainContent) mainContent.style.overflow = 'visible';
                            
                            // 等待内容完全展开后再判断
                            setTimeout(() => {
                                // 获取当前表格数据展示区域的容量
                                const tableCapacity = getTableDisplayCapacity();
                                console.log('数据加载完成后的表格容量分析:', tableCapacity);
                                
                                const needsScrollbar = shouldEnableScrollbar(pageSize);
                                setScrollbarState(needsScrollbar, '数据加载完成后');
                                
                                // 显示容量分析结果
                                console.log(`当前表格最多可显示 ${tableCapacity.maxRows} 条数据，分页大小为 ${pageSize} 条`);
                                if (pageSize > tableCapacity.maxRows) {
                                    console.log(`数据超出显示区域，启用内部滚动条`);
                                } else {
                                    console.log(`数据在显示区域内，无需滚动条`);
                                }
                            }, 50);
                        }, 100);
                    } else {
                        console.error('加载脚本失败:', data.message);
                        showError('加载脚本失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('加载脚本出错:', error);
                    showError('加载脚本出错: ' + error.message);
                });
        }
        
        function updateScriptTableWithPagination(page, pagination = null, scripts = []) {
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '';
            
            console.log('更新脚本表格:', { page, pagination, scriptsCount: scripts.length });
            
            if (!pagination || pagination.total_count === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted">暂无脚本文件</td></tr>';
                // 清空分页信息
                document.getElementById('startRecord').textContent = '0';
                document.getElementById('endRecord').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                document.getElementById('pagination').innerHTML = '';
                return;
            }
            
            // 更新记录显示信息 - 使用实际显示的记录数量
            const actualStart = pagination.start_index + 1;
            const actualEnd = pagination.start_index + scripts.length;
            document.getElementById('startRecord').textContent = actualStart;
            document.getElementById('endRecord').textContent = actualEnd;
            document.getElementById('totalRecords').textContent = pagination.total_count;
            
            console.log('分页显示信息更新:', {
                actualStart: actualStart,
                actualEnd: actualEnd,
                scriptsLength: scripts.length,
                paginationStart: pagination.start_index,
                paginationEnd: pagination.end_index,
                totalCount: pagination.total_count
            });
            
            console.log('更新分页信息:', {
                start: pagination.start_index + 1,
                end: pagination.end_index,
                total: pagination.total_count,
                pageSize: pageSize
            });
            
            // 直接使用传入的脚本数据
            scripts.forEach(script => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td><strong>${script.name}</strong></td>
                    <td>${script.note || '<span class="text-muted">无备注</span>'}</td>
                    <td>${script.size}</td>
                    <td>${script.modified_time}</td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-outline-primary" title="编辑脚本" onclick="editScript('${script.name}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline-danger" title="删除脚本" onclick="deleteScript('${script.name}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // 更新分页控件
            updatePagination(page);
        }
        
        function refreshScripts() {
            console.log('刷新脚本数据...');
            
            // 显示加载状态
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>刷新中...</td></tr>';
            
            // 重置分页信息
            document.getElementById('startRecord').textContent = '0';
            document.getElementById('endRecord').textContent = '0';
            document.getElementById('totalRecords').textContent = '0';
            
            // 清空分页控件
            document.getElementById('pagination').innerHTML = '';
            
            // 清空搜索状态
            isSearchMode = false;
            allScripts = [];
            filteredScripts = [];
            const searchInput = document.getElementById('scriptSearchInput');
            if (searchInput) {
                searchInput.value = '';
            }
            const searchResultInfo = document.getElementById('searchResultInfo');
            if (searchResultInfo) {
                searchResultInfo.style.display = 'none';
            }
            
            // 异步重新加载当前页数据
            loadScripts(currentPage);
        }
        
        function addScript() {
            console.log('添加脚本');
            
            // 清空表单
            document.getElementById('scriptName').value = '';
            document.getElementById('scriptNote').value = '';
            document.getElementById('scriptContent').value = '';
            
            // 显示脚本名称输入框
            document.getElementById('scriptNameGroup').style.display = 'block';
            
            // 更新弹窗标题和按钮文本
            document.getElementById('editScriptModalLabel').textContent = '脚本新增';
            document.getElementById('saveScriptBtn').textContent = '新增';
            
            // 显示弹窗
            const modal = new bootstrap.Modal(document.getElementById('editScriptModal'));
            modal.show();
        }
        
        let currentScriptName = '';
        let currentVMs = [];
        
        function deleteScript(scriptName) {
            if (confirm(`确定要删除脚本 "${scriptName}" 吗？\n\n此操作不可恢复！`)) {
                fetch('/api/script/delete', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_name: scriptName
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`脚本 "${scriptName}" 删除成功！`);
                        // 刷新脚本列表
                        refreshScripts();
                    } else {
                        alert(`删除失败: ${data.message}`);
                    }
                })
                .catch(error => {
                    console.error('删除脚本出错:', error);
                    alert('删除脚本出错: ' + error.message);
                });
            }
        }
        
        function editScript(scriptName) {
            console.log('编辑脚本:', scriptName);
            currentScriptName = scriptName;
            
            // 获取脚本内容
            fetch(`/api/script/content/${scriptName}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('scriptContent').value = data.content;
                        document.getElementById('scriptNote').value = data.note || '';
                        
                        // 隐藏脚本名称输入框
                        document.getElementById('scriptNameGroup').style.display = 'none';
                        
                        // 更新弹窗标题和按钮文本
                        document.getElementById('editScriptModalLabel').textContent = '编辑脚本';
                        document.getElementById('saveScriptBtn').textContent = '保存';
                        
                        // 显示弹窗
                        const modal = new bootstrap.Modal(document.getElementById('editScriptModal'));
                        modal.show();
                    } else {
                        alert('获取脚本内容失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('获取脚本内容出错:', error);
                    alert('获取脚本内容出错: ' + error.message);
                });
        }
        
        function saveScript() {
            const content = document.getElementById('scriptContent').value;
            const note = document.getElementById('scriptNote').value;
            const modalTitle = document.getElementById('editScriptModalLabel').textContent;
            
            if (!content.trim()) {
                alert('脚本内容不能为空');
                return;
            }
            
            // 判断是新增还是编辑
            if (modalTitle === '脚本新增') {
                // 新增脚本
                const scriptName = document.getElementById('scriptName').value.trim();
                if (!scriptName) {
                    alert('脚本名称为必填项，请输入脚本名称');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                // 检查是否包含中文字符
                if (/[\u4e00-\u9fa5]/.test(scriptName)) {
                    alert('脚本名称不能包含中文字符');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                // 检查文件名格式
                if (!scriptName.endsWith('.sh')) {
                    alert('脚本文件名必须以.sh结尾');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                // 检查文件名是否只包含合法字符（字母、数字、下划线、连字符、点）
                if (!/^[a-zA-Z0-9_.-]+\.sh$/.test(scriptName)) {
                    alert('脚本名称只能包含字母、数字、下划线、连字符和点，且必须以.sh结尾');
                    document.getElementById('scriptName').focus();
                    return;
                }
                
                fetch('/api/script/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_name: scriptName,
                        content: content,
                        note: note
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('脚本新增成功');
                        // 关闭弹窗
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editScriptModal'));
                        modal.hide();
                        // 刷新脚本列表
                        loadScripts(currentPage);
                    } else {
                        alert('新增失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('新增脚本出错:', error);
                    alert('新增脚本出错: ' + error.message);
                });
            } else {
                // 编辑脚本
                fetch('/api/script/edit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        script_name: currentScriptName,
                        content: content,
                        note: note
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert('脚本保存成功');
                        // 关闭弹窗
                        const modal = bootstrap.Modal.getInstance(document.getElementById('editScriptModal'));
                        modal.hide();
                        // 刷新脚本列表
                        loadScripts(currentPage);
                    } else {
                        alert('保存失败: ' + data.message);
                    }
                })
                .catch(error => {
                    console.error('保存脚本出错:', error);
                    alert('保存脚本出错: ' + error.message);
                });
            }
        }
        

        

        

        

        

        

        

        

        
        function updateVMList(vms, trustedVMs = []) {
            const vmList = document.getElementById('vmList');
            vmList.innerHTML = '';
            
            if (vms.length === 0) {
                vmList.innerHTML = `
                    <div class="text-center text-muted py-3">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        没有可用的虚拟机
                    </div>
                `;
                return;
            }
            
            // 创建互信虚拟机组
            if (trustedVMs.length > 0) {
                const trustedGroup = document.createElement('div');
                trustedGroup.className = 'mb-3';
                trustedGroup.innerHTML = `
                    <h6 class="text-success mb-2">
                        <i class="fas fa-check-circle me-2"></i>SSH互信虚拟机 (${trustedVMs.length})
                    </h6>
                `;
                vmList.appendChild(trustedGroup);
                
                trustedVMs.forEach(vm => {
                    const vmItem = document.createElement('div');
                    vmItem.className = 'form-check mb-2 ms-3';
                    vmItem.innerHTML = `
                        <input class="form-check-input vm-checkbox trusted-vm" type="checkbox" value="${vm.name}" id="vm_${vm.name}" onchange="updateSelectedCount()">
                        <label class="form-check-label" for="vm_${vm.name}">
                            <strong>${vm.name}</strong> 
                            <small class="text-muted">(${vm.ip})</small>
                            <span class="badge bg-success ms-2">
                                <i class="fas fa-shield-alt me-1"></i>已互信
                            </span>
                        </label>
                    `;
                    trustedGroup.appendChild(vmItem);
                });
            }
            
            // 创建部分在线虚拟机组
            const partialVMs = vms.filter(vm => !trustedVMs.some(tvm => tvm.name === vm.name));
            if (partialVMs.length > 0) {
                const partialGroup = document.createElement('div');
                partialGroup.className = 'mb-3';
                partialGroup.innerHTML = `
                    <h6 class="text-warning mb-2">
                        <i class="fas fa-exclamation-triangle me-2"></i>部分在线虚拟机 (${partialVMs.length})
                        <small class="text-muted">- 端口开放但未互信，可能无法发送脚本</small>
                    </h6>
                `;
                vmList.appendChild(partialGroup);
                
                partialVMs.forEach(vm => {
                    const vmItem = document.createElement('div');
                    vmItem.className = 'form-check mb-2 ms-3';
                    vmItem.innerHTML = `
                        <input class="form-check-input vm-checkbox partial-vm" type="checkbox" value="${vm.name}" id="vm_${vm.name}" onchange="updateSelectedCount()">
                        <label class="form-check-label" for="vm_${vm.name}">
                            <strong>${vm.name}</strong> 
                            <small class="text-muted">(${vm.ip})</small>
                            <span class="badge bg-warning ms-2">
                                <i class="fas fa-exclamation-triangle me-1"></i>未互信
                            </span>
                        </label>
                    `;
                    partialGroup.appendChild(vmItem);
                });
            }
        }
        
        function selectAllVMs() {
            document.querySelectorAll('.vm-checkbox').forEach(checkbox => {
                checkbox.checked = true;
            });
            updateSelectedCount();
        }
        
        function selectAllTrustedVMs() {
            // 只选择SSH互信的虚拟机
            document.querySelectorAll('.vm-checkbox.trusted-vm').forEach(checkbox => {
                checkbox.checked = true;
            });
            // 取消选择部分在线的虚拟机
            document.querySelectorAll('.vm-checkbox.partial-vm').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }
        
        function updateSelectedCount() {
            const selectedCount = document.querySelectorAll('.vm-checkbox:checked').length;
            document.getElementById('selectedCount').textContent = selectedCount;
        }
        
        function deselectAllVMs() {
            document.querySelectorAll('.vm-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            updateSelectedCount();
        }
        
        function confirmSendScript() {
            const selectedVMs = Array.from(document.querySelectorAll('.vm-checkbox:checked')).map(cb => cb.value);
            const selectedTrustedVMs = Array.from(document.querySelectorAll('.vm-checkbox.trusted-vm:checked')).map(cb => cb.value);
            const selectedPartialVMs = Array.from(document.querySelectorAll('.vm-checkbox.partial-vm:checked')).map(cb => cb.value);
            
            if (selectedVMs.length === 0) {
                alert('请选择至少一个虚拟机');
                return;
            }
            
            // 检查是否选择了未互信的虚拟机
            if (selectedPartialVMs.length > 0) {
                const warningMessage = `⚠️ 警告：您选择了 ${selectedPartialVMs.length} 个未互信的虚拟机。\n\n这些虚拟机可能无法成功接收脚本。\n\n建议只选择SSH互信的虚拟机以确保脚本发送成功。\n\n是否继续发送？`;
                if (!confirm(warningMessage)) {
                    return;
                }
            }
            
            const confirmMessage = `确定要发送脚本 ${currentScriptName} 到 ${selectedVMs.length} 个虚拟机吗？\n\n` +
                `• SSH互信虚拟机：${selectedTrustedVMs.length} 个\n` +
                `• 部分在线虚拟机：${selectedPartialVMs.length} 个`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            fetch('/api/script/send', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    script_name: currentScriptName,
                    vm_names: selectedVMs
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    let message = '脚本发送完成:\n\n';
                    let successCount = 0;
                    let failCount = 0;
                    
                    data.results.forEach(result => {
                        const status = result.status === 'success' ? '✅' : '❌';
                        const statusText = result.status === 'success' ? '成功' : '失败';
                        message += `${status} ${result.vm_name} (${result.ip}): ${statusText}\n`;
                        message += `   原因: ${result.message}\n\n`;
                        
                        if (result.status === 'success') {
                            successCount++;
                        } else {
                            failCount++;
                        }
                    });
                    
                    message += `\n总结:\n`;
                    message += `• 成功: ${successCount} 个虚拟机\n`;
                    message += `• 失败: ${failCount} 个虚拟机\n`;
                    message += `• 总计: ${data.results.length} 个虚拟机`;
                    
                    alert(message);
                    
                    // 关闭弹窗
                    const modal = bootstrap.Modal.getInstance(document.getElementById('sendScriptModal'));
                    modal.hide();
                } else {
                    alert('发送失败: ' + data.message);
                }
            })
            .catch(error => {
                console.error('发送脚本出错:', error);
                alert('发送脚本出错: ' + error.message);
            });
        }
        
        function showError(message) {
            const tbody = document.getElementById('scriptTableBody');
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>${message}
            </td></tr>`;
        }
        
        // 计算最佳分页大小
        function calculateOptimalPageSize() {
            const windowHeight = window.innerHeight;
            const availableHeight = windowHeight - 300; // 减去头部、导航等高度
            const rowHeight = 60; // 每行大约高度
            const optimalRows = Math.floor(availableHeight / rowHeight);
            
            // 确保在合理范围内，默认返回5
            if (optimalRows < 5) return 5;
            if (optimalRows > 50) return 50;
            return Math.max(5, Math.min(50, optimalRows));
        }
        
        // 智能计算当前界面能显示的最佳数据量
        function calculateOptimalDataDisplay() {
            // 获取当前表格数据展示区域的容量
            const tableCapacity = getTableDisplayCapacity();
            const maxVisibleRows = tableCapacity.maxRows;
            
            // 考虑分页控件的空间，预留一些空间给分页
            const optimalRows = Math.max(5, maxVisibleRows - 1);
            
            // 确保不超过可用选项的最大值
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const availableSizes = Array.from(pageSizeSelect.options).map(opt => parseInt(opt.value));
            const maxAvailableSize = Math.max(...availableSizes);
            
            const finalOptimalRows = Math.min(optimalRows, maxAvailableSize);
            
            console.log('智能计算最佳数据显示量:', {
                tableCapacity: tableCapacity,
                maxVisibleRows: maxVisibleRows,
                optimalRows: optimalRows,
                maxAvailableSize: maxAvailableSize,
                finalOptimalRows: finalOptimalRows
            });
            
            return finalOptimalRows;
        }
        
        // 计算当前界面能显示的最大行数
        function calculateMaxVisibleRows() {
            // 获取页面可用高度
            const windowHeight = window.innerHeight;
            
            // 估算其他元素占用的高度
            const headerHeight = 200; // 头部区域
            const footerHeight = 100; // 底部区域
            const paginationHeight = 50; // 分页控件
            const tableHeaderHeight = 50; // 表格头部
            const paddingHeight = 40; // 各种间距
            
            // 计算表格容器的可用高度
            const availableHeight = windowHeight - headerHeight - footerHeight - paginationHeight - tableHeaderHeight - paddingHeight;
            const rowHeight = 60; // 预估每行高度
            const maxRows = Math.floor(availableHeight / rowHeight);
            
            console.log('计算当前界面能显示的最大行数:', {
                windowHeight: windowHeight,
                availableHeight: availableHeight,
                rowHeight: rowHeight,
                maxRows: maxRows,
                headerHeight: headerHeight,
                footerHeight: footerHeight,
                paginationHeight: paginationHeight,
                tableHeaderHeight: tableHeaderHeight,
                paddingHeight: paddingHeight
            });
            
            return Math.max(1, maxRows); // 至少显示1行
        }
        
        // 判断是否需要启用滚动条
        function shouldEnableScrollbar(pageSize) {
            // 获取当前表格数据展示区域的容量
            const tableCapacity = getTableDisplayCapacity();
            const maxVisibleRows = tableCapacity.maxRows;
            
            // 减少容错空间，更充分地利用可用空间
            const adjustedMaxRows = maxVisibleRows + 1; // 只增加1行的容错空间
            
            // 只有当明显超出时才启用滚动条
            const needsScrollbar = pageSize > adjustedMaxRows && (pageSize - adjustedMaxRows) >= 1;
            
            console.log('判断是否需要启用滚动条:', {
                pageSize: pageSize,
                maxVisibleRows: maxVisibleRows,
                adjustedMaxRows: adjustedMaxRows,
                needsScrollbar: needsScrollbar,
                difference: pageSize - adjustedMaxRows,
                tableCapacity: tableCapacity
            });
            
            // 在控制台显示详细的空间使用信息
            if (pageSize === 10 || pageSize === 20) {
                console.log(`=== 分页大小为${pageSize}时的详细分析 ===`);
                console.log('当前表格数据展示区域容量:', tableCapacity);
                console.log('当前界面能显示的最大行数:', maxVisibleRows);
                console.log('调整后的最大行数（含容错空间）:', adjustedMaxRows);
                console.log('是否需要滚动条:', needsScrollbar);
                console.log('超出调整后最大行数的数量:', pageSize - adjustedMaxRows);
                console.log('================================');
            }
            
            return needsScrollbar;
        }
        
        // 统一设置滚动条状态
        function setScrollbarState(needsScrollbar, context = '') {
            const tableContainer = document.querySelector('.table-responsive');
            const mainContent = document.querySelector('.col-md-9.col-lg-10');
            
            if (needsScrollbar) {
                // 需要滚动条时，启用滚动 - 滚动条显示在表格数据区域内部
                tableContainer.style.overflow = 'auto';
                
                // 调整表格容器高度以优化滚动条显示
                adjustTableContainerHeight();
                
                // 确保外层容器不显示滚动条，让滚动条只显示在表格区域
                if (mainContent) {
                    mainContent.style.overflow = 'hidden';
                }
                
                // 确保表格头部固定在顶部
                const thead = tableContainer.querySelector('thead');
                if (thead) {
                    thead.style.position = 'sticky';
                    thead.style.top = '0';
                    thead.style.zIndex = '1';
                }
                
                console.log(`启用滚动条 (${context}) - 滚动条显示在表格数据区域内部`);
            } else {
                // 不需要滚动条时，禁用滚动
                tableContainer.style.overflow = 'visible';
                tableContainer.style.maxHeight = 'none';
                tableContainer.style.height = 'auto';
                
                if (mainContent) {
                    mainContent.style.overflow = 'visible';
                }
                
                // 恢复表格头部样式
                const thead = tableContainer.querySelector('thead');
                if (thead) {
                    thead.style.position = '';
                    thead.style.top = '';
                    thead.style.zIndex = '';
                }
                
                console.log(`禁用滚动条 (${context})`);
            }
        }
        
        // 动态测量实际可用空间
        function measureActualAvailableSpace() {
            const tableContainer = document.querySelector('.table-responsive');
            const mainContent = document.querySelector('.col-md-9.col-lg-10');
            
            if (!tableContainer || !mainContent) {
                console.log('无法找到表格容器，使用估算值');
                return calculateMaxVisibleRows();
            }
            
            // 临时设置容器为可见状态以测量实际高度
            const originalOverflow = tableContainer.style.overflow;
            const originalMaxHeight = tableContainer.style.maxHeight;
            
            tableContainer.style.overflow = 'visible';
            tableContainer.style.maxHeight = 'none';
            
            // 获取实际可用高度
            const containerRect = tableContainer.getBoundingClientRect();
            const mainContentRect = mainContent.getBoundingClientRect();
            
            // 计算实际可用高度 - 更精确的计算
            const distanceToBottom = window.innerHeight - containerRect.top;
            const mainContentAvailable = mainContentRect.height - 60; // 进一步减少边距
            
            // 使用更精确的值，充分利用空间
            const availableHeight = Math.max(distanceToBottom - 20, mainContentAvailable);
            
            const rowHeight = 55; // 每行高度
            const maxRows = Math.floor(availableHeight / rowHeight);
            
            // 恢复原始状态
            tableContainer.style.overflow = originalOverflow;
            tableContainer.style.maxHeight = originalMaxHeight;
            
            console.log('动态测量实际可用空间:', {
                containerTop: containerRect.top,
                distanceToBottom: distanceToBottom,
                mainContentHeight: mainContentRect.height,
                mainContentAvailable: mainContentAvailable,
                availableHeight: availableHeight,
                maxRows: maxRows,
                windowHeight: window.innerHeight
            });
            
            return Math.max(1, maxRows);
        }
        
        // 获取当前表格数据展示区域的大小并计算最大显示数据量
        function getTableDisplayCapacity() {
            const tableContainer = document.querySelector('.table-responsive');
            const tableContainerWrapper = document.querySelector('.table-container');
            
            if (!tableContainer || !tableContainerWrapper) {
                console.log('无法找到表格容器');
                return { maxRows: 10, containerHeight: 0, rowHeight: 55 };
            }
            
            // 获取表格容器的实际尺寸
            const containerRect = tableContainer.getBoundingClientRect();
            const wrapperRect = tableContainerWrapper.getBoundingClientRect();
            
            // 计算表格头部高度
            const thead = tableContainer.querySelector('thead');
            const headerHeight = thead ? thead.offsetHeight : 50;
            
            // 计算可用数据区域高度
            const totalContainerHeight = wrapperRect.height;
            const availableDataHeight = totalContainerHeight - headerHeight - 20; // 预留一些边距
            
            // 计算每行数据的高度
            const rowHeight = 55; // 预估每行高度
            
            // 计算最大可显示的数据行数
            const maxRows = Math.floor(availableDataHeight / rowHeight);
            
            console.log('表格数据展示区域容量分析:', {
                totalContainerHeight: totalContainerHeight,
                headerHeight: headerHeight,
                availableDataHeight: availableDataHeight,
                rowHeight: rowHeight,
                maxRows: maxRows,
                containerRect: {
                    width: containerRect.width,
                    height: containerRect.height
                },
                wrapperRect: {
                    width: wrapperRect.width,
                    height: wrapperRect.height
                }
            });
            
            return {
                maxRows: Math.max(1, maxRows),
                containerHeight: totalContainerHeight,
                rowHeight: rowHeight,
                availableDataHeight: availableDataHeight
            };
        }
        
        // 调整表格容器高度以优化滚动条显示
        function adjustTableContainerHeight() {
            const tableContainer = document.querySelector('.table-responsive');
            const tableContainerWrapper = document.querySelector('.table-container');
            
            if (!tableContainer || !tableContainerWrapper) return;
            
            // 计算最佳高度
            const windowHeight = window.innerHeight;
            const containerTop = tableContainer.getBoundingClientRect().top;
            const optimalHeight = windowHeight - containerTop - 200; // 预留空间给分页控件等
            
            // 设置表格容器高度
            tableContainer.style.maxHeight = `${Math.max(300, optimalHeight)}px`;
            
            console.log('调整表格容器高度:', {
                windowHeight: windowHeight,
                containerTop: containerTop,
                optimalHeight: optimalHeight,
                maxHeight: tableContainer.style.maxHeight
            });
        }
        
        // 监控表格容量变化并更新显示
        function monitorTableCapacity() {
            const tableCapacity = getTableDisplayCapacity();
            const currentPageSize = pageSize;
            
            console.log('表格容量监控:', {
                currentCapacity: tableCapacity.maxRows,
                currentPageSize: currentPageSize,
                needsScrollbar: currentPageSize > tableCapacity.maxRows,
                remainingSpace: Math.max(0, tableCapacity.maxRows - currentPageSize)
            });
            
            // 如果容量发生变化，重新评估滚动条状态
            if (currentPageSize > tableCapacity.maxRows) {
                const needsScrollbar = shouldEnableScrollbar(currentPageSize);
                setScrollbarState(needsScrollbar, '容量监控触发');
            }
        }
        
        // 更新分页控件
        function updatePagination(currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            // 获取总页数
            const totalRecords = parseInt(document.getElementById('totalRecords').textContent) || 0;
            const totalPages = Math.ceil(totalRecords / pageSize);
            
            console.log('更新分页控件:', { currentPage, totalRecords, totalPages, pageSize });
            
            if (totalPages <= 1) {
                console.log('总页数小于等于1，不显示分页控件');
                return;
            }
            
            // 上一页按钮
            const prevLi = document.createElement('li');
            prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
            prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1})">上一页</a>`;
            pagination.appendChild(prevLi);
            
            // 页码按钮
            const startPage = Math.max(1, currentPage - 2);
            const endPage = Math.min(totalPages, currentPage + 2);
            
            for (let i = startPage; i <= endPage; i++) {
                const pageLi = document.createElement('li');
                pageLi.className = `page-item ${i === currentPage ? 'active' : ''}`;
                pageLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i})">${i}</a>`;
                pagination.appendChild(pageLi);
            }
            
            // 下一页按钮
            const nextLi = document.createElement('li');
            nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
            nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1})">下一页</a>`;
            pagination.appendChild(nextLi);
            
            console.log('分页控件更新完成');
        }
        
        // 跳转到指定页
        function goToPage(page) {
            console.log('跳转到页面:', page);
            
            if (page < 1 || page > totalPages) {
                console.log('页码超出范围，忽略');
                return;
            }
            
            currentPage = page;
            loadScripts(page);
        }
        
        // 改变分页大小
        function changePageSize() {
            const newPageSize = parseInt(document.getElementById('pageSizeSelect').value);
            console.log('改变分页大小:', { oldSize: pageSize, newSize: newPageSize });
            
            if (newPageSize !== pageSize) {
                console.log('分页大小发生变化，重新加载数据...');
                
                // 更新全局变量
                pageSize = newPageSize;
                currentPage = 1; // 重置到第一页
                isAutoCalculated = false; // 标记为手动设置
                
                // 显示加载状态
                const tbody = document.getElementById('scriptTableBody');
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted"><i class="fas fa-spinner fa-spin me-2"></i>加载中...</td></tr>';
                
                // 清空分页信息
                document.getElementById('startRecord').textContent = '0';
                document.getElementById('endRecord').textContent = '0';
                document.getElementById('totalRecords').textContent = '0';
                document.getElementById('pagination').innerHTML = '';
                
                // 根据分页大小智能调整滚动条设置
                const tableContainer = document.querySelector('.table-responsive');
                const mainContent = document.querySelector('.col-md-9.col-lg-10');
                
                // 使用智能判断是否需要滚动条
                const needsScrollbar = shouldEnableScrollbar(newPageSize);
                setScrollbarState(needsScrollbar, `分页大小改变，分页大小: ${newPageSize}`);
                
                // 显示智能建议
                const optimalDisplay = calculateOptimalDataDisplay();
                const tableCapacity = getTableDisplayCapacity();
                
                console.log(`=== 分页大小改变分析 ===`);
                console.log(`当前表格数据展示区域容量: ${tableCapacity.maxRows} 条`);
                console.log(`当前界面最佳显示量: ${optimalDisplay} 条`);
                console.log(`您选择的分页大小: ${newPageSize} 条`);
                
                if (newPageSize > tableCapacity.maxRows) {
                    console.log(`⚠️ 数据将超出显示区域，将启用内部滚动条`);
                    console.log(`超出数量: ${newPageSize - tableCapacity.maxRows} 条`);
                } else {
                    console.log(`✅ 数据在显示区域内，无需滚动条`);
                    console.log(`剩余空间: ${tableCapacity.maxRows - newPageSize} 条`);
                }
                console.log(`================================`);
                
                // 重新加载数据
                console.log('调用 loadScripts(1) 重新加载数据，当前pageSize:', pageSize);
                console.log('强制刷新缓存，使用新的时间戳');
                
                // 强制延迟一下，确保pageSize变量已经更新
                setTimeout(() => {
                    console.log('延迟后重新检查pageSize:', pageSize);
                    loadScripts(1);
                }, 100);
            } else {
                console.log('分页大小未发生变化，跳过重新加载');
            }
        }
        
        // 重置为自动分页
        function resetToAuto() {
            const autoPageSize = calculateOptimalPageSize();
            console.log('重置为自动分页:', { autoPageSize });
            
            // 确保分页大小在可用选项中
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const availableSizes = Array.from(pageSizeSelect.options).map(opt => parseInt(opt.value));
            const closestSize = availableSizes.reduce((prev, curr) => 
                Math.abs(curr - autoPageSize) < Math.abs(prev - autoPageSize) ? curr : prev
            );
            
            console.log('可用的分页大小:', availableSizes);
            console.log('计算的分页大小:', closestSize);
            console.log('强制设置为5');
            
            // 强制设置为5
            pageSizeSelect.value = '5';
            pageSize = 5;
            currentPage = 1;
            isAutoCalculated = true;
            loadScripts(1);
        }
    </script>
</body>
</html> 