<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>VNC 远程桌面</title>
    <!-- 预加载关键资源 -->
    <link rel="preload" href="{{ url_for('static', filename='lib/bootstrap.min.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='lib/all.min.css') }}" as="style">
    <link rel="preload" href="{{ url_for('static', filename='js/noVNC-1.4.0/core/rfb.js') }}" as="script">
    
    <!-- 引入CSS -->
    <link href="{{ url_for('static', filename='lib/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='lib/all.min.css') }}" rel="stylesheet">
    
    <!-- 使用ES模块导入noVNC库 -->
    <script type="module">
        import RFB from '/static/js/noVNC-1.4.0/core/rfb.js';
        window.RFB = RFB;
    </script>
    
  <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #000;
            overflow: hidden;
            font-family: Arial, sans-serif;
        }
        
        .vnc-container {
            width: 100vw;
            height: 100vh;
            position: relative;
            display: flex;
            flex-direction: column;
        }
        
        .vnc-toolbar {
            background-color: #2c3e50;
            color: white;
            padding: 8px 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 1000;
            flex-shrink: 0;
        }
        
        .vnc-toolbar.hidden {
            transform: translateY(-100%);
            transition: transform 0.3s ease;
        }
        
        .vnc-info {
            font-size: 14px;
            color: #ecf0f1;
        }
        
        .vnc-controls {
            display: flex;
            gap: 10px;
        }
        
        .vnc-btn {
            background-color: #34495e;
            border: none;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: background-color 0.2s;
        }
        
        .vnc-btn:hover {
            background-color: #4a6741;
        }
        
        .vnc-btn.active {
            background-color: #27ae60;
        }
        
        .vnc-display {
            flex: 1;
            position: relative;
            overflow: hidden;
            background-color: #000;
        }
        
        #noVNC_canvas {
            display: block;
            margin: 0 auto;
        }
        
        .vnc-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            text-align: center;
            z-index: 100;
        }
        
        .vnc-error {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #e74c3c;
            text-align: center;
            z-index: 100;
            background-color: rgba(0,0,0,0.8);
            padding: 20px;
            border-radius: 8px;
        }
        
        .fullscreen-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
        }
        
        .fullscreen-mode .vnc-toolbar {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        
        .fullscreen-mode:hover .vnc-toolbar {
            opacity: 1;
        }
        
        .connection-status {
            display: inline-block;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: #e74c3c;
            margin-right: 8px;
        }
        
        .connection-status.connected {
            background-color: #27ae60;
        }
        
        .connection-status.connecting {
            background-color: #f39c12;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="vnc-container" id="vncContainer">
        <!-- 工具栏 -->
        <div class="vnc-toolbar" id="vncToolbar">
            <div class="vnc-info">
                <span class="connection-status" id="connectionStatus"></span>
                <span id="vncHostInfo">正在连接...</span>
            </div>
            <div class="vnc-controls">
                <button class="vnc-btn" onclick="sendCtrlAltDel()" title="发送 Ctrl+Alt+Del">
                    <i class="fas fa-keyboard"></i> Ctrl+Alt+Del
                </button>
                <button class="vnc-btn" onclick="toggleFullscreen()" title="全屏/退出全屏" id="fullscreenBtn">
                    <i class="fas fa-expand"></i> 全屏
                </button>
                <button class="vnc-btn" onclick="reconnectVNC()" title="重新连接">
                    <i class="fas fa-sync-alt"></i> 重连
                </button>
                <button class="vnc-btn" onclick="window.close()" title="关闭窗口">
                    <i class="fas fa-times"></i> 关闭
                </button>
            </div>
        </div>
        
        <!-- VNC显示区域 -->
        <div class="vnc-display" id="vncDisplay">
            <div class="vnc-loading" id="vncLoading">
                <div class="spinner-border text-light" role="status">
                    <span class="visually-hidden">加载中...</span>
                </div>
                <div class="mt-3">正在连接VNC服务器...</div>
            </div>
            
            <div class="vnc-error" id="vncError" style="display: none;">
                <i class="fas fa-exclamation-triangle fa-2x mb-3"></i>
                <div id="vncErrorMessage">连接失败</div>
                <button class="btn btn-outline-light btn-sm mt-3" onclick="reconnectVNC()">
                    <i class="fas fa-sync-alt"></i> 重试连接
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript 库 - 只引入必要的库 -->
    <script src="{{ url_for('static', filename='lib/bootstrap.bundle.min.js') }}"></script>
    
    <script>
        // 全局变量
        let currentRfb = null;
        let isFullscreen = false;
        let vncParams = {};
        
        // 解密连接字符串
        function decryptConnectionString(encryptedStr) {
            try {
                // 还原Base64编码
                const base64 = encryptedStr.replace(/[-_]/g, function(match) {
                    return {
                        '-': '+',
                        '_': '/'
                    }[match];
                });
                
                // 补齐Base64填充
                const padded = base64 + '==='.slice(0, (4 - base64.length % 4) % 4);
                
                // 解码
                const decoded = decodeURIComponent(atob(padded));
                
                // 解析参数
                const params = new URLSearchParams(decoded);
                return {
                    ip: params.get('ip'),
                    port: params.get('port'),
                    password: params.get('password') || ''
                };
            } catch (error) {
                console.error('解密连接参数失败:', error);
                return null;
            }
        }
        
        // 从URL参数获取连接信息
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            
            // 检查是否有加密参数
            const encryptedParams = urlParams.get('params');
            if (encryptedParams) {
                const decrypted = decryptConnectionString(encryptedParams);
                if (decrypted) {
                    return decrypted;
                }
            }
            
            // 兼容原有的明文参数
            return {
                ip: urlParams.get('ip'),
                port: urlParams.get('port'),
                password: urlParams.get('password') || ''
            };
        }
        
        // 初始化VNC连接
        function initVNCConnection() {
            vncParams = getUrlParams();
            
            if (!vncParams.ip || !vncParams.port) {
                showError('缺少连接参数');
                return;
            }
            
            document.getElementById('vncHostInfo').textContent = `连接到 ${vncParams.ip}`;
            document.title = `VNC - ${vncParams.ip}`;
            
            connectToVNC();
        }
        
        // 连接到VNC服务器 - 优化连接逻辑
        function connectToVNC() {
            // 预先缓存DOM元素以减少重复查询
            const vncLoading = document.getElementById('vncLoading');
            const vncError = document.getElementById('vncError');
            const vncDisplay = document.getElementById('vncDisplay');
            
            try {
                // 显示加载状态
                vncLoading.style.display = 'block';
                vncError.style.display = 'none';
                updateConnectionStatus('connecting');
                
                // 创建noVNC连接，使用127.0.0.1作为WebSocket服务器地址
                // 合并参数创建，避免多次字符串拼接
                const wsUrl = 'ws://127.0.0.1:' + vncParams.port;
                currentRfb = new RFB(vncDisplay, wsUrl, {
                    credentials: { password: vncParams.password || '' },
                    // 直接在构造函数中设置选项
                    scaleViewport: true,
                    resizeSession: false
                });
                
                // 设置事件监听器
                currentRfb.addEventListener('connect', onVNCConnected);
                currentRfb.addEventListener('disconnect', onVNCDisconnected);
                currentRfb.addEventListener('credentialsrequired', onVNCCredentialsRequired);
                currentRfb.addEventListener('securityfailure', onVNCSecurityFailure);
                
            } catch (error) {
                // 错误处理保留但减少日志输出
                showError('连接失败: ' + (error.message || '未知错误'));
            }
        }
        
        // VNC连接成功
        function onVNCConnected(e) {
            console.log('VNC连接成功');
            document.getElementById('vncLoading').style.display = 'none';
            updateConnectionStatus('connected');
            document.getElementById('vncHostInfo').textContent = `已连接到 ${vncParams.ip}`;
        }
        
        // VNC连接断开
        function onVNCDisconnected(e) {
            console.log('VNC连接断开:', e.detail);
            updateConnectionStatus('disconnected');
            
            if (e.detail.clean) {
                document.getElementById('vncHostInfo').textContent = `与 ${vncParams.ip} 的连接已断开`;
            } else {
                showError('连接意外断开: ' + (e.detail.reason || '未知原因'));
            }
        }
        
        // VNC需要认证
        function onVNCCredentialsRequired(e) {
            console.log('VNC需要认证');
            const password = prompt('请输入VNC密码:');
            if (password) {
                currentRfb.sendCredentials({ password: password });
            } else {
                showError('需要密码才能连接');
            }
        }
        
        // VNC认证失败
        function onVNCSecurityFailure(e) {
            console.log('VNC认证失败:', e.detail);
            showError('认证失败: ' + (e.detail.reason || '密码错误'));
        }
        
        // 更新连接状态
        function updateConnectionStatus(status) {
            const statusElement = document.getElementById('connectionStatus');
            statusElement.className = `connection-status ${status}`;
        }
        
        // 显示错误信息
        function showError(message) {
            document.getElementById('vncLoading').style.display = 'none';
            document.getElementById('vncError').style.display = 'block';
            document.getElementById('vncErrorMessage').textContent = message;
            updateConnectionStatus('disconnected');
        }
        
        // 发送Ctrl+Alt+Del
        function sendCtrlAltDel() {
            if (!currentRfb) {
                alert('VNC未连接');
                return;
            }
            
            try {
                currentRfb.sendCtrlAltDel();
                console.log('已发送Ctrl+Alt+Del');
            } catch (error) {
                console.error('发送Ctrl+Alt+Del失败:', error);
                alert('发送失败: ' + error.message);
            }
        }
        
        // 切换全屏模式
        function toggleFullscreen() {
            const container = document.getElementById('vncContainer');
            const btn = document.getElementById('fullscreenBtn');
            
            if (!isFullscreen) {
                // 进入全屏
                if (container.requestFullscreen) {
                    container.requestFullscreen();
                } else if (container.webkitRequestFullscreen) {
                    container.webkitRequestFullscreen();
                } else if (container.msRequestFullscreen) {
                    container.msRequestFullscreen();
                }
            } else {
                // 退出全屏
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }
        
        // 监听全屏状态变化
        function onFullscreenChange() {
            isFullscreen = !!(document.fullscreenElement || document.webkitFullscreenElement || document.msFullscreenElement);
            const btn = document.getElementById('fullscreenBtn');
            
            if (isFullscreen) {
                btn.innerHTML = '<i class="fas fa-compress"></i> 退出全屏';
                btn.classList.add('active');
            } else {
                btn.innerHTML = '<i class="fas fa-expand"></i> 全屏';
                btn.classList.remove('active');
            }
        }
        
        // 重新连接
        function reconnectVNC() {
            if (currentRfb) {
                currentRfb.disconnect();
                currentRfb = null;
            }
            
            setTimeout(() => {
                connectToVNC();
            }, 1000);
        }
        
        // 页面加载完成后初始化 - 优化执行顺序
        document.addEventListener('DOMContentLoaded', function() {
            // 优先设置事件监听
            document.addEventListener('fullscreenchange', onFullscreenChange);
            document.addEventListener('webkitfullscreenchange', onFullscreenChange);
            document.addEventListener('msfullscreenchange', onFullscreenChange);
            
            // 监听窗口关闭事件
            window.addEventListener('beforeunload', function() {
                if (currentRfb) {
                    currentRfb.disconnect();
                }
            });
            
            // 初始化VNC连接 - 减少不必要的日志输出以提高性能
            initVNCConnection();
        });
        
        // 键盘快捷键
        document.addEventListener('keydown', function(e) {
            // F11 切换全屏
            if (e.key === 'F11') {
                e.preventDefault();
                toggleFullscreen();
            }
            
            // Ctrl+Alt+D 发送Ctrl+Alt+Del
            if (e.ctrlKey && e.altKey && e.key === 'd') {
                e.preventDefault();
                sendCtrlAltDel();
            }
        });
    </script>
</body>
</html>