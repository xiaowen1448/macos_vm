{% extends "base.html" %}
{% block title %}代理IP分配管理{% endblock %}
{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-lg-12">
            <div class="card shadow mb-4">
                <div class="card-header py-3 bg-primary">
                    <h6 class="m-0 font-weight-bold text-white">VPN节点管理与测速</h6>
                </div>
                <div class="card-body">
                    <!-- 操作按钮区域 - 最小化间距和高度 -->
                    <div class="mb-0" style="display: flex; flex-wrap: wrap; align-items: center; gap: 5px; margin-bottom: 6px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 10px;">
                            <button id="importConfigBtn" class="btn btn-success">
                                <i class="fas fa-upload"></i> 导入VPN配置
                            </button>
                            <button id="batchTestBtn" class="btn btn-primary">
                            <i class="fas fa-tachometer-alt"></i> 批量测速
                        </button>

                            <button id="batchDeleteBtn" class="btn btn-danger" disabled>
                                <i class="fas fa-trash-alt"></i> 批量删除
                            </button>
                        </div>
                        <div style="margin-left: auto; display: flex; flex-wrap: wrap; gap: 10px;">
                            <select id="filterRegion" class="form-control form-control-sm d-inline-block w-auto">
                                <option value="all">全部地区</option>
                                <option value="hk">香港</option>
                                <option value="tw">台湾</option>
                                <option value="sg">新加坡</option>
                                <option value="jp">日本</option>
                                <option value="us">美国</option>
                                <option value="ca">加拿大</option>
                            </select>
                            <select id="filterProtocol" class="form-control form-control-sm d-inline-block w-auto">
                                <option value="all">全部协议</option>
                                <option value="trojan">Trojan</option>
                                <option value="vmess">VMess</option>
                                <option value="ss">Shadowsocks</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- 节点列表区域 - 调整布局确保分页可见 -->
                    <div class="table-responsive" style="margin-bottom: 15px;">
                        <table class="table table-bordered table-hover" id="nodeTable" width="100%" cellspacing="0">
                            <thead class="thead-light">
                                <tr>
                                    <th width="5%"><input type="checkbox" id="selectAllNodes">  全选</th>
                                    <th width="30%">节点名称</th>
                                    <th width="15%">地区</th>
                                    <th width="10%">协议</th>
                                    <th width="10%">延迟(ms)</th>
                                    <th width="30%">操作</th>
                                </tr>
                            </thead>
                            <tbody id="nodeList">
                                <!-- 节点数据将通过JavaScript动态加载 -->
                                <tr>
                                    <td colspan="6" class="text-center">请导入VPN配置加载节点</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <!-- 分页控件 -->
                    <div class="d-flex justify-content-between align-items-center mt-3 mb-4">
                <div class="d-flex align-items-center">
                    <div class="text-muted me-3">
                        <i class="fas fa-info-circle me-1"></i>
                        显示 <span id="startRecord" class="fw-bold">0</span> - <span id="endRecord" class="fw-bold">0</span> 条，共 <span id="totalRecords" class="fw-bold">0</span> 条记录
                    </div>
                    <div class="d-flex align-items-center">
                        <label class="form-label mb-0 me-2">每页显示:</label>
                        <select class="form-select form-select-sm" id="pageSizeSelect" style="width: auto;" onchange="changePageSize()">
                            <option value="10" selected>10</option>
                            <option value="20">20</option>
                            <option value="50">50</option>
                            <option value="100">100</option>
                            <option value="300">300</option>
                        </select>

                    </div>
                </div>
                <nav aria-label="节点列表分页">
                    <ul class="pagination pagination-sm mb-0" id="pagination">
                        <!-- 分页按钮将在这里动态生成 -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>

<!-- 导入VPN配置模态框 -->
<div class="modal fade" id="importConfigModal" tabindex="-1" aria-labelledby="importConfigModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="importConfigModalLabel">
                    <i class="fas fa-cloud-upload-alt me-2"></i>导入VPN配置文件
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-4">
                    <label class="form-label font-weight-bold">选择配置文件</label>
                    <input type="file" class="form-control" id="configFile" accept=".yaml,.yml,.json,.txt" onchange="validateConfigFile()">
                    <div id="configFileStatus" class="mt-1 text-muted">未选择任何文件</div>
                </div>
                
                <div class="alert alert-info p-3">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>支持格式：</strong>
                    <br>Clash（yaml/yml）、V2Ray、Trojan等主流VPN配置格式
                    <br>建议：使用Clash格式配置文件以获得最佳体验
                </div>
            </div>
            <div class="modal-footer justify-content-between">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                <button type="button" class="btn btn-primary" id="doImportBtn" disabled>确认导入</button>
            </div>
        </div>
    </div>
</div>

<script>
// 显示加载状态函数
function showLoading(text = '正在处理请求...') {
    // 检查是否已存在加载元素并移除
    let loadingElement = document.getElementById('loadingOverlay');
    if (loadingElement) {
        document.body.removeChild(loadingElement);
    }
    
    // 创建新的加载覆盖层
    loadingElement = document.createElement('div');
    loadingElement.id = 'loadingOverlay';
    loadingElement.className = 'fixed inset-0 bg-black bg-opacity-50 z-50 flex flex-col items-center justify-center';
    loadingElement.style.position = 'fixed';
    loadingElement.style.top = '0';
    loadingElement.style.left = '0';
    loadingElement.style.width = '100%';
    loadingElement.style.height = '100%';
    loadingElement.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    loadingElement.style.zIndex = '9999';
    loadingElement.style.display = 'flex';
    loadingElement.style.flexDirection = 'column';
    loadingElement.style.alignItems = 'center';
    loadingElement.style.justifyContent = 'center';
    
    // 创建加载内容
    const loadingContent = document.createElement('div');
    loadingContent.className = 'bg-white p-5 rounded-lg shadow-lg text-center';
    loadingContent.style.backgroundColor = 'white';
    loadingContent.style.padding = '20px';
    loadingContent.style.borderRadius = '8px';
    loadingContent.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.2)';
    loadingContent.style.textAlign = 'center';
    
    // 创建加载图标
    const spinner = document.createElement('div');
    spinner.className = 'spinner-border text-primary mb-3';
    spinner.style.width = '3rem';
    spinner.style.height = '3rem';
    spinner.role = 'status';
    
    const spinnerSpan = document.createElement('span');
    spinnerSpan.className = 'sr-only';
    spinnerSpan.textContent = '加载中...';
    spinner.appendChild(spinnerSpan);
    
    // 创建加载文本
    const loadingText = document.createElement('div');
    loadingText.id = 'loadingText';
    loadingText.className = 'text-dark';
    loadingText.style.color = '#333';
    loadingText.style.fontSize = '16px';
    loadingText.style.fontWeight = '500';
    
    // 设置加载文本
    loadingText.textContent = text;
    
    // 组装加载内容
    loadingContent.appendChild(spinner);
    loadingContent.appendChild(loadingText);
    loadingElement.appendChild(loadingContent);
    document.body.appendChild(loadingElement);
    
    return loadingElement; // 返回加载元素，便于后续操作
}

// 右上角浮窗通知函数
function showNotification(message, type = 'success') {
    // 创建通知容器
    const notificationContainer = document.createElement('div');
    notificationContainer.className = `notification ${type}`;
    notificationContainer.style.position = 'fixed';
    notificationContainer.style.top = '20px';
    notificationContainer.style.right = '20px';
    notificationContainer.style.zIndex = '9999';
    notificationContainer.style.padding = '15px 20px';
    notificationContainer.style.borderRadius = '8px';
    notificationContainer.style.boxShadow = '0 4px 12px rgba(0, 0, 0, 0.15)';
    notificationContainer.style.fontWeight = '500';
    notificationContainer.style.fontSize = '14px';
    notificationContainer.style.transition = 'all 0.3s ease';
    notificationContainer.style.opacity = '0';
    notificationContainer.style.transform = 'translateX(100%)';
    
    // 设置背景颜色和图标
    if (type === 'success') {
        notificationContainer.style.backgroundColor = '#52c41a';
        notificationContainer.style.color = 'white';
        notificationContainer.innerHTML = `<i class="fas fa-check-circle mr-2"></i>${message}`;
    } else if (type === 'error') {
        notificationContainer.style.backgroundColor = '#ff4d4f';
        notificationContainer.style.color = 'white';
        notificationContainer.innerHTML = `<i class="fas fa-times-circle mr-2"></i>${message}`;
    } else if (type === 'warning') {
        notificationContainer.style.backgroundColor = '#faad14';
        notificationContainer.style.color = 'white';
        notificationContainer.innerHTML = `<i class="fas fa-exclamation-circle mr-2"></i>${message}`;
    } else if (type === 'info') {
        notificationContainer.style.backgroundColor = '#1890ff';
        notificationContainer.style.color = 'white';
        notificationContainer.innerHTML = `<i class="fas fa-info-circle mr-2"></i>${message}`;
    }
    
    // 添加到页面
    document.body.appendChild(notificationContainer);
    
    // 显示通知
    setTimeout(() => {
        notificationContainer.style.opacity = '1';
        notificationContainer.style.transform = 'translateX(0)';
    }, 10);
    
    // 设置定时关闭
    setTimeout(() => {
        notificationContainer.style.opacity = '0';
        notificationContainer.style.transform = 'translateX(100%)';
        
        // 动画结束后移除元素
        setTimeout(() => {
            if (notificationContainer.parentNode === document.body) {
                document.body.removeChild(notificationContainer);
            }
        }, 300);
    }, 3000);
    
    // 添加点击关闭
    notificationContainer.addEventListener('click', () => {
        notificationContainer.style.opacity = '0';
        notificationContainer.style.transform = 'translateX(100%)';
        
        setTimeout(() => {
            if (notificationContainer.parentNode === document.body) {
                document.body.removeChild(notificationContainer);
            }
        }, 300);
    });
}

// 隐藏加载状态函数
function hideLoading() {
    const loadingElement = document.getElementById('loadingOverlay');
    if (loadingElement && loadingElement.parentNode === document.body) {
        // 直接移除而不是仅仅隐藏，确保加载状态被正确清理
        document.body.removeChild(loadingElement);
    }
}

// 验证配置文件并启用/禁用导入按钮
function validateConfigFile() {
    const fileInput = document.getElementById('configFile');
    const fileStatus = document.getElementById('configFileStatus');
    const importBtn = document.getElementById('doImportBtn');
    
    if (fileInput.files.length === 0) {
        fileStatus.textContent = '未选择任何文件';
        fileStatus.classList.remove('text-success', 'text-danger');
        importBtn.disabled = true;
        return;
    }
    
    const file = fileInput.files[0];
    const validExtensions = ['.yaml', '.yml', '.json', '.txt'];
    const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
    
    if (validExtensions.includes(fileExtension)) {
        fileStatus.textContent = '已选择: ' + file.name;
        fileStatus.classList.remove('text-danger');
        fileStatus.classList.add('text-success');
        importBtn.disabled = false;
    } else {
        fileStatus.textContent = '不支持的文件格式: ' + file.name;
        fileStatus.classList.remove('text-success');
        fileStatus.classList.add('text-danger');
        importBtn.disabled = true;
    }
}

// 获取延迟对应的样式类
function getDelayClass(delay) {
    // 添加防御性检查，处理undefined或null值
    if (delay === undefined || delay === null || isNaN(delay)) {
        return 'text-danger font-weight-bold';
    }
    
    if (delay < 100) {
        return 'text-success font-weight-bold';
    } else if (delay < 300) {
        return 'text-warning font-weight-bold';
    } else {
        return 'text-danger font-weight-bold';
    }
}

// 更新分页显示的记录信息
function updatePaginationInfo(startIndex, endIndex, totalCount) {
    document.getElementById('startRecord').textContent = startIndex + 1;
    document.getElementById('endRecord').textContent = endIndex;
    document.getElementById('totalRecords').textContent = totalCount;
}

// 改变分页大小
function changePageSize() {
    const newPageSize = parseInt(document.getElementById('pageSizeSelect').value);
    
    // 如果分页大小发生变化，重新加载数据
    if (newPageSize !== pageSize) {
        console.log('改变分页大小:', { oldSize: pageSize, newSize: newPageSize });
        
        pageSize = newPageSize;
        currentPage = 1; // 重置到第一页
        
        // 重新加载当前页面的数据
        // 这里需要调用现有的数据加载函数，假设为loadNodes()
        if (typeof loadNodes === 'function') {
            loadNodes(currentPage);
        }
    }
}



// 地区筛选功能
function setupFilterHandlers() {
    const filterRegion = document.getElementById('filterRegion');
    const filterProtocol = document.getElementById('filterProtocol');
    
    if (filterRegion) {
        filterRegion.addEventListener('change', function() {
            filterNodes();
        });
    }
    
    if (filterProtocol) {
        filterProtocol.addEventListener('change', function() {
            filterNodes();
        });
    }
}

// 页面加载时设置筛选处理器
document.addEventListener('DOMContentLoaded', setupFilterHandlers);

// CSS样式 - 动态加载指示器和滚动条优化
const style = document.createElement('style');
style.textContent = `
    /* 加载指示器样式 - 修复对齐问题 */
    .loading-spinner {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 5px;
        width: 100%;
        padding: 4px 0;
        margin: 0;
    }
    
    .spinner {
        width: 14px;
        height: 14px;
        border: 2px solid #f3f3f3;
        border-top: 2px solid #3498db;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        flex-shrink: 0;
    }
    
    @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }
    
    /* 加载状态样式 */
    .loading {
        color: #3498db;
        text-align: center;
        padding: 0 !important;
    }
    
    /* 表格容器样式优化 - 确保滚动条正常显示 */
    #nodeList {
        width: 100%;
        table-layout: fixed;
        margin-bottom: 0 !important;
    }
    
    #nodeList td, #nodeList th {
        word-wrap: break-word;
        overflow: hidden;
        text-overflow: ellipsis;
        text-align: center;
        vertical-align: middle !important;
        padding: 8px 4px !important;
    }
    
    /* 表格容器容器 */
    .table-responsive {
        max-height: 500px !important;
        overflow-y: auto !important;
        overflow-x: auto !important;
        margin-bottom: 15px !important;
        position: relative;
    }
    
    /* 分页控件样式优化 - 只保留外部边框 */
    .pagination {
        margin-bottom: 0;
        display: flex;
        list-style: none;
        padding: 0;
        flex-wrap: nowrap;
        margin-left: 0;
        background-color: #f8f9fa;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        overflow: hidden;
    }
    
    .pagination .page-item {
        margin: 0;
        border-right: 1px solid #dee2e6;
    }
    
    .pagination .page-item:last-child {
        border-right: none;
    }
    
    .pagination .page-link {
        padding: 8px 12px;
        font-size: 0.875rem;
        white-space: nowrap;
        box-sizing: border-box;
        min-width: 40px;
        text-align: center;
        border-radius: 0;
        margin: 0;
        border: none;
        transition: all 0.2s ease;
        background-color: transparent;
        color: #495057;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .pagination .page-link:hover {
        background-color: #e9ecef;
    }
    
    .pagination .page-item.active .page-link {
        background-color: #007bff;
        color: white;
        font-weight: 500;
        border: none;
    }
    
    .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: transparent;
        border: none;
    }
    
    /* 分页容器样式 */
    .pagination-container {
        width: 100%;
        overflow-x: auto;
        padding: 10px 0 20px 0;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 20px;
    }
    
    #pagination-content {
        min-width: 100%;
        display: flex;
        justify-content: flex-end;
        overflow-x: visible;
        white-space: nowrap;
    }
    
    /* 分页信息样式 */
    .pagination-info {
        white-space: nowrap;
        overflow: visible;
        flex-shrink: 0;
    }
    
    /* 修复分页区域文字显示问题 */
    .d-flex.justify-content-between .text-muted {
        white-space: nowrap;
        overflow: visible;
    }
    
    /* 页码信息样式 */
    .pagination-info {
        color: #666;
        font-size: 14px;
        white-space: nowrap;
        padding: 8px 16px;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 4px;
        display: flex;
        align-items: center;
    }
    
    /* 延迟列样式 */
    td:nth-child(5) {
        text-align: center !important;
        min-width: 80px;
    }
    
    /* 确保内容区域不被遮挡 */
    .card-body {
        overflow: visible;
    }
`;
document.head.appendChild(style);

// 获取延迟显示值
function getDelayDisplay(delay) {
    // 添加防御性检查，处理undefined或null值
    if (delay === undefined || delay === null || isNaN(delay)) {
        return '-';
    }
    return delay + 'ms';
}

// 初始化节点数据延迟字段
function initializeNodeDelays(nodes) {
    if (!nodes || !Array.isArray(nodes)) return [];
    
    return nodes.map(node => {
        // 确保每个节点都有延迟字段，默认为null
        if (node.delay === undefined || node.delay === null || isNaN(node.delay)) {
            node.delay = null;
        }
        return node;
    });
}

// 获取速度对应的CSS类
function getSpeedClass(speed) {
    speed = parseFloat(speed);
    if (speed > 30) return 'text-success font-weight-bold';
    if (speed > 20) return 'text-warning font-weight-bold';
    return 'text-danger font-weight-bold';
}

// 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', function() {
    // 初始化节点数据延迟字段
    const nodes = [];
    

    // 为批量测速按钮添加点击事件
    document.getElementById('batchTestBtn')?.addEventListener('click', function() {
        testAllNodes();
    });
    
    // 为批量删除按钮添加点击事件
    document.getElementById('batchDeleteBtn')?.addEventListener('click', function() {
        batchDeleteNodes();
    });
    
    // 为导入配置按钮添加点击事件
    document.getElementById('importConfigBtn')?.addEventListener('click', function() {
        const importModal = new bootstrap.Modal(document.getElementById('importConfigModal'));
        importModal.show();
    });
    
    // 为确认导入按钮添加点击事件
    document.getElementById('doImportBtn')?.addEventListener('click', function() {
        importConfigFile();
    });
    
    // 为全选复选框添加事件
    document.getElementById('selectAllNodes')?.addEventListener('change', function() {
        const isChecked = this.checked;
        const checkboxes = document.querySelectorAll('.node-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = isChecked;
        });
        // 更新批量删除按钮状态
        updateBatchDeleteButtonStatus();
    });
    
    // 为地区筛选下拉菜单添加事件
    document.getElementById('filterRegion')?.addEventListener('change', function() {
        filterNodes();
    });
    
    // 为协议筛选下拉菜单添加事件
    document.getElementById('filterProtocol')?.addEventListener('change', function() {
        filterNodes();
    });
    
    // 为页面大小选择器添加事件
    document.getElementById('pageSizeSelect')?.addEventListener('change', function() {
        pageSize = parseInt(this.value);
        currentPage = 1; // 重置为第一页
        renderNodeList(getCurrentPageNodes());
        renderPagination();
    });
    
    // 为重置自动分页按钮添加事件
    document.getElementById('resetAutoPageBtn')?.addEventListener('click', resetToOptimalPageSize);
    
    // 窗口大小改变时重新计算最佳分页大小
    window.addEventListener('resize', function() {
        // 延迟执行以避免频繁计算
        if (window.resizeTimeout) clearTimeout(window.resizeTimeout);
        window.resizeTimeout = setTimeout(function() {
            // 检查是否启用了自动分页模式（可以通过localStorage或其他标志）
            const autoPaginationEnabled = localStorage.getItem('autoPaginationEnabled') !== 'false';
            if (autoPaginationEnabled) {
                resetToOptimalPageSize();
            }
        }, 300);
    });
    
    // 初始计算最佳分页大小
    resetToOptimalPageSize();
    
    // 初始加载节点列表
    loadNodes();
});

// 全局节点数据存储
let nodeData = [];
// 分页相关变量
let currentPage = 1;
let pageSize = 20; // 每页显示的节点数量
let totalPages = 1;

// 计算最佳分页大小
function calculateOptimalPageSize() {
    // 获取可用区域高度
    const cardBody = document.querySelector('.card-body');
    const tableHeader = document.querySelector('#nodeTable thead');
    const paginationArea = document.querySelector('.d-flex.justify-content-between');
    
    if (!cardBody || !tableHeader || !paginationArea) {
        return 5; // 默认值，最小分页大小
    }
    
    // 获取视口高度
    const viewportHeight = window.innerHeight;
    
    // 计算可用高度（减去顶部导航栏、卡片头部、统计区域、分页区域等）
    const topNavHeight = 80; // 顶部导航栏高度
    const cardHeaderHeight = 80; // 卡片头部高度（包含padding）
    const headerHeight = tableHeader.offsetHeight;
    const paginationAreaHeight = paginationArea.offsetHeight;
    const paginationHeight = 60; // 分页控件高度（包括按钮和间距）
    const padding = 120; // 预留更多空间，确保分页控件完全显示
    
    const availableHeight = viewportHeight - topNavHeight - cardHeaderHeight - headerHeight - paginationHeight - padding;
    
    // 估算表格行高（包括边框和内边距）
    const estimatedRowHeight = 52; // 每行大约52px（Bootstrap表格行高）
    
    // 计算可以显示的行数
    const maxRows = Math.floor(availableHeight / estimatedRowHeight);
    
    // 确保至少显示5行，最多显示30行（更保守）
    const optimalPageSize = Math.max(5, Math.min(maxRows, 30));
    
    // 如果计算出的值不在预设选项中，选择最接近的选项
    const options = [5, 10, 20, 50, 100];
    let closestOption = 5; // 默认值，最小分页大小
    
    // 找到最接近的选项
    for (let i = 0; i < options.length; i++) {
        if (options[i] >= optimalPageSize) {
            closestOption = options[i];
            break;
        }
        if (i === options.length - 1) {
            closestOption = options[i]; // 如果都小于，选择最大值
        }
    }
    
    // 如果计算出的值太小，使用默认值
    if (optimalPageSize < 5) {
        return 5;
    }
    
    return closestOption;
}

// 重置为自动分页大小
function resetToOptimalPageSize() {
    pageSize = calculateOptimalPageSize();
    currentPage = 1;
    
    // 更新页面大小选择器
    const pageSizeSelect = document.getElementById('pageSizeSelect');
    if (pageSizeSelect) {
        // 检查是否有精确匹配的选项
        let hasExactMatch = false;
        for (let i = 0; i < pageSizeSelect.options.length; i++) {
            if (parseInt(pageSizeSelect.options[i].value) === pageSize) {
                pageSizeSelect.selectedIndex = i;
                hasExactMatch = true;
                break;
            }
        }
        
        // 如果没有精确匹配，添加一个新选项
        if (!hasExactMatch) {
            const option = document.createElement('option');
            option.value = pageSize;
            option.textContent = pageSize + ' 条/页';
            option.selected = true;
            pageSizeSelect.appendChild(option);
        }
    }
    
    // 重新渲染节点列表和分页控件
    renderNodeList(getCurrentPageNodes());
    renderPagination();
    
    console.log(`已重置为最佳分页大小: ${pageSize} 条/页`);
}

// 加载节点列表 - 从后端API获取真实数据
// 动态生成地区和协议筛选选项
function generateFilterOptions() {
    // 从节点数据中提取唯一的地区
    const regions = new Set();
    // 从节点数据中提取唯一的协议
    const protocols = new Set();
    
    // 遍历所有节点，收集地区和协议信息
    nodeData.forEach(node => {
        if (node.region) {
            regions.add(node.region);
        }
        if (node.protocol) {
            protocols.add(node.protocol);
        }
    });
    
    // 获取地区筛选下拉框并更新选项
    const regionFilter = document.getElementById('filterRegion');
    if (regionFilter) {
        // 保留第一个选项（全部地区）
        const firstOption = regionFilter.options[0];
        regionFilter.innerHTML = '';
        regionFilter.appendChild(firstOption);
        
        // 添加所有唯一地区选项
        regions.forEach(region => {
            const option = document.createElement('option');
            option.value = region;
            option.textContent = region;
            regionFilter.appendChild(option);
        });
    }
    
    // 获取协议筛选下拉框并更新选项
    const protocolFilter = document.getElementById('filterProtocol');
    if (protocolFilter) {
        // 保留第一个选项（全部协议）
        const firstOption = protocolFilter.options[0];
        protocolFilter.innerHTML = '';
        protocolFilter.appendChild(firstOption);
        
        // 添加所有唯一协议选项
        protocols.forEach(protocol => {
            const option = document.createElement('option');
            option.value = protocol.toLowerCase();
            option.textContent = protocol;
            protocolFilter.appendChild(option);
        });
    }
}

function loadNodes() {
    showLoading('正在加载节点列表...');
    
    // 从后端API获取节点数据
    fetch('/api/nodes')
        .then(response => response.json())
        .then(data => {
            hideLoading();
            
            if (data.success && data.data) {
                // 初始化节点延迟字段
                const initializedNodes = initializeNodeDelays(data.data);
                
                // 保存到全局变量
                nodeData = initializedNodes;
                
                // 重置当前页为第一页
                currentPage = 1;
                
                // 计算总页数
                totalPages = Math.ceil(nodeData.length / pageSize);
                
                // 动态生成地区和协议筛选选项
                generateFilterOptions();
                
                // 渲染当前页的节点列表
                renderNodeList(getCurrentPageNodes());
                
                // 渲染分页控件
                renderPagination();
                
                console.log(`节点列表加载成功，共 ${initializedNodes.length} 个节点`);
               // showNotification(`节点列表加载成功，共 ${initializedNodes.length} 个节点`, 'success');
            } else {
                // 如果没有数据，清空全局变量
                nodeData = [];
                currentPage = 1;
                totalPages = 1;
                
                // 显示空状态
                renderNodeList([]);
                renderPagination(); // 重置分页控件
                
                showNotification('未找到节点数据，请先导入配置文件', 'info');
            }
        })
        .catch(error => {
            hideLoading();
            showNotification(`加载节点列表失败: ${error.message}`, 'error');
            console.error('加载节点列表错误:', error);
        });
}

// 更新分页信息显示
function updatePaginationInfo(startIndex, endIndex, totalCount) {
    const startRecord = document.getElementById('startRecord');
    const endRecord = document.getElementById('endRecord');
    const totalRecords = document.getElementById('totalRecords');
    
    if (!startRecord || !endRecord || !totalRecords) return;
    
    if (totalCount === 0) {
        startRecord.textContent = '0';
        endRecord.textContent = '0';
        totalRecords.textContent = '0';
    } else {
        // 加1是因为索引从0开始，而显示时从1开始
        startRecord.textContent = startIndex + 1;
        endRecord.textContent = endIndex;
        totalRecords.textContent = totalCount;
    }
}

// 渲染节点列表
function renderNodeList(nodes) {
    // 确保表格容器有滚动条样式
    const tableContainer = document.querySelector('.table-responsive');
    if (tableContainer) {
        tableContainer.style.maxHeight = '500px';
        tableContainer.style.overflowY = 'auto';
        tableContainer.style.overflowX = 'auto';
        tableContainer.style.position = 'relative';
        tableContainer.style.marginBottom = '15px';
    }
    
    const nodeListElement = document.getElementById('nodeList');
    if (!nodeListElement) return;
    
    if (!nodes || nodes.length === 0) {
        nodeListElement.innerHTML = '<tr><td colspan="6" class="text-center">暂无节点数据</td></tr>';
        return;
    }
    
    let html = '';
    nodes.forEach(node => {
        // 使用getDelayDisplay函数显示延迟值
        const delayDisplay = getDelayDisplay(node.delay);
        const delayClass = getDelayClass(node.delay);
        
        html += `
        <tr>
            <td><input type="checkbox" class="node-checkbox" data-id="${node.id}"></td>
            <td>${node.name || '未知节点'}</td>
            <td>${node.region || '未知地区'}</td>
            <td>${node.protocol || '未知协议'}</td>
            <td class="${delayClass}">${delayDisplay}</td>
            <td>
                <button class="btn btn-sm btn-info test-node-btn" data-id="${node.id}">测速</button>
                <button class="btn btn-sm btn-danger delete-node-btn" data-id="${node.id}">删除</button>
            </td>
        </tr>
        `;
    });
    
    nodeListElement.innerHTML = html;
    
    // 为按钮添加事件监听器
    addNodeButtonListeners();
}

// 筛选节点数据
function filterNodes() {
    // 获取筛选条件
    const regionFilter = document.getElementById('filterRegion')?.value || 'all';
    const protocolFilter = document.getElementById('filterProtocol')?.value || 'all';
    
    // 重置当前页为第一页
    currentPage = 1;
    
    // 重新渲染节点列表和分页控件
    renderNodeList(getCurrentPageNodes());
    renderPagination();
}

// 获取当前页的节点数据（包含筛选）
function getCurrentPageNodes() {
    // 获取筛选条件
    const regionFilter = document.getElementById('filterRegion')?.value || 'all';
    const protocolFilter = document.getElementById('filterProtocol')?.value || 'all';
    
    // 应用筛选条件
    let filteredNodes = nodeData.filter(node => {
        // 地区筛选 - 确保根据节点显示的地区名称进行匹配
        let regionMatch = false;
        if (regionFilter === 'all') {
            regionMatch = true;
        } else if (node.region) {
            // 将筛选条件映射到地区名称进行匹配
            const regionMap = {
                'hk': '香港',
                'tw': '台湾', 
                'sg': '新加坡',
                'jp': '日本',
                'us': '美国',
                'ca': '加拿大'
            };
            const regionName = regionMap[regionFilter.toLowerCase()] || regionFilter;
            regionMatch = node.region.includes(regionName);
        }
        
        // 协议筛选
        const protocolMatch = protocolFilter === 'all' || 
                            (node.protocol && node.protocol.toLowerCase().includes(protocolFilter.toLowerCase()));
        
        // 两个条件都要满足
        return regionMatch && protocolMatch;
    });
    
    // 计算总页数
    totalPages = Math.ceil(filteredNodes.length / pageSize);
    
    // 确保当前页不超过总页数
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
    }
    
    // 获取当前页的数据
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = startIndex + pageSize;
    return filteredNodes.slice(startIndex, endIndex);
}

// 渲染分页控件
function renderPagination() {
    const paginationElement = document.getElementById('pagination');
    if (!paginationElement) return;
    
    // 获取筛选条件
    const regionFilter = document.getElementById('filterRegion')?.value || 'all';
    const protocolFilter = document.getElementById('filterProtocol')?.value || 'all';
    
    // 应用筛选条件
    let filteredNodes = nodeData.filter(node => {
        // 地区筛选 - 确保根据节点显示的地区名称进行匹配
        let regionMatch = false;
        if (regionFilter === 'all') {
            regionMatch = true;
        } else if (node.region) {
            // 将筛选条件映射到地区名称进行匹配
            const regionMap = {
                'hk': '香港',
                'tw': '台湾', 
                'sg': '新加坡',
                'jp': '日本',
                'us': '美国',
                'ca': '加拿大'
            };
            const regionName = regionMap[regionFilter.toLowerCase()] || regionFilter;
            regionMatch = node.region.includes(regionName);
        }
        
        // 协议筛选
        const protocolMatch = protocolFilter === 'all' || 
                            (node.protocol && node.protocol.toLowerCase().includes(protocolFilter.toLowerCase()));
        
        // 两个条件都要满足
        return regionMatch && protocolMatch;
    });
    
    // 计算当前页索引
    const startIndex = (currentPage - 1) * pageSize;
    const endIndex = Math.min(startIndex + pageSize, filteredNodes.length);
    
    // 更新分页信息，使用筛选后的节点数量
    updatePaginationInfo(startIndex, endIndex, filteredNodes.length);
    
    // 如果没有数据，隐藏分页控件
    if (filteredNodes.length === 0) {
        paginationElement.innerHTML = '';
        return;
    }
    
    // 计算总页数（基于筛选后的数据）
    totalPages = Math.ceil(filteredNodes.length / pageSize);
    
    // 确保当前页不超过总页数
    if (currentPage > totalPages && totalPages > 0) {
        currentPage = totalPages;
    }
    
    let html = '';
    
    // 上一页按钮
    html += `
    <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
        <a class="page-link" href="#" aria-label="上一页" onclick="goToPage(${currentPage - 1}); return false;">
            上一页
        </a>
    </li>
    `;
    
    // 添加页码数字，只显示三个页码
    let startPage = Math.max(1, currentPage - 1);
    let endPage = Math.min(totalPages, startPage + 2);
    
    // 调整起始页码，确保始终显示三个页码
    if (endPage - startPage < 2) {
        startPage = Math.max(1, endPage - 2);
    }
    
    for (let i = startPage; i <= endPage; i++) {
        html += `
        <li class="page-item ${currentPage === i ? 'active' : ''}">
            <a class="page-link" href="#" onclick="goToPage(${i}); return false;">
                ${i}
            </a>
        </li>
        `;
    }
    
    // 下一页按钮
    html += `
    <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
        <a class="page-link" href="#" aria-label="下一页" onclick="goToPage(${currentPage + 1}); return false;">
            下一页
        </a>
    </li>
    `;
    
    paginationElement.innerHTML = html;
}

// 跳转到指定页面
function goToPage(page) {
    // 验证页面范围
    if (page < 1 || page > totalPages) {
        return;
    }
    
    // 更新当前页
    currentPage = page;
    
    // 重新渲染节点列表和分页控件
    renderNodeList(getCurrentPageNodes());
    renderPagination();
}

// 为节点操作按钮添加事件监听器
function addNodeButtonListeners() {
    // 测速按钮
    document.querySelectorAll('.test-node-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const nodeId = this.getAttribute('data-id');
            testNode(nodeId);
        });
    });
    
    // 分配按钮
    // 测速按钮
    document.querySelectorAll('.test-node-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const nodeId = this.getAttribute('data-id');
            testNode(nodeId);
        });
    });
    
    // 分配按钮已移除
    
    // 删除按钮
    document.querySelectorAll('.delete-node-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            const nodeId = this.getAttribute('data-id');
            deleteNode(nodeId);
        });
    });
    
    // 节点复选框事件
    document.querySelectorAll('.node-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', updateBatchDeleteButtonStatus);
    });
}

// 测试单个节点
function testNode(nodeId) {
    // 显示加载指示器
    showLoadingIndicator(nodeId);
    
    // 模拟测速请求
    setTimeout(function() {
        const randomDelay = Math.floor(Math.random() * 300) + 50;
        
        // 更新节点延迟
        updateNodeDelay(nodeId, randomDelay);
    }, 1500);
}


// 显示加载指示器
function showLoadingIndicator(nodeId) {
    const rows = document.querySelectorAll('#nodeList tr');
    rows.forEach(row => {
        const checkbox = row.querySelector('.node-checkbox');
        if (checkbox && checkbox.getAttribute('data-id') === nodeId) {
            const delayCell = row.querySelector('td:nth-child(5)');
            if (delayCell) {
                // 保存原始类名
                delayCell.dataset.originalClass = delayCell.className;
                // 创建加载动画HTML
                const loadingHtml = `
                    <div class="loading-spinner">
                        <div class="spinner"></div>
                        <span>测速中...</span>
                    </div>
                `;
                delayCell.innerHTML = loadingHtml;
                delayCell.className = 'loading';
            }
        }
    });
}

// 批量测试节点
function testAllNodes() {
    // 获取选中的节点ID
    const selectedCheckboxes = document.querySelectorAll('.node-checkbox:checked');
    let nodeIdsToTest = [];
    
    if (selectedCheckboxes.length > 0) {
        // 如果有选中的节点，测试选中的节点
        nodeIdsToTest = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-id'));
    } else {
        // 如果没有选中的节点，测试当前页面显示的所有节点
        const currentPageNodes = document.querySelectorAll('.node-checkbox');
        nodeIdsToTest = Array.from(currentPageNodes).map(cb => cb.getAttribute('data-id'));
    }
    
    if (nodeIdsToTest.length === 0) {
        return;
    }
    
    // 为每个节点显示加载指示器
    nodeIdsToTest.forEach(nodeId => {
        showLoadingIndicator(nodeId);
    });
    
    // 模拟批量测速
    nodeIdsToTest.forEach(nodeId => {
        // 使用不同的延迟时间，让测试看起来更真实
        const delayTime = 500 + Math.random() * 1500;
        
        setTimeout(() => {
            const randomDelay = Math.floor(Math.random() * 300) + 50;
            updateNodeDelay(nodeId, randomDelay);
        }, delayTime);
    });
}

// 更新节点延迟
function updateNodeDelay(nodeId, delay) {
    const rows = document.querySelectorAll('#nodeList tr');
    
    // 更新DOM中的节点延迟
    rows.forEach(row => {
        const checkbox = row.querySelector('.node-checkbox');
        if (checkbox && checkbox.getAttribute('data-id') === nodeId) {
            const delayCell = row.querySelector('td:nth-child(5)');
            if (delayCell) {
                // 恢复原始类名或使用新的延迟类
                if (delayCell.dataset.originalClass) {
                    delayCell.className = delayCell.dataset.originalClass;
                } else {
                    delayCell.className = getDelayClass(delay);
                }
                // 直接设置文本内容，确保居中显示
                const delayDisplay = getDelayDisplay(delay);
                delayCell.innerHTML = `<span style="display: inline-block; vertical-align: middle;">${delayDisplay}</span>`;
            }
        }
    });
    
    // 同时更新全局数据中的节点延迟
    const nodeIndex = nodeData.findIndex(node => node.id === nodeId);
    if (nodeIndex !== -1) {
        nodeData[nodeIndex].delay = delay;
    }
}

// 分配节点功能已移除

// 删除节点
function deleteNode(nodeId) {
    if (confirm(`确定要删除节点 ${nodeId} 吗？`)) {
        showLoading('正在删除节点...');
        
        // 从全局数据中移除节点
        const originalLength = nodeData.length;
        nodeData = nodeData.filter(node => node.id != nodeId);
        
        if (nodeData.length === originalLength) {
            // 如果没有成功删除，显示错误
            hideLoading();
            showNotification('删除节点失败，节点不存在', 'error');
            return;
        }
        
        // 重新计算总页数
        totalPages = Math.ceil(nodeData.length / pageSize);
        
        // 如果当前页没有数据了（被删除后），调整到上一页
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        }
        
        // 重新渲染节点列表和分页控件
        renderNodeList(getCurrentPageNodes());
        renderPagination();
        
        // 更新批量删除按钮状态
        updateBatchDeleteButtonStatus();
        
        hideLoading();
        showNotification(`节点 ${nodeId} 删除成功`, 'success');
    }
}

// 批量删除节点
function batchDeleteNodes() {
    // 获取当前页面选中的节点ID
    const selectedCheckboxes = document.querySelectorAll('.node-checkbox:checked');
    const selectedNodeIds = Array.from(selectedCheckboxes).map(cb => cb.getAttribute('data-id'));
    
    if (selectedNodeIds.length === 0) {
        showNotification('请先选择要删除的节点', 'error');
        return;
    }
    
    if (confirm(`确定要删除选中的 ${selectedNodeIds.length} 个节点吗？`)) {
        showLoading('正在批量删除节点...');
        
        // 从全局数据中移除选中的节点
        const originalLength = nodeData.length;
        nodeData = nodeData.filter(node => !selectedNodeIds.includes(node.id));
        
        const deletedCount = originalLength - nodeData.length;
        
        // 重新计算总页数
        totalPages = Math.ceil(nodeData.length / pageSize);
        
        // 如果当前页没有数据了（被删除后），调整到上一页
        if (currentPage > totalPages && totalPages > 0) {
            currentPage = totalPages;
        }
        
        // 重新渲染节点列表和分页控件
        renderNodeList(getCurrentPageNodes());
        renderPagination();
        
        // 更新批量删除按钮状态
        updateBatchDeleteButtonStatus();
        
        // 更新全选复选框状态
        document.getElementById('selectAllNodes').checked = false;
        
        hideLoading();
        showNotification(`成功删除 ${deletedCount} 个节点`, 'success');
    }
}

// 更新批量删除按钮状态
function updateBatchDeleteButtonStatus() {
    const batchDeleteBtn = document.getElementById('batchDeleteBtn');
    if (!batchDeleteBtn) return;
    
    const selectedCheckboxes = document.querySelectorAll('.node-checkbox:checked');
    batchDeleteBtn.disabled = selectedCheckboxes.length === 0;
}

// 导入配置文件
function importConfigFile() {
    // 确保先移除可能存在的旧加载元素
    hideLoading();
    
    // 获取选择的文件
    const fileInput = document.getElementById('configFile');
    const file = fileInput.files[0];
    
    if (!file) {
        showNotification('请先选择一个配置文件', 'error');
        return;
    }
    
    showLoading('正在上传和解析配置文件...');
    
    // 创建FormData对象
    const formData = new FormData();
    formData.append('config_file', file);
    formData.append('debug', 'true'); // 开启调试模式以获取详细日志
    
    // 发送文件到后端API
    fetch('/api/nodes/import', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        hideLoading();
        
        if (data.success) {
            // 关闭模态框
            const importModal = bootstrap.Modal.getInstance(document.getElementById('importConfigModal'));
            if (importModal) {
                importModal.hide();
            }
            
            // 重置表单和按钮状态
            document.getElementById('configFile').value = '';
            document.getElementById('configFileStatus').textContent = '未选择任何文件';
            document.getElementById('configFileStatus').classList.remove('text-success', 'text-danger');
            document.getElementById('doImportBtn').disabled = true;
            
            showNotification(data.message, 'success');
            
            // 重新从后端加载节点列表
            loadNodes();
        } else {
            showNotification(`导入失败: ${data.message}`, 'error');
        }
    })
    .catch(error => {
        hideLoading();
        showNotification(`导入过程中发生错误: ${error.message}`, 'error');
        console.error('导入配置文件错误:', error);
    });
}

</script>

<style>
/* 自定义样式 */
.node-checkbox {
    cursor: pointer;
}

.test-node-btn, .assign-node-btn, .delete-node-btn {
    margin-right: 5px;
}

.test-node-btn:hover {
    background-color: #17a2b8;
    border-color: #17a2b8;
}

.assign-node-btn:hover {
    background-color: #e0a800;
    border-color: #e0a800;
}

.delete-node-btn:hover {
    background-color: #dc3545;
    border-color: #dc3545;
}

/* 主要内容容器添加水平滚动条，确保内容超出时可以滚动 */
.card-body {
    overflow-x: auto !important;
    position: relative;
    width: 100%;
    max-width: 100%;
    box-sizing: border-box;
}

/* 确保表格容器样式正确，避免与外部滚动条冲突 */
.table-responsive {
    overflow-x: visible !important;
    margin-bottom: 15px;
    width: 100%;
}

/* 表格本身设置最小宽度，确保内容不会被过度压缩 */
.table {
    min-width: 900px;
    width: 100%;
}

/* 分页容器优化，确保在小屏幕上也能显示完整 */
.pagination-container {
    overflow-x: auto !important;
    white-space: nowrap;
    padding-bottom: 10px;
    min-width: 500px;
    width: 100%;
    box-sizing: border-box;
}

/* 批量删除按钮样式 */
#batchDeleteBtn:disabled {
    opacity: 0.65;
    cursor: not-allowed;
}

#batchDeleteBtn:hover:not(:disabled) {
    background-color: #c82333;
    border-color: #bd2130;
}

/* 进度条样式 */
.progress-bar {
    transition: width 0.6s ease;
}

/* 分页控件样式 */
.pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 15px;
    width: 100%;
    min-width: 500px; /* 确保有足够的最小宽度 */
}

.pagination {
    margin: 0;
}

.pagination .page-link {
    padding: 6px 12px;
    font-size: 14px;
    line-height: 1.5;
}

.pagination .page-item.active .page-link {
    background-color: #007bff;
    border-color: #007bff;
}

.pagination .page-item.disabled .page-link {
    color: #6c757d;
    background-color: #f8f9fa;
    border-color: #dee2e6;
}

/* 修复模态框关闭问题 - 确保模态框和背景层级正确 */
.modal-backdrop {
    z-index: 1040 !important;
}

.modal {
    z-index: 1050 !important;
}

/* 确保关闭按钮可点击 */
.close {
    z-index: 1060 !important;
    cursor: pointer !important;
    background-color: white !important;
    border-radius: 50% !important;
    width: 30px !important;
    height: 30px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
    position: relative !important;
}

/* 确保模态框内容可点击 */
.modal-content {
    position: relative !important;
    z-index: 1055 !important;
}

/* 确保底部按钮可点击 */
.close-btn {
    position: relative !important;
    z-index: 1060 !important;
    cursor: pointer !important;
}

/* 表格响应式调整 */
  .table-responsive {
      display: block;
      width: 100%;
      overflow-x: auto;
  }
  
  /* 确保按钮可点击，最小化尺寸 */
  .btn {
      min-width: 55px;
      min-height: 26px;
      padding: 3px 8px !important;
      font-size: 11px !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      position: relative; /* 确保z-index生效 */
      z-index: 1; /* 确保按钮在最上层 */
      margin-bottom: 1px;
      margin-right: 1px;
  }

/* 分页控件调整 - 最小化高度和内边距 */
  .pagination-container {
      overflow-x: auto;
      white-space: nowrap;
      padding-bottom: 5px;
      text-align: center;
      margin-top: 5px;
  }

.pagination {
      display: inline-flex;
      justify-content: center;
      margin: 0;
  }
  
  /* 最小化分页按钮 */
  .pagination > li > a,
  .pagination > li > span {
      padding: 3px 8px;
      font-size: 11px;
      line-height: 1;
      height: 24px;
  }
  
  /* 最小化表格包装器 */
  .table-responsive {
      margin-bottom: 5px;
  }

/* 页面比例调整 - 进一步缩小并减小高度 */
  body {
      font-size: 88%; /* 大幅缩小页面比例 */
      padding-bottom: 8px; /* 最小化底部空间 */
      line-height: 1.1; /* 进一步减小行高 */
      margin: 0;
  }

/* 调整内容包装器，最小化整体高度 */
  .container-fluid {
      padding-left: 5px;
      padding-right: 5px;
      min-height: auto;
      padding-bottom: 10px;
  }

.card {
    margin-bottom: 20px;
}

/* 表格列宽调整 - 确保每列有合适的宽度 */
  table#nodeTable {
      table-layout: fixed; /* 固定布局，避免列宽不均 */
      width: 100%;
  }
  
  /* 表格单元格调整 - 最小化内边距和行高 */
  .table th,
  .table td {
      padding: 0.15rem 0.3rem;
      line-height: 1.0;
      font-size: 11px;
  }
  
  /* 最小化表格行高 */
  table#nodeTable tbody tr {
      height: 32px; /* 更小的固定行高 */
  }
  
  /* 最小化表头高度 */
  table#nodeTable thead {
      height: 28px;
  }
  
  /* 最小化卡片内边距 */
  .card-body {
      padding: 5px !important;
      margin: 0;
  }
  
  /* 最小化下拉框高度 */
  select.form-control {
      height: 24px;
      padding: 1px 6px;
      font-size: 11px;
  }
  
  /* 最小化搜索框高度 */
  input.form-control {
      height: 24px;
      padding: 2px 6px;
      font-size: 11px;
  }
  
  /* 最小化卡片边距 */
  .card {
      margin-bottom: 5px;
      padding: 0;
  }

table#nodeTable th,
table#nodeTable td {
    white-space: nowrap;
    padding: 8px 6px;
    font-size: 14px;
    text-overflow: ellipsis;
    overflow: hidden;
}

/* 明确设置每列宽度，确保布局合理 */
table#nodeTable th:nth-child(1),
table#nodeTable td:nth-child(1) { width: 40px; }     /* 复选框 */
table#nodeTable th:nth-child(2),
table#nodeTable td:nth-child(2) { width: 120px; }    /* 节点名称 */
table#nodeTable th:nth-child(3),
table#nodeTable td:nth-child(3) { width: 80px; }     /* 地区 */
table#nodeTable th:nth-child(4),
table#nodeTable td:nth-child(4) { width: 80px; }     /* 协议 */
table#nodeTable th:nth-child(5),
table#nodeTable td:nth-child(5) { width: 60px; }     /* 类型 */
table#nodeTable th:nth-child(6),
table#nodeTable td:nth-child(6) { width: 80px; }     /* 延迟 */
table#nodeTable th:nth-child(7),
table#nodeTable td:nth-child(7) { width: 100px; }    /* 速度 */
table#nodeTable th:nth-child(8),
table#nodeTable td:nth-child(8) { width: 120px; }    /* 剩余流量 */
table#nodeTable th:nth-child(9),
table#nodeTable td:nth-child(9) { width: 120px; }    /* 有效期 */
table#nodeTable th:nth-child(10),
table#nodeTable td:nth-child(10) { width: 80px; }    /* 状态 */
table#nodeTable th:nth-child(11),
table#nodeTable td:nth-child(11) { width: 120px; }   /* 操作 */

/* 响应式调整 */
  @media (max-width: 1200px) {
      body {
          font-size: 92%;
      }
      
      .card-body {
          padding: 0.75rem;
          overflow-x: auto;
      }
      
      .btn {
          padding: 3px 6px !important;
          font-size: 10px !important;
          margin-right: 2px;
          margin-bottom: 2px;
          min-width: 50px;
          min-height: 24px;
      }
      
      #filterRegion, #filterProtocol {
          margin-bottom: 8px;
          font-size: 0.9rem;
      }
      
      table#nodeTable th,
      table#nodeTable td {
          padding: 6px 4px;
          font-size: 13px;
          white-space: nowrap; /* 确保内容不换行 */
      }
      
      /* 在小屏幕上，调整分页控件布局 */
      .d-flex.justify-content-between {
          flex-direction: column;
          align-items: center;
          gap: 10px;
          width: 100%;
      }
      
      .d-flex.align-items-center {
          flex-wrap: wrap;
          justify-content: center;
          gap: 10px;
          width: 100%;
      }
      
      /* 分页控件样式 - 与wuma.html保持一致 */
      .pagination {
        margin-bottom: 0;
      }
      
      .pagination .page-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
      }
      
      .pagination .page-item.active .page-link {
        background-color: #007bff;
        border-color: #007bff;
      }
      
      .pagination .page-item.disabled .page-link {
        color: #6c757d;
        pointer-events: none;
        background-color: #fff;
        border-color: #dee2e6;
      }
  }

@media (max-width: 768px) {
    body {
        font-size: 90%;
    }
    
    .card-body {
        padding: 0.5rem;
    }
    
    .btn {
        margin-bottom: 5px;
    }
    
    #filterRegion, #filterProtocol {
        margin-bottom: 10px;
        width: 100%;
    }
    
    table#nodeTable th,
    table#nodeTable td {
        font-size: 12px;
    }
    
    /* 小屏幕分页控件优化 - 与wuma.html保持一致 */
    .pagination {
        overflow-x: auto;
        display: flex;
        white-space: nowrap;
        margin-bottom: 0;
        -webkit-overflow-scrolling: touch;
    }
    
    .pagination .page-link {
        padding: 0.375rem 0.75rem;
        font-size: 0.875rem;
    }
}
</style>


{% endblock %}